<!DOCTYPE html>
<html>
<head>
<title>ç¬¬28ç« -æ¨¡å‹å¾®è°ƒä¸å®šåˆ¶åŒ–å¼€å‘.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%E7%AC%AC28%E7%AB%A0%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96%E5%BC%80%E5%8F%91">ç¬¬28ç« ï¼šæ¨¡å‹å¾®è°ƒä¸å®šåˆ¶åŒ–å¼€å‘</h1>
<h2 id="%F0%9F%8E%AF-%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87">ğŸ¯ å­¦ä¹ ç›®æ ‡</h2>
<h3 id="%F0%9F%93%9A-%E7%9F%A5%E8%AF%86%E7%9B%AE%E6%A0%87">ğŸ“š çŸ¥è¯†ç›®æ ‡</h3>
<ul>
<li>æŒæ¡æ¨¡å‹å¾®è°ƒçš„æ ¸å¿ƒåŸç†å’ŒæŠ€æœ¯è·¯çº¿</li>
<li>ç†è§£LoRAã€Adapterç­‰å‚æ•°é«˜æ•ˆå¾®è°ƒæ–¹æ³•</li>
<li>å­¦ä¹ æ•°æ®å·¥ç¨‹å’Œè®­ç»ƒä¼˜åŒ–ç­–ç•¥</li>
<li>äº†è§£æ¨¡å‹è¯„ä¼°å’Œéƒ¨ç½²ä¼˜åŒ–æŠ€æœ¯</li>
</ul>
<h3 id="%F0%9F%9B%A0%EF%B8%8F-%E6%8A%80%E8%83%BD%E7%9B%AE%E6%A0%87">ğŸ› ï¸ æŠ€èƒ½ç›®æ ‡</h3>
<ul>
<li>èƒ½å¤Ÿè®¾è®¡å’Œå®æ–½å®Œæ•´çš„æ¨¡å‹å¾®è°ƒæµç¨‹</li>
<li>æŒæ¡å¤šç§å¾®è°ƒæŠ€æœ¯çš„é€‰æ‹©å’Œåº”ç”¨</li>
<li>å…·å¤‡æ•°æ®å¤„ç†å’Œè®­ç»ƒä¼˜åŒ–èƒ½åŠ›</li>
<li>èƒ½å¤Ÿæ„å»ºè‡ªåŠ¨åŒ–å¾®è°ƒå¹³å°</li>
</ul>
<h3 id="%F0%9F%8E%A8-%E7%B4%A0%E5%85%BB%E7%9B%AE%E6%A0%87">ğŸ¨ ç´ å…»ç›®æ ‡</h3>
<ul>
<li>åŸ¹å…»AIæ¨¡å‹å®šåˆ¶åŒ–çš„ç³»ç»Ÿæ€§æ€ç»´</li>
<li>å»ºç«‹ä¼ä¸šçº§AIåº”ç”¨çš„å·¥ç¨‹åŒ–æ„è¯†</li>
<li>å½¢æˆæŒç»­å­¦ä¹ å’ŒæŠ€æœ¯åˆ›æ–°çš„èƒ½åŠ›</li>
</ul>
<h2 id="%F0%9F%8F%AD-%E6%AC%A2%E8%BF%8E%E6%9D%A5%E5%88%B0%E6%A8%A1%E5%9E%8B%E5%AE%9A%E5%88%B6%E5%B7%A5%E5%8E%82">ğŸ­ æ¬¢è¿æ¥åˆ°æ¨¡å‹å®šåˆ¶å·¥å‚</h2>
<p>æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„<strong>æ¨¡å‹å®šåˆ¶å·¥å‚</strong>ï¼åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»æŒæ¡äº†å¤šæ™ºèƒ½ä½“åä½œä¸é€šä¿¡çš„æŠ€æœ¯ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¿›å…¥ä¸€ä¸ªæ›´åŠ ç²¾ç»†åŒ–çš„é¢†åŸŸâ€”â€”æ¨¡å‹å¾®è°ƒä¸å®šåˆ¶åŒ–å¼€å‘ã€‚</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœè¯´é¢„è®­ç»ƒæ¨¡å‹æ˜¯å·¥å‚ç”Ÿäº§çš„&quot;é€šç”¨äº§å“&quot;ï¼Œé‚£ä¹ˆæ¨¡å‹å¾®è°ƒå°±æ˜¯æ ¹æ®å®¢æˆ·éœ€æ±‚è¿›è¡Œçš„&quot;ä¸ªæ€§åŒ–å®šåˆ¶&quot;ã€‚åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼š</p>
<ul>
<li><strong>åŸæ–™æŠ•å…¥</strong> â†’ é¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚BERTã€GPTç­‰ï¼‰</li>
<li><strong>ç”Ÿäº§çº¿é…ç½®</strong> â†’ å¾®è°ƒç­–ç•¥é€‰æ‹©ï¼ˆLoRAã€Adapterç­‰ï¼‰</li>
<li><strong>è´¨é‡æ§åˆ¶</strong> â†’ è®­ç»ƒç›‘æ§ä¸è¯„ä¼°</li>
<li><strong>äº§å“è¾“å‡º</strong> â†’ å®šåˆ¶åŒ–æ¨¡å‹</li>
</ul>
<h2 id="%F0%9F%93%8B-%E6%9C%AC%E7%AB%A0%E5%86%85%E5%AE%B9%E5%AF%BC%E8%A7%88">ğŸ“‹ æœ¬ç« å†…å®¹å¯¼è§ˆ</h2>
<h3 id="281-%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA">28.1 æ¨¡å‹å¾®è°ƒåŸºç¡€ç†è®º</h3>
<p>æ·±å…¥ç†è§£æ¨¡å‹å¾®è°ƒçš„æ ¸å¿ƒåŸç†ï¼Œå­¦ä¹ ä¸åŒå¾®è°ƒç­–ç•¥çš„é€‰æ‹©å’Œåº”ç”¨ã€‚</p>
<h3 id="282-%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83%E6%8A%80%E6%9C%AF">28.2 å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯</h3>
<p>æŒæ¡LoRAã€Adapterç­‰å‰æ²¿çš„å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯ã€‚</p>
<h3 id="283-%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E9%A2%84%E5%A4%84%E7%90%86">28.3 æ•°æ®å·¥ç¨‹ä¸é¢„å¤„ç†</h3>
<p>æ„å»ºé«˜è´¨é‡çš„è®­ç»ƒæ•°æ®ï¼Œå»ºç«‹å®Œå–„çš„æ•°æ®å¤„ç†æµç¨‹ã€‚</p>
<h3 id="284-%E8%AE%AD%E7%BB%83%E4%BC%98%E5%8C%96%E4%B8%8E%E7%9B%91%E6%8E%A7">28.4 è®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§</h3>
<p>ç²¾ç»†åŒ–ç®¡ç†è®­ç»ƒè¿‡ç¨‹ï¼Œå®ç°é«˜æ•ˆçš„æ¨¡å‹ä¼˜åŒ–ã€‚</p>
<h3 id="285-%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%B8%8E%E5%88%86%E6%9E%90">28.5 æ¨¡å‹è¯„ä¼°ä¸åˆ†æ</h3>
<p>å»ºç«‹å¤šç»´åº¦çš„æ•ˆæœè¯„ä¼°ä½“ç³»ï¼Œç§‘å­¦éªŒè¯æ¨¡å‹æ€§èƒ½ã€‚</p>
<h3 id="286-%E5%AE%9A%E5%88%B6%E5%8C%96ai%E5%8A%A9%E6%89%8B%E5%AE%9E%E6%88%98">28.6 å®šåˆ¶åŒ–AIåŠ©æ‰‹å®æˆ˜</h3>
<p>å¼€å‘ä¼ä¸šçº§ä¸ªæ€§åŒ–AIåŠ©æ‰‹ï¼Œå®ç°å®Œæ•´çš„å®šåˆ¶åŒ–è§£å†³æ–¹æ¡ˆã€‚</p>
<h3 id="287-%E6%9C%AC%E7%AB%A0%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B">28.7 æœ¬ç« æ€»ç»“ä¸å±•æœ›</h3>
<p>å›é¡¾å­¦ä¹ æˆæœï¼Œå±•æœ›æ¨¡å‹å®šåˆ¶æŠ€æœ¯çš„æœªæ¥å‘å±•ã€‚</p>
<hr>
<h2 id="281-%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA">28.1 æ¨¡å‹å¾®è°ƒåŸºç¡€ç†è®º</h2>
<h3 id="%F0%9F%94%AC-%E5%BE%AE%E8%B0%83%E7%9A%84%E6%9C%AC%E8%B4%A8%E7%9F%A5%E8%AF%86%E7%9A%84%E7%B2%BE%E5%87%86%E8%BF%81%E7%A7%BB">ğŸ”¬ å¾®è°ƒçš„æœ¬è´¨ï¼šçŸ¥è¯†çš„ç²¾å‡†è¿ç§»</h3>
<p>åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼Œå¾®è°ƒå°±åƒæ˜¯å¯¹é€šç”¨äº§å“è¿›è¡Œç²¾å‡†æ”¹é€ çš„è¿‡ç¨‹ã€‚è®©æˆ‘ä»¬æ·±å…¥ç†è§£è¿™ä¸ªè¿‡ç¨‹çš„æœ¬è´¨ã€‚</p>
<h4 id="%F0%9F%93%8A-%E5%BE%AE%E8%B0%83-vs-%E9%A2%84%E8%AE%AD%E7%BB%83%E4%B8%A4%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%BC%8F">ğŸ“Š å¾®è°ƒ vs é¢„è®­ç»ƒï¼šä¸¤ç§ä¸åŒçš„å­¦ä¹ æ¨¡å¼</h4>
<pre><code class="language-mermaid"><div class="mermaid">graph LR
    subgraph "é¢„è®­ç»ƒé˜¶æ®µ"
        A[å¤§è§„æ¨¡æ— æ ‡ç­¾æ•°æ®] --> B[é€šç”¨è¯­è¨€ç†è§£]
        B --> C[åŸºç¡€æ¨¡å‹]
    end
    
    subgraph "å¾®è°ƒé˜¶æ®µ"
        C --> D[ç‰¹å®šä»»åŠ¡æ•°æ®]
        D --> E[ä»»åŠ¡é€‚é…]
        E --> F[å®šåˆ¶åŒ–æ¨¡å‹]
    end
    
    style A fill:#e1f5fe
    style D fill:#f3e5f5
    style C fill:#e8f5e8
    style F fill:#fff3e0
</div></code></pre>
<p><strong>é¢„è®­ç»ƒ</strong>å°±åƒæ˜¯åŸ¹å…»ä¸€ä¸ªåšå­¦çš„é€šæ‰ï¼Œè®©æ¨¡å‹åœ¨æµ·é‡æ•°æ®ä¸Šå­¦ä¹ é€šç”¨çš„è¯­è¨€ç†è§£èƒ½åŠ›ã€‚è€Œ<strong>å¾®è°ƒ</strong>åˆ™æ˜¯åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œé’ˆå¯¹ç‰¹å®šä»»åŠ¡è¿›è¡Œä¸“ä¸šåŒ–è®­ç»ƒï¼Œå°±åƒè®©é€šæ‰æˆä¸ºæŸä¸ªé¢†åŸŸçš„ä¸“å®¶ã€‚</p>
<p>è®©æˆ‘ä»¬ç”¨ä»£ç æ¥ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModel, AutoTokenizer
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FineTuningDemo</span>:</span>
    <span class="hljs-string">"""æ¨¡å‹å¾®è°ƒæ¼”ç¤ºç±»"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model_name=<span class="hljs-string">"bert-base-uncased"</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–å¾®è°ƒæ¼”ç¤º
        Args:
            model_name: é¢„è®­ç»ƒæ¨¡å‹åç§°
        """</span>
        self.model_name = model_name
        self.tokenizer = AutoTokenizer.from_pretrained(model_name)
        self.base_model = AutoModel.from_pretrained(model_name)
        
        <span class="hljs-comment"># å†»ç»“é¢„è®­ç»ƒå±‚çš„å‚æ•°ï¼ˆå¯é€‰ï¼‰</span>
        self.freeze_base_model()
        
        print(<span class="hljs-string">f"âœ… å·²åŠ è½½é¢„è®­ç»ƒæ¨¡å‹: <span class="hljs-subst">{model_name}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“Š æ¨¡å‹å‚æ•°é‡: <span class="hljs-subst">{self.count_parameters():,}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">freeze_base_model</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å†»ç»“é¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°"""</span>
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> self.base_model.parameters():
            param.requires_grad = <span class="hljs-literal">False</span>
        print(<span class="hljs-string">"ğŸ”’ å·²å†»ç»“é¢„è®­ç»ƒæ¨¡å‹å‚æ•°"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unfreeze_base_model</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""è§£å†»é¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°"""</span>
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> self.base_model.parameters():
            param.requires_grad = <span class="hljs-literal">True</span>
        print(<span class="hljs-string">"ğŸ”“ å·²è§£å†»é¢„è®­ç»ƒæ¨¡å‹å‚æ•°"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">count_parameters</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ç»Ÿè®¡æ¨¡å‹å‚æ•°é‡"""</span>
        <span class="hljs-keyword">return</span> sum(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.base_model.parameters())
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_classification_head</span><span class="hljs-params">(self, num_classes=<span class="hljs-number">2</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆ›å»ºåˆ†ç±»å¤´
        Args:
            num_classes: åˆ†ç±»ç±»åˆ«æ•°
        """</span>
        hidden_size = self.base_model.config.hidden_size
        
        self.classifier = nn.Sequential(
            nn.Dropout(<span class="hljs-number">0.1</span>),
            nn.Linear(hidden_size, hidden_size // <span class="hljs-number">2</span>),
            nn.ReLU(),
            nn.Dropout(<span class="hljs-number">0.1</span>),
            nn.Linear(hidden_size // <span class="hljs-number">2</span>, num_classes)
        )
        
        print(<span class="hljs-string">f"ğŸ¯ å·²åˆ›å»ºåˆ†ç±»å¤´ï¼Œè¾“å‡ºç»´åº¦: <span class="hljs-subst">{num_classes}</span>"</span>)
        <span class="hljs-keyword">return</span> self.classifier
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">demonstrate_feature_extraction</span><span class="hljs-params">(self, texts)</span>:</span>
        <span class="hljs-string">"""
        æ¼”ç¤ºç‰¹å¾æå–è¿‡ç¨‹
        Args:
            texts: è¾“å…¥æ–‡æœ¬åˆ—è¡¨
        """</span>
        print(<span class="hljs-string">"\nğŸ” ç‰¹å¾æå–æ¼”ç¤º:"</span>)
        
        <span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> enumerate(texts):
            <span class="hljs-comment"># ç¼–ç æ–‡æœ¬</span>
            inputs = self.tokenizer(text, return_tensors=<span class="hljs-string">"pt"</span>, 
                                  padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>)
            
            <span class="hljs-comment"># æå–ç‰¹å¾</span>
            <span class="hljs-keyword">with</span> torch.no_grad():
                outputs = self.base_model(**inputs)
                features = outputs.last_hidden_state.mean(dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># å¹³å‡æ± åŒ–</span>
            
            print(<span class="hljs-string">f"æ–‡æœ¬ <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{text}</span>"</span>)
            print(<span class="hljs-string">f"ç‰¹å¾ç»´åº¦: <span class="hljs-subst">{features.shape}</span>"</span>)
            print(<span class="hljs-string">f"ç‰¹å¾èŒƒå›´: [<span class="hljs-subst">{features.min():<span class="hljs-number">.3</span>f}</span>, <span class="hljs-subst">{features.max():<span class="hljs-number">.3</span>f}</span>]"</span>)
            print(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># æ¼”ç¤ºå¾®è°ƒåŸºç¡€æ¦‚å¿µ</span>
demo = FineTuningDemo()

<span class="hljs-comment"># åˆ›å»ºåˆ†ç±»å¤´</span>
classifier = demo.create_classification_head(num_classes=<span class="hljs-number">3</span>)

<span class="hljs-comment"># æ¼”ç¤ºç‰¹å¾æå–</span>
sample_texts = [
    <span class="hljs-string">"This movie is absolutely fantastic!"</span>,
    <span class="hljs-string">"The service was terrible and disappointing."</span>,
    <span class="hljs-string">"It's an okay product, nothing special."</span>
]

demo.demonstrate_feature_extraction(sample_texts)
</div></code></pre>
<h4 id="%F0%9F%8E%AF-%E5%BE%AE%E8%B0%83%E7%AD%96%E7%95%A5%E5%88%86%E7%B1%BB%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AE%9A%E5%88%B6%E6%96%B9%E6%A1%88">ğŸ¯ å¾®è°ƒç­–ç•¥åˆ†ç±»ï¼šä¸åŒçš„å®šåˆ¶æ–¹æ¡ˆ</h4>
<p>åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼Œæœ‰å¤šç§ä¸åŒçš„å®šåˆ¶æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼š</p>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    A[æ¨¡å‹å¾®è°ƒç­–ç•¥] --> B[å…¨å‚æ•°å¾®è°ƒ]
    A --> C[å‚æ•°é«˜æ•ˆå¾®è°ƒ]
    
    B --> D[å®Œå…¨å¾®è°ƒ]
    B --> E[æ¸è¿›å¼å¾®è°ƒ]
    
    C --> F[LoRA]
    C --> G[Adapter]
    C --> H[Prefix Tuning]
    C --> I[Prompt Tuning]
    
    style A fill:#ff9800
    style B fill:#2196f3
    style C fill:#4caf50
</div></code></pre>
<p>è®©æˆ‘ä»¬è¯¦ç»†äº†è§£æ¯ç§ç­–ç•¥ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FineTuningStrategy</span>:</span>
    <span class="hljs-string">"""å¾®è°ƒç­–ç•¥åˆ†æç±»"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.strategies = {
            <span class="hljs-string">"full_finetuning"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"å…¨å‚æ•°å¾®è°ƒ"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"æ›´æ–°æ¨¡å‹çš„æ‰€æœ‰å‚æ•°"</span>,
                <span class="hljs-string">"advantages"</span>: [<span class="hljs-string">"æ•ˆæœæœ€å¥½"</span>, <span class="hljs-string">"é€‚åº”æ€§å¼º"</span>],
                <span class="hljs-string">"disadvantages"</span>: [<span class="hljs-string">"è®¡ç®—æˆæœ¬é«˜"</span>, <span class="hljs-string">"å®¹æ˜“è¿‡æ‹Ÿåˆ"</span>, <span class="hljs-string">"å­˜å‚¨éœ€æ±‚å¤§"</span>],
                <span class="hljs-string">"suitable_for"</span>: [<span class="hljs-string">"æ•°æ®å……è¶³"</span>, <span class="hljs-string">"è®¡ç®—èµ„æºä¸°å¯Œ"</span>, <span class="hljs-string">"è¿½æ±‚æœ€ä½³æ•ˆæœ"</span>]
            },
            <span class="hljs-string">"lora"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"LoRAå¾®è°ƒ"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"ä½ç§©é€‚åº”ï¼Œåªè®­ç»ƒå°‘é‡å‚æ•°"</span>,
                <span class="hljs-string">"advantages"</span>: [<span class="hljs-string">"å‚æ•°å°‘"</span>, <span class="hljs-string">"è®­ç»ƒå¿«"</span>, <span class="hljs-string">"é˜²æ­¢è¿‡æ‹Ÿåˆ"</span>],
                <span class="hljs-string">"disadvantages"</span>: [<span class="hljs-string">"æ•ˆæœå¯èƒ½ç•¥é€Š"</span>, <span class="hljs-string">"éœ€è¦è°ƒæ•´ç§©å‚æ•°"</span>],
                <span class="hljs-string">"suitable_for"</span>: [<span class="hljs-string">"æ•°æ®æœ‰é™"</span>, <span class="hljs-string">"è®¡ç®—èµ„æºå—é™"</span>, <span class="hljs-string">"å¿«é€Ÿéƒ¨ç½²"</span>]
            },
            <span class="hljs-string">"adapter"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"Adapterå¾®è°ƒ"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"åœ¨æ¨¡å‹ä¸­æ’å…¥å°å‹é€‚é…å™¨å±‚"</span>,
                <span class="hljs-string">"advantages"</span>: [<span class="hljs-string">"æ¨¡å—åŒ–"</span>, <span class="hljs-string">"å¯æ’æ‹”"</span>, <span class="hljs-string">"å‚æ•°æ•ˆç‡é«˜"</span>],
                <span class="hljs-string">"disadvantages"</span>: [<span class="hljs-string">"å¢åŠ æ¨ç†å»¶è¿Ÿ"</span>, <span class="hljs-string">"æ¶æ„å¤æ‚"</span>],
                <span class="hljs-string">"suitable_for"</span>: [<span class="hljs-string">"å¤šä»»åŠ¡åœºæ™¯"</span>, <span class="hljs-string">"æ¨¡å‹å…±äº«"</span>, <span class="hljs-string">"å¢é‡å­¦ä¹ "</span>]
            },
            <span class="hljs-string">"prefix_tuning"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"å‰ç¼€å¾®è°ƒ"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"åªè®­ç»ƒè¾“å…¥å‰ç¼€çš„åµŒå…¥"</span>,
                <span class="hljs-string">"advantages"</span>: [<span class="hljs-string">"å‚æ•°æå°‘"</span>, <span class="hljs-string">"ä¸æ”¹å˜æ¨¡å‹ç»“æ„"</span>],
                <span class="hljs-string">"disadvantages"</span>: [<span class="hljs-string">"æ•ˆæœæœ‰é™"</span>, <span class="hljs-string">"é€‚ç”¨åœºæ™¯çª„"</span>],
                <span class="hljs-string">"suitable_for"</span>: [<span class="hljs-string">"ç”Ÿæˆä»»åŠ¡"</span>, <span class="hljs-string">"å¿«é€Ÿé€‚é…"</span>, <span class="hljs-string">"è½»é‡åŒ–éƒ¨ç½²"</span>]
            }
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_strategies</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""æ¯”è¾ƒä¸åŒå¾®è°ƒç­–ç•¥"""</span>
        print(<span class="hljs-string">"ğŸ“Š å¾®è°ƒç­–ç•¥å¯¹æ¯”åˆ†æ:"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
        
        <span class="hljs-keyword">for</span> key, strategy <span class="hljs-keyword">in</span> self.strategies.items():
            print(<span class="hljs-string">f"\nğŸ¯ <span class="hljs-subst">{strategy[<span class="hljs-string">'name'</span>]}</span>"</span>)
            print(<span class="hljs-string">f"æè¿°: <span class="hljs-subst">{strategy[<span class="hljs-string">'description'</span>]}</span>"</span>)
            print(<span class="hljs-string">f"âœ… ä¼˜åŠ¿: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(strategy[<span class="hljs-string">'advantages'</span>])}</span>"</span>)
            print(<span class="hljs-string">f"âŒ åŠ£åŠ¿: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(strategy[<span class="hljs-string">'disadvantages'</span>])}</span>"</span>)
            print(<span class="hljs-string">f"ğŸ¯ é€‚ç”¨åœºæ™¯: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(strategy[<span class="hljs-string">'suitable_for'</span>])}</span>"</span>)
            print(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">estimate_resources</span><span class="hljs-params">(self, model_size_mb, strategy=<span class="hljs-string">"full_finetuning"</span>)</span>:</span>
        <span class="hljs-string">"""
        ä¼°ç®—èµ„æºéœ€æ±‚
        Args:
            model_size_mb: æ¨¡å‹å¤§å°(MB)
            strategy: å¾®è°ƒç­–ç•¥
        """</span>
        multipliers = {
            <span class="hljs-string">"full_finetuning"</span>: {<span class="hljs-string">"memory"</span>: <span class="hljs-number">4.0</span>, <span class="hljs-string">"time"</span>: <span class="hljs-number">1.0</span>, <span class="hljs-string">"storage"</span>: <span class="hljs-number">2.0</span>},
            <span class="hljs-string">"lora"</span>: {<span class="hljs-string">"memory"</span>: <span class="hljs-number">1.2</span>, <span class="hljs-string">"time"</span>: <span class="hljs-number">0.3</span>, <span class="hljs-string">"storage"</span>: <span class="hljs-number">1.1</span>},
            <span class="hljs-string">"adapter"</span>: {<span class="hljs-string">"memory"</span>: <span class="hljs-number">1.5</span>, <span class="hljs-string">"time"</span>: <span class="hljs-number">0.4</span>, <span class="hljs-string">"storage"</span>: <span class="hljs-number">1.2</span>},
            <span class="hljs-string">"prefix_tuning"</span>: {<span class="hljs-string">"memory"</span>: <span class="hljs-number">1.1</span>, <span class="hljs-string">"time"</span>: <span class="hljs-number">0.2</span>, <span class="hljs-string">"storage"</span>: <span class="hljs-number">1.05</span>}
        }
        
        <span class="hljs-keyword">if</span> strategy <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> multipliers:
            print(<span class="hljs-string">f"âŒ ä¸æ”¯æŒçš„ç­–ç•¥: <span class="hljs-subst">{strategy}</span>"</span>)
            <span class="hljs-keyword">return</span>
        
        mult = multipliers[strategy]
        
        print(<span class="hljs-string">f"\nğŸ“Š <span class="hljs-subst">{self.strategies[strategy][<span class="hljs-string">'name'</span>]}</span> èµ„æºéœ€æ±‚ä¼°ç®—:"</span>)
        print(<span class="hljs-string">f"åŸºç¡€æ¨¡å‹å¤§å°: <span class="hljs-subst">{model_size_mb}</span> MB"</span>)
        print(<span class="hljs-string">f"è®­ç»ƒå†…å­˜éœ€æ±‚: <span class="hljs-subst">{model_size_mb * mult[<span class="hljs-string">'memory'</span>]:<span class="hljs-number">.1</span>f}</span> MB"</span>)
        print(<span class="hljs-string">f"ç›¸å¯¹è®­ç»ƒæ—¶é—´: <span class="hljs-subst">{mult[<span class="hljs-string">'time'</span>]:<span class="hljs-number">.1</span>f}</span>x"</span>)
        print(<span class="hljs-string">f"å­˜å‚¨éœ€æ±‚: <span class="hljs-subst">{model_size_mb * mult[<span class="hljs-string">'storage'</span>]:<span class="hljs-number">.1</span>f}</span> MB"</span>)

<span class="hljs-comment"># æ¼”ç¤ºç­–ç•¥åˆ†æ</span>
strategy_analyzer = FineTuningStrategy()
strategy_analyzer.compare_strategies()

<span class="hljs-comment"># èµ„æºéœ€æ±‚ä¼°ç®—</span>
strategy_analyzer.estimate_resources(<span class="hljs-number">440</span>, <span class="hljs-string">"full_finetuning"</span>)  <span class="hljs-comment"># BERT-base</span>
strategy_analyzer.estimate_resources(<span class="hljs-number">440</span>, <span class="hljs-string">"lora"</span>)
</div></code></pre>
<h4 id="%F0%9F%94%84-%E8%BF%81%E7%A7%BB%E5%AD%A6%E4%B9%A0%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86%E4%BC%A0%E6%89%BF%E7%9A%84%E8%89%BA%E6%9C%AF">ğŸ”„ è¿ç§»å­¦ä¹ ç†è®ºï¼šçŸ¥è¯†ä¼ æ‰¿çš„è‰ºæœ¯</h4>
<p>å¾®è°ƒçš„æ ¸å¿ƒæ˜¯è¿ç§»å­¦ä¹ ï¼Œå°±åƒæ˜¯å°†ä¸€ä¸ªé¢†åŸŸçš„ä¸“ä¸šçŸ¥è¯†è½¬ç§»åˆ°å¦ä¸€ä¸ªé¢†åŸŸã€‚è®©æˆ‘ä»¬æ·±å…¥ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.manifold <span class="hljs-keyword">import</span> TSNE
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransferLearningAnalyzer</span>:</span>
    <span class="hljs-string">"""è¿ç§»å­¦ä¹ åˆ†æå™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.layer_types = [
            <span class="hljs-string">"è¯åµŒå…¥å±‚"</span>, <span class="hljs-string">"æµ…å±‚ç¼–ç å™¨"</span>, <span class="hljs-string">"ä¸­å±‚ç¼–ç å™¨"</span>, 
            <span class="hljs-string">"æ·±å±‚ç¼–ç å™¨"</span>, <span class="hljs-string">"ä»»åŠ¡ç‰¹å®šå±‚"</span>
        ]
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_knowledge_transfer</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–çŸ¥è¯†è¿ç§»è¿‡ç¨‹"""</span>
        <span class="hljs-comment"># æ¨¡æ‹Ÿä¸åŒå±‚çš„çŸ¥è¯†é€šç”¨æ€§</span>
        universality = [<span class="hljs-number">0.95</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.1</span>]
        task_specificity = [<span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.9</span>]
        
        fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">6</span>))
        
        <span class="hljs-comment"># çŸ¥è¯†é€šç”¨æ€§å›¾</span>
        ax1.barh(self.layer_types, universality, color=<span class="hljs-string">'skyblue'</span>, alpha=<span class="hljs-number">0.7</span>)
        ax1.set_xlabel(<span class="hljs-string">'é€šç”¨æ€§ç¨‹åº¦'</span>)
        ax1.set_title(<span class="hljs-string">'ä¸åŒå±‚çš„çŸ¥è¯†é€šç”¨æ€§'</span>)
        ax1.set_xlim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># ä»»åŠ¡ç‰¹å¼‚æ€§å›¾</span>
        ax2.barh(self.layer_types, task_specificity, color=<span class="hljs-string">'lightcoral'</span>, alpha=<span class="hljs-number">0.7</span>)
        ax2.set_xlabel(<span class="hljs-string">'ä»»åŠ¡ç‰¹å¼‚æ€§ç¨‹åº¦'</span>)
        ax2.set_title(<span class="hljs-string">'ä¸åŒå±‚çš„ä»»åŠ¡ç‰¹å¼‚æ€§'</span>)
        ax2.set_xlim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        
        plt.tight_layout()
        plt.show()
        
        print(<span class="hljs-string">"ğŸ“Š çŸ¥è¯†è¿ç§»è§„å¾‹:"</span>)
        <span class="hljs-keyword">for</span> i, layer <span class="hljs-keyword">in</span> enumerate(self.layer_types):
            print(<span class="hljs-string">f"<span class="hljs-subst">{layer}</span>: é€šç”¨æ€§<span class="hljs-subst">{universality[i]:<span class="hljs-number">.1</span>%}</span>, ç‰¹å¼‚æ€§<span class="hljs-subst">{task_specificity[i]:<span class="hljs-number">.1</span>%}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">demonstrate_feature_evolution</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""æ¼”ç¤ºç‰¹å¾æ¼”åŒ–è¿‡ç¨‹"""</span>
        <span class="hljs-comment"># æ¨¡æ‹Ÿé¢„è®­ç»ƒå’Œå¾®è°ƒè¿‡ç¨‹ä¸­ç‰¹å¾çš„å˜åŒ–</span>
        np.random.seed(<span class="hljs-number">42</span>)
        
        <span class="hljs-comment"># é¢„è®­ç»ƒç‰¹å¾ (é€šç”¨)</span>
        pretrain_features = np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, (<span class="hljs-number">100</span>, <span class="hljs-number">2</span>))
        
        <span class="hljs-comment"># å¾®è°ƒåç‰¹å¾ (ä»»åŠ¡ç‰¹å®š)</span>
        finetune_features = pretrain_features + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>, (<span class="hljs-number">100</span>, <span class="hljs-number">2</span>))
        finetune_features[:<span class="hljs-number">50</span>] += [<span class="hljs-number">1.5</span>, <span class="hljs-number">1.5</span>]  <span class="hljs-comment"># ç±»åˆ«1</span>
        finetune_features[<span class="hljs-number">50</span>:] += [<span class="hljs-number">-1.5</span>, <span class="hljs-number">-1.5</span>]  <span class="hljs-comment"># ç±»åˆ«2</span>
        
        fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">5</span>))
        
        <span class="hljs-comment"># é¢„è®­ç»ƒç‰¹å¾åˆ†å¸ƒ</span>
        ax1.scatter(pretrain_features[:, <span class="hljs-number">0</span>], pretrain_features[:, <span class="hljs-number">1</span>], 
                   alpha=<span class="hljs-number">0.6</span>, s=<span class="hljs-number">50</span>, c=<span class="hljs-string">'gray'</span>)
        ax1.set_title(<span class="hljs-string">'é¢„è®­ç»ƒç‰¹å¾åˆ†å¸ƒ\n(é€šç”¨è¡¨ç¤º)'</span>)
        ax1.set_xlabel(<span class="hljs-string">'ç‰¹å¾ç»´åº¦1'</span>)
        ax1.set_ylabel(<span class="hljs-string">'ç‰¹å¾ç»´åº¦2'</span>)
        ax1.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
        
        <span class="hljs-comment"># å¾®è°ƒåç‰¹å¾åˆ†å¸ƒ</span>
        colors = [<span class="hljs-string">'red'</span>] * <span class="hljs-number">50</span> + [<span class="hljs-string">'blue'</span>] * <span class="hljs-number">50</span>
        ax2.scatter(finetune_features[:, <span class="hljs-number">0</span>], finetune_features[:, <span class="hljs-number">1</span>], 
                   alpha=<span class="hljs-number">0.6</span>, s=<span class="hljs-number">50</span>, c=colors)
        ax2.set_title(<span class="hljs-string">'å¾®è°ƒåç‰¹å¾åˆ†å¸ƒ\n(ä»»åŠ¡ç‰¹å®š)'</span>)
        ax2.set_xlabel(<span class="hljs-string">'ç‰¹å¾ç»´åº¦1'</span>)
        ax2.set_ylabel(<span class="hljs-string">'ç‰¹å¾ç»´åº¦2'</span>)
        ax2.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
        
        plt.tight_layout()
        plt.show()
        
        print(<span class="hljs-string">"ğŸ¯ ç‰¹å¾æ¼”åŒ–åˆ†æ:"</span>)
        print(<span class="hljs-string">"â€¢ é¢„è®­ç»ƒé˜¶æ®µ: å­¦ä¹ é€šç”¨çš„è¯­è¨€è¡¨ç¤º"</span>)
        print(<span class="hljs-string">"â€¢ å¾®è°ƒé˜¶æ®µ: é€‚åº”ç‰¹å®šä»»åŠ¡éœ€æ±‚"</span>)
        print(<span class="hljs-string">"â€¢ ç»“æœ: ä¿æŒé€šç”¨æ€§çš„åŒæ—¶è·å¾—ä»»åŠ¡ç‰¹å¼‚æ€§"</span>)

<span class="hljs-comment"># æ¼”ç¤ºè¿ç§»å­¦ä¹ åˆ†æ</span>
transfer_analyzer = TransferLearningAnalyzer()
transfer_analyzer.visualize_knowledge_transfer()
transfer_analyzer.demonstrate_feature_evolution()
</div></code></pre>
<h4 id="%F0%9F%9B%A0%EF%B8%8F-%E5%BE%AE%E8%B0%83%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E9%83%A8%E7%BD%B2%E7%9A%84%E5%AE%8C%E6%95%B4pipeline">ğŸ› ï¸ å¾®è°ƒæµç¨‹è®¾è®¡ï¼šä»æ•°æ®åˆ°éƒ¨ç½²çš„å®Œæ•´pipeline</h4>
<p>ç°åœ¨è®©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„å¾®è°ƒæµç¨‹ï¼Œå°±åƒåœ¨å·¥å‚ä¸­å»ºç«‹æ ‡å‡†åŒ–çš„ç”Ÿäº§çº¿ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FineTuningPipeline</span>:</span>
    <span class="hljs-string">"""å®Œæ•´çš„å¾®è°ƒæµç¨‹ç®¡ç†å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model_name, task_type=<span class="hljs-string">"classification"</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–å¾®è°ƒæµç¨‹
        Args:
            model_name: é¢„è®­ç»ƒæ¨¡å‹åç§°
            task_type: ä»»åŠ¡ç±»å‹ (classification, regression, generation)
        """</span>
        self.model_name = model_name
        self.task_type = task_type
        self.pipeline_stages = [
            <span class="hljs-string">"æ•°æ®å‡†å¤‡"</span>, <span class="hljs-string">"æ¨¡å‹åŠ è½½"</span>, <span class="hljs-string">"é…ç½®ä¼˜åŒ–å™¨"</span>, 
            <span class="hljs-string">"è®­ç»ƒç›‘æ§"</span>, <span class="hljs-string">"æ¨¡å‹è¯„ä¼°"</span>, <span class="hljs-string">"æ¨¡å‹ä¿å­˜"</span>, <span class="hljs-string">"éƒ¨ç½²å‡†å¤‡"</span>
        ]
        
        print(<span class="hljs-string">f"ğŸ­ åˆå§‹åŒ–å¾®è°ƒæµæ°´çº¿: <span class="hljs-subst">{model_name}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“‹ ä»»åŠ¡ç±»å‹: <span class="hljs-subst">{task_type}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_pipeline</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–å¾®è°ƒæµç¨‹"""</span>
        print(<span class="hljs-string">"\nğŸ”„ å¾®è°ƒæµç¨‹å›¾:"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        
        <span class="hljs-comment"># åˆ›å»ºæµç¨‹å›¾</span>
        flow_chart = <span class="hljs-string">"""
        ```mermaid
        graph TD
            A[åŸå§‹æ•°æ®] --&gt; B[æ•°æ®æ¸…æ´—]
            B --&gt; C[æ•°æ®æ ‡æ³¨]
            C --&gt; D[æ•°æ®åˆ’åˆ†]
            D --&gt; E[åŠ è½½é¢„è®­ç»ƒæ¨¡å‹]
            E --&gt; F[æ·»åŠ ä»»åŠ¡å¤´]
            F --&gt; G[é…ç½®è®­ç»ƒå‚æ•°]
            G --&gt; H[å¼€å§‹è®­ç»ƒ]
            H --&gt; I[å®æ—¶ç›‘æ§]
            I --&gt; J{æ˜¯å¦æ”¶æ•›?}
            J --&gt;|å¦| H
            J --&gt;|æ˜¯| K[æ¨¡å‹è¯„ä¼°]
            K --&gt; L[æ€§èƒ½ä¼˜åŒ–]
            L --&gt; M[æ¨¡å‹ä¿å­˜]
            M --&gt; N[éƒ¨ç½²å‡†å¤‡]
            
            style A fill:#e1f5fe
            style N fill:#e8f5e8
            style J fill:#fff3e0
        ```
        """</span>
        print(flow_chart)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">estimate_pipeline_time</span><span class="hljs-params">(self, data_size, model_size=<span class="hljs-string">"base"</span>)</span>:</span>
        <span class="hljs-string">"""
        ä¼°ç®—æµç¨‹æ—¶é—´
        Args:
            data_size: æ•°æ®é›†å¤§å°
            model_size: æ¨¡å‹è§„æ¨¡ (base, large, xl)
        """</span>
        size_multipliers = {<span class="hljs-string">"base"</span>: <span class="hljs-number">1.0</span>, <span class="hljs-string">"large"</span>: <span class="hljs-number">2.5</span>, <span class="hljs-string">"xl"</span>: <span class="hljs-number">6.0</span>}
        
        base_times = {
            <span class="hljs-string">"æ•°æ®å‡†å¤‡"</span>: max(<span class="hljs-number">0.5</span>, data_size / <span class="hljs-number">10000</span>),  <span class="hljs-comment"># å°æ—¶</span>
            <span class="hljs-string">"æ¨¡å‹åŠ è½½"</span>: <span class="hljs-number">0.1</span> * size_multipliers[model_size],
            <span class="hljs-string">"è®­ç»ƒè¿‡ç¨‹"</span>: max(<span class="hljs-number">1.0</span>, data_size / <span class="hljs-number">1000</span>) * size_multipliers[model_size],
            <span class="hljs-string">"æ¨¡å‹è¯„ä¼°"</span>: <span class="hljs-number">0.2</span> * size_multipliers[model_size],
            <span class="hljs-string">"éƒ¨ç½²å‡†å¤‡"</span>: <span class="hljs-number">0.3</span>
        }
        
        print(<span class="hljs-string">f"\nâ±ï¸ æµç¨‹æ—¶é—´ä¼°ç®— (æ•°æ®é‡: <span class="hljs-subst">{data_size}</span>, æ¨¡å‹: <span class="hljs-subst">{model_size}</span>):"</span>)
        print(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
        
        total_time = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> stage, time_hours <span class="hljs-keyword">in</span> base_times.items():
            print(<span class="hljs-string">f"<span class="hljs-subst">{stage}</span>: <span class="hljs-subst">{time_hours:<span class="hljs-number">.1</span>f}</span> å°æ—¶"</span>)
            total_time += time_hours
        
        print(<span class="hljs-string">f"æ€»è®¡æ—¶é—´: <span class="hljs-subst">{total_time:<span class="hljs-number">.1</span>f}</span> å°æ—¶"</span>)
        
        <span class="hljs-keyword">return</span> total_time
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_checklist</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""åˆ›å»ºå¾®è°ƒæ£€æŸ¥æ¸…å•"""</span>
        checklist = {
            <span class="hljs-string">"æ•°æ®å‡†å¤‡"</span>: [
                <span class="hljs-string">"æ•°æ®è´¨é‡æ£€æŸ¥"</span>,
                <span class="hljs-string">"æ ‡æ³¨ä¸€è‡´æ€§éªŒè¯"</span>, 
                <span class="hljs-string">"æ•°æ®å¹³è¡¡æ€§åˆ†æ"</span>,
                <span class="hljs-string">"è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†åˆ’åˆ†"</span>
            ],
            <span class="hljs-string">"æ¨¡å‹é…ç½®"</span>: [
                <span class="hljs-string">"é€‰æ‹©åˆé€‚çš„é¢„è®­ç»ƒæ¨¡å‹"</span>,
                <span class="hljs-string">"è®¾è®¡ä»»åŠ¡ç‰¹å®šå±‚"</span>,
                <span class="hljs-string">"é…ç½®ä¼˜åŒ–å™¨å’Œå­¦ä¹ ç‡"</span>,
                <span class="hljs-string">"è®¾ç½®æ­£åˆ™åŒ–å‚æ•°"</span>
            ],
            <span class="hljs-string">"è®­ç»ƒç›‘æ§"</span>: [
                <span class="hljs-string">"æŸå¤±å‡½æ•°ç›‘æ§"</span>,
                <span class="hljs-string">"éªŒè¯é›†æ€§èƒ½è·Ÿè¸ª"</span>,
                <span class="hljs-string">"è¿‡æ‹Ÿåˆæ£€æµ‹"</span>,
                <span class="hljs-string">"æ—©åœæœºåˆ¶è®¾ç½®"</span>
            ],
            <span class="hljs-string">"æ¨¡å‹è¯„ä¼°"</span>: [
                <span class="hljs-string">"å¤šæŒ‡æ ‡ç»¼åˆè¯„ä¼°"</span>,
                <span class="hljs-string">"é”™è¯¯æ¡ˆä¾‹åˆ†æ"</span>,
                <span class="hljs-string">"æ¨¡å‹é²æ£’æ€§æµ‹è¯•"</span>,
                <span class="hljs-string">"æ•ˆç‡æ€§èƒ½æµ‹è¯•"</span>
            ],
            <span class="hljs-string">"éƒ¨ç½²å‡†å¤‡"</span>: [
                <span class="hljs-string">"æ¨¡å‹å‹ç¼©ä¼˜åŒ–"</span>,
                <span class="hljs-string">"æ¨ç†é€Ÿåº¦æµ‹è¯•"</span>,
                <span class="hljs-string">"å†…å­˜ä½¿ç”¨è¯„ä¼°"</span>,
                <span class="hljs-string">"å…¼å®¹æ€§æ£€æŸ¥"</span>
            ]
        }
        
        print(<span class="hljs-string">"\nğŸ“‹ å¾®è°ƒæ£€æŸ¥æ¸…å•:"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
        
        <span class="hljs-keyword">for</span> category, items <span class="hljs-keyword">in</span> checklist.items():
            print(<span class="hljs-string">f"\nğŸ¯ <span class="hljs-subst">{category}</span>:"</span>)
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:
                print(<span class="hljs-string">f"  â˜ <span class="hljs-subst">{item}</span>"</span>)
        
        <span class="hljs-keyword">return</span> checklist

<span class="hljs-comment"># æ¼”ç¤ºå¾®è°ƒæµç¨‹</span>
pipeline = FineTuningPipeline(<span class="hljs-string">"bert-base-chinese"</span>, <span class="hljs-string">"classification"</span>)
pipeline.visualize_pipeline()
pipeline.estimate_pipeline_time(<span class="hljs-number">10000</span>, <span class="hljs-string">"base"</span>)
pipeline.create_checklist()
</div></code></pre>
<h3 id="%F0%9F%8E%AF-%E5%BE%AE%E8%B0%83%E7%AD%96%E7%95%A5%E9%80%89%E6%8B%A9%E6%8C%87%E5%8D%97">ğŸ¯ å¾®è°ƒç­–ç•¥é€‰æ‹©æŒ‡å—</h3>
<p>é€‰æ‹©åˆé€‚çš„å¾®è°ƒç­–ç•¥å°±åƒé€‰æ‹©åˆé€‚çš„ç”Ÿäº§çº¿é…ç½®ï¼Œéœ€è¦è€ƒè™‘å¤šä¸ªå› ç´ ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StrategySelector</span>:</span>
    <span class="hljs-string">"""å¾®è°ƒç­–ç•¥é€‰æ‹©å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.decision_tree = {
            <span class="hljs-string">"data_size"</span>: {
                <span class="hljs-string">"small"</span>: <span class="hljs-string">"å‚æ•°é«˜æ•ˆå¾®è°ƒ"</span>,
                <span class="hljs-string">"medium"</span>: <span class="hljs-string">"éƒ¨åˆ†å¾®è°ƒ"</span>,
                <span class="hljs-string">"large"</span>: <span class="hljs-string">"å…¨å‚æ•°å¾®è°ƒ"</span>
            },
            <span class="hljs-string">"compute_budget"</span>: {
                <span class="hljs-string">"low"</span>: <span class="hljs-string">"LoRAæˆ–Adapter"</span>,
                <span class="hljs-string">"medium"</span>: <span class="hljs-string">"éƒ¨åˆ†å±‚å¾®è°ƒ"</span>,
                <span class="hljs-string">"high"</span>: <span class="hljs-string">"å…¨å‚æ•°å¾®è°ƒ"</span>
            },
            <span class="hljs-string">"task_similarity"</span>: {
                <span class="hljs-string">"high"</span>: <span class="hljs-string">"è½»é‡å¾®è°ƒ"</span>,
                <span class="hljs-string">"medium"</span>: <span class="hljs-string">"æ ‡å‡†å¾®è°ƒ"</span>, 
                <span class="hljs-string">"low"</span>: <span class="hljs-string">"æ·±åº¦å¾®è°ƒ"</span>
            }
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recommend_strategy</span><span class="hljs-params">(self, data_size, compute_budget, task_similarity)</span>:</span>
        <span class="hljs-string">"""
        æ¨èå¾®è°ƒç­–ç•¥
        Args:
            data_size: æ•°æ®è§„æ¨¡ (small/medium/large)
            compute_budget: è®¡ç®—é¢„ç®— (low/medium/high)
            task_similarity: ä¸é¢„è®­ç»ƒä»»åŠ¡ç›¸ä¼¼åº¦ (low/medium/high)
        """</span>
        print(<span class="hljs-string">"ğŸ¤– æ™ºèƒ½ç­–ç•¥æ¨èç³»ç»Ÿ"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">40</span>)
        print(<span class="hljs-string">f"æ•°æ®è§„æ¨¡: <span class="hljs-subst">{data_size}</span>"</span>)
        print(<span class="hljs-string">f"è®¡ç®—é¢„ç®—: <span class="hljs-subst">{compute_budget}</span>"</span>)
        print(<span class="hljs-string">f"ä»»åŠ¡ç›¸ä¼¼åº¦: <span class="hljs-subst">{task_similarity}</span>"</span>)
        print(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
        
        <span class="hljs-comment"># åŸºäºè§„åˆ™çš„æ¨è</span>
        <span class="hljs-keyword">if</span> data_size == <span class="hljs-string">"small"</span> <span class="hljs-keyword">or</span> compute_budget == <span class="hljs-string">"low"</span>:
            <span class="hljs-keyword">if</span> task_similarity == <span class="hljs-string">"high"</span>:
                recommendation = <span class="hljs-string">"Prompt Tuning"</span>
                confidence = <span class="hljs-number">0.9</span>
            <span class="hljs-keyword">else</span>:
                recommendation = <span class="hljs-string">"LoRA"</span>
                confidence = <span class="hljs-number">0.85</span>
        <span class="hljs-keyword">elif</span> data_size == <span class="hljs-string">"large"</span> <span class="hljs-keyword">and</span> compute_budget == <span class="hljs-string">"high"</span>:
            recommendation = <span class="hljs-string">"Full Fine-tuning"</span>
            confidence = <span class="hljs-number">0.95</span>
        <span class="hljs-keyword">else</span>:
            recommendation = <span class="hljs-string">"Adapter"</span>
            confidence = <span class="hljs-number">0.8</span>
        
        print(<span class="hljs-string">f"ğŸ¯ æ¨èç­–ç•¥: <span class="hljs-subst">{recommendation}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“Š ç½®ä¿¡åº¦: <span class="hljs-subst">{confidence:<span class="hljs-number">.1</span>%}</span>"</span>)
        
        <span class="hljs-comment"># æä¾›æ›¿ä»£æ–¹æ¡ˆ</span>
        alternatives = self._get_alternatives(recommendation)
        print(<span class="hljs-string">f"ğŸ”„ å¤‡é€‰æ–¹æ¡ˆ: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(alternatives)}</span>"</span>)
        
        <span class="hljs-keyword">return</span> recommendation, confidence
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_alternatives</span><span class="hljs-params">(self, primary)</span>:</span>
        <span class="hljs-string">"""è·å–æ›¿ä»£æ–¹æ¡ˆ"""</span>
        alternatives_map = {
            <span class="hljs-string">"Full Fine-tuning"</span>: [<span class="hljs-string">"LoRA"</span>, <span class="hljs-string">"Adapter"</span>],
            <span class="hljs-string">"LoRA"</span>: [<span class="hljs-string">"QLoRA"</span>, <span class="hljs-string">"Adapter"</span>],
            <span class="hljs-string">"Adapter"</span>: [<span class="hljs-string">"LoRA"</span>, <span class="hljs-string">"Prefix Tuning"</span>],
            <span class="hljs-string">"Prompt Tuning"</span>: [<span class="hljs-string">"P-tuning v2"</span>, <span class="hljs-string">"LoRA"</span>]
        }
        <span class="hljs-keyword">return</span> alternatives_map.get(primary, [<span class="hljs-string">"LoRA"</span>, <span class="hljs-string">"Adapter"</span>])

<span class="hljs-comment"># æ¼”ç¤ºç­–ç•¥é€‰æ‹©</span>
selector = StrategySelector()

<span class="hljs-comment"># ä¸åŒåœºæ™¯çš„ç­–ç•¥æ¨è</span>
scenarios = [
    (<span class="hljs-string">"small"</span>, <span class="hljs-string">"low"</span>, <span class="hljs-string">"high"</span>),      <span class="hljs-comment"># å°æ•°æ®ï¼Œä½é¢„ç®—ï¼Œé«˜ç›¸ä¼¼åº¦</span>
    (<span class="hljs-string">"large"</span>, <span class="hljs-string">"high"</span>, <span class="hljs-string">"low"</span>),      <span class="hljs-comment"># å¤§æ•°æ®ï¼Œé«˜é¢„ç®—ï¼Œä½ç›¸ä¼¼åº¦</span>
    (<span class="hljs-string">"medium"</span>, <span class="hljs-string">"medium"</span>, <span class="hljs-string">"medium"</span>) <span class="hljs-comment"># ä¸­ç­‰åœºæ™¯</span>
]

<span class="hljs-keyword">for</span> i, (data, budget, similarity) <span class="hljs-keyword">in</span> enumerate(scenarios, <span class="hljs-number">1</span>):
    print(<span class="hljs-string">f"\nğŸ“‹ åœºæ™¯ <span class="hljs-subst">{i}</span>:"</span>)
    selector.recommend_strategy(data, budget, similarity)
</div></code></pre>
<p>é€šè¿‡è¿™ä¸€èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ·±å…¥ç†è§£äº†æ¨¡å‹å¾®è°ƒçš„åŸºç¡€ç†è®ºã€‚å¾®è°ƒä¸ä»…ä»…æ˜¯ç®€å•çš„å‚æ•°æ›´æ–°ï¼Œè€Œæ˜¯ä¸€ä¸ªæ¶‰åŠçŸ¥è¯†è¿ç§»ã€ç­–ç•¥é€‰æ‹©å’Œæµç¨‹ç®¡ç†çš„å¤æ‚è¿‡ç¨‹ã€‚</p>
<p>åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯LoRAã€Adapterç­‰å‰æ²¿æ–¹æ³•ï¼Œè®©æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚èƒ½å¤Ÿæä¾›æ›´åŠ é«˜æ•ˆå’Œç»æµçš„å®šåˆ¶æ–¹æ¡ˆã€‚</p>
<hr>
<h2 id="282-%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83%E6%8A%80%E6%9C%AF">28.2 å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯</h2>
<h3 id="%F0%9F%9A%80-%E8%BF%9B%E5%85%A5%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83%E8%BD%A6%E9%97%B4">ğŸš€ è¿›å…¥é«˜æ•ˆå¾®è°ƒè½¦é—´</h3>
<p>åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼Œå‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯å°±åƒæ˜¯å¼•å…¥äº†é©å‘½æ€§çš„é«˜æ•ˆç”Ÿäº§çº¿ã€‚ä¼ ç»Ÿçš„å…¨å‚æ•°å¾®è°ƒå°±åƒæ˜¯é‡æ–°åˆ¶é€ æ•´ä¸ªäº§å“ï¼Œè€Œå‚æ•°é«˜æ•ˆå¾®è°ƒåˆ™åƒæ˜¯åªæ›´æ¢å…³é”®éƒ¨ä»¶ï¼Œæ—¢ä¿æŒäº†äº§å“çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œåˆå¤§å¹…é™ä½äº†æˆæœ¬å’Œæ—¶é—´ã€‚</p>
<p>è®©æˆ‘ä»¬æ·±å…¥è¿™ä¸ªé«˜æ•ˆè½¦é—´ï¼Œå­¦ä¹ æœ€å‰æ²¿çš„å¾®è°ƒæŠ€æœ¯ï¼</p>
<h4 id="%F0%9F%94%A7-lora%E4%BD%8E%E7%A7%A9%E9%80%82%E5%BA%94%E7%9A%84%E8%89%BA%E6%9C%AF">ğŸ”§ LoRAï¼šä½ç§©é€‚åº”çš„è‰ºæœ¯</h4>
<p><strong>LoRA (Low-Rank Adaptation)</strong> æ˜¯ç›®å‰æœ€å—æ¬¢è¿çš„å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯ä¹‹ä¸€ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå¤§å¤šæ•°æ¨¡å‹å‚æ•°çš„æ›´æ–°éƒ½å¯ä»¥ç”¨ä½ç§©çŸ©é˜µæ¥è¿‘ä¼¼ã€‚</p>
<pre><code class="language-mermaid"><div class="mermaid">graph LR
    subgraph "ä¼ ç»Ÿå¾®è°ƒ"
        A1[åŸå§‹æƒé‡W] --> B1[æ›´æ–°æ‰€æœ‰å‚æ•°]
        B1 --> C1[æ–°æƒé‡W']
    end
    
    subgraph "LoRAå¾®è°ƒ"
        A2[åŸå§‹æƒé‡W] --> B2[å†»ç»“ä¸å˜]
        D2[ä½ç§©çŸ©é˜µA] --> E2[Î”W = AB]
        F2[ä½ç§©çŸ©é˜µB] --> E2
        E2 --> G2[W' = W + Î”W]
        B2 --> G2
    end
    
    style A1 fill:#ffcdd2
    style C1 fill:#ffcdd2
    style A2 fill:#c8e6c9
    style G2 fill:#c8e6c9
    style E2 fill:#fff3e0
</div></code></pre>
<p>è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªå®Œæ•´çš„LoRAç³»ç»Ÿï¼š</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> math
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoRALayer</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-string">"""LoRAå±‚å®ç°"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(
        self, 
        in_features: int, 
        out_features: int, 
        rank: int = <span class="hljs-number">4</span>,
        alpha: float = <span class="hljs-number">1.0</span>,
        dropout: float = <span class="hljs-number">0.0</span>
    )</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–LoRAå±‚
        Args:
            in_features: è¾“å…¥ç‰¹å¾ç»´åº¦
            out_features: è¾“å‡ºç‰¹å¾ç»´åº¦  
            rank: ä½ç§©åˆ†è§£çš„ç§©
            alpha: ç¼©æ”¾å› å­
            dropout: dropoutæ¦‚ç‡
        """</span>
        super().__init__()
        
        self.rank = rank
        self.alpha = alpha
        self.scaling = alpha / rank
        
        <span class="hljs-comment"># LoRAçš„ä¸¤ä¸ªä½ç§©çŸ©é˜µ</span>
        self.lora_A = nn.Parameter(torch.randn(rank, in_features) * <span class="hljs-number">0.01</span>)
        self.lora_B = nn.Parameter(torch.zeros(out_features, rank))
        
        <span class="hljs-comment"># Dropoutå±‚</span>
        self.dropout = nn.Dropout(dropout) <span class="hljs-keyword">if</span> dropout &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> nn.Identity()
        
        print(<span class="hljs-string">f"âœ… åˆ›å»ºLoRAå±‚: <span class="hljs-subst">{in_features}</span>â†’<span class="hljs-subst">{out_features}</span>, rank=<span class="hljs-subst">{rank}</span>, Î±=<span class="hljs-subst">{alpha}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“Š å‚æ•°é‡: <span class="hljs-subst">{self.count_parameters():,}</span> (åŸå±‚å‚æ•°: <span class="hljs-subst">{in_features * out_features:,}</span>)"</span>)
        print(<span class="hljs-string">f"ğŸ“‰ å‚æ•°å‡å°‘: <span class="hljs-subst">{(<span class="hljs-number">1</span> - self.count_parameters() / (in_features * out_features)):<span class="hljs-number">.1</span>%}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">count_parameters</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""è®¡ç®—LoRAå±‚çš„å‚æ•°é‡"""</span>
        <span class="hljs-keyword">return</span> self.lora_A.numel() + self.lora_B.numel()
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, x)</span>:</span>
        <span class="hljs-string">"""å‰å‘ä¼ æ’­"""</span>
        <span class="hljs-comment"># LoRAçš„å‰å‘è®¡ç®—: x @ (A^T @ B^T) * scaling</span>
        lora_output = self.dropout(x) @ self.lora_A.T @ self.lora_B.T * self.scaling
        <span class="hljs-keyword">return</span> lora_output

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoRALinear</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-string">"""å¸¦LoRAçš„çº¿æ€§å±‚"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(
        self,
        original_layer: nn.Linear,
        rank: int = <span class="hljs-number">4</span>,
        alpha: float = <span class="hljs-number">1.0</span>,
        dropout: float = <span class="hljs-number">0.0</span>
    )</span>:</span>
        <span class="hljs-string">"""
        ä¸ºç°æœ‰çº¿æ€§å±‚æ·»åŠ LoRA
        Args:
            original_layer: åŸå§‹çº¿æ€§å±‚
            rank: LoRAçš„ç§©
            alpha: ç¼©æ”¾å› å­
            dropout: dropoutæ¦‚ç‡
        """</span>
        super().__init__()
        
        <span class="hljs-comment"># å†»ç»“åŸå§‹å±‚</span>
        self.original_layer = original_layer
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> self.original_layer.parameters():
            param.requires_grad = <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># æ·»åŠ LoRAå±‚</span>
        self.lora = LoRALayer(
            original_layer.in_features,
            original_layer.out_features,
            rank=rank,
            alpha=alpha,
            dropout=dropout
        )
        
        print(<span class="hljs-string">f"ğŸ”— ä¸ºçº¿æ€§å±‚æ·»åŠ LoRAé€‚é…å™¨"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, x)</span>:</span>
        <span class="hljs-string">"""å‰å‘ä¼ æ’­: åŸå§‹è¾“å‡º + LoRAè¾“å‡º"""</span>
        original_output = self.original_layer(x)
        lora_output = self.lora(x)
        <span class="hljs-keyword">return</span> original_output + lora_output

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoRATransformer</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-string">"""å¸¦LoRAçš„Transformeræ¨¡å‹"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, base_model, target_modules=None, rank=<span class="hljs-number">4</span>, alpha=<span class="hljs-number">1.0</span>)</span>:</span>
        <span class="hljs-string">"""
        ä¸ºTransformeræ¨¡å‹æ·»åŠ LoRA
        Args:
            base_model: åŸºç¡€æ¨¡å‹
            target_modules: ç›®æ ‡æ¨¡å—åç§°åˆ—è¡¨
            rank: LoRAç§©
            alpha: ç¼©æ”¾å› å­
        """</span>
        super().__init__()
        
        self.base_model = base_model
        self.rank = rank
        self.alpha = alpha
        
        <span class="hljs-comment"># é»˜è®¤ç›®æ ‡æ¨¡å—</span>
        <span class="hljs-keyword">if</span> target_modules <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            target_modules = [<span class="hljs-string">"query"</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>, <span class="hljs-string">"dense"</span>]
        
        <span class="hljs-comment"># æ·»åŠ LoRAå±‚</span>
        self.add_lora_layers(target_modules)
        
        print(<span class="hljs-string">f"ğŸ¯ ä¸ºæ¨¡å‹æ·»åŠ LoRAé€‚é…å™¨"</span>)
        print(<span class="hljs-string">f"ğŸ“Š æ€»å‚æ•°é‡: <span class="hljs-subst">{self.count_total_parameters():,}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ”§ å¯è®­ç»ƒå‚æ•°: <span class="hljs-subst">{self.count_trainable_parameters():,}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“‰ å¯è®­ç»ƒæ¯”ä¾‹: <span class="hljs-subst">{self.count_trainable_parameters() / self.count_total_parameters():<span class="hljs-number">.2</span>%}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_lora_layers</span><span class="hljs-params">(self, target_modules)</span>:</span>
        <span class="hljs-string">"""ä¸ºæŒ‡å®šæ¨¡å—æ·»åŠ LoRAå±‚"""</span>
        lora_count = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> name, module <span class="hljs-keyword">in</span> self.base_model.named_modules():
            <span class="hljs-keyword">if</span> isinstance(module, nn.Linear):
                <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡æ¨¡å—</span>
                should_add_lora = any(target <span class="hljs-keyword">in</span> name <span class="hljs-keyword">for</span> target <span class="hljs-keyword">in</span> target_modules)
                
                <span class="hljs-keyword">if</span> should_add_lora:
                    <span class="hljs-comment"># è·å–çˆ¶æ¨¡å—å’Œå±æ€§å</span>
                    parent_name = <span class="hljs-string">'.'</span>.join(name.split(<span class="hljs-string">'.'</span>)[:<span class="hljs-number">-1</span>])
                    attr_name = name.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">-1</span>]
                    
                    <span class="hljs-keyword">if</span> parent_name:
                        parent_module = self.base_model
                        <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> parent_name.split(<span class="hljs-string">'.'</span>):
                            parent_module = getattr(parent_module, part)
                    <span class="hljs-keyword">else</span>:
                        parent_module = self.base_model
                    
                    <span class="hljs-comment"># æ›¿æ¢ä¸ºLoRAå±‚</span>
                    lora_layer = LoRALinear(module, self.rank, self.alpha)
                    setattr(parent_module, attr_name, lora_layer)
                    lora_count += <span class="hljs-number">1</span>
        
        print(<span class="hljs-string">f"âœ… å·²æ·»åŠ  <span class="hljs-subst">{lora_count}</span> ä¸ªLoRAé€‚é…å™¨"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">count_total_parameters</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ç»Ÿè®¡æ€»å‚æ•°é‡"""</span>
        <span class="hljs-keyword">return</span> sum(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.parameters())
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">count_trainable_parameters</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ç»Ÿè®¡å¯è®­ç»ƒå‚æ•°é‡"""</span>
        <span class="hljs-keyword">return</span> sum(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.parameters() <span class="hljs-keyword">if</span> p.requires_grad)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, *args, **kwargs)</span>:</span>
        <span class="hljs-string">"""å‰å‘ä¼ æ’­"""</span>
        <span class="hljs-keyword">return</span> self.base_model(*args, **kwargs)

<span class="hljs-comment"># æ¼”ç¤ºLoRAçš„ä½¿ç”¨</span>
print(<span class="hljs-string">"ğŸ”§ LoRAæŠ€æœ¯æ¼”ç¤º"</span>)
print(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªç®€å•çš„çº¿æ€§å±‚</span>
original_layer = nn.Linear(<span class="hljs-number">768</span>, <span class="hljs-number">768</span>)
print(<span class="hljs-string">f"åŸå§‹å±‚å‚æ•°é‡: <span class="hljs-subst">{sum(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> original_layer.parameters()):,}</span>"</span>)

<span class="hljs-comment"># æ·»åŠ LoRA</span>
lora_layer = LoRALinear(original_layer, rank=<span class="hljs-number">8</span>, alpha=<span class="hljs-number">16.0</span>)

<span class="hljs-comment"># æµ‹è¯•è¾“å…¥</span>
test_input = torch.randn(<span class="hljs-number">32</span>, <span class="hljs-number">768</span>)  <span class="hljs-comment"># batch_size=32, hidden_size=768</span>

<span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    original_output = original_layer(test_input)
    lora_output = lora_layer(test_input)

print(<span class="hljs-string">f"\nğŸ“Š è¾“å‡ºå¯¹æ¯”:"</span>)
print(<span class="hljs-string">f"åŸå§‹è¾“å‡ºèŒƒå›´: [<span class="hljs-subst">{original_output.min():<span class="hljs-number">.3</span>f}</span>, <span class="hljs-subst">{original_output.max():<span class="hljs-number">.3</span>f}</span>]"</span>)
print(<span class="hljs-string">f"LoRAè¾“å‡ºèŒƒå›´: [<span class="hljs-subst">{lora_output.min():<span class="hljs-number">.3</span>f}</span>, <span class="hljs-subst">{lora_output.max():<span class="hljs-number">.3</span>f}</span>]"</span>)
print(<span class="hljs-string">f"è¾“å‡ºå·®å¼‚: <span class="hljs-subst">{(lora_output - original_output).abs().mean():<span class="hljs-number">.6</span>f}</span>"</span>)
</div></code></pre>
<h4 id="%F0%9F%94%8C-adapter%E5%8F%AF%E6%8F%92%E6%8B%94%E7%9A%84%E5%BE%AE%E8%B0%83%E6%A8%A1%E5%9D%97">ğŸ”Œ Adapterï¼šå¯æ’æ‹”çš„å¾®è°ƒæ¨¡å—</h4>
<p><strong>Adapter</strong> æŠ€æœ¯é€šè¿‡åœ¨æ¨¡å‹ä¸­æ’å…¥å°å‹çš„é€‚é…å™¨æ¨¡å—æ¥å®ç°å¾®è°ƒï¼Œå°±åƒåœ¨ç”Ÿäº§çº¿ä¸Šå®‰è£…å¯æ’æ‹”çš„åŠŸèƒ½æ¨¡å—ã€‚</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdapterLayer</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-string">"""Adapterå±‚å®ç°"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(
        self, 
        hidden_size: int, 
        adapter_size: int = <span class="hljs-number">64</span>,
        activation: str = <span class="hljs-string">"relu"</span>,
        dropout: float = <span class="hljs-number">0.1</span>
    )</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–Adapterå±‚
        Args:
            hidden_size: éšè—å±‚å¤§å°
            adapter_size: adapterçš„ä¸­é—´å±‚å¤§å°
            activation: æ¿€æ´»å‡½æ•°
            dropout: dropoutæ¦‚ç‡
        """</span>
        super().__init__()
        
        self.hidden_size = hidden_size
        self.adapter_size = adapter_size
        
        <span class="hljs-comment"># ä¸‹æŠ•å½±å±‚ (é™ç»´)</span>
        self.down_project = nn.Linear(hidden_size, adapter_size)
        
        <span class="hljs-comment"># æ¿€æ´»å‡½æ•°</span>
        <span class="hljs-keyword">if</span> activation == <span class="hljs-string">"relu"</span>:
            self.activation = nn.ReLU()
        <span class="hljs-keyword">elif</span> activation == <span class="hljs-string">"gelu"</span>:
            self.activation = nn.GELU()
        <span class="hljs-keyword">else</span>:
            self.activation = nn.Identity()
        
        <span class="hljs-comment"># ä¸ŠæŠ•å½±å±‚ (å‡ç»´)</span>
        self.up_project = nn.Linear(adapter_size, hidden_size)
        
        <span class="hljs-comment"># Dropout</span>
        self.dropout = nn.Dropout(dropout)
        
        <span class="hljs-comment"># åˆå§‹åŒ–æƒé‡</span>
        self._init_weights()
        
        print(<span class="hljs-string">f"ğŸ”Œ åˆ›å»ºAdapter: <span class="hljs-subst">{hidden_size}</span>â†’<span class="hljs-subst">{adapter_size}</span>â†’<span class="hljs-subst">{hidden_size}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“Š å‚æ•°é‡: <span class="hljs-subst">{self.count_parameters():,}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“‰ å‹ç¼©æ¯”: <span class="hljs-subst">{adapter_size / hidden_size:<span class="hljs-number">.1</span>%}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init_weights</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""åˆå§‹åŒ–æƒé‡"""</span>
        <span class="hljs-comment"># ä¸ŠæŠ•å½±å±‚åˆå§‹åŒ–ä¸ºæ¥è¿‘é›¶ï¼Œç¡®ä¿åˆå§‹æ—¶adapterå½±å“å¾ˆå°</span>
        nn.init.normal_(self.down_project.weight, std=<span class="hljs-number">0.02</span>)
        nn.init.zeros_(self.down_project.bias)
        nn.init.zeros_(self.up_project.weight)
        nn.init.zeros_(self.up_project.bias)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">count_parameters</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""è®¡ç®—å‚æ•°é‡"""</span>
        <span class="hljs-keyword">return</span> sum(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.parameters())
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, x)</span>:</span>
        <span class="hljs-string">"""
        å‰å‘ä¼ æ’­
        Args:
            x: è¾“å…¥å¼ é‡ [batch_size, seq_len, hidden_size]
        Returns:
            adapterè¾“å‡º [batch_size, seq_len, hidden_size]
        """</span>
        <span class="hljs-comment"># é™ç»´ â†’ æ¿€æ´» â†’ å‡ç»´</span>
        adapter_output = self.down_project(x)
        adapter_output = self.activation(adapter_output)
        adapter_output = self.dropout(adapter_output)
        adapter_output = self.up_project(adapter_output)
        
        <span class="hljs-keyword">return</span> adapter_output

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdapterTransformerLayer</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-string">"""å¸¦Adapterçš„Transformerå±‚"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, original_layer, adapter_size=<span class="hljs-number">64</span>)</span>:</span>
        <span class="hljs-string">"""
        ä¸ºTransformerå±‚æ·»åŠ Adapter
        Args:
            original_layer: åŸå§‹Transformerå±‚
            adapter_size: adapterå¤§å°
        """</span>
        super().__init__()
        
        <span class="hljs-comment"># å†»ç»“åŸå§‹å±‚</span>
        self.original_layer = original_layer
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> self.original_layer.parameters():
            param.requires_grad = <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># è·å–éšè—å±‚å¤§å°</span>
        hidden_size = self._get_hidden_size(original_layer)
        
        <span class="hljs-comment"># æ·»åŠ ä¸¤ä¸ªadapterï¼šä¸€ä¸ªåœ¨attentionåï¼Œä¸€ä¸ªåœ¨FFNå</span>
        self.adapter_after_attn = AdapterLayer(hidden_size, adapter_size)
        self.adapter_after_ffn = AdapterLayer(hidden_size, adapter_size)
        
        print(<span class="hljs-string">f"ğŸ”— ä¸ºTransformerå±‚æ·»åŠ Adapteré€‚é…å™¨"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_hidden_size</span><span class="hljs-params">(self, layer)</span>:</span>
        <span class="hljs-string">"""ä»å±‚ä¸­æ¨æ–­éšè—å±‚å¤§å°"""</span>
        <span class="hljs-comment"># è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ ¹æ®å…·ä½“æ¨¡å‹ç»“æ„æ¥ç¡®å®š</span>
        <span class="hljs-keyword">for</span> module <span class="hljs-keyword">in</span> layer.modules():
            <span class="hljs-keyword">if</span> isinstance(module, nn.Linear):
                <span class="hljs-keyword">return</span> module.in_features
        <span class="hljs-keyword">return</span> <span class="hljs-number">768</span>  <span class="hljs-comment"># é»˜è®¤å€¼</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, hidden_states, attention_mask=None, **kwargs)</span>:</span>
        <span class="hljs-string">"""å‰å‘ä¼ æ’­"""</span>
        <span class="hljs-comment"># åŸå§‹å±‚çš„å‰å‘ä¼ æ’­ (éœ€è¦æ ¹æ®å…·ä½“æ¨¡å‹è°ƒæ•´)</span>
        outputs = self.original_layer(hidden_states, attention_mask=attention_mask, **kwargs)
        
        <span class="hljs-keyword">if</span> isinstance(outputs, tuple):
            hidden_states = outputs[<span class="hljs-number">0</span>]
            other_outputs = outputs[<span class="hljs-number">1</span>:]
        <span class="hljs-keyword">else</span>:
            hidden_states = outputs
            other_outputs = ()
        
        <span class="hljs-comment"># æ·»åŠ adapterè¾“å‡º (æ®‹å·®è¿æ¥)</span>
        <span class="hljs-comment"># æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–äº†ï¼Œå®é™…éœ€è¦æ ¹æ®å…·ä½“çš„Transformerç»“æ„æ¥è°ƒæ•´</span>
        adapter_output = self.adapter_after_ffn(hidden_states)
        hidden_states = hidden_states + adapter_output
        
        <span class="hljs-keyword">return</span> (hidden_states,) + other_outputs <span class="hljs-keyword">if</span> other_outputs <span class="hljs-keyword">else</span> hidden_states

<span class="hljs-comment"># æ¼”ç¤ºAdapterçš„ä½¿ç”¨</span>
print(<span class="hljs-string">"\nğŸ”Œ AdapteræŠ€æœ¯æ¼”ç¤º"</span>)
print(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># åˆ›å»ºAdapterå±‚</span>
adapter = AdapterLayer(hidden_size=<span class="hljs-number">768</span>, adapter_size=<span class="hljs-number">64</span>)

<span class="hljs-comment"># æµ‹è¯•è¾“å…¥</span>
test_input = torch.randn(<span class="hljs-number">8</span>, <span class="hljs-number">128</span>, <span class="hljs-number">768</span>)  <span class="hljs-comment"># [batch, seq_len, hidden]</span>

<span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    adapter_output = adapter(test_input)

print(<span class="hljs-string">f"\nğŸ“Š Adapterè¾“å‡ºåˆ†æ:"</span>)
print(<span class="hljs-string">f"è¾“å…¥å½¢çŠ¶: <span class="hljs-subst">{test_input.shape}</span>"</span>)
print(<span class="hljs-string">f"è¾“å‡ºå½¢çŠ¶: <span class="hljs-subst">{adapter_output.shape}</span>"</span>)
print(<span class="hljs-string">f"è¾“å‡ºèŒƒå›´: [<span class="hljs-subst">{adapter_output.min():<span class="hljs-number">.6</span>f}</span>, <span class="hljs-subst">{adapter_output.max():<span class="hljs-number">.6</span>f}</span>]"</span>)
print(<span class="hljs-string">f"è¾“å‡ºå‡å€¼: <span class="hljs-subst">{adapter_output.mean():<span class="hljs-number">.6</span>f}</span>"</span>)
print(<span class="hljs-string">f"è¾“å‡ºæ ‡å‡†å·®: <span class="hljs-subst">{adapter_output.std():<span class="hljs-number">.6</span>f}</span>"</span>)
</div></code></pre>
<h4 id="%F0%9F%8E%AF-prefix-tuning%E6%99%BA%E8%83%BD%E5%89%8D%E7%BC%80%E5%AD%A6%E4%B9%A0">ğŸ¯ Prefix Tuningï¼šæ™ºèƒ½å‰ç¼€å­¦ä¹ </h4>
<p><strong>Prefix Tuning</strong> æ˜¯ä¸€ç§åªè®­ç»ƒè¾“å…¥å‰ç¼€çš„å¾®è°ƒæ–¹æ³•ï¼Œç‰¹åˆ«é€‚ç”¨äºç”Ÿæˆä»»åŠ¡ã€‚</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PrefixTuning</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-string">"""Prefix Tuningå®ç°"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(
        self,
        num_layers: int,
        num_heads: int,
        head_dim: int,
        prefix_length: int = <span class="hljs-number">10</span>,
        dropout: float = <span class="hljs-number">0.1</span>
    )</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–Prefix Tuning
        Args:
            num_layers: Transformerå±‚æ•°
            num_heads: æ³¨æ„åŠ›å¤´æ•°
            head_dim: æ¯ä¸ªå¤´çš„ç»´åº¦
            prefix_length: å‰ç¼€é•¿åº¦
            dropout: dropoutæ¦‚ç‡
        """</span>
        super().__init__()
        
        self.num_layers = num_layers
        self.num_heads = num_heads
        self.head_dim = head_dim
        self.prefix_length = prefix_length
        self.hidden_size = num_heads * head_dim
        
        <span class="hljs-comment"># å¯å­¦ä¹ çš„å‰ç¼€å‚æ•°</span>
        <span class="hljs-comment"># å½¢çŠ¶: [num_layers, 2, num_heads, prefix_length, head_dim]</span>
        <span class="hljs-comment"># 2è¡¨ç¤ºkeyå’Œvalue</span>
        self.prefix_embeddings = nn.Parameter(
            torch.randn(num_layers, <span class="hljs-number">2</span>, num_heads, prefix_length, head_dim) * <span class="hljs-number">0.02</span>
        )
        
        <span class="hljs-comment"># å¯é€‰çš„MLPæ¥ç”Ÿæˆå‰ç¼€</span>
        self.prefix_mlp = nn.Sequential(
            nn.Linear(self.hidden_size, self.hidden_size),
            nn.Tanh(),
            nn.Linear(self.hidden_size, num_layers * <span class="hljs-number">2</span> * num_heads * prefix_length * head_dim),
            nn.Dropout(dropout)
        )
        
        print(<span class="hljs-string">f"ğŸ¯ åˆ›å»ºPrefix Tuning:"</span>)
        print(<span class="hljs-string">f"ğŸ“Š å±‚æ•°: <span class="hljs-subst">{num_layers}</span>, å¤´æ•°: <span class="hljs-subst">{num_heads}</span>, å‰ç¼€é•¿åº¦: <span class="hljs-subst">{prefix_length}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ”¢ å‰ç¼€å‚æ•°é‡: <span class="hljs-subst">{self.prefix_embeddings.numel():,}</span>"</span>)
        
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_prefix_key_values</span><span class="hljs-params">(self, batch_size: int, device: torch.device)</span>:</span>
        <span class="hljs-string">"""
        è·å–å‰ç¼€çš„keyå’Œvalue
        Args:
            batch_size: æ‰¹æ¬¡å¤§å°
            device: è®¾å¤‡
        Returns:
            prefix_key_values: å‰ç¼€çš„keyå’Œvalueå¯¹
        """</span>
        <span class="hljs-comment"># æ‰©å±•åˆ°æ‰¹æ¬¡ç»´åº¦</span>
        prefix_key_values = self.prefix_embeddings.unsqueeze(<span class="hljs-number">0</span>).expand(
            batch_size, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>
        )
        
        <span class="hljs-comment"># é‡æ–°æ•´å½¢ä¸ºé€‚åˆattentionçš„æ ¼å¼</span>
        <span class="hljs-comment"># [batch, num_layers, 2, num_heads, prefix_length, head_dim]</span>
        <span class="hljs-keyword">return</span> prefix_key_values.to(device)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, batch_size: int, device: torch.device)</span>:</span>
        <span class="hljs-string">"""å‰å‘ä¼ æ’­"""</span>
        <span class="hljs-keyword">return</span> self.get_prefix_key_values(batch_size, device)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PrefixAttention</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-string">"""å¸¦å‰ç¼€çš„æ³¨æ„åŠ›å±‚"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, original_attention, prefix_tuning: PrefixTuning, layer_idx: int)</span>:</span>
        <span class="hljs-string">"""
        ä¸ºæ³¨æ„åŠ›å±‚æ·»åŠ å‰ç¼€
        Args:
            original_attention: åŸå§‹æ³¨æ„åŠ›å±‚
            prefix_tuning: å‰ç¼€è°ƒä¼˜æ¨¡å—
            layer_idx: å±‚ç´¢å¼•
        """</span>
        super().__init__()
        
        self.original_attention = original_attention
        self.prefix_tuning = prefix_tuning
        self.layer_idx = layer_idx
        
        <span class="hljs-comment"># å†»ç»“åŸå§‹æ³¨æ„åŠ›å±‚</span>
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> self.original_attention.parameters():
            param.requires_grad = <span class="hljs-literal">False</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, hidden_states, attention_mask=None, **kwargs)</span>:</span>
        <span class="hljs-string">"""å‰å‘ä¼ æ’­"""</span>
        batch_size = hidden_states.size(<span class="hljs-number">0</span>)
        device = hidden_states.device
        
        <span class="hljs-comment"># è·å–å‰ç¼€key-value</span>
        prefix_kv = self.prefix_tuning(batch_size, device)
        prefix_key = prefix_kv[:, self.layer_idx, <span class="hljs-number">0</span>]  <span class="hljs-comment"># [batch, num_heads, prefix_len, head_dim]</span>
        prefix_value = prefix_kv[:, self.layer_idx, <span class="hljs-number">1</span>]
        
        <span class="hljs-comment"># åŸå§‹æ³¨æ„åŠ›è®¡ç®— (è¿™é‡Œç®€åŒ–ï¼Œå®é™…éœ€è¦æ ¹æ®å…·ä½“æ¨¡å‹è°ƒæ•´)</span>
        outputs = self.original_attention(hidden_states, attention_mask=attention_mask, **kwargs)
        
        <span class="hljs-comment"># å°†å‰ç¼€key-valueä¸åŸå§‹key-valueè¿æ¥</span>
        <span class="hljs-comment"># è¿™é‡Œéœ€è¦æ ¹æ®å…·ä½“çš„æ³¨æ„åŠ›å®ç°æ¥è°ƒæ•´</span>
        
        <span class="hljs-keyword">return</span> outputs

<span class="hljs-comment"># æ¼”ç¤ºPrefix Tuning</span>
print(<span class="hljs-string">"\nğŸ¯ Prefix Tuningæ¼”ç¤º"</span>)
print(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># åˆ›å»ºPrefix Tuning</span>
prefix_tuning = PrefixTuning(
    num_layers=<span class="hljs-number">12</span>,
    num_heads=<span class="hljs-number">12</span>, 
    head_dim=<span class="hljs-number">64</span>,
    prefix_length=<span class="hljs-number">10</span>
)

<span class="hljs-comment"># æµ‹è¯•</span>
batch_size = <span class="hljs-number">4</span>
device = torch.device(<span class="hljs-string">'cpu'</span>)

<span class="hljs-keyword">with</span> torch.no_grad():
    prefix_kv = prefix_tuning(batch_size, device)

print(<span class="hljs-string">f"\nğŸ“Š å‰ç¼€Key-Valueåˆ†æ:"</span>)
print(<span class="hljs-string">f"å‰ç¼€KVå½¢çŠ¶: <span class="hljs-subst">{prefix_kv.shape}</span>"</span>)
print(<span class="hljs-string">f"å‰ç¼€å‚æ•°é‡: <span class="hljs-subst">{prefix_tuning.prefix_embeddings.numel():,}</span>"</span>)
print(<span class="hljs-string">f"KeyèŒƒå›´: [<span class="hljs-subst">{prefix_kv[:, :, <span class="hljs-number">0</span>].min():<span class="hljs-number">.3</span>f}</span>, <span class="hljs-subst">{prefix_kv[:, :, <span class="hljs-number">0</span>].max():<span class="hljs-number">.3</span>f}</span>]"</span>)
print(<span class="hljs-string">f"ValueèŒƒå›´: [<span class="hljs-subst">{prefix_kv[:, :, <span class="hljs-number">1</span>].min():<span class="hljs-number">.3</span>f}</span>, <span class="hljs-subst">{prefix_kv[:, :, <span class="hljs-number">1</span>].max():<span class="hljs-number">.3</span>f}</span>]"</span>)
</div></code></pre>
<h4 id="%F0%9F%93%8A-%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94">ğŸ“Š å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯å¯¹æ¯”</h4>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå…¨é¢çš„å¯¹æ¯”åˆ†æç³»ç»Ÿï¼š</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParameterEfficientComparison</span>:</span>
    <span class="hljs-string">"""å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯å¯¹æ¯”åˆ†æ"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.methods = {
            <span class="hljs-string">"LoRA"</span>: {
                <span class="hljs-string">"å‚æ•°é‡"</span>: <span class="hljs-string">"æå°‘ (0.1-1%)"</span>,
                <span class="hljs-string">"è®­ç»ƒé€Ÿåº¦"</span>: <span class="hljs-string">"å¿«"</span>,
                <span class="hljs-string">"æ¨ç†é€Ÿåº¦"</span>: <span class="hljs-string">"å‡ ä¹æ— å½±å“"</span>,
                <span class="hljs-string">"å†…å­˜éœ€æ±‚"</span>: <span class="hljs-string">"ä½"</span>,
                <span class="hljs-string">"æ•ˆæœ"</span>: <span class="hljs-string">"ä¼˜ç§€"</span>,
                <span class="hljs-string">"é€‚ç”¨åœºæ™¯"</span>: <span class="hljs-string">"é€šç”¨å¾®è°ƒ"</span>,
                <span class="hljs-string">"ä¼˜åŠ¿"</span>: [<span class="hljs-string">"å‚æ•°æå°‘"</span>, <span class="hljs-string">"è®­ç»ƒå¿«é€Ÿ"</span>, <span class="hljs-string">"æ•ˆæœå¥½"</span>],
                <span class="hljs-string">"åŠ£åŠ¿"</span>: [<span class="hljs-string">"éœ€è¦è°ƒæ•´ç§©"</span>, <span class="hljs-string">"ç†è®ºåŸºç¡€æœ‰é™"</span>]
            },
            <span class="hljs-string">"Adapter"</span>: {
                <span class="hljs-string">"å‚æ•°é‡"</span>: <span class="hljs-string">"å°‘ (1-5%)"</span>,
                <span class="hljs-string">"è®­ç»ƒé€Ÿåº¦"</span>: <span class="hljs-string">"ä¸­ç­‰"</span>,
                <span class="hljs-string">"æ¨ç†é€Ÿåº¦"</span>: <span class="hljs-string">"è½»å¾®å½±å“"</span>,
                <span class="hljs-string">"å†…å­˜éœ€æ±‚"</span>: <span class="hljs-string">"ä¸­ç­‰"</span>,
                <span class="hljs-string">"æ•ˆæœ"</span>: <span class="hljs-string">"è‰¯å¥½"</span>,
                <span class="hljs-string">"é€‚ç”¨åœºæ™¯"</span>: <span class="hljs-string">"å¤šä»»åŠ¡å­¦ä¹ "</span>,
                <span class="hljs-string">"ä¼˜åŠ¿"</span>: [<span class="hljs-string">"æ¨¡å—åŒ–"</span>, <span class="hljs-string">"å¯æ’æ‹”"</span>, <span class="hljs-string">"ç¨³å®š"</span>],
                <span class="hljs-string">"åŠ£åŠ¿"</span>: [<span class="hljs-string">"æ¨ç†å»¶è¿Ÿ"</span>, <span class="hljs-string">"å‚æ•°ç¨å¤š"</span>]
            },
            <span class="hljs-string">"Prefix Tuning"</span>: {
                <span class="hljs-string">"å‚æ•°é‡"</span>: <span class="hljs-string">"æå°‘ (0.01-0.1%)"</span>,
                <span class="hljs-string">"è®­ç»ƒé€Ÿåº¦"</span>: <span class="hljs-string">"å¾ˆå¿«"</span>,
                <span class="hljs-string">"æ¨ç†é€Ÿåº¦"</span>: <span class="hljs-string">"æ— å½±å“"</span>,
                <span class="hljs-string">"å†…å­˜éœ€æ±‚"</span>: <span class="hljs-string">"æä½"</span>,
                <span class="hljs-string">"æ•ˆæœ"</span>: <span class="hljs-string">"ä¸­ç­‰"</span>,
                <span class="hljs-string">"é€‚ç”¨åœºæ™¯"</span>: <span class="hljs-string">"ç”Ÿæˆä»»åŠ¡"</span>,
                <span class="hljs-string">"ä¼˜åŠ¿"</span>: [<span class="hljs-string">"å‚æ•°æœ€å°‘"</span>, <span class="hljs-string">"ä¸æ”¹ç»“æ„"</span>],
                <span class="hljs-string">"åŠ£åŠ¿"</span>: [<span class="hljs-string">"æ•ˆæœæœ‰é™"</span>, <span class="hljs-string">"é€‚ç”¨é¢çª„"</span>]
            },
            <span class="hljs-string">"Full Fine-tuning"</span>: {
                <span class="hljs-string">"å‚æ•°é‡"</span>: <span class="hljs-string">"å…¨éƒ¨ (100%)"</span>,
                <span class="hljs-string">"è®­ç»ƒé€Ÿåº¦"</span>: <span class="hljs-string">"æ…¢"</span>,
                <span class="hljs-string">"æ¨ç†é€Ÿåº¦"</span>: <span class="hljs-string">"æ— å½±å“"</span>,
                <span class="hljs-string">"å†…å­˜éœ€æ±‚"</span>: <span class="hljs-string">"é«˜"</span>,
                <span class="hljs-string">"æ•ˆæœ"</span>: <span class="hljs-string">"æœ€ä½³"</span>,
                <span class="hljs-string">"é€‚ç”¨åœºæ™¯"</span>: <span class="hljs-string">"èµ„æºå……è¶³"</span>,
                <span class="hljs-string">"ä¼˜åŠ¿"</span>: [<span class="hljs-string">"æ•ˆæœæœ€å¥½"</span>, <span class="hljs-string">"é€‚åº”æ€§å¼º"</span>],
                <span class="hljs-string">"åŠ£åŠ¿"</span>: [<span class="hljs-string">"æˆæœ¬é«˜"</span>, <span class="hljs-string">"æ˜“è¿‡æ‹Ÿåˆ"</span>]
            }
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_comparison_table</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""åˆ›å»ºå¯¹æ¯”è¡¨æ ¼"""</span>
        print(<span class="hljs-string">"ğŸ“Š å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯å¯¹æ¯”"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">100</span>)
        
        <span class="hljs-comment"># è¡¨å¤´</span>
        headers = [<span class="hljs-string">"æ–¹æ³•"</span>, <span class="hljs-string">"å‚æ•°é‡"</span>, <span class="hljs-string">"è®­ç»ƒé€Ÿåº¦"</span>, <span class="hljs-string">"æ¨ç†é€Ÿåº¦"</span>, <span class="hljs-string">"å†…å­˜éœ€æ±‚"</span>, <span class="hljs-string">"æ•ˆæœ"</span>, <span class="hljs-string">"é€‚ç”¨åœºæ™¯"</span>]
        print(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'æ–¹æ³•'</span>:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'å‚æ•°é‡'</span>:&lt;<span class="hljs-number">12</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'è®­ç»ƒé€Ÿåº¦'</span>:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'æ¨ç†é€Ÿåº¦'</span>:&lt;<span class="hljs-number">12</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'å†…å­˜éœ€æ±‚'</span>:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'æ•ˆæœ'</span>:&lt;<span class="hljs-number">8</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'é€‚ç”¨åœºæ™¯'</span>:&lt;<span class="hljs-number">15</span>}</span>"</span>)
        print(<span class="hljs-string">"-"</span> * <span class="hljs-number">100</span>)
        
        <span class="hljs-comment"># æ•°æ®è¡Œ</span>
        <span class="hljs-keyword">for</span> method, props <span class="hljs-keyword">in</span> self.methods.items():
            print(<span class="hljs-string">f"<span class="hljs-subst">{method:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{props[<span class="hljs-string">'å‚æ•°é‡'</span>]:&lt;<span class="hljs-number">12</span>}</span> <span class="hljs-subst">{props[<span class="hljs-string">'è®­ç»ƒé€Ÿåº¦'</span>]:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{props[<span class="hljs-string">'æ¨ç†é€Ÿåº¦'</span>]:&lt;<span class="hljs-number">12</span>}</span> <span class="hljs-subst">{props[<span class="hljs-string">'å†…å­˜éœ€æ±‚'</span>]:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{props[<span class="hljs-string">'æ•ˆæœ'</span>]:&lt;<span class="hljs-number">8</span>}</span> <span class="hljs-subst">{props[<span class="hljs-string">'é€‚ç”¨åœºæ™¯'</span>]:&lt;<span class="hljs-number">15</span>}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_efficiency_comparison</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–æ•ˆç‡å¯¹æ¯”"""</span>
        <span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
        <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
        
        methods = list(self.methods.keys())
        
        <span class="hljs-comment"># æ¨¡æ‹Ÿæ•°æ® (å½’ä¸€åŒ–åˆ†æ•°)</span>
        efficiency_scores = {
            <span class="hljs-string">"å‚æ•°æ•ˆç‡"</span>: [<span class="hljs-number">0.95</span>, <span class="hljs-number">0.85</span>, <span class="hljs-number">0.98</span>, <span class="hljs-number">0.1</span>],    <span class="hljs-comment"># LoRA, Adapter, Prefix, Full</span>
            <span class="hljs-string">"è®­ç»ƒé€Ÿåº¦"</span>: [<span class="hljs-number">0.9</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.95</span>, <span class="hljs-number">0.3</span>],
            <span class="hljs-string">"æ¨ç†é€Ÿåº¦"</span>: [<span class="hljs-number">0.95</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>],
            <span class="hljs-string">"æ•ˆæœè´¨é‡"</span>: [<span class="hljs-number">0.9</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">1.0</span>]
        }
        
        <span class="hljs-comment"># åˆ›å»ºé›·è¾¾å›¾</span>
        angles = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">2</span> * np.pi, len(efficiency_scores), endpoint=<span class="hljs-literal">False</span>)
        angles = np.concatenate((angles, [angles[<span class="hljs-number">0</span>]]))  <span class="hljs-comment"># é—­åˆ</span>
        
        fig, ax = plt.subplots(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>), subplot_kw=dict(projection=<span class="hljs-string">'polar'</span>))
        
        colors = [<span class="hljs-string">'#FF6B6B'</span>, <span class="hljs-string">'#4ECDC4'</span>, <span class="hljs-string">'#45B7D1'</span>, <span class="hljs-string">'#96CEB4'</span>]
        
        <span class="hljs-keyword">for</span> i, method <span class="hljs-keyword">in</span> enumerate(methods):
            values = [efficiency_scores[metric][i] <span class="hljs-keyword">for</span> metric <span class="hljs-keyword">in</span> efficiency_scores.keys()]
            values += [values[<span class="hljs-number">0</span>]]  <span class="hljs-comment"># é—­åˆ</span>
            
            ax.plot(angles, values, <span class="hljs-string">'o-'</span>, linewidth=<span class="hljs-number">2</span>, label=method, color=colors[i])
            ax.fill(angles, values, alpha=<span class="hljs-number">0.25</span>, color=colors[i])
        
        <span class="hljs-comment"># è®¾ç½®æ ‡ç­¾</span>
        ax.set_xticks(angles[:<span class="hljs-number">-1</span>])
        ax.set_xticklabels(efficiency_scores.keys())
        ax.set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        ax.legend(loc=<span class="hljs-string">'upper right'</span>, bbox_to_anchor=(<span class="hljs-number">1.2</span>, <span class="hljs-number">1.0</span>))
        ax.set_title(<span class="hljs-string">'å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯ç»¼åˆå¯¹æ¯”'</span>, size=<span class="hljs-number">16</span>, pad=<span class="hljs-number">20</span>)
        
        plt.tight_layout()
        plt.show()
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recommend_method</span><span class="hljs-params">(self, scenario)</span>:</span>
        <span class="hljs-string">"""æ ¹æ®åœºæ™¯æ¨èæ–¹æ³•"""</span>
        recommendations = {
            <span class="hljs-string">"èµ„æºå—é™"</span>: <span class="hljs-string">"LoRA"</span>,
            <span class="hljs-string">"å¤šä»»åŠ¡å­¦ä¹ "</span>: <span class="hljs-string">"Adapter"</span>, 
            <span class="hljs-string">"ç”Ÿæˆä»»åŠ¡"</span>: <span class="hljs-string">"Prefix Tuning"</span>,
            <span class="hljs-string">"è¿½æ±‚æœ€ä½³æ•ˆæœ"</span>: <span class="hljs-string">"Full Fine-tuning"</span>,
            <span class="hljs-string">"å¿«é€ŸåŸå‹"</span>: <span class="hljs-string">"LoRA"</span>,
            <span class="hljs-string">"ç”Ÿäº§éƒ¨ç½²"</span>: <span class="hljs-string">"LoRA"</span>,
            <span class="hljs-string">"ç ”ç©¶å®éªŒ"</span>: <span class="hljs-string">"Full Fine-tuning"</span>
        }
        
        method = recommendations.get(scenario, <span class="hljs-string">"LoRA"</span>)
        details = self.methods[method]
        
        print(<span class="hljs-string">f"\nğŸ¯ åœºæ™¯: <span class="hljs-subst">{scenario}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ’¡ æ¨èæ–¹æ³•: <span class="hljs-subst">{method}</span>"</span>)
        print(<span class="hljs-string">f"âœ… ä¼˜åŠ¿: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(details[<span class="hljs-string">'ä¼˜åŠ¿'</span>])}</span>"</span>)
        print(<span class="hljs-string">f"âš ï¸ æ³¨æ„: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(details[<span class="hljs-string">'åŠ£åŠ¿'</span>])}</span>"</span>)
        
        <span class="hljs-keyword">return</span> method

<span class="hljs-comment"># æ¼”ç¤ºå¯¹æ¯”åˆ†æ</span>
comparison = ParameterEfficientComparison()
comparison.create_comparison_table()
comparison.visualize_efficiency_comparison()

<span class="hljs-comment"># åœºæ™¯æ¨è</span>
scenarios = [<span class="hljs-string">"èµ„æºå—é™"</span>, <span class="hljs-string">"å¤šä»»åŠ¡å­¦ä¹ "</span>, <span class="hljs-string">"ç”Ÿæˆä»»åŠ¡"</span>, <span class="hljs-string">"è¿½æ±‚æœ€ä½³æ•ˆæœ"</span>]
<span class="hljs-keyword">for</span> scenario <span class="hljs-keyword">in</span> scenarios:
    comparison.recommend_method(scenario)
</div></code></pre>
<p>é€šè¿‡è¿™ä¸€èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ·±å…¥æŒæ¡äº†å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯çš„æ ¸å¿ƒåŸç†å’Œå®é™…åº”ç”¨ã€‚è¿™äº›æŠ€æœ¯è®©æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚èƒ½å¤Ÿä»¥æ›´ä½çš„æˆæœ¬å’Œæ›´é«˜çš„æ•ˆç‡ç”Ÿäº§å‡ºé«˜è´¨é‡çš„å®šåˆ¶åŒ–æ¨¡å‹ã€‚</p>
<p>åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ æ•°æ®å·¥ç¨‹ä¸é¢„å¤„ç†æŠ€æœ¯ï¼Œè¿™æ˜¯ç¡®ä¿å¾®è°ƒæ•ˆæœçš„é‡è¦åŸºç¡€ã€‚</p>
<hr>
<h2 id="283-%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E9%A2%84%E5%A4%84%E7%90%86">28.3 æ•°æ®å·¥ç¨‹ä¸é¢„å¤„ç†</h2>
<h3 id="%F0%9F%8F%97%EF%B8%8F-%E8%BF%9B%E5%85%A5%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E8%BD%A6%E9%97%B4">ğŸ—ï¸ è¿›å…¥æ•°æ®å·¥ç¨‹è½¦é—´</h3>
<p>åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼Œæ•°æ®å·¥ç¨‹ä¸é¢„å¤„ç†å°±åƒæ˜¯åŸææ–™çš„ç²¾ç»†åŠ å·¥è½¦é—´ã€‚é«˜è´¨é‡çš„æ•°æ®æ˜¯æˆåŠŸå¾®è°ƒçš„åŸºç¡€ï¼Œå°±åƒä¼˜è´¨çš„åŸææ–™æ˜¯ç”Ÿäº§ç²¾å“çš„å‰æã€‚</p>
<p>è®©æˆ‘ä»¬æ·±å…¥è¿™ä¸ªæ•°æ®å·¥ç¨‹è½¦é—´ï¼Œå­¦ä¹ å¦‚ä½•å°†åŸå§‹æ•°æ®è½¬åŒ–ä¸ºè®­ç»ƒå°±ç»ªçš„é«˜è´¨é‡æ•°æ®é›†ï¼</p>
<h4 id="%F0%9F%93%8A-%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%9E%B6%E6%9E%84">ğŸ“Š æ•°æ®å·¥ç¨‹æµæ°´çº¿æ¶æ„</h4>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬é€šè¿‡Mermaidå›¾äº†è§£å®Œæ•´çš„æ•°æ®å·¥ç¨‹æµæ°´çº¿ï¼š</p>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    A[åŸå§‹æ•°æ®æº] --> B{æ•°æ®ç±»å‹æ£€æµ‹}
    B -->|æ–‡æœ¬æ•°æ®| C[æ–‡æœ¬é¢„å¤„ç†]
    B -->|ç»“æ„åŒ–æ•°æ®| D[æ•°æ®æ¸…æ´—]
    B -->|å¤šæ¨¡æ€æ•°æ®| E[å¤šæ¨¡æ€å¤„ç†]
    
    C --> F[æ•°æ®è´¨é‡è¯„ä¼°]
    D --> F
    E --> F
    
    F --> G{è´¨é‡è¾¾æ ‡?}
    G -->|å¦| H[æ•°æ®ä¿®å¤]
    H --> F
    G -->|æ˜¯| I[æ•°æ®å¢å¼º]
    
    I --> J[æ•°æ®åˆ’åˆ†]
    J --> K[è®­ç»ƒé›†]
    J --> L[éªŒè¯é›†]
    J --> M[æµ‹è¯•é›†]
    
    K --> N[æ•°æ®åŠ è½½å™¨]
    L --> N
    M --> N
    
    N --> O[æ‰¹å¤„ç†ä¼˜åŒ–]
    O --> P[å¾®è°ƒå°±ç»ªæ•°æ®]
    
    style A fill:#e1f5fe
    style P fill:#e8f5e8
    style G fill:#fff3e0
    style F fill:#f3e5f5
</div></code></pre>
<p>è®©æˆ‘ä»¬å®ç°è¿™ä¸ªå®Œæ•´çš„æ•°æ®å·¥ç¨‹ç³»ç»Ÿï¼š</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset, DataLoader, random_split
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Dict, Tuple, Optional, Union
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> LabelEncoder
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter
<span class="hljs-keyword">import</span> warnings
warnings.filterwarnings(<span class="hljs-string">'ignore'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataQualityAnalyzer</span>:</span>
    <span class="hljs-string">"""æ•°æ®è´¨é‡åˆ†æå™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.quality_metrics = {}
        self.recommendations = []
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze_text_quality</span><span class="hljs-params">(self, texts: List[str])</span> -&gt; Dict:</span>
        <span class="hljs-string">"""
        åˆ†ææ–‡æœ¬æ•°æ®è´¨é‡
        Args:
            texts: æ–‡æœ¬åˆ—è¡¨
        Returns:
            è´¨é‡åˆ†ææŠ¥å‘Š
        """</span>
        print(<span class="hljs-string">"ğŸ” å¼€å§‹æ–‡æœ¬è´¨é‡åˆ†æ..."</span>)
        
        <span class="hljs-comment"># åŸºç¡€ç»Ÿè®¡</span>
        total_samples = len(texts)
        empty_texts = sum(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> texts <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> text <span class="hljs-keyword">or</span> text.strip() == <span class="hljs-string">""</span>)
        avg_length = np.mean([len(text) <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> texts <span class="hljs-keyword">if</span> text])
        std_length = np.std([len(text) <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> texts <span class="hljs-keyword">if</span> text])
        
        <span class="hljs-comment"># å­—ç¬¦åˆ†æ</span>
        char_counts = Counter()
        <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> texts:
            <span class="hljs-keyword">if</span> text:
                char_counts.update(text)
        
        <span class="hljs-comment"># è¯­è¨€æ£€æµ‹ï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
        chinese_chars = sum(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> char_counts <span class="hljs-keyword">if</span> <span class="hljs-string">'\u4e00'</span> &lt;= char &lt;= <span class="hljs-string">'\u9fff'</span>)
        english_chars = sum(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> char_counts <span class="hljs-keyword">if</span> char.isalpha() <span class="hljs-keyword">and</span> ord(char) &lt; <span class="hljs-number">128</span>)
        
        <span class="hljs-comment"># ç‰¹æ®Šå­—ç¬¦æ£€æµ‹</span>
        special_chars = sum(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> char_counts <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> char.isalnum() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> char.isspace())
        
        quality_report = {
            <span class="hljs-string">"æ ·æœ¬æ€»æ•°"</span>: total_samples,
            <span class="hljs-string">"ç©ºæ–‡æœ¬æ•°"</span>: empty_texts,
            <span class="hljs-string">"ç©ºæ–‡æœ¬æ¯”ä¾‹"</span>: empty_texts / total_samples <span class="hljs-keyword">if</span> total_samples &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">"å¹³å‡é•¿åº¦"</span>: round(avg_length, <span class="hljs-number">2</span>),
            <span class="hljs-string">"é•¿åº¦æ ‡å‡†å·®"</span>: round(std_length, <span class="hljs-number">2</span>),
            <span class="hljs-string">"ä¸­æ–‡å­—ç¬¦æ•°"</span>: chinese_chars,
            <span class="hljs-string">"è‹±æ–‡å­—ç¬¦æ•°"</span>: english_chars,
            <span class="hljs-string">"ç‰¹æ®Šå­—ç¬¦æ•°"</span>: special_chars,
            <span class="hljs-string">"å­—ç¬¦å¤šæ ·æ€§"</span>: len(char_counts)
        }
        
        <span class="hljs-comment"># è´¨é‡è¯„åˆ†</span>
        quality_score = self._calculate_quality_score(quality_report)
        quality_report[<span class="hljs-string">"è´¨é‡è¯„åˆ†"</span>] = quality_score
        
        <span class="hljs-comment"># ç”Ÿæˆå»ºè®®</span>
        self._generate_recommendations(quality_report)
        
        print(<span class="hljs-string">f"âœ… æ–‡æœ¬è´¨é‡åˆ†æå®Œæˆï¼Œè´¨é‡è¯„åˆ†: <span class="hljs-subst">{quality_score:<span class="hljs-number">.1</span>f}</span>/100"</span>)
        <span class="hljs-keyword">return</span> quality_report
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_calculate_quality_score</span><span class="hljs-params">(self, report: Dict)</span> -&gt; float:</span>
        <span class="hljs-string">"""è®¡ç®—è´¨é‡è¯„åˆ†"""</span>
        score = <span class="hljs-number">100.0</span>
        
        <span class="hljs-comment"># ç©ºæ–‡æœ¬æƒ©ç½š</span>
        <span class="hljs-keyword">if</span> report[<span class="hljs-string">"ç©ºæ–‡æœ¬æ¯”ä¾‹"</span>] &gt; <span class="hljs-number">0.1</span>:
            score -= <span class="hljs-number">20</span> * report[<span class="hljs-string">"ç©ºæ–‡æœ¬æ¯”ä¾‹"</span>]
        
        <span class="hljs-comment"># é•¿åº¦ä¸€è‡´æ€§è¯„åˆ†</span>
        <span class="hljs-keyword">if</span> report[<span class="hljs-string">"é•¿åº¦æ ‡å‡†å·®"</span>] &gt; report[<span class="hljs-string">"å¹³å‡é•¿åº¦"</span>]:
            score -= <span class="hljs-number">15</span>
        
        <span class="hljs-comment"># å­—ç¬¦å¤šæ ·æ€§è¯„åˆ†</span>
        <span class="hljs-keyword">if</span> report[<span class="hljs-string">"å­—ç¬¦å¤šæ ·æ€§"</span>] &lt; <span class="hljs-number">100</span>:
            score -= <span class="hljs-number">10</span>
        
        <span class="hljs-keyword">return</span> max(<span class="hljs-number">0</span>, score)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_generate_recommendations</span><span class="hljs-params">(self, report: Dict)</span>:</span>
        <span class="hljs-string">"""ç”Ÿæˆæ”¹è¿›å»ºè®®"""</span>
        self.recommendations = []
        
        <span class="hljs-keyword">if</span> report[<span class="hljs-string">"ç©ºæ–‡æœ¬æ¯”ä¾‹"</span>] &gt; <span class="hljs-number">0.05</span>:
            self.recommendations.append(<span class="hljs-string">"å»ºè®®æ¸…ç†ç©ºæ–‡æœ¬æ•°æ®"</span>)
        
        <span class="hljs-keyword">if</span> report[<span class="hljs-string">"é•¿åº¦æ ‡å‡†å·®"</span>] &gt; report[<span class="hljs-string">"å¹³å‡é•¿åº¦"</span>]:
            self.recommendations.append(<span class="hljs-string">"å»ºè®®è¿›è¡Œé•¿åº¦æ ‡å‡†åŒ–å¤„ç†"</span>)
        
        <span class="hljs-keyword">if</span> report[<span class="hljs-string">"ç‰¹æ®Šå­—ç¬¦æ•°"</span>] &gt; report[<span class="hljs-string">"ä¸­æ–‡å­—ç¬¦æ•°"</span>] + report[<span class="hljs-string">"è‹±æ–‡å­—ç¬¦æ•°"</span>]:
            self.recommendations.append(<span class="hljs-string">"å»ºè®®æ¸…ç†è¿‡å¤šçš„ç‰¹æ®Šå­—ç¬¦"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_quality_report</span><span class="hljs-params">(self, report: Dict)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–è´¨é‡æŠ¥å‘Š"""</span>
        fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>))
        
        <span class="hljs-comment"># åŸºç¡€ç»Ÿè®¡</span>
        basic_stats = [<span class="hljs-string">"æ ·æœ¬æ€»æ•°"</span>, <span class="hljs-string">"ç©ºæ–‡æœ¬æ•°"</span>, <span class="hljs-string">"å­—ç¬¦å¤šæ ·æ€§"</span>]
        values = [report[stat] <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> basic_stats]
        ax1.bar(basic_stats, values, color=[<span class="hljs-string">'skyblue'</span>, <span class="hljs-string">'lightcoral'</span>, <span class="hljs-string">'lightgreen'</span>])
        ax1.set_title(<span class="hljs-string">'åŸºç¡€ç»Ÿè®¡ä¿¡æ¯'</span>)
        ax1.tick_params(axis=<span class="hljs-string">'x'</span>, rotation=<span class="hljs-number">45</span>)
        
        <span class="hljs-comment"># å­—ç¬¦åˆ†å¸ƒ</span>
        char_types = [<span class="hljs-string">"ä¸­æ–‡å­—ç¬¦"</span>, <span class="hljs-string">"è‹±æ–‡å­—ç¬¦"</span>, <span class="hljs-string">"ç‰¹æ®Šå­—ç¬¦"</span>]
        char_counts = [report[<span class="hljs-string">"ä¸­æ–‡å­—ç¬¦æ•°"</span>], report[<span class="hljs-string">"è‹±æ–‡å­—ç¬¦æ•°"</span>], report[<span class="hljs-string">"ç‰¹æ®Šå­—ç¬¦æ•°"</span>]]
        ax2.pie(char_counts, labels=char_types, autopct=<span class="hljs-string">'%1.1f%%'</span>, startangle=<span class="hljs-number">90</span>)
        ax2.set_title(<span class="hljs-string">'å­—ç¬¦ç±»å‹åˆ†å¸ƒ'</span>)
        
        <span class="hljs-comment"># è´¨é‡è¯„åˆ†</span>
        ax3.bar([<span class="hljs-string">'è´¨é‡è¯„åˆ†'</span>], [report[<span class="hljs-string">"è´¨é‡è¯„åˆ†"</span>]], color=<span class="hljs-string">'gold'</span>)
        ax3.set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>)
        ax3.set_title(<span class="hljs-string">'æ•°æ®è´¨é‡è¯„åˆ†'</span>)
        ax3.axhline(y=<span class="hljs-number">80</span>, color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, label=<span class="hljs-string">'ä¼˜ç§€çº¿'</span>)
        ax3.axhline(y=<span class="hljs-number">60</span>, color=<span class="hljs-string">'orange'</span>, linestyle=<span class="hljs-string">'--'</span>, label=<span class="hljs-string">'åŠæ ¼çº¿'</span>)
        ax3.legend()
        
        <span class="hljs-comment"># é•¿åº¦åˆ†æ</span>
        length_stats = [<span class="hljs-string">"å¹³å‡é•¿åº¦"</span>, <span class="hljs-string">"é•¿åº¦æ ‡å‡†å·®"</span>]
        length_values = [report[<span class="hljs-string">"å¹³å‡é•¿åº¦"</span>], report[<span class="hljs-string">"é•¿åº¦æ ‡å‡†å·®"</span>]]
        ax4.bar(length_stats, length_values, color=[<span class="hljs-string">'lightblue'</span>, <span class="hljs-string">'pink'</span>])
        ax4.set_title(<span class="hljs-string">'æ–‡æœ¬é•¿åº¦åˆ†æ'</span>)
        
        plt.tight_layout()
        plt.show()

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdvancedDataProcessor</span>:</span>
    <span class="hljs-string">"""é«˜çº§æ•°æ®å¤„ç†å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, tokenizer_name: str = <span class="hljs-string">"bert-base-chinese"</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–æ•°æ®å¤„ç†å™¨
        Args:
            tokenizer_name: åˆ†è¯å™¨åç§°
        """</span>
        self.tokenizer = AutoTokenizer.from_pretrained(tokenizer_name)
        self.label_encoder = LabelEncoder()
        self.processing_stats = {}
        
        print(<span class="hljs-string">f"ğŸ”§ åˆå§‹åŒ–æ•°æ®å¤„ç†å™¨: <span class="hljs-subst">{tokenizer_name}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clean_text</span><span class="hljs-params">(self, text: str)</span> -&gt; str:</span>
        <span class="hljs-string">"""
        æ¸…æ´—å•ä¸ªæ–‡æœ¬
        Args:
            text: åŸå§‹æ–‡æœ¬
        Returns:
            æ¸…æ´—åçš„æ–‡æœ¬
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> text <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> isinstance(text, str):
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>
        
        <span class="hljs-comment"># å»é™¤å¤šä½™ç©ºç™½</span>
        text = re.sub(<span class="hljs-string">r'\s+'</span>, <span class="hljs-string">' '</span>, text.strip())
        
        <span class="hljs-comment"># å»é™¤ç‰¹æ®Šå­—ç¬¦ï¼ˆä¿ç•™ä¸­è‹±æ–‡ã€æ•°å­—ã€åŸºæœ¬æ ‡ç‚¹ï¼‰</span>
        text = re.sub(<span class="hljs-string">r'[^\u4e00-\u9fff\w\s.,!?;:ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š]'</span>, <span class="hljs-string">''</span>, text)
        
        <span class="hljs-comment"># å»é™¤è¿‡çŸ­çš„æ–‡æœ¬</span>
        <span class="hljs-keyword">if</span> len(text) &lt; <span class="hljs-number">3</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>
        
        <span class="hljs-keyword">return</span> text
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">batch_clean_texts</span><span class="hljs-params">(self, texts: List[str])</span> -&gt; List[str]:</span>
        <span class="hljs-string">"""
        æ‰¹é‡æ¸…æ´—æ–‡æœ¬
        Args:
            texts: æ–‡æœ¬åˆ—è¡¨
        Returns:
            æ¸…æ´—åçš„æ–‡æœ¬åˆ—è¡¨
        """</span>
        print(<span class="hljs-string">"ğŸ§¹ å¼€å§‹æ‰¹é‡æ–‡æœ¬æ¸…æ´—..."</span>)
        
        cleaned_texts = []
        removed_count = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> texts:
            cleaned = self.clean_text(text)
            <span class="hljs-keyword">if</span> cleaned:
                cleaned_texts.append(cleaned)
            <span class="hljs-keyword">else</span>:
                removed_count += <span class="hljs-number">1</span>
        
        self.processing_stats[<span class="hljs-string">'removed_texts'</span>] = removed_count
        self.processing_stats[<span class="hljs-string">'clean_ratio'</span>] = len(cleaned_texts) / len(texts)
        
        print(<span class="hljs-string">f"âœ… æ–‡æœ¬æ¸…æ´—å®Œæˆï¼Œä¿ç•™: <span class="hljs-subst">{len(cleaned_texts)}</span>, ç§»é™¤: <span class="hljs-subst">{removed_count}</span>"</span>)
        <span class="hljs-keyword">return</span> cleaned_texts
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">augment_data</span><span class="hljs-params">(self, texts: List[str], labels: List[int], 
                    augment_ratio: float = <span class="hljs-number">0.2</span>)</span> -&gt; Tuple[List[str], List[int]]:</span>
        <span class="hljs-string">"""
        æ•°æ®å¢å¼º
        Args:
            texts: æ–‡æœ¬åˆ—è¡¨
            labels: æ ‡ç­¾åˆ—è¡¨
            augment_ratio: å¢å¼ºæ¯”ä¾‹
        Returns:
            å¢å¼ºåçš„æ–‡æœ¬å’Œæ ‡ç­¾
        """</span>
        print(<span class="hljs-string">f"ğŸ”„ å¼€å§‹æ•°æ®å¢å¼ºï¼Œå¢å¼ºæ¯”ä¾‹: <span class="hljs-subst">{augment_ratio:<span class="hljs-number">.1</span>%}</span>"</span>)
        
        augmented_texts = texts.copy()
        augmented_labels = labels.copy()
        
        <span class="hljs-comment"># è®¡ç®—éœ€è¦å¢å¼ºçš„æ ·æœ¬æ•°</span>
        augment_count = int(len(texts) * augment_ratio)
        
        <span class="hljs-comment"># éšæœºé€‰æ‹©æ ·æœ¬è¿›è¡Œå¢å¼º</span>
        indices = np.random.choice(len(texts), augment_count, replace=<span class="hljs-literal">True</span>)
        
        <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> indices:
            original_text = texts[idx]
            original_label = labels[idx]
            
            <span class="hljs-comment"># ç®€å•çš„å¢å¼ºç­–ç•¥ï¼šåŒä¹‰è¯æ›¿æ¢ã€å¥å¼å˜æ¢ç­‰</span>
            augmented_text = self._simple_augment(original_text)
            
            <span class="hljs-keyword">if</span> augmented_text <span class="hljs-keyword">and</span> augmented_text != original_text:
                augmented_texts.append(augmented_text)
                augmented_labels.append(original_label)
        
        print(<span class="hljs-string">f"âœ… æ•°æ®å¢å¼ºå®Œæˆï¼Œä» <span class="hljs-subst">{len(texts)}</span> å¢åŠ åˆ° <span class="hljs-subst">{len(augmented_texts)}</span> æ ·æœ¬"</span>)
        <span class="hljs-keyword">return</span> augmented_texts, augmented_labels
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_simple_augment</span><span class="hljs-params">(self, text: str)</span> -&gt; str:</span>
        <span class="hljs-string">"""ç®€å•çš„æ–‡æœ¬å¢å¼º"""</span>
        <span class="hljs-comment"># è¿™é‡Œå®ç°ç®€å•çš„å¢å¼ºç­–ç•¥</span>
        <span class="hljs-comment"># å®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„å¢å¼ºæ–¹æ³•</span>
        
        augment_strategies = [
            <span class="hljs-keyword">lambda</span> x: x,  <span class="hljs-comment"># ä¿æŒåŸæ ·</span>
            <span class="hljs-keyword">lambda</span> x: x + <span class="hljs-string">"ã€‚"</span>,  <span class="hljs-comment"># æ·»åŠ å¥å·</span>
            <span class="hljs-keyword">lambda</span> x: x.replace(<span class="hljs-string">"å¾ˆ"</span>, <span class="hljs-string">"éå¸¸"</span>),  <span class="hljs-comment"># åŒä¹‰è¯æ›¿æ¢</span>
            <span class="hljs-keyword">lambda</span> x: x.replace(<span class="hljs-string">"å¥½"</span>, <span class="hljs-string">"ä¸é”™"</span>),  <span class="hljs-comment"># åŒä¹‰è¯æ›¿æ¢</span>
        ]
        
        strategy = np.random.choice(augment_strategies)
        <span class="hljs-keyword">return</span> strategy(text)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmartDataLoader</span>:</span>
    <span class="hljs-string">"""æ™ºèƒ½æ•°æ®åŠ è½½å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, tokenizer, max_length: int = <span class="hljs-number">128</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨
        Args:
            tokenizer: åˆ†è¯å™¨
            max_length: æœ€å¤§åºåˆ—é•¿åº¦
        """</span>
        self.tokenizer = tokenizer
        self.max_length = max_length
        
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_dataset</span><span class="hljs-params">(self, texts: List[str], labels: List[int])</span> -&gt; 'FineTuningDataset':</span>
        <span class="hljs-string">"""
        åˆ›å»ºæ•°æ®é›†
        Args:
            texts: æ–‡æœ¬åˆ—è¡¨
            labels: æ ‡ç­¾åˆ—è¡¨
        Returns:
            æ•°æ®é›†å¯¹è±¡
        """</span>
        <span class="hljs-keyword">return</span> FineTuningDataset(texts, labels, self.tokenizer, self.max_length)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_dataloaders</span><span class="hljs-params">(self, dataset, train_ratio: float = <span class="hljs-number">0.8</span>, 
                          val_ratio: float = <span class="hljs-number">0.1</span>, batch_size: int = <span class="hljs-number">32</span>,
                          shuffle: bool = True)</span> -&gt; Tuple[DataLoader, DataLoader, DataLoader]:</span>
        <span class="hljs-string">"""
        åˆ›å»ºè®­ç»ƒã€éªŒè¯ã€æµ‹è¯•æ•°æ®åŠ è½½å™¨
        Args:
            dataset: æ•°æ®é›†
            train_ratio: è®­ç»ƒé›†æ¯”ä¾‹
            val_ratio: éªŒè¯é›†æ¯”ä¾‹
            batch_size: æ‰¹æ¬¡å¤§å°
            shuffle: æ˜¯å¦æ‰“ä¹±
        Returns:
            è®­ç»ƒã€éªŒè¯ã€æµ‹è¯•æ•°æ®åŠ è½½å™¨
        """</span>
        <span class="hljs-comment"># è®¡ç®—å„éƒ¨åˆ†å¤§å°</span>
        total_size = len(dataset)
        train_size = int(total_size * train_ratio)
        val_size = int(total_size * val_ratio)
        test_size = total_size - train_size - val_size
        
        <span class="hljs-comment"># åˆ’åˆ†æ•°æ®é›†</span>
        train_dataset, val_dataset, test_dataset = random_split(
            dataset, [train_size, val_size, test_size]
        )
        
        <span class="hljs-comment"># åˆ›å»ºæ•°æ®åŠ è½½å™¨</span>
        train_loader = DataLoader(
            train_dataset, batch_size=batch_size, shuffle=shuffle
        )
        val_loader = DataLoader(
            val_dataset, batch_size=batch_size, shuffle=<span class="hljs-literal">False</span>
        )
        test_loader = DataLoader(
            test_dataset, batch_size=batch_size, shuffle=<span class="hljs-literal">False</span>
        )
        
        print(<span class="hljs-string">f"ğŸ“Š æ•°æ®é›†åˆ’åˆ†å®Œæˆ:"</span>)
        print(<span class="hljs-string">f"  è®­ç»ƒé›†: <span class="hljs-subst">{train_size}</span> æ ·æœ¬"</span>)
        print(<span class="hljs-string">f"  éªŒè¯é›†: <span class="hljs-subst">{val_size}</span> æ ·æœ¬"</span>)
        print(<span class="hljs-string">f"  æµ‹è¯•é›†: <span class="hljs-subst">{test_size}</span> æ ·æœ¬"</span>)
        
        <span class="hljs-keyword">return</span> train_loader, val_loader, test_loader

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FineTuningDataset</span><span class="hljs-params">(Dataset)</span>:</span>
    <span class="hljs-string">"""å¾®è°ƒä¸“ç”¨æ•°æ®é›†"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, texts: List[str], labels: List[int], 
                 tokenizer, max_length: int = <span class="hljs-number">128</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–æ•°æ®é›†
        Args:
            texts: æ–‡æœ¬åˆ—è¡¨
            labels: æ ‡ç­¾åˆ—è¡¨
            tokenizer: åˆ†è¯å™¨
            max_length: æœ€å¤§é•¿åº¦
        """</span>
        self.texts = texts
        self.labels = labels
        self.tokenizer = tokenizer
        self.max_length = max_length
        
        <span class="hljs-comment"># éªŒè¯æ•°æ®ä¸€è‡´æ€§</span>
        <span class="hljs-keyword">assert</span> len(texts) == len(labels), <span class="hljs-string">"æ–‡æœ¬å’Œæ ‡ç­¾æ•°é‡ä¸åŒ¹é…"</span>
        
        print(<span class="hljs-string">f"ğŸ“¦ åˆ›å»ºæ•°æ®é›†: <span class="hljs-subst">{len(texts)}</span> æ ·æœ¬, æœ€å¤§é•¿åº¦: <span class="hljs-subst">{max_length}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__len__</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> len(self.texts)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__getitem__</span><span class="hljs-params">(self, idx)</span>:</span>
        text = str(self.texts[idx])
        label = self.labels[idx]
        
        <span class="hljs-comment"># åˆ†è¯å’Œç¼–ç </span>
        encoding = self.tokenizer(
            text,
            truncation=<span class="hljs-literal">True</span>,
            padding=<span class="hljs-string">'max_length'</span>,
            max_length=self.max_length,
            return_tensors=<span class="hljs-string">'pt'</span>
        )
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'input_ids'</span>: encoding[<span class="hljs-string">'input_ids'</span>].flatten(),
            <span class="hljs-string">'attention_mask'</span>: encoding[<span class="hljs-string">'attention_mask'</span>].flatten(),
            <span class="hljs-string">'label'</span>: torch.tensor(label, dtype=torch.long),
            <span class="hljs-string">'text'</span>: text  <span class="hljs-comment"># ä¿ç•™åŸæ–‡æœ¬ç”¨äºè°ƒè¯•</span>
        }

<span class="hljs-comment"># æ¼”ç¤ºå®Œæ•´çš„æ•°æ®å·¥ç¨‹æµç¨‹</span>
print(<span class="hljs-string">"ğŸ—ï¸ æ•°æ®å·¥ç¨‹ä¸é¢„å¤„ç†æ¼”ç¤º"</span>)
print(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># 1. åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®</span>
sample_data = {
    <span class="hljs-string">'text'</span>: [
        <span class="hljs-string">"è¿™éƒ¨ç”µå½±çœŸçš„å¾ˆæ£’ï¼æ¼”å‘˜è¡¨æ¼”å‡ºè‰²ï¼Œå‰§æƒ…å¼•äººå…¥èƒœã€‚"</span>,
        <span class="hljs-string">"æœåŠ¡æ€åº¦å¾ˆå·®ï¼Œç­‰äº†å¾ˆä¹…éƒ½æ²¡äººç†ã€‚"</span>,
        <span class="hljs-string">"   "</span>,  <span class="hljs-comment"># ç©ºæ–‡æœ¬</span>
        <span class="hljs-string">"è¿˜å¯ä»¥ï¼Œä¸€èˆ¬èˆ¬çš„ä½“éªŒï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚"</span>,
        <span class="hljs-string">"éå¸¸æ»¡æ„è¿™æ¬¡è´­ç‰©ä½“éªŒï¼ï¼ï¼"</span>,
        <span class="hljs-string">""</span>,  <span class="hljs-comment"># ç©ºæ–‡æœ¬</span>
        <span class="hljs-string">"è´¨é‡ä¸å¤ªå¥½ï¼Œç”¨äº†å‡ å¤©å°±åäº†ã€‚"</span>,
        <span class="hljs-string">"ä»·æ ¼åˆç†ï¼Œæ€§ä»·æ¯”å¾ˆé«˜ï¼Œå€¼å¾—æ¨èç»™æœ‹å‹ã€‚"</span>,
        <span class="hljs-string">"###ç‰¹æ®Šå­—ç¬¦###æµ‹è¯•æ–‡æœ¬@@@"</span>,  <span class="hljs-comment"># åŒ…å«ç‰¹æ®Šå­—ç¬¦</span>
        <span class="hljs-string">"è¶…çº§æ£’çš„äº§å“ï¼Œäº”æ˜Ÿå¥½è¯„ï¼"</span>
    ] * <span class="hljs-number">50</span>,  <span class="hljs-comment"># æ‰©å±•æ•°æ®</span>
    <span class="hljs-string">'label'</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>] * <span class="hljs-number">50</span>  <span class="hljs-comment"># 0:è´Ÿé¢, 1:ä¸­æ€§, 2:æ­£é¢</span>
}

df = pd.DataFrame(sample_data)
print(<span class="hljs-string">f"ğŸ“Š åŸå§‹æ•°æ®: <span class="hljs-subst">{len(df)}</span> æ¡è®°å½•"</span>)

<span class="hljs-comment"># 2. æ•°æ®è´¨é‡åˆ†æ</span>
quality_analyzer = DataQualityAnalyzer()
quality_report = quality_analyzer.analyze_text_quality(df[<span class="hljs-string">'text'</span>].tolist())

print(<span class="hljs-string">"\nğŸ“‹ æ•°æ®è´¨é‡æŠ¥å‘Š:"</span>)
<span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> quality_report.items():
    print(<span class="hljs-string">f"  <span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)

print(<span class="hljs-string">f"\nğŸ’¡ æ”¹è¿›å»ºè®®:"</span>)
<span class="hljs-keyword">for</span> rec <span class="hljs-keyword">in</span> quality_analyzer.recommendations:
    print(<span class="hljs-string">f"  â€¢ <span class="hljs-subst">{rec}</span>"</span>)

<span class="hljs-comment"># å¯è§†åŒ–è´¨é‡æŠ¥å‘Š</span>
quality_analyzer.visualize_quality_report(quality_report)

<span class="hljs-comment"># 3. æ•°æ®å¤„ç†</span>
processor = AdvancedDataProcessor()

<span class="hljs-comment"># æ¸…æ´—æ•°æ®</span>
cleaned_texts = processor.batch_clean_texts(df[<span class="hljs-string">'text'</span>].tolist())
cleaned_labels = [df[<span class="hljs-string">'label'</span>].tolist()[i] <span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> enumerate(df[<span class="hljs-string">'text'</span>].tolist()) 
                 <span class="hljs-keyword">if</span> processor.clean_text(text)]

print(<span class="hljs-string">f"\nğŸ§¹ æ•°æ®æ¸…æ´—ç»“æœ:"</span>)
print(<span class="hljs-string">f"  æ¸…æ´—å‰: <span class="hljs-subst">{len(df)}</span> æ ·æœ¬"</span>)
print(<span class="hljs-string">f"  æ¸…æ´—å: <span class="hljs-subst">{len(cleaned_texts)}</span> æ ·æœ¬"</span>)
print(<span class="hljs-string">f"  ä¿ç•™ç‡: <span class="hljs-subst">{len(cleaned_texts)/len(df):<span class="hljs-number">.1</span>%}</span>"</span>)

<span class="hljs-comment"># 4. æ•°æ®å¢å¼º</span>
augmented_texts, augmented_labels = processor.augment_data(
    cleaned_texts, cleaned_labels, augment_ratio=<span class="hljs-number">0.3</span>
)

print(<span class="hljs-string">f"\nğŸ”„ æ•°æ®å¢å¼ºç»“æœ:"</span>)
print(<span class="hljs-string">f"  å¢å¼ºå‰: <span class="hljs-subst">{len(cleaned_texts)}</span> æ ·æœ¬"</span>)
print(<span class="hljs-string">f"  å¢å¼ºå: <span class="hljs-subst">{len(augmented_texts)}</span> æ ·æœ¬"</span>)
print(<span class="hljs-string">f"  å¢é•¿ç‡: <span class="hljs-subst">{(len(augmented_texts)-len(cleaned_texts))/len(cleaned_texts):<span class="hljs-number">.1</span>%}</span>"</span>)

<span class="hljs-comment"># 5. åˆ›å»ºæ•°æ®åŠ è½½å™¨</span>
tokenizer = AutoTokenizer.from_pretrained(<span class="hljs-string">'bert-base-chinese'</span>)
data_loader = SmartDataLoader(tokenizer, max_length=<span class="hljs-number">128</span>)

<span class="hljs-comment"># åˆ›å»ºæ•°æ®é›†</span>
dataset = data_loader.create_dataset(augmented_texts, augmented_labels)

<span class="hljs-comment"># åˆ›å»ºæ•°æ®åŠ è½½å™¨</span>
train_loader, val_loader, test_loader = data_loader.create_dataloaders(
    dataset, train_ratio=<span class="hljs-number">0.7</span>, val_ratio=<span class="hljs-number">0.15</span>, batch_size=<span class="hljs-number">16</span>
)

print(<span class="hljs-string">f"\nğŸ“¦ æ•°æ®åŠ è½½å™¨åˆ›å»ºå®Œæˆ:"</span>)
print(<span class="hljs-string">f"  è®­ç»ƒæ‰¹æ¬¡æ•°: <span class="hljs-subst">{len(train_loader)}</span>"</span>)
print(<span class="hljs-string">f"  éªŒè¯æ‰¹æ¬¡æ•°: <span class="hljs-subst">{len(val_loader)}</span>"</span>)
print(<span class="hljs-string">f"  æµ‹è¯•æ‰¹æ¬¡æ•°: <span class="hljs-subst">{len(test_loader)}</span>"</span>)

<span class="hljs-comment"># 6. æ•°æ®æ‰¹æ¬¡æ£€æŸ¥</span>
print(<span class="hljs-string">f"\nğŸ” æ•°æ®æ‰¹æ¬¡æ£€æŸ¥:"</span>)
<span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> train_loader:
    print(<span class="hljs-string">f"  input_idså½¢çŠ¶: <span class="hljs-subst">{batch[<span class="hljs-string">'input_ids'</span>].shape}</span>"</span>)
    print(<span class="hljs-string">f"  attention_maskå½¢çŠ¶: <span class="hljs-subst">{batch[<span class="hljs-string">'attention_mask'</span>].shape}</span>"</span>)
    print(<span class="hljs-string">f"  labelså½¢çŠ¶: <span class="hljs-subst">{batch[<span class="hljs-string">'label'</span>].shape}</span>"</span>)
    print(<span class="hljs-string">f"  ç¤ºä¾‹æ–‡æœ¬: <span class="hljs-subst">{batch[<span class="hljs-string">'text'</span>][<span class="hljs-number">0</span>]}</span>"</span>)
    <span class="hljs-keyword">break</span>
</div></code></pre>
<h4 id="%F0%9F%8E%9B%EF%B8%8F-%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F">ğŸ›ï¸ æ•°æ®è´¨é‡ç›‘æ§ç³»ç»Ÿ</h4>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å®ç°ä¸€ä¸ªå®æ—¶çš„æ•°æ®è´¨é‡ç›‘æ§ç³»ç»Ÿï¼š</p>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    A[æ•°æ®è¾“å…¥] --> B[å®æ—¶è´¨é‡æ£€æµ‹]
    B --> C{è´¨é‡æ£€æŸ¥}
    C -->|é€šè¿‡| D[æ•°æ®å…¥åº“]
    C -->|ä¸é€šè¿‡| E[è´¨é‡ä¿®å¤]
    E --> F{ä¿®å¤æˆåŠŸ?}
    F -->|æ˜¯| D
    F -->|å¦| G[äººå·¥å®¡æ ¸]
    
    D --> H[è´¨é‡æŒ‡æ ‡æ›´æ–°]
    H --> I[ç›‘æ§é¢æ¿]
    I --> J[å‘Šè­¦ç³»ç»Ÿ]
    
    G --> K[æ ‡è®°é—®é¢˜æ•°æ®]
    K --> L[è´¨é‡æŠ¥å‘Š]
    
    style A fill:#e1f5fe
    style D fill:#e8f5e8
    style C fill:#fff3e0
    style J fill:#ffebee
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> queue <span class="hljs-keyword">import</span> Queue
<span class="hljs-keyword">import</span> json

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataQualityMonitor</span>:</span>
    <span class="hljs-string">"""æ•°æ®è´¨é‡å®æ—¶ç›‘æ§ç³»ç»Ÿ"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, quality_threshold: float = <span class="hljs-number">80.0</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–è´¨é‡ç›‘æ§å™¨
        Args:
            quality_threshold: è´¨é‡é˜ˆå€¼
        """</span>
        self.quality_threshold = quality_threshold
        self.monitoring_active = <span class="hljs-literal">False</span>
        self.quality_history = []
        self.alert_queue = Queue()
        self.stats = {
            <span class="hljs-string">'total_samples'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'passed_samples'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'failed_samples'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'avg_quality'</span>: <span class="hljs-number">0.0</span>
        }
        
        print(<span class="hljs-string">f"ğŸ” æ•°æ®è´¨é‡ç›‘æ§å™¨åˆå§‹åŒ–ï¼Œè´¨é‡é˜ˆå€¼: <span class="hljs-subst">{quality_threshold}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start_monitoring</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯åŠ¨ç›‘æ§"""</span>
        self.monitoring_active = <span class="hljs-literal">True</span>
        
        <span class="hljs-comment"># å¯åŠ¨ç›‘æ§çº¿ç¨‹</span>
        monitor_thread = threading.Thread(target=self._monitoring_loop)
        monitor_thread.daemon = <span class="hljs-literal">True</span>
        monitor_thread.start()
        
        <span class="hljs-comment"># å¯åŠ¨å‘Šè­¦å¤„ç†çº¿ç¨‹</span>
        alert_thread = threading.Thread(target=self._alert_handler)
        alert_thread.daemon = <span class="hljs-literal">True</span>
        alert_thread.start()
        
        print(<span class="hljs-string">"ğŸš€ è´¨é‡ç›‘æ§ç³»ç»Ÿå¯åŠ¨"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop_monitoring</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""åœæ­¢ç›‘æ§"""</span>
        self.monitoring_active = <span class="hljs-literal">False</span>
        print(<span class="hljs-string">"â¹ï¸ è´¨é‡ç›‘æ§ç³»ç»Ÿåœæ­¢"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_data_quality</span><span class="hljs-params">(self, text: str)</span> -&gt; Dict:</span>
        <span class="hljs-string">"""
        æ£€æŸ¥å•æ¡æ•°æ®è´¨é‡
        Args:
            text: æ–‡æœ¬æ•°æ®
        Returns:
            è´¨é‡æ£€æŸ¥ç»“æœ
        """</span>
        quality_score = <span class="hljs-number">100.0</span>
        issues = []
        
        <span class="hljs-comment"># é•¿åº¦æ£€æŸ¥</span>
        <span class="hljs-keyword">if</span> len(text) &lt; <span class="hljs-number">5</span>:
            quality_score -= <span class="hljs-number">30</span>
            issues.append(<span class="hljs-string">"æ–‡æœ¬è¿‡çŸ­"</span>)
        <span class="hljs-keyword">elif</span> len(text) &gt; <span class="hljs-number">1000</span>:
            quality_score -= <span class="hljs-number">20</span>
            issues.append(<span class="hljs-string">"æ–‡æœ¬è¿‡é•¿"</span>)
        
        <span class="hljs-comment"># å­—ç¬¦æ£€æŸ¥</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> any(c.isalnum() <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> text):
            quality_score -= <span class="hljs-number">40</span>
            issues.append(<span class="hljs-string">"ç¼ºå°‘å­—æ¯æ•°å­—å­—ç¬¦"</span>)
        
        <span class="hljs-comment"># ç‰¹æ®Šå­—ç¬¦æ¯”ä¾‹æ£€æŸ¥</span>
        special_char_ratio = sum(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> text <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> c.isalnum() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> c.isspace()) / len(text)
        <span class="hljs-keyword">if</span> special_char_ratio &gt; <span class="hljs-number">0.3</span>:
            quality_score -= <span class="hljs-number">25</span>
            issues.append(<span class="hljs-string">"ç‰¹æ®Šå­—ç¬¦è¿‡å¤š"</span>)
        
        <span class="hljs-comment"># é‡å¤å­—ç¬¦æ£€æŸ¥</span>
        <span class="hljs-keyword">if</span> any(text.count(c) &gt; len(text) * <span class="hljs-number">0.5</span> <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> set(text)):
            quality_score -= <span class="hljs-number">35</span>
            issues.append(<span class="hljs-string">"é‡å¤å­—ç¬¦è¿‡å¤š"</span>)
        
        quality_score = max(<span class="hljs-number">0</span>, quality_score)
        
        result = {
            <span class="hljs-string">'quality_score'</span>: quality_score,
            <span class="hljs-string">'passed'</span>: quality_score &gt;= self.quality_threshold,
            <span class="hljs-string">'issues'</span>: issues,
            <span class="hljs-string">'timestamp'</span>: datetime.now().isoformat()
        }
        
        <span class="hljs-comment"># æ›´æ–°ç»Ÿè®¡</span>
        self._update_stats(result)
        
        <span class="hljs-comment"># å¦‚æœè´¨é‡ä¸è¾¾æ ‡ï¼Œæ·»åŠ åˆ°å‘Šè­¦é˜Ÿåˆ—</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result[<span class="hljs-string">'passed'</span>]:
            self.alert_queue.put({
                <span class="hljs-string">'type'</span>: <span class="hljs-string">'quality_alert'</span>,
                <span class="hljs-string">'text'</span>: text[:<span class="hljs-number">100</span>] + <span class="hljs-string">'...'</span> <span class="hljs-keyword">if</span> len(text) &gt; <span class="hljs-number">100</span> <span class="hljs-keyword">else</span> text,
                <span class="hljs-string">'score'</span>: quality_score,
                <span class="hljs-string">'issues'</span>: issues,
                <span class="hljs-string">'timestamp'</span>: result[<span class="hljs-string">'timestamp'</span>]
            })
        
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_update_stats</span><span class="hljs-params">(self, result: Dict)</span>:</span>
        <span class="hljs-string">"""æ›´æ–°ç»Ÿè®¡ä¿¡æ¯"""</span>
        self.stats[<span class="hljs-string">'total_samples'</span>] += <span class="hljs-number">1</span>
        
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'passed'</span>]:
            self.stats[<span class="hljs-string">'passed_samples'</span>] += <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            self.stats[<span class="hljs-string">'failed_samples'</span>] += <span class="hljs-number">1</span>
        
        <span class="hljs-comment"># æ›´æ–°å¹³å‡è´¨é‡</span>
        self.quality_history.append(result[<span class="hljs-string">'quality_score'</span>])
        <span class="hljs-keyword">if</span> len(self.quality_history) &gt; <span class="hljs-number">1000</span>:  <span class="hljs-comment"># ä¿æŒæœ€è¿‘1000æ¡è®°å½•</span>
            self.quality_history.pop(<span class="hljs-number">0</span>)
        
        self.stats[<span class="hljs-string">'avg_quality'</span>] = np.mean(self.quality_history)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_monitoring_loop</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ç›‘æ§ä¸»å¾ªç¯"""</span>
        <span class="hljs-keyword">while</span> self.monitoring_active:
            <span class="hljs-comment"># ç”Ÿæˆç›‘æ§æŠ¥å‘Š</span>
            <span class="hljs-keyword">if</span> self.stats[<span class="hljs-string">'total_samples'</span>] &gt; <span class="hljs-number">0</span>:
                pass_rate = self.stats[<span class="hljs-string">'passed_samples'</span>] / self.stats[<span class="hljs-string">'total_samples'</span>]
                <span class="hljs-keyword">if</span> pass_rate &lt; <span class="hljs-number">0.8</span>:  <span class="hljs-comment"># é€šè¿‡ç‡ä½äº80%æ—¶å‘Šè­¦</span>
                    self.alert_queue.put({
                        <span class="hljs-string">'type'</span>: <span class="hljs-string">'pass_rate_alert'</span>,
                        <span class="hljs-string">'pass_rate'</span>: pass_rate,
                        <span class="hljs-string">'timestamp'</span>: datetime.now().isoformat()
                    })
            
            time.sleep(<span class="hljs-number">10</span>)  <span class="hljs-comment"># æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_alert_handler</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å‘Šè­¦å¤„ç†å™¨"""</span>
        <span class="hljs-keyword">while</span> self.monitoring_active:
            <span class="hljs-keyword">try</span>:
                alert = self.alert_queue.get(timeout=<span class="hljs-number">1</span>)
                self._process_alert(alert)
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">continue</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_process_alert</span><span class="hljs-params">(self, alert: Dict)</span>:</span>
        <span class="hljs-string">"""å¤„ç†å‘Šè­¦"""</span>
        <span class="hljs-keyword">if</span> alert[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'quality_alert'</span>:
            print(<span class="hljs-string">f"âš ï¸ æ•°æ®è´¨é‡å‘Šè­¦: è´¨é‡è¯„åˆ† <span class="hljs-subst">{alert[<span class="hljs-string">'score'</span>]:<span class="hljs-number">.1</span>f}</span>"</span>)
            print(<span class="hljs-string">f"   é—®é¢˜: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(alert[<span class="hljs-string">'issues'</span>])}</span>"</span>)
            print(<span class="hljs-string">f"   æ—¶é—´: <span class="hljs-subst">{alert[<span class="hljs-string">'timestamp'</span>]}</span>"</span>)
        <span class="hljs-keyword">elif</span> alert[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'pass_rate_alert'</span>:
            print(<span class="hljs-string">f"ğŸš¨ é€šè¿‡ç‡å‘Šè­¦: <span class="hljs-subst">{alert[<span class="hljs-string">'pass_rate'</span>]:<span class="hljs-number">.1</span>%}</span>"</span>)
            print(<span class="hljs-string">f"   æ—¶é—´: <span class="hljs-subst">{alert[<span class="hljs-string">'timestamp'</span>]}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_quality_dashboard</span><span class="hljs-params">(self)</span> -&gt; Dict:</span>
        <span class="hljs-string">"""è·å–è´¨é‡ä»ªè¡¨æ¿æ•°æ®"""</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'total_samples'</span>: self.stats[<span class="hljs-string">'total_samples'</span>],
            <span class="hljs-string">'passed_samples'</span>: self.stats[<span class="hljs-string">'passed_samples'</span>],
            <span class="hljs-string">'failed_samples'</span>: self.stats[<span class="hljs-string">'failed_samples'</span>],
            <span class="hljs-string">'pass_rate'</span>: self.stats[<span class="hljs-string">'passed_samples'</span>] / max(<span class="hljs-number">1</span>, self.stats[<span class="hljs-string">'total_samples'</span>]),
            <span class="hljs-string">'avg_quality'</span>: self.stats[<span class="hljs-string">'avg_quality'</span>],
            <span class="hljs-string">'recent_quality_trend'</span>: self.quality_history[<span class="hljs-number">-10</span>:] <span class="hljs-keyword">if</span> self.quality_history <span class="hljs-keyword">else</span> []
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_dashboard</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–ç›‘æ§é¢æ¿"""</span>
        dashboard = self.get_quality_dashboard()
        
        fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>))
        
        <span class="hljs-comment"># é€šè¿‡ç‡é¥¼å›¾</span>
        pass_fail = [dashboard[<span class="hljs-string">'passed_samples'</span>], dashboard[<span class="hljs-string">'failed_samples'</span>]]
        labels = [<span class="hljs-string">'é€šè¿‡'</span>, <span class="hljs-string">'å¤±è´¥'</span>]
        colors = [<span class="hljs-string">'lightgreen'</span>, <span class="hljs-string">'lightcoral'</span>]
        ax1.pie(pass_fail, labels=labels, colors=colors, autopct=<span class="hljs-string">'%1.1f%%'</span>, startangle=<span class="hljs-number">90</span>)
        ax1.set_title(<span class="hljs-string">f'æ•°æ®è´¨é‡é€šè¿‡ç‡: <span class="hljs-subst">{dashboard[<span class="hljs-string">"pass_rate"</span>]:<span class="hljs-number">.1</span>%}</span>'</span>)
        
        <span class="hljs-comment"># æ ·æœ¬æ€»æ•°</span>
        ax2.bar([<span class="hljs-string">'æ€»æ ·æœ¬æ•°'</span>], [dashboard[<span class="hljs-string">'total_samples'</span>]], color=<span class="hljs-string">'skyblue'</span>)
        ax2.set_title(<span class="hljs-string">'å¤„ç†æ ·æœ¬æ€»æ•°'</span>)
        ax2.set_ylabel(<span class="hljs-string">'æ ·æœ¬æ•°'</span>)
        
        <span class="hljs-comment"># å¹³å‡è´¨é‡è¯„åˆ†</span>
        ax3.bar([<span class="hljs-string">'å¹³å‡è´¨é‡'</span>], [dashboard[<span class="hljs-string">'avg_quality'</span>]], color=<span class="hljs-string">'gold'</span>)
        ax3.set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>)
        ax3.set_title(<span class="hljs-string">f'å¹³å‡è´¨é‡è¯„åˆ†: <span class="hljs-subst">{dashboard[<span class="hljs-string">"avg_quality"</span>]:<span class="hljs-number">.1</span>f}</span>'</span>)
        ax3.axhline(y=self.quality_threshold, color=<span class="hljs-string">'red'</span>, linestyle=<span class="hljs-string">'--'</span>, label=<span class="hljs-string">'é˜ˆå€¼'</span>)
        ax3.legend()
        
        <span class="hljs-comment"># è´¨é‡è¶‹åŠ¿</span>
        <span class="hljs-keyword">if</span> dashboard[<span class="hljs-string">'recent_quality_trend'</span>]:
            ax4.plot(dashboard[<span class="hljs-string">'recent_quality_trend'</span>], marker=<span class="hljs-string">'o'</span>, color=<span class="hljs-string">'blue'</span>)
            ax4.set_title(<span class="hljs-string">'æœ€è¿‘è´¨é‡è¶‹åŠ¿'</span>)
            ax4.set_ylabel(<span class="hljs-string">'è´¨é‡è¯„åˆ†'</span>)
            ax4.set_xlabel(<span class="hljs-string">'æ ·æœ¬åºå·'</span>)
            ax4.axhline(y=self.quality_threshold, color=<span class="hljs-string">'red'</span>, linestyle=<span class="hljs-string">'--'</span>, alpha=<span class="hljs-number">0.7</span>)
        
        plt.tight_layout()
        plt.show()

<span class="hljs-comment"># æ¼”ç¤ºæ•°æ®è´¨é‡ç›‘æ§ç³»ç»Ÿ</span>
print(<span class="hljs-string">"\nğŸ” æ•°æ®è´¨é‡ç›‘æ§ç³»ç»Ÿæ¼”ç¤º"</span>)
print(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ›å»ºç›‘æ§å™¨</span>
monitor = DataQualityMonitor(quality_threshold=<span class="hljs-number">75.0</span>)
monitor.start_monitoring()

<span class="hljs-comment"># æ¨¡æ‹Ÿæ•°æ®æµ</span>
test_texts = [
    <span class="hljs-string">"è¿™æ˜¯ä¸€ä¸ªé«˜è´¨é‡çš„æ–‡æœ¬æ ·æœ¬ï¼Œå†…å®¹ä¸°å¯Œä¸”æœ‰æ„ä¹‰ã€‚"</span>,
    <span class="hljs-string">"çŸ­æ–‡æœ¬"</span>,  <span class="hljs-comment"># è´¨é‡é—®é¢˜ï¼šè¿‡çŸ­</span>
    <span class="hljs-string">"!!!@@@###ç‰¹æ®Šå­—ç¬¦è¿‡å¤šçš„æ–‡æœ¬æ ·æœ¬###@@@!!!"</span>,  <span class="hljs-comment"># è´¨é‡é—®é¢˜ï¼šç‰¹æ®Šå­—ç¬¦</span>
    <span class="hljs-string">"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>,  <span class="hljs-comment"># è´¨é‡é—®é¢˜ï¼šé‡å¤å­—ç¬¦</span>
    <span class="hljs-string">"æ­£å¸¸çš„æ–‡æœ¬æ ·æœ¬ï¼Œè´¨é‡åº”è¯¥æ˜¯åˆæ ¼çš„ã€‚"</span>,
    <span class="hljs-string">""</span>,  <span class="hljs-comment"># è´¨é‡é—®é¢˜ï¼šç©ºæ–‡æœ¬</span>
    <span class="hljs-string">"å¦ä¸€ä¸ªæ­£å¸¸çš„é«˜è´¨é‡æ–‡æœ¬ï¼Œç”¨äºæµ‹è¯•ç›‘æ§ç³»ç»Ÿçš„åŠŸèƒ½ã€‚"</span>
]

print(<span class="hljs-string">"ğŸ“Š å¼€å§‹æ¨¡æ‹Ÿæ•°æ®è´¨é‡æ£€æŸ¥..."</span>)
<span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> enumerate(test_texts):
    result = monitor.check_data_quality(text)
    print(<span class="hljs-string">f"æ ·æœ¬ <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: è´¨é‡è¯„åˆ† <span class="hljs-subst">{result[<span class="hljs-string">'quality_score'</span>]:<span class="hljs-number">.1</span>f}</span>, "</span>
          <span class="hljs-string">f"é€šè¿‡: <span class="hljs-subst">{<span class="hljs-string">'âœ…'</span> <span class="hljs-keyword">if</span> result[<span class="hljs-string">'passed'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">'âŒ'</span>}</span>"</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">'issues'</span>]:
        print(<span class="hljs-string">f"  é—®é¢˜: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(result[<span class="hljs-string">'issues'</span>])}</span>"</span>)
    time.sleep(<span class="hljs-number">0.5</span>)  <span class="hljs-comment"># æ¨¡æ‹Ÿå®æ—¶å¤„ç†</span>

<span class="hljs-comment"># ç­‰å¾…ä¸€æ®µæ—¶é—´è®©ç›‘æ§ç³»ç»Ÿå¤„ç†</span>
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># æ˜¾ç¤ºç›‘æ§é¢æ¿</span>
print(<span class="hljs-string">f"\nğŸ“ˆ è´¨é‡ç›‘æ§é¢æ¿:"</span>)
dashboard = monitor.get_quality_dashboard()
<span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> dashboard.items():
    <span class="hljs-keyword">if</span> key != <span class="hljs-string">'recent_quality_trend'</span>:
        print(<span class="hljs-string">f"  <span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)

<span class="hljs-comment"># å¯è§†åŒ–ç›‘æ§é¢æ¿</span>
monitor.visualize_dashboard()

<span class="hljs-comment"># åœæ­¢ç›‘æ§</span>
monitor.stop_monitoring()
</div></code></pre>
<p>é€šè¿‡è¿™ä¸€èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å»ºç«‹äº†å®Œæ•´çš„æ•°æ®å·¥ç¨‹ä¸é¢„å¤„ç†ä½“ç³»ã€‚ä»æ•°æ®è´¨é‡åˆ†æåˆ°å®æ—¶ç›‘æ§ï¼Œä»æ•°æ®æ¸…æ´—åˆ°æ™ºèƒ½å¢å¼ºï¼Œæˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ç°åœ¨æ‹¥æœ‰äº†é«˜æ•ˆçš„åŸææ–™åŠ å·¥è½¦é—´ã€‚</p>
<p>åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ è®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§æŠ€æœ¯ï¼Œç¡®ä¿å¾®è°ƒè¿‡ç¨‹çš„é«˜æ•ˆå’Œç¨³å®šã€‚</p>
<hr>
<h2 id="284-%E8%AE%AD%E7%BB%83%E4%BC%98%E5%8C%96%E4%B8%8E%E7%9B%91%E6%8E%A7">28.4 è®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§</h2>
<h3 id="%E2%9A%99%EF%B8%8F-%E8%BF%9B%E5%85%A5%E6%99%BA%E8%83%BD%E8%AE%AD%E7%BB%83%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83">âš™ï¸ è¿›å…¥æ™ºèƒ½è®­ç»ƒç›‘æ§ä¸­å¿ƒ</h3>
<p>åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼Œè®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§å°±åƒæ˜¯ç”Ÿäº§çº¿çš„æ™ºèƒ½æ§åˆ¶ä¸­å¿ƒã€‚å®ƒä¸ä»…è¦ç¡®ä¿ç”Ÿäº§è¿‡ç¨‹çš„é«˜æ•ˆè¿è¡Œï¼Œè¿˜è¦å®æ—¶ç›‘æ§å„é¡¹æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜ã€‚</p>
<p>è®©æˆ‘ä»¬æ·±å…¥è¿™ä¸ªæ™ºèƒ½æ§åˆ¶ä¸­å¿ƒï¼Œå­¦ä¹ å¦‚ä½•æ‰“é€ ä¸€ä¸ªå…¨æ–¹ä½çš„è®­ç»ƒç›‘æ§å’Œä¼˜åŒ–ç³»ç»Ÿï¼</p>
<h4 id="%F0%9F%8E%9B%EF%B8%8F-%E8%AE%AD%E7%BB%83%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84">ğŸ›ï¸ è®­ç»ƒç›‘æ§ç³»ç»Ÿæ¶æ„</h4>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬é€šè¿‡Mermaidå›¾äº†è§£å®Œæ•´çš„è®­ç»ƒç›‘æ§ç³»ç»Ÿæ¶æ„ï¼š</p>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    A[è®­ç»ƒå¯åŠ¨] --> B[å‚æ•°åˆå§‹åŒ–]
    B --> C[è®­ç»ƒå¾ªç¯å¼€å§‹]
    
    C --> D[æ‰¹æ¬¡æ•°æ®åŠ è½½]
    D --> E[å‰å‘ä¼ æ’­]
    E --> F[æŸå¤±è®¡ç®—]
    F --> G[åå‘ä¼ æ’­]
    G --> H[å‚æ•°æ›´æ–°]
    
    H --> I[æ€§èƒ½ç›‘æ§]
    I --> J{ç›‘æ§æ£€æŸ¥}
    J -->|æ­£å¸¸| K[è®°å½•æŒ‡æ ‡]
    J -->|å¼‚å¸¸| L[å¼‚å¸¸å¤„ç†]
    
    K --> M{è®­ç»ƒå®Œæˆ?}
    L --> N[è°ƒæ•´ç­–ç•¥]
    N --> M
    
    M -->|å¦| D
    M -->|æ˜¯| O[è®­ç»ƒç»“æŸ]
    
    I --> P[å®æ—¶å¯è§†åŒ–]
    I --> Q[å‘Šè­¦ç³»ç»Ÿ]
    I --> R[è‡ªåŠ¨è°ƒä¼˜]
    
    style A fill:#e1f5fe
    style O fill:#e8f5e8
    style J fill:#fff3e0
    style L fill:#ffebee
    style R fill:#f3e5f5
</div></code></pre>
<p>è®©æˆ‘ä»¬å®ç°è¿™ä¸ªå®Œæ•´çš„è®­ç»ƒç›‘æ§å’Œä¼˜åŒ–ç³»ç»Ÿï¼š</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim
<span class="hljs-keyword">from</span> torch.optim.lr_scheduler <span class="hljs-keyword">import</span> ReduceLROnPlateau, CosineAnnealingLR
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict, deque
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> warnings
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, List, Optional, Callable, Any
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass, field

<span class="hljs-meta">@dataclass</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrainingConfig</span>:</span>
    <span class="hljs-string">"""è®­ç»ƒé…ç½®ç±»"""</span>
    learning_rate: float = <span class="hljs-number">2e-5</span>
    batch_size: int = <span class="hljs-number">32</span>
    num_epochs: int = <span class="hljs-number">10</span>
    warmup_steps: int = <span class="hljs-number">100</span>
    weight_decay: float = <span class="hljs-number">0.01</span>
    gradient_clip_norm: float = <span class="hljs-number">1.0</span>
    early_stopping_patience: int = <span class="hljs-number">3</span>
    save_best_model: bool = <span class="hljs-literal">True</span>
    log_interval: int = <span class="hljs-number">10</span>
    eval_interval: int = <span class="hljs-number">100</span>
    
    <span class="hljs-comment"># ä¼˜åŒ–å™¨é…ç½®</span>
    optimizer_type: str = <span class="hljs-string">"adamw"</span>
    scheduler_type: str = <span class="hljs-string">"reduce_on_plateau"</span>
    
    <span class="hljs-comment"># ç›‘æ§é…ç½®</span>
    monitor_gpu: bool = <span class="hljs-literal">True</span>
    monitor_memory: bool = <span class="hljs-literal">True</span>
    enable_profiling: bool = <span class="hljs-literal">False</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrainingMetrics</span>:</span>
    <span class="hljs-string">"""è®­ç»ƒæŒ‡æ ‡ç®¡ç†å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, history_size: int = <span class="hljs-number">1000</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–æŒ‡æ ‡ç®¡ç†å™¨
        Args:
            history_size: å†å²è®°å½•å¤§å°
        """</span>
        self.history_size = history_size
        self.metrics = defaultdict(<span class="hljs-keyword">lambda</span>: deque(maxlen=history_size))
        self.best_metrics = {}
        self.current_epoch = <span class="hljs-number">0</span>
        self.current_step = <span class="hljs-number">0</span>
        
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span><span class="hljs-params">(self, metric_name: str, value: float, step: Optional[int] = None)</span>:</span>
        <span class="hljs-string">"""
        æ›´æ–°æŒ‡æ ‡
        Args:
            metric_name: æŒ‡æ ‡åç§°
            value: æŒ‡æ ‡å€¼
            step: æ­¥æ•°
        """</span>
        <span class="hljs-keyword">if</span> step <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            step = self.current_step
            
        self.metrics[metric_name].append((step, value))
        
        <span class="hljs-comment"># æ›´æ–°æœ€ä½³æŒ‡æ ‡</span>
        <span class="hljs-keyword">if</span> metric_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.best_metrics:
            self.best_metrics[metric_name] = value
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">if</span> <span class="hljs-string">'loss'</span> <span class="hljs-keyword">in</span> metric_name.lower():
                self.best_metrics[metric_name] = min(self.best_metrics[metric_name], value)
            <span class="hljs-keyword">else</span>:
                self.best_metrics[metric_name] = max(self.best_metrics[metric_name], value)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_latest</span><span class="hljs-params">(self, metric_name: str)</span> -&gt; Optional[float]:</span>
        <span class="hljs-string">"""è·å–æœ€æ–°æŒ‡æ ‡å€¼"""</span>
        <span class="hljs-keyword">if</span> metric_name <span class="hljs-keyword">in</span> self.metrics <span class="hljs-keyword">and</span> self.metrics[metric_name]:
            <span class="hljs-keyword">return</span> self.metrics[metric_name][<span class="hljs-number">-1</span>][<span class="hljs-number">1</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_average</span><span class="hljs-params">(self, metric_name: str, last_n: int = <span class="hljs-number">10</span>)</span> -&gt; Optional[float]:</span>
        <span class="hljs-string">"""è·å–å¹³å‡å€¼"""</span>
        <span class="hljs-keyword">if</span> metric_name <span class="hljs-keyword">in</span> self.metrics <span class="hljs-keyword">and</span> self.metrics[metric_name]:
            values = [item[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> list(self.metrics[metric_name])[-last_n:]]
            <span class="hljs-keyword">return</span> np.mean(values)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_trend</span><span class="hljs-params">(self, metric_name: str, last_n: int = <span class="hljs-number">20</span>)</span> -&gt; str:</span>
        <span class="hljs-string">"""è·å–è¶‹åŠ¿"""</span>
        <span class="hljs-keyword">if</span> metric_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.metrics <span class="hljs-keyword">or</span> len(self.metrics[metric_name]) &lt; last_n:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"insufficient_data"</span>
        
        values = [item[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> list(self.metrics[metric_name])[-last_n:]]
        
        <span class="hljs-comment"># è®¡ç®—è¶‹åŠ¿</span>
        x = np.arange(len(values))
        slope = np.polyfit(x, values, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
        
        <span class="hljs-keyword">if</span> abs(slope) &lt; <span class="hljs-number">1e-6</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"stable"</span>
        <span class="hljs-keyword">elif</span> slope &gt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"increasing"</span> <span class="hljs-keyword">if</span> <span class="hljs-string">'loss'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> metric_name.lower() <span class="hljs-keyword">else</span> <span class="hljs-string">"deteriorating"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"decreasing"</span> <span class="hljs-keyword">if</span> <span class="hljs-string">'loss'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> metric_name.lower() <span class="hljs-keyword">else</span> <span class="hljs-string">"improving"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrainingMonitor</span>:</span>
    <span class="hljs-string">"""è®­ç»ƒç›‘æ§å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, config: TrainingConfig)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–è®­ç»ƒç›‘æ§å™¨
        Args:
            config: è®­ç»ƒé…ç½®
        """</span>
        self.config = config
        self.metrics = TrainingMetrics()
        self.alerts = []
        self.monitoring_active = <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># GPUç›‘æ§</span>
        self.gpu_available = torch.cuda.is_available()
        <span class="hljs-keyword">if</span> self.gpu_available <span class="hljs-keyword">and</span> config.monitor_gpu:
            self.device = torch.device(<span class="hljs-string">'cuda'</span>)
        <span class="hljs-keyword">else</span>:
            self.device = torch.device(<span class="hljs-string">'cpu'</span>)
        
        print(<span class="hljs-string">f"ğŸ›ï¸ è®­ç»ƒç›‘æ§å™¨åˆå§‹åŒ–å®Œæˆï¼Œè®¾å¤‡: <span class="hljs-subst">{self.device}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start_monitoring</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯åŠ¨ç›‘æ§"""</span>
        self.monitoring_active = <span class="hljs-literal">True</span>
        
        <span class="hljs-comment"># å¯åŠ¨ç›‘æ§çº¿ç¨‹</span>
        <span class="hljs-keyword">if</span> self.config.monitor_gpu <span class="hljs-keyword">or</span> self.config.monitor_memory:
            monitor_thread = threading.Thread(target=self._system_monitor_loop)
            monitor_thread.daemon = <span class="hljs-literal">True</span>
            monitor_thread.start()
        
        print(<span class="hljs-string">"ğŸš€ è®­ç»ƒç›‘æ§ç³»ç»Ÿå¯åŠ¨"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop_monitoring</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""åœæ­¢ç›‘æ§"""</span>
        self.monitoring_active = <span class="hljs-literal">False</span>
        print(<span class="hljs-string">"â¹ï¸ è®­ç»ƒç›‘æ§ç³»ç»Ÿåœæ­¢"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log_metrics</span><span class="hljs-params">(self, metrics_dict: Dict[str, float], step: int)</span>:</span>
        <span class="hljs-string">"""
        è®°å½•æŒ‡æ ‡
        Args:
            metrics_dict: æŒ‡æ ‡å­—å…¸
            step: å½“å‰æ­¥æ•°
        """</span>
        self.metrics.current_step = step
        
        <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">in</span> metrics_dict.items():
            self.metrics.update(name, value, step)
        
        <span class="hljs-comment"># æ£€æŸ¥å¼‚å¸¸</span>
        self._check_anomalies(metrics_dict)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_check_anomalies</span><span class="hljs-params">(self, metrics_dict: Dict[str, float])</span>:</span>
        <span class="hljs-string">"""æ£€æŸ¥å¼‚å¸¸æƒ…å†µ"""</span>
        <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">in</span> metrics_dict.items():
            <span class="hljs-comment"># æ£€æŸ¥NaNæˆ–æ— ç©·å¤§</span>
            <span class="hljs-keyword">if</span> np.isnan(value) <span class="hljs-keyword">or</span> np.isinf(value):
                self._add_alert(<span class="hljs-string">f"å¼‚å¸¸å€¼æ£€æµ‹: <span class="hljs-subst">{name}</span> = <span class="hljs-subst">{value}</span>"</span>, <span class="hljs-string">"error"</span>)
            
            <span class="hljs-comment"># æ£€æŸ¥æŸå¤±çˆ†ç‚¸</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'loss'</span> <span class="hljs-keyword">in</span> name.lower() <span class="hljs-keyword">and</span> value &gt; <span class="hljs-number">100</span>:
                self._add_alert(<span class="hljs-string">f"æŸå¤±çˆ†ç‚¸: <span class="hljs-subst">{name}</span> = <span class="hljs-subst">{value:<span class="hljs-number">.4</span>f}</span>"</span>, <span class="hljs-string">"warning"</span>)
            
            <span class="hljs-comment"># æ£€æŸ¥æ¢¯åº¦æ¶ˆå¤±</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'grad_norm'</span> <span class="hljs-keyword">in</span> name.lower() <span class="hljs-keyword">and</span> value &lt; <span class="hljs-number">1e-7</span>:
                self._add_alert(<span class="hljs-string">f"æ¢¯åº¦æ¶ˆå¤±: <span class="hljs-subst">{name}</span> = <span class="hljs-subst">{value:<span class="hljs-number">.2</span>e}</span>"</span>, <span class="hljs-string">"warning"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_add_alert</span><span class="hljs-params">(self, message: str, level: str = <span class="hljs-string">"info"</span>)</span>:</span>
        <span class="hljs-string">"""æ·»åŠ å‘Šè­¦"""</span>
        alert = {
            <span class="hljs-string">'timestamp'</span>: datetime.now().isoformat(),
            <span class="hljs-string">'message'</span>: message,
            <span class="hljs-string">'level'</span>: level,
            <span class="hljs-string">'step'</span>: self.metrics.current_step
        }
        self.alerts.append(alert)
        
        <span class="hljs-comment"># æ‰“å°å‘Šè­¦</span>
        emoji = {<span class="hljs-string">"info"</span>: <span class="hljs-string">"â„¹ï¸"</span>, <span class="hljs-string">"warning"</span>: <span class="hljs-string">"âš ï¸"</span>, <span class="hljs-string">"error"</span>: <span class="hljs-string">"ğŸš¨"</span>}
        print(<span class="hljs-string">f"<span class="hljs-subst">{emoji.get(level, <span class="hljs-string">'â„¹ï¸'</span>)}</span> <span class="hljs-subst">{message}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_system_monitor_loop</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ç³»ç»Ÿç›‘æ§å¾ªç¯"""</span>
        <span class="hljs-keyword">while</span> self.monitoring_active:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># GPUç›‘æ§</span>
                <span class="hljs-keyword">if</span> self.gpu_available <span class="hljs-keyword">and</span> self.config.monitor_gpu:
                    gpu_memory = torch.cuda.memory_allocated() / <span class="hljs-number">1024</span>**<span class="hljs-number">3</span>  <span class="hljs-comment"># GB</span>
                    gpu_memory_cached = torch.cuda.memory_reserved() / <span class="hljs-number">1024</span>**<span class="hljs-number">3</span>  <span class="hljs-comment"># GB</span>
                    
                    self.metrics.update(<span class="hljs-string">'gpu_memory_allocated'</span>, gpu_memory)
                    self.metrics.update(<span class="hljs-string">'gpu_memory_cached'</span>, gpu_memory_cached)
                    
                    <span class="hljs-comment"># GPUå†…å­˜å‘Šè­¦</span>
                    <span class="hljs-keyword">if</span> gpu_memory &gt; <span class="hljs-number">10</span>:  <span class="hljs-comment"># è¶…è¿‡10GBå‘Šè­¦</span>
                        self._add_alert(<span class="hljs-string">f"GPUå†…å­˜ä½¿ç”¨è¿‡é«˜: <span class="hljs-subst">{gpu_memory:<span class="hljs-number">.1</span>f}</span>GB"</span>, <span class="hljs-string">"warning"</span>)
                
                time.sleep(<span class="hljs-number">5</span>)  <span class="hljs-comment"># æ¯5ç§’ç›‘æ§ä¸€æ¬¡</span>
                
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                print(<span class="hljs-string">f"ç³»ç»Ÿç›‘æ§é”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
                time.sleep(<span class="hljs-number">10</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_training_summary</span><span class="hljs-params">(self)</span> -&gt; Dict:</span>
        <span class="hljs-string">"""è·å–è®­ç»ƒæ‘˜è¦"""</span>
        summary = {
            <span class="hljs-string">'current_step'</span>: self.metrics.current_step,
            <span class="hljs-string">'current_epoch'</span>: self.metrics.current_epoch,
            <span class="hljs-string">'best_metrics'</span>: self.metrics.best_metrics.copy(),
            <span class="hljs-string">'recent_trends'</span>: {},
            <span class="hljs-string">'alerts_count'</span>: len(self.alerts),
            <span class="hljs-string">'system_status'</span>: <span class="hljs-string">'normal'</span>
        }
        
        <span class="hljs-comment"># è®¡ç®—è¶‹åŠ¿</span>
        <span class="hljs-keyword">for</span> metric_name <span class="hljs-keyword">in</span> self.metrics.metrics.keys():
            <span class="hljs-keyword">if</span> metric_name.startswith((<span class="hljs-string">'train_'</span>, <span class="hljs-string">'val_'</span>, <span class="hljs-string">'test_'</span>)):
                summary[<span class="hljs-string">'recent_trends'</span>][metric_name] = self.metrics.get_trend(metric_name)
        
        <span class="hljs-keyword">return</span> summary
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_training_progress</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–è®­ç»ƒè¿›åº¦"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.metrics.metrics:
            print(<span class="hljs-string">"æš‚æ— è®­ç»ƒæ•°æ®"</span>)
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment"># å‡†å¤‡æ•°æ®</span>
        metric_names = [name <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self.metrics.metrics.keys() 
                       <span class="hljs-keyword">if</span> name.startswith((<span class="hljs-string">'train_'</span>, <span class="hljs-string">'val_'</span>, <span class="hljs-string">'test_'</span>))]
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> metric_names:
            print(<span class="hljs-string">"æš‚æ— è®­ç»ƒæŒ‡æ ‡æ•°æ®"</span>)
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment"># åˆ›å»ºå­å›¾</span>
        n_metrics = len(metric_names)
        n_cols = min(<span class="hljs-number">3</span>, n_metrics)
        n_rows = (n_metrics + n_cols - <span class="hljs-number">1</span>) // n_cols
        
        fig, axes = plt.subplots(n_rows, n_cols, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">5</span>*n_rows))
        <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span>:
            axes = [axes] <span class="hljs-keyword">if</span> n_cols == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> axes
        <span class="hljs-keyword">else</span>:
            axes = axes.flatten()
        
        <span class="hljs-keyword">for</span> i, metric_name <span class="hljs-keyword">in</span> enumerate(metric_names):
            <span class="hljs-keyword">if</span> i &gt;= len(axes):
                <span class="hljs-keyword">break</span>
                
            data = list(self.metrics.metrics[metric_name])
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
                <span class="hljs-keyword">continue</span>
                
            steps, values = zip(*data)
            
            ax = axes[i]
            ax.plot(steps, values, marker=<span class="hljs-string">'o'</span>, markersize=<span class="hljs-number">2</span>, linewidth=<span class="hljs-number">1</span>)
            ax.set_title(<span class="hljs-string">f'<span class="hljs-subst">{metric_name}</span> (æœ€æ–°: <span class="hljs-subst">{values[<span class="hljs-number">-1</span>]:<span class="hljs-number">.4</span>f}</span>)'</span>)
            ax.set_xlabel(<span class="hljs-string">'Steps'</span>)
            ax.set_ylabel(<span class="hljs-string">'Value'</span>)
            ax.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
            
            <span class="hljs-comment"># æ·»åŠ è¶‹åŠ¿çº¿</span>
            <span class="hljs-keyword">if</span> len(values) &gt; <span class="hljs-number">10</span>:
                z = np.polyfit(range(len(values)), values, <span class="hljs-number">1</span>)
                p = np.poly1d(z)
                ax.plot(steps, p(range(len(values))), <span class="hljs-string">"--"</span>, alpha=<span class="hljs-number">0.7</span>, color=<span class="hljs-string">'red'</span>)
        
        <span class="hljs-comment"># éšè—å¤šä½™çš„å­å›¾</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(metric_names), len(axes)):
            axes[i].set_visible(<span class="hljs-literal">False</span>)
        
        plt.tight_layout()
        plt.show()

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmartOptimizer</span>:</span>
    <span class="hljs-string">"""æ™ºèƒ½ä¼˜åŒ–å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model: nn.Module, config: TrainingConfig)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–æ™ºèƒ½ä¼˜åŒ–å™¨
        Args:
            model: æ¨¡å‹
            config: è®­ç»ƒé…ç½®
        """</span>
        self.model = model
        self.config = config
        
        <span class="hljs-comment"># åˆ›å»ºä¼˜åŒ–å™¨</span>
        self.optimizer = self._create_optimizer()
        
        <span class="hljs-comment"># åˆ›å»ºå­¦ä¹ ç‡è°ƒåº¦å™¨</span>
        self.scheduler = self._create_scheduler()
        
        <span class="hljs-comment"># æ¢¯åº¦è£å‰ª</span>
        self.grad_clip_norm = config.gradient_clip_norm
        
        print(<span class="hljs-string">f"ğŸ”§ æ™ºèƒ½ä¼˜åŒ–å™¨åˆå§‹åŒ–: <span class="hljs-subst">{config.optimizer_type}</span> + <span class="hljs-subst">{config.scheduler_type}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_create_optimizer</span><span class="hljs-params">(self)</span> -&gt; optim.Optimizer:</span>
        <span class="hljs-string">"""åˆ›å»ºä¼˜åŒ–å™¨"""</span>
        <span class="hljs-keyword">if</span> self.config.optimizer_type.lower() == <span class="hljs-string">"adamw"</span>:
            <span class="hljs-keyword">return</span> optim.AdamW(
                self.model.parameters(),
                lr=self.config.learning_rate,
                weight_decay=self.config.weight_decay
            )
        <span class="hljs-keyword">elif</span> self.config.optimizer_type.lower() == <span class="hljs-string">"adam"</span>:
            <span class="hljs-keyword">return</span> optim.Adam(
                self.model.parameters(),
                lr=self.config.learning_rate,
                weight_decay=self.config.weight_decay
            )
        <span class="hljs-keyword">elif</span> self.config.optimizer_type.lower() == <span class="hljs-string">"sgd"</span>:
            <span class="hljs-keyword">return</span> optim.SGD(
                self.model.parameters(),
                lr=self.config.learning_rate,
                momentum=<span class="hljs-number">0.9</span>,
                weight_decay=self.config.weight_decay
            )
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"ä¸æ”¯æŒçš„ä¼˜åŒ–å™¨ç±»å‹: <span class="hljs-subst">{self.config.optimizer_type}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_create_scheduler</span><span class="hljs-params">(self)</span> -&gt; Optional[object]:</span>
        <span class="hljs-string">"""åˆ›å»ºå­¦ä¹ ç‡è°ƒåº¦å™¨"""</span>
        <span class="hljs-keyword">if</span> self.config.scheduler_type.lower() == <span class="hljs-string">"reduce_on_plateau"</span>:
            <span class="hljs-keyword">return</span> ReduceLROnPlateau(
                self.optimizer,
                mode=<span class="hljs-string">'min'</span>,
                factor=<span class="hljs-number">0.5</span>,
                patience=<span class="hljs-number">2</span>,
                verbose=<span class="hljs-literal">True</span>
            )
        <span class="hljs-keyword">elif</span> self.config.scheduler_type.lower() == <span class="hljs-string">"cosine"</span>:
            <span class="hljs-keyword">return</span> CosineAnnealingLR(
                self.optimizer,
                T_max=self.config.num_epochs,
                eta_min=<span class="hljs-number">1e-7</span>
            )
        <span class="hljs-keyword">elif</span> self.config.scheduler_type.lower() == <span class="hljs-string">"none"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"ä¸æ”¯æŒçš„è°ƒåº¦å™¨ç±»å‹: <span class="hljs-subst">{self.config.scheduler_type}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">step</span><span class="hljs-params">(self, loss: torch.Tensor)</span> -&gt; Dict[str, float]:</span>
        <span class="hljs-string">"""
        æ‰§è¡Œä¼˜åŒ–æ­¥éª¤
        Args:
            loss: æŸå¤±å€¼
        Returns:
            ä¼˜åŒ–æŒ‡æ ‡
        """</span>
        <span class="hljs-comment"># åå‘ä¼ æ’­</span>
        loss.backward()
        
        <span class="hljs-comment"># è®¡ç®—æ¢¯åº¦èŒƒæ•°</span>
        grad_norm = torch.nn.utils.clip_grad_norm_(
            self.model.parameters(), 
            self.grad_clip_norm
        )
        
        <span class="hljs-comment"># ä¼˜åŒ–å™¨æ­¥éª¤</span>
        self.optimizer.step()
        self.optimizer.zero_grad()
        
        <span class="hljs-comment"># å­¦ä¹ ç‡è°ƒåº¦</span>
        current_lr = self.optimizer.param_groups[<span class="hljs-number">0</span>][<span class="hljs-string">'lr'</span>]
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'grad_norm'</span>: float(grad_norm),
            <span class="hljs-string">'learning_rate'</span>: current_lr
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scheduler_step</span><span class="hljs-params">(self, metric: Optional[float] = None)</span>:</span>
        <span class="hljs-string">"""å­¦ä¹ ç‡è°ƒåº¦å™¨æ­¥éª¤"""</span>
        <span class="hljs-keyword">if</span> self.scheduler <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">if</span> isinstance(self.scheduler, ReduceLROnPlateau):
                <span class="hljs-keyword">if</span> metric <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                    self.scheduler.step(metric)
            <span class="hljs-keyword">else</span>:
                self.scheduler.step()

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdvancedTrainer</span>:</span>
    <span class="hljs-string">"""é«˜çº§è®­ç»ƒå™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model: nn.Module, config: TrainingConfig)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–é«˜çº§è®­ç»ƒå™¨
        Args:
            model: æ¨¡å‹
            config: è®­ç»ƒé…ç½®
        """</span>
        self.model = model
        self.config = config
        
        <span class="hljs-comment"># åˆå§‹åŒ–ç»„ä»¶</span>
        self.monitor = TrainingMonitor(config)
        self.optimizer = SmartOptimizer(model, config)
        
        <span class="hljs-comment"># æŸå¤±å‡½æ•°</span>
        self.criterion = nn.CrossEntropyLoss()
        
        <span class="hljs-comment"># æ—©åœæœºåˆ¶</span>
        self.early_stopping_counter = <span class="hljs-number">0</span>
        self.best_val_loss = float(<span class="hljs-string">'inf'</span>)
        
        <span class="hljs-comment"># è®­ç»ƒçŠ¶æ€</span>
        self.training_active = <span class="hljs-literal">False</span>
        
        print(<span class="hljs-string">f"ğŸ¯ é«˜çº§è®­ç»ƒå™¨åˆå§‹åŒ–å®Œæˆ"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train</span><span class="hljs-params">(self, train_loader, val_loader, test_loader=None)</span>:</span>
        <span class="hljs-string">"""
        å¼€å§‹è®­ç»ƒ
        Args:
            train_loader: è®­ç»ƒæ•°æ®åŠ è½½å™¨
            val_loader: éªŒè¯æ•°æ®åŠ è½½å™¨
            test_loader: æµ‹è¯•æ•°æ®åŠ è½½å™¨ï¼ˆå¯é€‰ï¼‰
        """</span>
        print(<span class="hljs-string">"ğŸš€ å¼€å§‹è®­ç»ƒ..."</span>)
        
        <span class="hljs-comment"># å¯åŠ¨ç›‘æ§</span>
        self.monitor.start_monitoring()
        self.training_active = <span class="hljs-literal">True</span>
        
        <span class="hljs-comment"># ç§»åŠ¨æ¨¡å‹åˆ°è®¾å¤‡</span>
        self.model.to(self.monitor.device)
        
        global_step = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(self.config.num_epochs):
                print(<span class="hljs-string">f"\nğŸ“… Epoch <span class="hljs-subst">{epoch + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{self.config.num_epochs}</span>"</span>)
                
                <span class="hljs-comment"># è®­ç»ƒé˜¶æ®µ</span>
                train_metrics = self._train_epoch(train_loader, global_step)
                
                <span class="hljs-comment"># éªŒè¯é˜¶æ®µ</span>
                val_metrics = self._validate_epoch(val_loader)
                
                <span class="hljs-comment"># åˆå¹¶æŒ‡æ ‡</span>
                epoch_metrics = {**train_metrics, **val_metrics}
                
                <span class="hljs-comment"># è®°å½•epochæŒ‡æ ‡</span>
                self.monitor.metrics.current_epoch = epoch + <span class="hljs-number">1</span>
                self.monitor.log_metrics(epoch_metrics, global_step)
                
                <span class="hljs-comment"># å­¦ä¹ ç‡è°ƒåº¦</span>
                self.optimizer.scheduler_step(val_metrics.get(<span class="hljs-string">'val_loss'</span>))
                
                <span class="hljs-comment"># æ—©åœæ£€æŸ¥</span>
                <span class="hljs-keyword">if</span> self._check_early_stopping(val_metrics.get(<span class="hljs-string">'val_loss'</span>, float(<span class="hljs-string">'inf'</span>))):
                    print(<span class="hljs-string">"ğŸ›‘ æ—©åœè§¦å‘ï¼Œåœæ­¢è®­ç»ƒ"</span>)
                    <span class="hljs-keyword">break</span>
                
                <span class="hljs-comment"># æ‰“å°epochæ€»ç»“</span>
                self._print_epoch_summary(epoch + <span class="hljs-number">1</span>, epoch_metrics)
                
                <span class="hljs-comment"># æ›´æ–°å…¨å±€æ­¥æ•°</span>
                global_step += len(train_loader)
            
            <span class="hljs-comment"># æµ‹è¯•é˜¶æ®µ</span>
            <span class="hljs-keyword">if</span> test_loader <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                print(<span class="hljs-string">"\nğŸ§ª å¼€å§‹æµ‹è¯•..."</span>)
                test_metrics = self._test_epoch(test_loader)
                print(<span class="hljs-string">f"æµ‹è¯•ç»“æœ: <span class="hljs-subst">{test_metrics}</span>"</span>)
        
        <span class="hljs-keyword">except</span> KeyboardInterrupt:
            print(<span class="hljs-string">"\nâ¹ï¸ è®­ç»ƒè¢«ç”¨æˆ·ä¸­æ–­"</span>)
        
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            print(<span class="hljs-string">f"\nâŒ è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        
        <span class="hljs-keyword">finally</span>:
            self.training_active = <span class="hljs-literal">False</span>
            self.monitor.stop_monitoring()
            
        print(<span class="hljs-string">"âœ… è®­ç»ƒå®Œæˆ"</span>)
        
        <span class="hljs-comment"># æ˜¾ç¤ºè®­ç»ƒæ€»ç»“</span>
        self._show_training_summary()
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_train_epoch</span><span class="hljs-params">(self, train_loader, global_step_start: int)</span> -&gt; Dict[str, float]:</span>
        <span class="hljs-string">"""è®­ç»ƒä¸€ä¸ªepoch"""</span>
        self.model.train()
        
        total_loss = <span class="hljs-number">0.0</span>
        total_samples = <span class="hljs-number">0</span>
        correct_predictions = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> batch_idx, batch <span class="hljs-keyword">in</span> enumerate(train_loader):
            global_step = global_step_start + batch_idx
            
            <span class="hljs-comment"># ç§»åŠ¨æ•°æ®åˆ°è®¾å¤‡</span>
            input_ids = batch[<span class="hljs-string">'input_ids'</span>].to(self.monitor.device)
            attention_mask = batch[<span class="hljs-string">'attention_mask'</span>].to(self.monitor.device)
            labels = batch[<span class="hljs-string">'label'</span>].to(self.monitor.device)
            
            <span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
            logits = self.model(input_ids, attention_mask)
            loss = self.criterion(logits, labels)
            
            <span class="hljs-comment"># ä¼˜åŒ–æ­¥éª¤</span>
            opt_metrics = self.optimizer.step(loss)
            
            <span class="hljs-comment"># ç»Ÿè®¡</span>
            total_loss += loss.item()
            total_samples += labels.size(<span class="hljs-number">0</span>)
            
            predictions = torch.argmax(logits, dim=<span class="hljs-number">1</span>)
            correct_predictions += (predictions == labels).sum().item()
            
            <span class="hljs-comment"># è®°å½•æ‰¹æ¬¡æŒ‡æ ‡</span>
            <span class="hljs-keyword">if</span> batch_idx % self.config.log_interval == <span class="hljs-number">0</span>:
                batch_metrics = {
                    <span class="hljs-string">'train_loss'</span>: loss.item(),
                    <span class="hljs-string">'train_accuracy'</span>: (predictions == labels).float().mean().item(),
                    **opt_metrics
                }
                self.monitor.log_metrics(batch_metrics, global_step)
                
                print(<span class="hljs-string">f"  Batch <span class="hljs-subst">{batch_idx}</span>/<span class="hljs-subst">{len(train_loader)}</span>: "</span>
                      <span class="hljs-string">f"Loss=<span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>, "</span>
                      <span class="hljs-string">f"Acc=<span class="hljs-subst">{batch_metrics[<span class="hljs-string">'train_accuracy'</span>]:<span class="hljs-number">.3</span>f}</span>, "</span>
                      <span class="hljs-string">f"LR=<span class="hljs-subst">{opt_metrics[<span class="hljs-string">'learning_rate'</span>]:<span class="hljs-number">.2</span>e}</span>"</span>)
        
        <span class="hljs-comment"># è®¡ç®—epochå¹³å‡æŒ‡æ ‡</span>
        avg_loss = total_loss / len(train_loader)
        avg_accuracy = correct_predictions / total_samples
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'train_loss_epoch'</span>: avg_loss,
            <span class="hljs-string">'train_accuracy_epoch'</span>: avg_accuracy
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_validate_epoch</span><span class="hljs-params">(self, val_loader)</span> -&gt; Dict[str, float]:</span>
        <span class="hljs-string">"""éªŒè¯ä¸€ä¸ªepoch"""</span>
        self.model.eval()
        
        total_loss = <span class="hljs-number">0.0</span>
        total_samples = <span class="hljs-number">0</span>
        correct_predictions = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">with</span> torch.no_grad():
            <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> val_loader:
                <span class="hljs-comment"># ç§»åŠ¨æ•°æ®åˆ°è®¾å¤‡</span>
                input_ids = batch[<span class="hljs-string">'input_ids'</span>].to(self.monitor.device)
                attention_mask = batch[<span class="hljs-string">'attention_mask'</span>].to(self.monitor.device)
                labels = batch[<span class="hljs-string">'label'</span>].to(self.monitor.device)
                
                <span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
                logits = self.model(input_ids, attention_mask)
                loss = self.criterion(logits, labels)
                
                <span class="hljs-comment"># ç»Ÿè®¡</span>
                total_loss += loss.item()
                total_samples += labels.size(<span class="hljs-number">0</span>)
                
                predictions = torch.argmax(logits, dim=<span class="hljs-number">1</span>)
                correct_predictions += (predictions == labels).sum().item()
        
        <span class="hljs-comment"># è®¡ç®—å¹³å‡æŒ‡æ ‡</span>
        avg_loss = total_loss / len(val_loader)
        avg_accuracy = correct_predictions / total_samples
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'val_loss'</span>: avg_loss,
            <span class="hljs-string">'val_accuracy'</span>: avg_accuracy
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_test_epoch</span><span class="hljs-params">(self, test_loader)</span> -&gt; Dict[str, float]:</span>
        <span class="hljs-string">"""æµ‹è¯•ä¸€ä¸ªepoch"""</span>
        self.model.eval()
        
        total_loss = <span class="hljs-number">0.0</span>
        total_samples = <span class="hljs-number">0</span>
        correct_predictions = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">with</span> torch.no_grad():
            <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> test_loader:
                <span class="hljs-comment"># ç§»åŠ¨æ•°æ®åˆ°è®¾å¤‡</span>
                input_ids = batch[<span class="hljs-string">'input_ids'</span>].to(self.monitor.device)
                attention_mask = batch[<span class="hljs-string">'attention_mask'</span>].to(self.monitor.device)
                labels = batch[<span class="hljs-string">'label'</span>].to(self.monitor.device)
                
                <span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
                logits = self.model(input_ids, attention_mask)
                loss = self.criterion(logits, labels)
                
                <span class="hljs-comment"># ç»Ÿè®¡</span>
                total_loss += loss.item()
                total_samples += labels.size(<span class="hljs-number">0</span>)
                
                predictions = torch.argmax(logits, dim=<span class="hljs-number">1</span>)
                correct_predictions += (predictions == labels).sum().item()
        
        <span class="hljs-comment"># è®¡ç®—å¹³å‡æŒ‡æ ‡</span>
        avg_loss = total_loss / len(test_loader)
        avg_accuracy = correct_predictions / total_samples
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'test_loss'</span>: avg_loss,
            <span class="hljs-string">'test_accuracy'</span>: avg_accuracy
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_check_early_stopping</span><span class="hljs-params">(self, val_loss: float)</span> -&gt; bool:</span>
        <span class="hljs-string">"""æ£€æŸ¥æ—©åœæ¡ä»¶"""</span>
        <span class="hljs-keyword">if</span> val_loss &lt; self.best_val_loss:
            self.best_val_loss = val_loss
            self.early_stopping_counter = <span class="hljs-number">0</span>
            
            <span class="hljs-comment"># ä¿å­˜æœ€ä½³æ¨¡å‹</span>
            <span class="hljs-keyword">if</span> self.config.save_best_model:
                torch.save(self.model.state_dict(), <span class="hljs-string">'best_model.pth'</span>)
                print(<span class="hljs-string">"ğŸ’¾ ä¿å­˜æœ€ä½³æ¨¡å‹"</span>)
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">else</span>:
            self.early_stopping_counter += <span class="hljs-number">1</span>
            print(<span class="hljs-string">f"â° æ—©åœè®¡æ•°: <span class="hljs-subst">{self.early_stopping_counter}</span>/<span class="hljs-subst">{self.config.early_stopping_patience}</span>"</span>)
            
            <span class="hljs-keyword">return</span> self.early_stopping_counter &gt;= self.config.early_stopping_patience
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_print_epoch_summary</span><span class="hljs-params">(self, epoch: int, metrics: Dict[str, float])</span>:</span>
        <span class="hljs-string">"""æ‰“å°epochæ€»ç»“"""</span>
        print(<span class="hljs-string">f"\nğŸ“Š Epoch <span class="hljs-subst">{epoch}</span> æ€»ç»“:"</span>)
        <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">in</span> metrics.items():
            print(<span class="hljs-string">f"  <span class="hljs-subst">{name}</span>: <span class="hljs-subst">{value:<span class="hljs-number">.4</span>f}</span>"</span>)
        
        <span class="hljs-comment"># æ˜¾ç¤ºè¶‹åŠ¿</span>
        trends = {}
        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> metrics.keys():
            trend = self.monitor.metrics.get_trend(name)
            <span class="hljs-keyword">if</span> trend != <span class="hljs-string">"insufficient_data"</span>:
                trends[name] = trend
        
        <span class="hljs-keyword">if</span> trends:
            print(<span class="hljs-string">"ğŸ“ˆ è¶‹åŠ¿åˆ†æ:"</span>)
            <span class="hljs-keyword">for</span> name, trend <span class="hljs-keyword">in</span> trends.items():
                emoji = {<span class="hljs-string">"improving"</span>: <span class="hljs-string">"ğŸ“ˆ"</span>, <span class="hljs-string">"deteriorating"</span>: <span class="hljs-string">"ğŸ“‰"</span>, <span class="hljs-string">"stable"</span>: <span class="hljs-string">"â¡ï¸"</span>}.get(trend, <span class="hljs-string">"â“"</span>)
                print(<span class="hljs-string">f"  <span class="hljs-subst">{name}</span>: <span class="hljs-subst">{trend}</span> <span class="hljs-subst">{emoji}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_show_training_summary</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""æ˜¾ç¤ºè®­ç»ƒæ€»ç»“"""</span>
        summary = self.monitor.get_training_summary()
        
        print(<span class="hljs-string">"\nğŸ¯ è®­ç»ƒæ€»ç»“:"</span>)
        print(<span class="hljs-string">f"  æ€»æ­¥æ•°: <span class="hljs-subst">{summary[<span class="hljs-string">'current_step'</span>]}</span>"</span>)
        print(<span class="hljs-string">f"  æ€»è½®æ•°: <span class="hljs-subst">{summary[<span class="hljs-string">'current_epoch'</span>]}</span>"</span>)
        print(<span class="hljs-string">f"  å‘Šè­¦æ•°é‡: <span class="hljs-subst">{summary[<span class="hljs-string">'alerts_count'</span>]}</span>"</span>)
        
        print(<span class="hljs-string">"\nğŸ† æœ€ä½³æŒ‡æ ‡:"</span>)
        <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">in</span> summary[<span class="hljs-string">'best_metrics'</span>].items():
            print(<span class="hljs-string">f"  <span class="hljs-subst">{name}</span>: <span class="hljs-subst">{value:<span class="hljs-number">.4</span>f}</span>"</span>)
        
        <span class="hljs-comment"># å¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹</span>
        self.monitor.visualize_training_progress()

<span class="hljs-comment"># æ¼”ç¤ºè®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§ç³»ç»Ÿ</span>
print(<span class="hljs-string">"âš™ï¸ è®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§ç³»ç»Ÿæ¼”ç¤º"</span>)
print(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ›å»ºæ¨¡æ‹Ÿæ¨¡å‹å’Œæ•°æ®</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleModel</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, vocab_size=<span class="hljs-number">1000</span>, hidden_size=<span class="hljs-number">128</span>, num_classes=<span class="hljs-number">3</span>)</span>:</span>
        super().__init__()
        self.embedding = nn.Embedding(vocab_size, hidden_size)
        self.classifier = nn.Sequential(
            nn.Linear(hidden_size, hidden_size // <span class="hljs-number">2</span>),
            nn.ReLU(),
            nn.Dropout(<span class="hljs-number">0.1</span>),
            nn.Linear(hidden_size // <span class="hljs-number">2</span>, num_classes)
        )
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, input_ids, attention_mask)</span>:</span>
        embeddings = self.embedding(input_ids)
        pooled = embeddings.mean(dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># ç®€å•å¹³å‡æ± åŒ–</span>
        <span class="hljs-keyword">return</span> self.classifier(pooled)

<span class="hljs-comment"># åˆ›å»ºæ¨¡å‹</span>
model = SimpleModel()

<span class="hljs-comment"># åˆ›å»ºè®­ç»ƒé…ç½®</span>
config = TrainingConfig(
    learning_rate=<span class="hljs-number">1e-3</span>,
    batch_size=<span class="hljs-number">16</span>,
    num_epochs=<span class="hljs-number">5</span>,
    early_stopping_patience=<span class="hljs-number">2</span>,
    log_interval=<span class="hljs-number">5</span>
)

<span class="hljs-comment"># åˆ›å»ºè®­ç»ƒå™¨</span>
trainer = AdvancedTrainer(model, config)

print(<span class="hljs-string">"âœ… è®­ç»ƒç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æ¼”ç¤ºè®­ç»ƒè¿‡ç¨‹"</span>)
print(<span class="hljs-string">"ğŸ“ æ³¨æ„: è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒç›‘æ§å’Œä¼˜åŒ–ç³»ç»Ÿæ¼”ç¤º"</span>)
</div></code></pre>
<p>é€šè¿‡è¿™ä¸€èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªå…¨æ–¹ä½çš„è®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§ç³»ç»Ÿã€‚ä»æ™ºèƒ½ä¼˜åŒ–å™¨åˆ°å®æ—¶ç›‘æ§ï¼Œä»å¼‚å¸¸æ£€æµ‹åˆ°æ—©åœæœºåˆ¶ï¼Œæˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ç°åœ¨æ‹¥æœ‰äº†æ™ºèƒ½åŒ–çš„ç”Ÿäº§æ§åˆ¶ä¸­å¿ƒã€‚</p>
<p>åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ æ¨¡å‹è¯„ä¼°ä¸åˆ†ææŠ€æœ¯ï¼Œç¡®ä¿æˆ‘ä»¬ç”Ÿäº§å‡ºçš„å®šåˆ¶åŒ–æ¨¡å‹è¾¾åˆ°æœ€é«˜è´¨é‡æ ‡å‡†ã€‚</p>
<hr>
<h2 id="285-%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%B8%8E%E5%88%86%E6%9E%90">28.5 æ¨¡å‹è¯„ä¼°ä¸åˆ†æ</h2>
<h3 id="%F0%9F%A7%AA-%E8%BF%9B%E5%85%A5%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E8%BD%A6%E9%97%B4">ğŸ§ª è¿›å…¥æ¨¡å‹è¯„ä¼°è½¦é—´</h3>
<p>åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼Œæ¨¡å‹è¯„ä¼°å°±åƒæ˜¯äº§å“çš„è´¨é‡æ£€æµ‹ä¸­å¿ƒã€‚å®ƒä¸ä»…è¦ç¡®ä¿æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¡¨ç°è‰¯å¥½ï¼Œè¿˜è¦è¯„ä¼°æ¨¡å‹åœ¨æœªè§è¿‡çš„æ•°æ®ä¸Šçš„æ³›åŒ–èƒ½åŠ›ã€‚</p>
<p>è®©æˆ‘ä»¬æ·±å…¥è¿™ä¸ªè´¨é‡æ£€æµ‹ä¸­å¿ƒï¼Œå­¦ä¹ å¦‚ä½•è¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼</p>
<h4 id="%F0%9F%93%8A-%E5%A4%9A%E6%8C%87%E6%A0%87%E7%BB%BC%E5%90%88%E8%AF%84%E4%BC%B0">ğŸ“Š å¤šæŒ‡æ ‡ç»¼åˆè¯„ä¼°</h4>
<p>å¤šæŒ‡æ ‡ç»¼åˆè¯„ä¼°æ˜¯è¯„ä¼°æ¨¡å‹æ€§èƒ½çš„ä¸€ç§å¸¸ç”¨æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªæŒ‡æ ‡æ¥å…¨é¢è¯„ä¼°æ¨¡å‹çš„æ€§èƒ½ï¼Œä¾‹å¦‚å‡†ç¡®ç‡ã€ç²¾ç¡®ç‡ã€å¬å›ç‡ã€F1åˆ†æ•°ç­‰ã€‚</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> precision_recall_fscore_support, accuracy_score

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MultiMetricEvaluator</span>:</span>
    <span class="hljs-string">"""å¤šæŒ‡æ ‡è¯„ä¼°å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.metrics = {}
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">evaluate</span><span class="hljs-params">(self, y_true, y_pred)</span>:</span>
        <span class="hljs-string">"""è¯„ä¼°æ¨¡å‹æ€§èƒ½"""</span>
        self.metrics[<span class="hljs-string">'accuracy'</span>] = accuracy_score(y_true, y_pred)
        self.metrics[<span class="hljs-string">'precision'</span>], self.metrics[<span class="hljs-string">'recall'</span>], self.metrics[<span class="hljs-string">'f1'</span>], _ = precision_recall_fscore_support(y_true, y_pred, average=<span class="hljs-string">'weighted'</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_metrics</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–è¯„ä¼°ç»“æœ"""</span>
        fig, ax = plt.subplots()
        ax.bar([<span class="hljs-string">'Accuracy'</span>, <span class="hljs-string">'Precision'</span>, <span class="hljs-string">'Recall'</span>, <span class="hljs-string">'F1 Score'</span>], list(self.metrics.values()))
        ax.set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        ax.set_title(<span class="hljs-string">'æ¨¡å‹æ€§èƒ½è¯„ä¼°'</span>)
        plt.show()

<span class="hljs-comment"># æ¼”ç¤ºå¤šæŒ‡æ ‡ç»¼åˆè¯„ä¼°</span>
evaluator = MultiMetricEvaluator()

<span class="hljs-comment"># åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®</span>
y_true = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]
y_pred = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]

<span class="hljs-comment"># è¯„ä¼°æ¨¡å‹</span>
evaluator.evaluate(y_true, y_pred)

<span class="hljs-comment"># å¯è§†åŒ–è¯„ä¼°ç»“æœ</span>
evaluator.visualize_metrics()
</div></code></pre>
<h4 id="%F0%9F%94%8D-%E9%94%99%E8%AF%AF%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">ğŸ” é”™è¯¯æ¡ˆä¾‹åˆ†æ</h4>
<p>é”™è¯¯æ¡ˆä¾‹åˆ†ææ˜¯è¯„ä¼°æ¨¡å‹æ€§èƒ½çš„ä¸€ç§é‡è¦æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†ææ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°çš„é”™è¯¯æ¡ˆä¾‹ï¼Œæ¥äº†è§£æ¨¡å‹åœ¨å“ªäº›æƒ…å†µä¸‹å®¹æ˜“å‡ºé”™ï¼Œä»è€Œæœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œæ”¹è¿›ã€‚</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> ConfusionMatrixDisplay
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorAnalyzer</span>:</span>
    <span class="hljs-string">"""é”™è¯¯æ¡ˆä¾‹åˆ†æå™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.confusion_matrix = <span class="hljs-literal">None</span>
        self.class_names = <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze</span><span class="hljs-params">(self, y_true, y_pred)</span>:</span>
        <span class="hljs-string">"""åˆ†æé”™è¯¯æ¡ˆä¾‹"""</span>
        self.confusion_matrix = ConfusionMatrixDisplay.from_predictions(y_true, y_pred)
        self.class_names = self.confusion_matrix.display_labels
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_confusion_matrix</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–æ··æ·†çŸ©é˜µ"""</span>
        fig, ax = plt.subplots(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
        sns.heatmap(self.confusion_matrix.confusion_matrix, annot=<span class="hljs-literal">True</span>, fmt=<span class="hljs-string">'d'</span>, cmap=<span class="hljs-string">'Blues'</span>, ax=ax)
        ax.set_title(<span class="hljs-string">'æ··æ·†çŸ©é˜µ'</span>)
        ax.set_xlabel(<span class="hljs-string">'é¢„æµ‹ç±»åˆ«'</span>)
        ax.set_ylabel(<span class="hljs-string">'çœŸå®ç±»åˆ«'</span>)
        plt.show()

<span class="hljs-comment"># æ¼”ç¤ºé”™è¯¯æ¡ˆä¾‹åˆ†æ</span>
analyzer = ErrorAnalyzer()

<span class="hljs-comment"># åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®</span>
y_true = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]
y_pred = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]

<span class="hljs-comment"># åˆ†æé”™è¯¯æ¡ˆä¾‹</span>
analyzer.analyze(y_true, y_pred)

<span class="hljs-comment"># å¯è§†åŒ–é”™è¯¯æ¡ˆä¾‹åˆ†æç»“æœ</span>
analyzer.visualize_confusion_matrix()
</div></code></pre>
<h4 id="%F0%9F%9B%A0%EF%B8%8F-%E6%A8%A1%E5%9E%8B%E9%B2%81%E6%A3%92%E6%80%A7%E6%B5%8B%E8%AF%95">ğŸ› ï¸ æ¨¡å‹é²æ£’æ€§æµ‹è¯•</h4>
<p>æ¨¡å‹é²æ£’æ€§æµ‹è¯•æ˜¯è¯„ä¼°æ¨¡å‹æ€§èƒ½çš„ä¸€ç§é‡è¦æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è®­ç»ƒæ•°æ®ä¸Šæ·»åŠ å™ªå£°æˆ–å¹²æ‰°ï¼Œæ¥æµ‹è¯•æ¨¡å‹åœ¨ä¸åŒæƒ…å†µä¸‹çš„è¡¨ç°ã€‚</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RobustnessTester</span>:</span>
    <span class="hljs-string">"""æ¨¡å‹é²æ£’æ€§æµ‹è¯•å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model, data_loader)</span>:</span>
        self.model = model
        self.data_loader = data_loader
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""æµ‹è¯•æ¨¡å‹é²æ£’æ€§"""</span>
        self.model.eval()
        total_samples = <span class="hljs-number">0</span>
        correct_predictions = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">with</span> torch.no_grad():
            <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> self.data_loader:
                <span class="hljs-comment"># ç§»åŠ¨æ•°æ®åˆ°è®¾å¤‡</span>
                input_ids = batch[<span class="hljs-string">'input_ids'</span>].to(self.model.device)
                attention_mask = batch[<span class="hljs-string">'attention_mask'</span>].to(self.model.device)
                labels = batch[<span class="hljs-string">'label'</span>].to(self.model.device)
                
                <span class="hljs-comment"># æ·»åŠ å™ªå£°</span>
                noise = torch.randn_like(input_ids) * <span class="hljs-number">0.1</span>
                noisy_input_ids = input_ids + noise
                
                <span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
                logits = self.model(noisy_input_ids, attention_mask)
                loss = self.criterion(logits, labels)
                
                <span class="hljs-comment"># ç»Ÿè®¡</span>
                total_samples += labels.size(<span class="hljs-number">0</span>)
                correct_predictions += (torch.argmax(logits, dim=<span class="hljs-number">1</span>) == labels).sum().item()
        
        <span class="hljs-keyword">return</span> accuracy_score(labels.cpu().numpy(), torch.argmax(logits, dim=<span class="hljs-number">1</span>).cpu().numpy())

<span class="hljs-comment"># æ¼”ç¤ºæ¨¡å‹é²æ£’æ€§æµ‹è¯•</span>
print(<span class="hljs-string">"ğŸ› ï¸ æ¨¡å‹é²æ£’æ€§æµ‹è¯•"</span>)
print(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># åˆ›å»ºæ¨¡æ‹Ÿæ¨¡å‹å’Œæ•°æ®</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleModel</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, vocab_size=<span class="hljs-number">1000</span>, hidden_size=<span class="hljs-number">128</span>, num_classes=<span class="hljs-number">3</span>)</span>:</span>
        super().__init__()
        self.embedding = nn.Embedding(vocab_size, hidden_size)
        self.classifier = nn.Sequential(
            nn.Linear(hidden_size, hidden_size // <span class="hljs-number">2</span>),
            nn.ReLU(),
            nn.Dropout(<span class="hljs-number">0.1</span>),
            nn.Linear(hidden_size // <span class="hljs-number">2</span>, num_classes)
        )
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, input_ids, attention_mask)</span>:</span>
        embeddings = self.embedding(input_ids)
        pooled = embeddings.mean(dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># ç®€å•å¹³å‡æ± åŒ–</span>
        <span class="hljs-keyword">return</span> self.classifier(pooled)

<span class="hljs-comment"># åˆ›å»ºæ¨¡å‹</span>
model = SimpleModel()

<span class="hljs-comment"># åˆ›å»ºè®­ç»ƒé…ç½®</span>
config = TrainingConfig(
    learning_rate=<span class="hljs-number">1e-3</span>,
    batch_size=<span class="hljs-number">16</span>,
    num_epochs=<span class="hljs-number">5</span>,
    early_stopping_patience=<span class="hljs-number">2</span>,
    log_interval=<span class="hljs-number">5</span>
)

<span class="hljs-comment"># åˆ›å»ºè®­ç»ƒå™¨</span>
trainer = AdvancedTrainer(model, config)

<span class="hljs-comment"># åˆ›å»ºæ•°æ®åŠ è½½å™¨</span>
tokenizer = AutoTokenizer.from_pretrained(<span class="hljs-string">'bert-base-chinese'</span>)
data_loader = SmartDataLoader(tokenizer, max_length=<span class="hljs-number">128</span>)

<span class="hljs-comment"># åˆ›å»ºæ•°æ®é›†</span>
dataset = data_loader.create_dataset(augmented_texts, augmented_labels)

<span class="hljs-comment"># åˆ›å»ºæ•°æ®åŠ è½½å™¨</span>
train_loader, val_loader, test_loader = data_loader.create_dataloaders(
    dataset, train_ratio=<span class="hljs-number">0.7</span>, val_ratio=<span class="hljs-number">0.15</span>, batch_size=<span class="hljs-number">16</span>
)

<span class="hljs-comment"># æµ‹è¯•æ¨¡å‹é²æ£’æ€§</span>
robustness_tester = RobustnessTester(model, test_loader)
robustness_score = robustness_tester.test()
print(<span class="hljs-string">f"æ¨¡å‹é²æ£’æ€§å¾—åˆ†: <span class="hljs-subst">{robustness_score:<span class="hljs-number">.2</span>%}</span>"</span>)
</div></code></pre>
<h4 id="%F0%9F%94%84-%E6%95%88%E7%8E%87%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95">ğŸ”„ æ•ˆç‡æ€§èƒ½æµ‹è¯•</h4>
<p>æ•ˆç‡æ€§èƒ½æµ‹è¯•æ˜¯è¯„ä¼°æ¨¡å‹æ€§èƒ½çš„ä¸€ç§é‡è¦æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç›¸åŒè®¡ç®—èµ„æºä¸‹æ¯”è¾ƒä¸åŒæ¨¡å‹çš„æ¨ç†é€Ÿåº¦ï¼Œæ¥è¯„ä¼°æ¨¡å‹çš„æ•ˆç‡ã€‚</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> queue <span class="hljs-keyword">import</span> Queue
<span class="hljs-keyword">import</span> json

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerformanceTester</span>:</span>
    <span class="hljs-string">"""æ€§èƒ½æµ‹è¯•å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model, data_loader)</span>:</span>
        self.model = model
        self.data_loader = data_loader
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""æµ‹è¯•æ¨¡å‹æ€§èƒ½"""</span>
        self.model.eval()
        total_samples = <span class="hljs-number">0</span>
        total_time = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">with</span> torch.no_grad():
            <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> self.data_loader:
                <span class="hljs-comment"># ç§»åŠ¨æ•°æ®åˆ°è®¾å¤‡</span>
                input_ids = batch[<span class="hljs-string">'input_ids'</span>].to(self.model.device)
                attention_mask = batch[<span class="hljs-string">'attention_mask'</span>].to(self.model.device)
                labels = batch[<span class="hljs-string">'label'</span>].to(self.model.device)
                
                start_time = time.time()
                logits = self.model(input_ids, attention_mask)
                end_time = time.time()
                
                <span class="hljs-comment"># ç»Ÿè®¡</span>
                total_samples += labels.size(<span class="hljs-number">0</span>)
                total_time += end_time - start_time
        
        <span class="hljs-keyword">return</span> total_time / total_samples

<span class="hljs-comment"># æ¼”ç¤ºæ•ˆç‡æ€§èƒ½æµ‹è¯•</span>
print(<span class="hljs-string">"ğŸ”„ æ•ˆç‡æ€§èƒ½æµ‹è¯•"</span>)
print(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># åˆ›å»ºæ¨¡æ‹Ÿæ¨¡å‹å’Œæ•°æ®</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleModel</span><span class="hljs-params">(nn.Module)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, vocab_size=<span class="hljs-number">1000</span>, hidden_size=<span class="hljs-number">128</span>, num_classes=<span class="hljs-number">3</span>)</span>:</span>
        super().__init__()
        self.embedding = nn.Embedding(vocab_size, hidden_size)
        self.classifier = nn.Sequential(
            nn.Linear(hidden_size, hidden_size // <span class="hljs-number">2</span>),
            nn.ReLU(),
            nn.Dropout(<span class="hljs-number">0.1</span>),
            nn.Linear(hidden_size // <span class="hljs-number">2</span>, num_classes)
        )
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, input_ids, attention_mask)</span>:</span>
        embeddings = self.embedding(input_ids)
        pooled = embeddings.mean(dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># ç®€å•å¹³å‡æ± åŒ–</span>
        <span class="hljs-keyword">return</span> self.classifier(pooled)

<span class="hljs-comment"># åˆ›å»ºæ¨¡å‹</span>
model = SimpleModel()

<span class="hljs-comment"># åˆ›å»ºè®­ç»ƒé…ç½®</span>
config = TrainingConfig(
    learning_rate=<span class="hljs-number">1e-3</span>,
    batch_size=<span class="hljs-number">16</span>,
    num_epochs=<span class="hljs-number">5</span>,
    early_stopping_patience=<span class="hljs-number">2</span>,
    log_interval=<span class="hljs-number">5</span>
)

<span class="hljs-comment"># åˆ›å»ºè®­ç»ƒå™¨</span>
trainer = AdvancedTrainer(model, config)

<span class="hljs-comment"># åˆ›å»ºæ•°æ®åŠ è½½å™¨</span>
tokenizer = AutoTokenizer.from_pretrained(<span class="hljs-string">'bert-base-chinese'</span>)
data_loader = SmartDataLoader(tokenizer, max_length=<span class="hljs-number">128</span>)

<span class="hljs-comment"># åˆ›å»ºæ•°æ®é›†</span>
dataset = data_loader.create_dataset(augmented_texts, augmented_labels)

<span class="hljs-comment"># åˆ›å»ºæ•°æ®åŠ è½½å™¨</span>
train_loader, val_loader, test_loader = data_loader.create_dataloaders(
    dataset, train_ratio=<span class="hljs-number">0.7</span>, val_ratio=<span class="hljs-number">0.15</span>, batch_size=<span class="hljs-number">16</span>
)

<span class="hljs-comment"># æµ‹è¯•æ¨¡å‹æ€§èƒ½</span>
performance_tester = PerformanceTester(model, test_loader)
inference_time = performance_tester.test()
print(<span class="hljs-string">f"æ¨¡å‹æ¨ç†æ—¶é—´: <span class="hljs-subst">{inference_time:<span class="hljs-number">.4</span>f}</span> ç§’/æ ·æœ¬"</span>)
</div></code></pre>
<p>é€šè¿‡è¿™ä¸€èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å»ºç«‹äº†å…¨é¢çš„æ¨¡å‹è¯„ä¼°ä¸åˆ†æä½“ç³»ã€‚ä»å¤šæŒ‡æ ‡ç»¼åˆè¯„ä¼°åˆ°é”™è¯¯æ¡ˆä¾‹åˆ†æï¼Œä»æ¨¡å‹é²æ£’æ€§æµ‹è¯•åˆ°æ•ˆç‡æ€§èƒ½æµ‹è¯•ï¼Œæˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ç°åœ¨æ‹¥æœ‰äº†ä¸¥æ ¼çš„æ€§èƒ½æ£€æµ‹ä¸­å¿ƒã€‚</p>
<p>åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å‘ä¼ä¸šçº§ä¸ªæ€§åŒ–AIåŠ©æ‰‹ï¼Œå®ç°å®Œæ•´çš„å®šåˆ¶åŒ–è§£å†³æ–¹æ¡ˆã€‚</p>
<hr>
<h2 id="286-%E5%AE%9A%E5%88%B6%E5%8C%96ai%E5%8A%A9%E6%89%8B%E5%AE%9E%E6%88%98">28.6 å®šåˆ¶åŒ–AIåŠ©æ‰‹å®æˆ˜</h2>
<h3 id="%F0%9F%8E%A8-%E8%BF%9B%E5%85%A5ai%E5%8A%A9%E6%89%8B%E5%AE%9A%E5%88%B6%E8%BD%A6%E9%97%B4">ğŸ¨ è¿›å…¥AIåŠ©æ‰‹å®šåˆ¶è½¦é—´</h3>
<p>åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼Œå®šåˆ¶åŒ–AIåŠ©æ‰‹å°±åƒæ˜¯è‰ºæœ¯å“çš„è®¾è®¡è½¦é—´ã€‚å®ƒä¸ä»…è¦ç¡®ä¿æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¡¨ç°è‰¯å¥½ï¼Œè¿˜è¦æ ¹æ®å®¢æˆ·éœ€æ±‚è¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶ã€‚</p>
<p>è®©æˆ‘ä»¬æ·±å…¥è¿™ä¸ªè‰ºæœ¯å“è®¾è®¡è½¦é—´ï¼Œå­¦ä¹ å¦‚ä½•æ‰“é€ ä¸€ä¸ªç¬¦åˆå®¢æˆ·éœ€æ±‚çš„AIåŠ©æ‰‹ï¼</p>
<h4 id="%F0%9F%8E%AF-%E5%AE%9A%E5%88%B6%E5%8C%96ai%E5%8A%A9%E6%89%8B%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B">ğŸ¯ å®šåˆ¶åŒ–AIåŠ©æ‰‹å¼€å‘æµç¨‹</h4>
<p>å®šåˆ¶åŒ–AIåŠ©æ‰‹å¼€å‘æµç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li><strong>éœ€æ±‚åˆ†æ</strong>ï¼šä¸å®¢æˆ·æ²Ÿé€šï¼Œäº†è§£ä»–ä»¬çš„å…·ä½“éœ€æ±‚ã€‚</li>
<li><strong>æ¨¡å‹é€‰æ‹©</strong>ï¼šæ ¹æ®å®¢æˆ·éœ€æ±‚é€‰æ‹©åˆé€‚çš„é¢„è®­ç»ƒæ¨¡å‹ã€‚</li>
<li><strong>å¾®è°ƒç­–ç•¥é€‰æ‹©</strong>ï¼šæ ¹æ®å®¢æˆ·éœ€æ±‚é€‰æ‹©åˆé€‚çš„å¾®è°ƒç­–ç•¥ã€‚</li>
<li><strong>æ•°æ®å·¥ç¨‹ä¸é¢„å¤„ç†</strong>ï¼šæ„å»ºé«˜è´¨é‡çš„è®­ç»ƒæ•°æ®ï¼Œå»ºç«‹å®Œå–„çš„æ•°æ®å¤„ç†æµç¨‹ã€‚</li>
<li><strong>è®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§</strong>ï¼šç²¾ç»†åŒ–ç®¡ç†è®­ç»ƒè¿‡ç¨‹ï¼Œå®ç°é«˜æ•ˆçš„æ¨¡å‹ä¼˜åŒ–ã€‚</li>
<li><strong>æ¨¡å‹è¯„ä¼°ä¸åˆ†æ</strong>ï¼šå»ºç«‹å¤šç»´åº¦çš„æ•ˆæœè¯„ä¼°ä½“ç³»ï¼Œç§‘å­¦éªŒè¯æ¨¡å‹æ€§èƒ½ã€‚</li>
<li><strong>å®šåˆ¶åŒ–æ¨¡å‹å¼€å‘</strong>ï¼šæ ¹æ®å®¢æˆ·éœ€æ±‚è¿›è¡Œæ¨¡å‹å®šåˆ¶ã€‚</li>
<li><strong>éƒ¨ç½²ä¸ç»´æŠ¤</strong>ï¼šæ„å»ºè‡ªåŠ¨åŒ–å¾®è°ƒå¹³å°ï¼Œç¡®ä¿æ¨¡å‹çš„é«˜æ•ˆè¿è¡Œå’ŒæŒç»­ä¼˜åŒ–ã€‚</li>
</ol>
<p>è®©æˆ‘ä»¬ç”¨ä»£ç æ¥å®ç°è¿™ä¸ªå®šåˆ¶åŒ–AIåŠ©æ‰‹å¼€å‘æµç¨‹ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModel, AutoTokenizer
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FineTuningDemo</span>:</span>
    <span class="hljs-string">"""æ¨¡å‹å¾®è°ƒæ¼”ç¤ºç±»"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model_name=<span class="hljs-string">"bert-base-uncased"</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–å¾®è°ƒæ¼”ç¤º
        Args:
            model_name: é¢„è®­ç»ƒæ¨¡å‹åç§°
        """</span>
        self.model_name = model_name
        self.tokenizer = AutoTokenizer.from_pretrained(model_name)
        self.base_model = AutoModel.from_pretrained(model_name)
        
        <span class="hljs-comment"># å†»ç»“é¢„è®­ç»ƒå±‚çš„å‚æ•°ï¼ˆå¯é€‰ï¼‰</span>
        self.freeze_base_model()
        
        print(<span class="hljs-string">f"âœ… å·²åŠ è½½é¢„è®­ç»ƒæ¨¡å‹: <span class="hljs-subst">{model_name}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“Š æ¨¡å‹å‚æ•°é‡: <span class="hljs-subst">{self.count_parameters():,}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">freeze_base_model</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å†»ç»“é¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°"""</span>
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> self.base_model.parameters():
            param.requires_grad = <span class="hljs-literal">False</span>
        print(<span class="hljs-string">"ğŸ”’ å·²å†»ç»“é¢„è®­ç»ƒæ¨¡å‹å‚æ•°"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unfreeze_base_model</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""è§£å†»é¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°"""</span>
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> self.base_model.parameters():
            param.requires_grad = <span class="hljs-literal">True</span>
        print(<span class="hljs-string">"ğŸ”“ å·²è§£å†»é¢„è®­ç»ƒæ¨¡å‹å‚æ•°"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">count_parameters</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ç»Ÿè®¡æ¨¡å‹å‚æ•°é‡"""</span>
        <span class="hljs-keyword">return</span> sum(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.base_model.parameters())
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_classification_head</span><span class="hljs-params">(self, num_classes=<span class="hljs-number">2</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆ›å»ºåˆ†ç±»å¤´
        Args:
            num_classes: åˆ†ç±»ç±»åˆ«æ•°
        """</span>
        hidden_size = self.base_model.config.hidden_size
        
        self.classifier = nn.Sequential(
            nn.Dropout(<span class="hljs-number">0.1</span>),
            nn.Linear(hidden_size, hidden_size // <span class="hljs-number">2</span>),
            nn.ReLU(),
            nn.Dropout(<span class="hljs-number">0.1</span>),
            nn.Linear(hidden_size // <span class="hljs-number">2</span>, num_classes)
        )
        
        print(<span class="hljs-string">f"ğŸ¯ å·²åˆ›å»ºåˆ†ç±»å¤´ï¼Œè¾“å‡ºç»´åº¦: <span class="hljs-subst">{num_classes}</span>"</span>)
        <span class="hljs-keyword">return</span> self.classifier
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">demonstrate_feature_extraction</span><span class="hljs-params">(self, texts)</span>:</span>
        <span class="hljs-string">"""
        æ¼”ç¤ºç‰¹å¾æå–è¿‡ç¨‹
        Args:
            texts: è¾“å…¥æ–‡æœ¬åˆ—è¡¨
        """</span>
        print(<span class="hljs-string">"\nğŸ” ç‰¹å¾æå–æ¼”ç¤º:"</span>)
        
        <span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> enumerate(texts):
            <span class="hljs-comment"># ç¼–ç æ–‡æœ¬</span>
            inputs = self.tokenizer(text, return_tensors=<span class="hljs-string">"pt"</span>, 
                                  padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>)
            
            <span class="hljs-comment"># æå–ç‰¹å¾</span>
            <span class="hljs-keyword">with</span> torch.no_grad():
                outputs = self.base_model(**inputs)
                features = outputs.last_hidden_state.mean(dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># å¹³å‡æ± åŒ–</span>
            
            print(<span class="hljs-string">f"æ–‡æœ¬ <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{text}</span>"</span>)
            print(<span class="hljs-string">f"ç‰¹å¾ç»´åº¦: <span class="hljs-subst">{features.shape}</span>"</span>)
            print(<span class="hljs-string">f"ç‰¹å¾èŒƒå›´: [<span class="hljs-subst">{features.min():<span class="hljs-number">.3</span>f}</span>, <span class="hljs-subst">{features.max():<span class="hljs-number">.3</span>f}</span>]"</span>)
            print(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># æ¼”ç¤ºå¾®è°ƒåŸºç¡€æ¦‚å¿µ</span>
demo = FineTuningDemo()

<span class="hljs-comment"># åˆ›å»ºåˆ†ç±»å¤´</span>
classifier = demo.create_classification_head(num_classes=<span class="hljs-number">3</span>)

<span class="hljs-comment"># æ¼”ç¤ºç‰¹å¾æå–</span>
sample_texts = [
    <span class="hljs-string">"This movie is absolutely fantastic!"</span>,
    <span class="hljs-string">"The service was terrible and disappointing."</span>,
    <span class="hljs-string">"It's an okay product, nothing special."</span>
]

demo.demonstrate_feature_extraction(sample_texts)
</div></code></pre>
<h4 id="%F0%9F%8E%AF-%E5%BE%AE%E8%B0%83%E7%AD%96%E7%95%A5%E5%88%86%E7%B1%BB%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AE%9A%E5%88%B6%E6%96%B9%E6%A1%88">ğŸ¯ å¾®è°ƒç­–ç•¥åˆ†ç±»ï¼šä¸åŒçš„å®šåˆ¶æ–¹æ¡ˆ</h4>
<p>åœ¨æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚ä¸­ï¼Œæœ‰å¤šç§ä¸åŒçš„å®šåˆ¶æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼š</p>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    A[æ¨¡å‹å¾®è°ƒç­–ç•¥] --> B[å…¨å‚æ•°å¾®è°ƒ]
    A --> C[å‚æ•°é«˜æ•ˆå¾®è°ƒ]
    
    B --> D[å®Œå…¨å¾®è°ƒ]
    B --> E[æ¸è¿›å¼å¾®è°ƒ]
    
    C --> F[LoRA]
    C --> G[Adapter]
    C --> H[Prefix Tuning]
    C --> I[Prompt Tuning]
    
    style A fill:#ff9800
    style B fill:#2196f3
    style C fill:#4caf50
</div></code></pre>
<p>è®©æˆ‘ä»¬è¯¦ç»†äº†è§£æ¯ç§ç­–ç•¥ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FineTuningStrategy</span>:</span>
    <span class="hljs-string">"""å¾®è°ƒç­–ç•¥åˆ†æç±»"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.strategies = {
            <span class="hljs-string">"full_finetuning"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"å…¨å‚æ•°å¾®è°ƒ"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"æ›´æ–°æ¨¡å‹çš„æ‰€æœ‰å‚æ•°"</span>,
                <span class="hljs-string">"advantages"</span>: [<span class="hljs-string">"æ•ˆæœæœ€å¥½"</span>, <span class="hljs-string">"é€‚åº”æ€§å¼º"</span>],
                <span class="hljs-string">"disadvantages"</span>: [<span class="hljs-string">"è®¡ç®—æˆæœ¬é«˜"</span>, <span class="hljs-string">"å®¹æ˜“è¿‡æ‹Ÿåˆ"</span>, <span class="hljs-string">"å­˜å‚¨éœ€æ±‚å¤§"</span>],
                <span class="hljs-string">"suitable_for"</span>: [<span class="hljs-string">"æ•°æ®å……è¶³"</span>, <span class="hljs-string">"è®¡ç®—èµ„æºä¸°å¯Œ"</span>, <span class="hljs-string">"è¿½æ±‚æœ€ä½³æ•ˆæœ"</span>]
            },
            <span class="hljs-string">"lora"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"LoRAå¾®è°ƒ"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"ä½ç§©é€‚åº”ï¼Œåªè®­ç»ƒå°‘é‡å‚æ•°"</span>,
                <span class="hljs-string">"advantages"</span>: [<span class="hljs-string">"å‚æ•°å°‘"</span>, <span class="hljs-string">"è®­ç»ƒå¿«"</span>, <span class="hljs-string">"é˜²æ­¢è¿‡æ‹Ÿåˆ"</span>],
                <span class="hljs-string">"disadvantages"</span>: [<span class="hljs-string">"æ•ˆæœå¯èƒ½ç•¥é€Š"</span>, <span class="hljs-string">"éœ€è¦è°ƒæ•´ç§©å‚æ•°"</span>],
                <span class="hljs-string">"suitable_for"</span>: [<span class="hljs-string">"æ•°æ®æœ‰é™"</span>, <span class="hljs-string">"è®¡ç®—èµ„æºå—é™"</span>, <span class="hljs-string">"å¿«é€Ÿéƒ¨ç½²"</span>]
            },
            <span class="hljs-string">"adapter"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"Adapterå¾®è°ƒ"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"åœ¨æ¨¡å‹ä¸­æ’å…¥å°å‹é€‚é…å™¨å±‚"</span>,
                <span class="hljs-string">"advantages"</span>: [<span class="hljs-string">"æ¨¡å—åŒ–"</span>, <span class="hljs-string">"å¯æ’æ‹”"</span>, <span class="hljs-string">"å‚æ•°æ•ˆç‡é«˜"</span>],
                <span class="hljs-string">"disadvantages"</span>: [<span class="hljs-string">"å¢åŠ æ¨ç†å»¶è¿Ÿ"</span>, <span class="hljs-string">"æ¶æ„å¤æ‚"</span>],
                <span class="hljs-string">"suitable_for"</span>: [<span class="hljs-string">"å¤šä»»åŠ¡åœºæ™¯"</span>, <span class="hljs-string">"æ¨¡å‹å…±äº«"</span>, <span class="hljs-string">"å¢é‡å­¦ä¹ "</span>]
            },
            <span class="hljs-string">"prefix_tuning"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"å‰ç¼€å¾®è°ƒ"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"åªè®­ç»ƒè¾“å…¥å‰ç¼€çš„åµŒå…¥"</span>,
                <span class="hljs-string">"advantages"</span>: [<span class="hljs-string">"å‚æ•°æå°‘"</span>, <span class="hljs-string">"ä¸æ”¹å˜æ¨¡å‹ç»“æ„"</span>],
                <span class="hljs-string">"disadvantages"</span>: [<span class="hljs-string">"æ•ˆæœæœ‰é™"</span>, <span class="hljs-string">"é€‚ç”¨åœºæ™¯çª„"</span>],
                <span class="hljs-string">"suitable_for"</span>: [<span class="hljs-string">"ç”Ÿæˆä»»åŠ¡"</span>, <span class="hljs-string">"å¿«é€Ÿé€‚é…"</span>, <span class="hljs-string">"è½»é‡åŒ–éƒ¨ç½²"</span>]
            }
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_strategies</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""æ¯”è¾ƒä¸åŒå¾®è°ƒç­–ç•¥"""</span>
        print(<span class="hljs-string">"ğŸ“Š å¾®è°ƒç­–ç•¥å¯¹æ¯”åˆ†æ:"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
        
        <span class="hljs-keyword">for</span> key, strategy <span class="hljs-keyword">in</span> self.strategies.items():
            print(<span class="hljs-string">f"\nğŸ¯ <span class="hljs-subst">{strategy[<span class="hljs-string">'name'</span>]}</span>"</span>)
            print(<span class="hljs-string">f"æè¿°: <span class="hljs-subst">{strategy[<span class="hljs-string">'description'</span>]}</span>"</span>)
            print(<span class="hljs-string">f"âœ… ä¼˜åŠ¿: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(strategy[<span class="hljs-string">'advantages'</span>])}</span>"</span>)
            print(<span class="hljs-string">f"âŒ åŠ£åŠ¿: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(strategy[<span class="hljs-string">'disadvantages'</span>])}</span>"</span>)
            print(<span class="hljs-string">f"ğŸ¯ é€‚ç”¨åœºæ™¯: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(strategy[<span class="hljs-string">'suitable_for'</span>])}</span>"</span>)
            print(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">estimate_resources</span><span class="hljs-params">(self, model_size_mb, strategy=<span class="hljs-string">"full_finetuning"</span>)</span>:</span>
        <span class="hljs-string">"""
        ä¼°ç®—èµ„æºéœ€æ±‚
        Args:
            model_size_mb: æ¨¡å‹å¤§å°(MB)
            strategy: å¾®è°ƒç­–ç•¥
        """</span>
        multipliers = {
            <span class="hljs-string">"full_finetuning"</span>: {<span class="hljs-string">"memory"</span>: <span class="hljs-number">4.0</span>, <span class="hljs-string">"time"</span>: <span class="hljs-number">1.0</span>, <span class="hljs-string">"storage"</span>: <span class="hljs-number">2.0</span>},
            <span class="hljs-string">"lora"</span>: {<span class="hljs-string">"memory"</span>: <span class="hljs-number">1.2</span>, <span class="hljs-string">"time"</span>: <span class="hljs-number">0.3</span>, <span class="hljs-string">"storage"</span>: <span class="hljs-number">1.1</span>},
            <span class="hljs-string">"adapter"</span>: {<span class="hljs-string">"memory"</span>: <span class="hljs-number">1.5</span>, <span class="hljs-string">"time"</span>: <span class="hljs-number">0.4</span>, <span class="hljs-string">"storage"</span>: <span class="hljs-number">1.2</span>},
            <span class="hljs-string">"prefix_tuning"</span>: {<span class="hljs-string">"memory"</span>: <span class="hljs-number">1.1</span>, <span class="hljs-string">"time"</span>: <span class="hljs-number">0.2</span>, <span class="hljs-string">"storage"</span>: <span class="hljs-number">1.05</span>}
        }
        
        <span class="hljs-keyword">if</span> strategy <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> multipliers:
            print(<span class="hljs-string">f"âŒ ä¸æ”¯æŒçš„ç­–ç•¥: <span class="hljs-subst">{strategy}</span>"</span>)
            <span class="hljs-keyword">return</span>
        
        mult = multipliers[strategy]
        
        print(<span class="hljs-string">f"\nğŸ“Š <span class="hljs-subst">{self.strategies[strategy][<span class="hljs-string">'name'</span>]}</span> èµ„æºéœ€æ±‚ä¼°ç®—:"</span>)
        print(<span class="hljs-string">f"åŸºç¡€æ¨¡å‹å¤§å°: <span class="hljs-subst">{model_size_mb}</span> MB"</span>)
        print(<span class="hljs-string">f"è®­ç»ƒå†…å­˜éœ€æ±‚: <span class="hljs-subst">{model_size_mb * mult[<span class="hljs-string">'memory'</span>]:<span class="hljs-number">.1</span>f}</span> MB"</span>)
        print(<span class="hljs-string">f"ç›¸å¯¹è®­ç»ƒæ—¶é—´: <span class="hljs-subst">{mult[<span class="hljs-string">'time'</span>]:<span class="hljs-number">.1</span>f}</span>x"</span>)
        print(<span class="hljs-string">f"å­˜å‚¨éœ€æ±‚: <span class="hljs-subst">{model_size_mb * mult[<span class="hljs-string">'storage'</span>]:<span class="hljs-number">.1</span>f}</span> MB"</span>)

<span class="hljs-comment"># æ¼”ç¤ºç­–ç•¥åˆ†æ</span>
strategy_analyzer = FineTuningStrategy()
strategy_analyzer.compare_strategies()

<span class="hljs-comment"># èµ„æºéœ€æ±‚ä¼°ç®—</span>
strategy_analyzer.estimate_resources(<span class="hljs-number">440</span>, <span class="hljs-string">"full_finetuning"</span>)  <span class="hljs-comment"># BERT-base</span>
strategy_analyzer.estimate_resources(<span class="hljs-number">440</span>, <span class="hljs-string">"lora"</span>)
</div></code></pre>
<h4 id="%F0%9F%94%84-%E8%BF%81%E7%A7%BB%E5%AD%A6%E4%B9%A0%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86%E4%BC%A0%E6%89%BF%E7%9A%84%E8%89%BA%E6%9C%AF">ğŸ”„ è¿ç§»å­¦ä¹ ç†è®ºï¼šçŸ¥è¯†ä¼ æ‰¿çš„è‰ºæœ¯</h4>
<p>å¾®è°ƒçš„æ ¸å¿ƒæ˜¯è¿ç§»å­¦ä¹ ï¼Œå°±åƒæ˜¯å°†ä¸€ä¸ªé¢†åŸŸçš„ä¸“ä¸šçŸ¥è¯†è½¬ç§»åˆ°å¦ä¸€ä¸ªé¢†åŸŸã€‚è®©æˆ‘ä»¬æ·±å…¥ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.manifold <span class="hljs-keyword">import</span> TSNE
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransferLearningAnalyzer</span>:</span>
    <span class="hljs-string">"""è¿ç§»å­¦ä¹ åˆ†æå™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.layer_types = [
            <span class="hljs-string">"è¯åµŒå…¥å±‚"</span>, <span class="hljs-string">"æµ…å±‚ç¼–ç å™¨"</span>, <span class="hljs-string">"ä¸­å±‚ç¼–ç å™¨"</span>, 
            <span class="hljs-string">"æ·±å±‚ç¼–ç å™¨"</span>, <span class="hljs-string">"ä»»åŠ¡ç‰¹å®šå±‚"</span>
        ]
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_knowledge_transfer</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–çŸ¥è¯†è¿ç§»è¿‡ç¨‹"""</span>
        <span class="hljs-comment"># æ¨¡æ‹Ÿä¸åŒå±‚çš„çŸ¥è¯†é€šç”¨æ€§</span>
        universality = [<span class="hljs-number">0.95</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.1</span>]
        task_specificity = [<span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.9</span>]
        
        fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">6</span>))
        
        <span class="hljs-comment"># çŸ¥è¯†é€šç”¨æ€§å›¾</span>
        ax1.barh(self.layer_types, universality, color=<span class="hljs-string">'skyblue'</span>, alpha=<span class="hljs-number">0.7</span>)
        ax1.set_xlabel(<span class="hljs-string">'é€šç”¨æ€§ç¨‹åº¦'</span>)
        ax1.set_title(<span class="hljs-string">'ä¸åŒå±‚çš„çŸ¥è¯†é€šç”¨æ€§'</span>)
        ax1.set_xlim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># ä»»åŠ¡ç‰¹å¼‚æ€§å›¾</span>
        ax2.barh(self.layer_types, task_specificity, color=<span class="hljs-string">'lightcoral'</span>, alpha=<span class="hljs-number">0.7</span>)
        ax2.set_xlabel(<span class="hljs-string">'ä»»åŠ¡ç‰¹å¼‚æ€§ç¨‹åº¦'</span>)
        ax2.set_title(<span class="hljs-string">'ä¸åŒå±‚çš„ä»»åŠ¡ç‰¹å¼‚æ€§'</span>)
        ax2.set_xlim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        
        plt.tight_layout()
        plt.show()
        
        print(<span class="hljs-string">"ğŸ“Š çŸ¥è¯†è¿ç§»è§„å¾‹:"</span>)
        <span class="hljs-keyword">for</span> i, layer <span class="hljs-keyword">in</span> enumerate(self.layer_types):
            print(<span class="hljs-string">f"<span class="hljs-subst">{layer}</span>: é€šç”¨æ€§<span class="hljs-subst">{universality[i]:<span class="hljs-number">.1</span>%}</span>, ç‰¹å¼‚æ€§<span class="hljs-subst">{task_specificity[i]:<span class="hljs-number">.1</span>%}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">demonstrate_feature_evolution</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""æ¼”ç¤ºç‰¹å¾æ¼”åŒ–è¿‡ç¨‹"""</span>
        <span class="hljs-comment"># æ¨¡æ‹Ÿé¢„è®­ç»ƒå’Œå¾®è°ƒè¿‡ç¨‹ä¸­ç‰¹å¾çš„å˜åŒ–</span>
        np.random.seed(<span class="hljs-number">42</span>)
        
        <span class="hljs-comment"># é¢„è®­ç»ƒç‰¹å¾ (é€šç”¨)</span>
        pretrain_features = np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, (<span class="hljs-number">100</span>, <span class="hljs-number">2</span>))
        
        <span class="hljs-comment"># å¾®è°ƒåç‰¹å¾ (ä»»åŠ¡ç‰¹å®š)</span>
        finetune_features = pretrain_features + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>, (<span class="hljs-number">100</span>, <span class="hljs-number">2</span>))
        finetune_features[:<span class="hljs-number">50</span>] += [<span class="hljs-number">1.5</span>, <span class="hljs-number">1.5</span>]  <span class="hljs-comment"># ç±»åˆ«1</span>
        finetune_features[<span class="hljs-number">50</span>:] += [<span class="hljs-number">-1.5</span>, <span class="hljs-number">-1.5</span>]  <span class="hljs-comment"># ç±»åˆ«2</span>
        
        fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">5</span>))
        
        <span class="hljs-comment"># é¢„è®­ç»ƒç‰¹å¾åˆ†å¸ƒ</span>
        ax1.scatter(pretrain_features[:, <span class="hljs-number">0</span>], pretrain_features[:, <span class="hljs-number">1</span>], 
                   alpha=<span class="hljs-number">0.6</span>, s=<span class="hljs-number">50</span>, c=<span class="hljs-string">'gray'</span>)
        ax1.set_title(<span class="hljs-string">'é¢„è®­ç»ƒç‰¹å¾åˆ†å¸ƒ\n(é€šç”¨è¡¨ç¤º)'</span>)
        ax1.set_xlabel(<span class="hljs-string">'ç‰¹å¾ç»´åº¦1'</span>)
        ax1.set_ylabel(<span class="hljs-string">'ç‰¹å¾ç»´åº¦2'</span>)
        ax1.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
        
        <span class="hljs-comment"># å¾®è°ƒåç‰¹å¾åˆ†å¸ƒ</span>
        colors = [<span class="hljs-string">'red'</span>] * <span class="hljs-number">50</span> + [<span class="hljs-string">'blue'</span>] * <span class="hljs-number">50</span>
        ax2.scatter(finetune_features[:, <span class="hljs-number">0</span>], finetune_features[:, <span class="hljs-number">1</span>], 
                   alpha=<span class="hljs-number">0.6</span>, s=<span class="hljs-number">50</span>, c=colors)
        ax2.set_title(<span class="hljs-string">'å¾®è°ƒåç‰¹å¾åˆ†å¸ƒ\n(ä»»åŠ¡ç‰¹å®š)'</span>)
        ax2.set_xlabel(<span class="hljs-string">'ç‰¹å¾ç»´åº¦1'</span>)
        ax2.set_ylabel(<span class="hljs-string">'ç‰¹å¾ç»´åº¦2'</span>)
        ax2.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
        
        plt.tight_layout()
        plt.show()
        
        print(<span class="hljs-string">"ğŸ¯ ç‰¹å¾æ¼”åŒ–åˆ†æ:"</span>)
        print(<span class="hljs-string">"â€¢ é¢„è®­ç»ƒé˜¶æ®µ: å­¦ä¹ é€šç”¨çš„è¯­è¨€è¡¨ç¤º"</span>)
        print(<span class="hljs-string">"â€¢ å¾®è°ƒé˜¶æ®µ: é€‚åº”ç‰¹å®šä»»åŠ¡éœ€æ±‚"</span>)
        print(<span class="hljs-string">"â€¢ ç»“æœ: ä¿æŒé€šç”¨æ€§çš„åŒæ—¶è·å¾—ä»»åŠ¡ç‰¹å¼‚æ€§"</span>)

<span class="hljs-comment"># æ¼”ç¤ºè¿ç§»å­¦ä¹ åˆ†æ</span>
transfer_analyzer = TransferLearningAnalyzer()
transfer_analyzer.visualize_knowledge_transfer()
transfer_analyzer.demonstrate_feature_evolution()
</div></code></pre>
<h4 id="%F0%9F%9B%A0%EF%B8%8F-%E5%BE%AE%E8%B0%83%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E9%83%A8%E7%BD%B2%E7%9A%84%E5%AE%8C%E6%95%B4pipeline">ğŸ› ï¸ å¾®è°ƒæµç¨‹è®¾è®¡ï¼šä»æ•°æ®åˆ°éƒ¨ç½²çš„å®Œæ•´pipeline</h4>
<p>ç°åœ¨è®©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„å¾®è°ƒæµç¨‹ï¼Œå°±åƒåœ¨å·¥å‚ä¸­å»ºç«‹æ ‡å‡†åŒ–çš„ç”Ÿäº§çº¿ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FineTuningPipeline</span>:</span>
    <span class="hljs-string">"""å®Œæ•´çš„å¾®è°ƒæµç¨‹ç®¡ç†å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model_name, task_type=<span class="hljs-string">"classification"</span>)</span>:</span>
        <span class="hljs-string">"""
        åˆå§‹åŒ–å¾®è°ƒæµç¨‹
        Args:
            model_name: é¢„è®­ç»ƒæ¨¡å‹åç§°
            task_type: ä»»åŠ¡ç±»å‹ (classification, regression, generation)
        """</span>
        self.model_name = model_name
        self.task_type = task_type
        self.pipeline_stages = [
            <span class="hljs-string">"æ•°æ®å‡†å¤‡"</span>, <span class="hljs-string">"æ¨¡å‹åŠ è½½"</span>, <span class="hljs-string">"é…ç½®ä¼˜åŒ–å™¨"</span>, 
            <span class="hljs-string">"è®­ç»ƒç›‘æ§"</span>, <span class="hljs-string">"æ¨¡å‹è¯„ä¼°"</span>, <span class="hljs-string">"æ¨¡å‹ä¿å­˜"</span>, <span class="hljs-string">"éƒ¨ç½²å‡†å¤‡"</span>
        ]
        
        print(<span class="hljs-string">f"ğŸ­ åˆå§‹åŒ–å¾®è°ƒæµæ°´çº¿: <span class="hljs-subst">{model_name}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“‹ ä»»åŠ¡ç±»å‹: <span class="hljs-subst">{task_type}</span>"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visualize_pipeline</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""å¯è§†åŒ–å¾®è°ƒæµç¨‹"""</span>
        print(<span class="hljs-string">"\nğŸ”„ å¾®è°ƒæµç¨‹å›¾:"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        
        <span class="hljs-comment"># åˆ›å»ºæµç¨‹å›¾</span>
        flow_chart = <span class="hljs-string">"""
        ```mermaid
        graph TD
            A[åŸå§‹æ•°æ®] --&gt; B[æ•°æ®æ¸…æ´—]
            B --&gt; C[æ•°æ®æ ‡æ³¨]
            C --&gt; D[æ•°æ®åˆ’åˆ†]
            D --&gt; E[åŠ è½½é¢„è®­ç»ƒæ¨¡å‹]
            E --&gt; F[æ·»åŠ ä»»åŠ¡å¤´]
            F --&gt; G[é…ç½®è®­ç»ƒå‚æ•°]
            G --&gt; H[å¼€å§‹è®­ç»ƒ]
            H --&gt; I[å®æ—¶ç›‘æ§]
            I --&gt; J{æ˜¯å¦æ”¶æ•›?}
            J --&gt;|å¦| H
            J --&gt;|æ˜¯| K[æ¨¡å‹è¯„ä¼°]
            K --&gt; L[æ€§èƒ½ä¼˜åŒ–]
            L --&gt; M[æ¨¡å‹ä¿å­˜]
            M --&gt; N[éƒ¨ç½²å‡†å¤‡]
            
            style A fill:#e1f5fe
            style N fill:#e8f5e8
            style J fill:#fff3e0
        ```
        """</span>
        print(flow_chart)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">estimate_pipeline_time</span><span class="hljs-params">(self, data_size, model_size=<span class="hljs-string">"base"</span>)</span>:</span>
        <span class="hljs-string">"""
        ä¼°ç®—æµç¨‹æ—¶é—´
        Args:
            data_size: æ•°æ®é›†å¤§å°
            model_size: æ¨¡å‹è§„æ¨¡ (base, large, xl)
        """</span>
        size_multipliers = {<span class="hljs-string">"base"</span>: <span class="hljs-number">1.0</span>, <span class="hljs-string">"large"</span>: <span class="hljs-number">2.5</span>, <span class="hljs-string">"xl"</span>: <span class="hljs-number">6.0</span>}
        
        base_times = {
            <span class="hljs-string">"æ•°æ®å‡†å¤‡"</span>: max(<span class="hljs-number">0.5</span>, data_size / <span class="hljs-number">10000</span>),  <span class="hljs-comment"># å°æ—¶</span>
            <span class="hljs-string">"æ¨¡å‹åŠ è½½"</span>: <span class="hljs-number">0.1</span> * size_multipliers[model_size],
            <span class="hljs-string">"è®­ç»ƒè¿‡ç¨‹"</span>: max(<span class="hljs-number">1.0</span>, data_size / <span class="hljs-number">1000</span>) * size_multipliers[model_size],
            <span class="hljs-string">"æ¨¡å‹è¯„ä¼°"</span>: <span class="hljs-number">0.2</span> * size_multipliers[model_size],
            <span class="hljs-string">"éƒ¨ç½²å‡†å¤‡"</span>: <span class="hljs-number">0.3</span>
        }
        
        print(<span class="hljs-string">f"\nâ±ï¸ æµç¨‹æ—¶é—´ä¼°ç®— (æ•°æ®é‡: <span class="hljs-subst">{data_size}</span>, æ¨¡å‹: <span class="hljs-subst">{model_size}</span>):"</span>)
        print(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
        
        total_time = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> stage, time_hours <span class="hljs-keyword">in</span> base_times.items():
            print(<span class="hljs-string">f"<span class="hljs-subst">{stage}</span>: <span class="hljs-subst">{time_hours:<span class="hljs-number">.1</span>f}</span> å°æ—¶"</span>)
            total_time += time_hours
        
        print(<span class="hljs-string">f"æ€»è®¡æ—¶é—´: <span class="hljs-subst">{total_time:<span class="hljs-number">.1</span>f}</span> å°æ—¶"</span>)
        
        <span class="hljs-keyword">return</span> total_time
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_checklist</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""åˆ›å»ºå¾®è°ƒæ£€æŸ¥æ¸…å•"""</span>
        checklist = {
            <span class="hljs-string">"æ•°æ®å‡†å¤‡"</span>: [
                <span class="hljs-string">"æ•°æ®è´¨é‡æ£€æŸ¥"</span>,
                <span class="hljs-string">"æ ‡æ³¨ä¸€è‡´æ€§éªŒè¯"</span>, 
                <span class="hljs-string">"æ•°æ®å¹³è¡¡æ€§åˆ†æ"</span>,
                <span class="hljs-string">"è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†åˆ’åˆ†"</span>
            ],
            <span class="hljs-string">"æ¨¡å‹é…ç½®"</span>: [
                <span class="hljs-string">"é€‰æ‹©åˆé€‚çš„é¢„è®­ç»ƒæ¨¡å‹"</span>,
                <span class="hljs-string">"è®¾è®¡ä»»åŠ¡ç‰¹å®šå±‚"</span>,
                <span class="hljs-string">"é…ç½®ä¼˜åŒ–å™¨å’Œå­¦ä¹ ç‡"</span>,
                <span class="hljs-string">"è®¾ç½®æ­£åˆ™åŒ–å‚æ•°"</span>
            ],
            <span class="hljs-string">"è®­ç»ƒç›‘æ§"</span>: [
                <span class="hljs-string">"æŸå¤±å‡½æ•°ç›‘æ§"</span>,
                <span class="hljs-string">"éªŒè¯é›†æ€§èƒ½è·Ÿè¸ª"</span>,
                <span class="hljs-string">"è¿‡æ‹Ÿåˆæ£€æµ‹"</span>,
                <span class="hljs-string">"æ—©åœæœºåˆ¶è®¾ç½®"</span>
            ],
            <span class="hljs-string">"æ¨¡å‹è¯„ä¼°"</span>: [
                <span class="hljs-string">"å¤šæŒ‡æ ‡ç»¼åˆè¯„ä¼°"</span>,
                <span class="hljs-string">"é”™è¯¯æ¡ˆä¾‹åˆ†æ"</span>,
                <span class="hljs-string">"æ¨¡å‹é²æ£’æ€§æµ‹è¯•"</span>,
                <span class="hljs-string">"æ•ˆç‡æ€§èƒ½æµ‹è¯•"</span>
            ],
            <span class="hljs-string">"éƒ¨ç½²å‡†å¤‡"</span>: [
                <span class="hljs-string">"æ¨¡å‹å‹ç¼©ä¼˜åŒ–"</span>,
                <span class="hljs-string">"æ¨ç†é€Ÿåº¦æµ‹è¯•"</span>,
                <span class="hljs-string">"å†…å­˜ä½¿ç”¨è¯„ä¼°"</span>,
                <span class="hljs-string">"å…¼å®¹æ€§æ£€æŸ¥"</span>
            ]
        }
        
        print(<span class="hljs-string">"\nğŸ“‹ å¾®è°ƒæ£€æŸ¥æ¸…å•:"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
        
        <span class="hljs-keyword">for</span> category, items <span class="hljs-keyword">in</span> checklist.items():
            print(<span class="hljs-string">f"\nğŸ¯ <span class="hljs-subst">{category}</span>:"</span>)
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:
                print(<span class="hljs-string">f"  â˜ <span class="hljs-subst">{item}</span>"</span>)
        
        <span class="hljs-keyword">return</span> checklist

<span class="hljs-comment"># æ¼”ç¤ºå¾®è°ƒæµç¨‹</span>
pipeline = FineTuningPipeline(<span class="hljs-string">"bert-base-chinese"</span>, <span class="hljs-string">"classification"</span>)
pipeline.visualize_pipeline()
pipeline.estimate_pipeline_time(<span class="hljs-number">10000</span>, <span class="hljs-string">"base"</span>)
pipeline.create_checklist()
</div></code></pre>
<h3 id="%F0%9F%8E%AF-%E5%BE%AE%E8%B0%83%E7%AD%96%E7%95%A5%E9%80%89%E6%8B%A9%E6%8C%87%E5%8D%97">ğŸ¯ å¾®è°ƒç­–ç•¥é€‰æ‹©æŒ‡å—</h3>
<p>é€‰æ‹©åˆé€‚çš„å¾®è°ƒç­–ç•¥å°±åƒé€‰æ‹©åˆé€‚çš„ç”Ÿäº§çº¿é…ç½®ï¼Œéœ€è¦è€ƒè™‘å¤šä¸ªå› ç´ ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StrategySelector</span>:</span>
    <span class="hljs-string">"""å¾®è°ƒç­–ç•¥é€‰æ‹©å™¨"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.decision_tree = {
            <span class="hljs-string">"data_size"</span>: {
                <span class="hljs-string">"small"</span>: <span class="hljs-string">"å‚æ•°é«˜æ•ˆå¾®è°ƒ"</span>,
                <span class="hljs-string">"medium"</span>: <span class="hljs-string">"éƒ¨åˆ†å¾®è°ƒ"</span>,
                <span class="hljs-string">"large"</span>: <span class="hljs-string">"å…¨å‚æ•°å¾®è°ƒ"</span>
            },
            <span class="hljs-string">"compute_budget"</span>: {
                <span class="hljs-string">"low"</span>: <span class="hljs-string">"LoRAæˆ–Adapter"</span>,
                <span class="hljs-string">"medium"</span>: <span class="hljs-string">"éƒ¨åˆ†å±‚å¾®è°ƒ"</span>,
                <span class="hljs-string">"high"</span>: <span class="hljs-string">"å…¨å‚æ•°å¾®è°ƒ"</span>
            },
            <span class="hljs-string">"task_similarity"</span>: {
                <span class="hljs-string">"high"</span>: <span class="hljs-string">"è½»é‡å¾®è°ƒ"</span>,
                <span class="hljs-string">"medium"</span>: <span class="hljs-string">"æ ‡å‡†å¾®è°ƒ"</span>, 
                <span class="hljs-string">"low"</span>: <span class="hljs-string">"æ·±åº¦å¾®è°ƒ"</span>
            }
        }
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recommend_strategy</span><span class="hljs-params">(self, data_size, compute_budget, task_similarity)</span>:</span>
        <span class="hljs-string">"""
        æ¨èå¾®è°ƒç­–ç•¥
        Args:
            data_size: æ•°æ®è§„æ¨¡ (small/medium/large)
            compute_budget: è®¡ç®—é¢„ç®— (low/medium/high)
            task_similarity: ä¸é¢„è®­ç»ƒä»»åŠ¡ç›¸ä¼¼åº¦ (low/medium/high)
        """</span>
        print(<span class="hljs-string">"ğŸ¤– æ™ºèƒ½ç­–ç•¥æ¨èç³»ç»Ÿ"</span>)
        print(<span class="hljs-string">"="</span> * <span class="hljs-number">40</span>)
        print(<span class="hljs-string">f"æ•°æ®è§„æ¨¡: <span class="hljs-subst">{data_size}</span>"</span>)
        print(<span class="hljs-string">f"è®¡ç®—é¢„ç®—: <span class="hljs-subst">{compute_budget}</span>"</span>)
        print(<span class="hljs-string">f"ä»»åŠ¡ç›¸ä¼¼åº¦: <span class="hljs-subst">{task_similarity}</span>"</span>)
        print(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
        
        <span class="hljs-comment"># åŸºäºè§„åˆ™çš„æ¨è</span>
        <span class="hljs-keyword">if</span> data_size == <span class="hljs-string">"small"</span> <span class="hljs-keyword">or</span> compute_budget == <span class="hljs-string">"low"</span>:
            <span class="hljs-keyword">if</span> task_similarity == <span class="hljs-string">"high"</span>:
                recommendation = <span class="hljs-string">"Prompt Tuning"</span>
                confidence = <span class="hljs-number">0.9</span>
            <span class="hljs-keyword">else</span>:
                recommendation = <span class="hljs-string">"LoRA"</span>
                confidence = <span class="hljs-number">0.85</span>
        <span class="hljs-keyword">elif</span> data_size == <span class="hljs-string">"large"</span> <span class="hljs-keyword">and</span> compute_budget == <span class="hljs-string">"high"</span>:
            recommendation = <span class="hljs-string">"Full Fine-tuning"</span>
            confidence = <span class="hljs-number">0.95</span>
        <span class="hljs-keyword">else</span>:
            recommendation = <span class="hljs-string">"Adapter"</span>
            confidence = <span class="hljs-number">0.8</span>
        
        print(<span class="hljs-string">f"ğŸ¯ æ¨èç­–ç•¥: <span class="hljs-subst">{recommendation}</span>"</span>)
        print(<span class="hljs-string">f"ğŸ“Š ç½®ä¿¡åº¦: <span class="hljs-subst">{confidence:<span class="hljs-number">.1</span>%}</span>"</span>)
        
        <span class="hljs-comment"># æä¾›æ›¿ä»£æ–¹æ¡ˆ</span>
        alternatives = self._get_alternatives(recommendation)
        print(<span class="hljs-string">f"ğŸ”„ å¤‡é€‰æ–¹æ¡ˆ: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(alternatives)}</span>"</span>)
        
        <span class="hljs-keyword">return</span> recommendation, confidence
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_alternatives</span><span class="hljs-params">(self, primary)</span>:</span>
        <span class="hljs-string">"""è·å–æ›¿ä»£æ–¹æ¡ˆ"""</span>
        alternatives_map = {
            <span class="hljs-string">"Full Fine-tuning"</span>: [<span class="hljs-string">"LoRA"</span>, <span class="hljs-string">"Adapter"</span>],
            <span class="hljs-string">"LoRA"</span>: [<span class="hljs-string">"QLoRA"</span>, <span class="hljs-string">"Adapter"</span>],
            <span class="hljs-string">"Adapter"</span>: [<span class="hljs-string">"LoRA"</span>, <span class="hljs-string">"Prefix Tuning"</span>],
            <span class="hljs-string">"Prompt Tuning"</span>: [<span class="hljs-string">"P-tuning v2"</span>, <span class="hljs-string">"LoRA"</span>]
        }
        <span class="hljs-keyword">return</span> alternatives_map.get(primary, [<span class="hljs-string">"LoRA"</span>, <span class="hljs-string">"Adapter"</span>])

<span class="hljs-comment"># æ¼”ç¤ºç­–ç•¥é€‰æ‹©</span>
selector = StrategySelector()

<span class="hljs-comment"># ä¸åŒåœºæ™¯çš„ç­–ç•¥æ¨è</span>
scenarios = [
    (<span class="hljs-string">"small"</span>, <span class="hljs-string">"low"</span>, <span class="hljs-string">"high"</span>),      <span class="hljs-comment"># å°æ•°æ®ï¼Œä½é¢„ç®—ï¼Œé«˜ç›¸ä¼¼åº¦</span>
    (<span class="hljs-string">"large"</span>, <span class="hljs-string">"high"</span>, <span class="hljs-string">"low"</span>),      <span class="hljs-comment"># å¤§æ•°æ®ï¼Œé«˜é¢„ç®—ï¼Œä½ç›¸ä¼¼åº¦</span>
    (<span class="hljs-string">"medium"</span>, <span class="hljs-string">"medium"</span>, <span class="hljs-string">"medium"</span>) <span class="hljs-comment"># ä¸­ç­‰åœºæ™¯</span>
]

<span class="hljs-keyword">for</span> i, (data, budget, similarity) <span class="hljs-keyword">in</span> enumerate(scenarios, <span class="hljs-number">1</span>):
    print(<span class="hljs-string">f"\nğŸ“‹ åœºæ™¯ <span class="hljs-subst">{i}</span>:"</span>)
    selector.recommend_strategy(data, budget, similarity)
</div></code></pre>
<p>é€šè¿‡è¿™ä¸€èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ·±å…¥ç†è§£äº†æ¨¡å‹å¾®è°ƒçš„åŸºç¡€ç†è®ºã€‚å¾®è°ƒä¸ä»…ä»…æ˜¯ç®€å•çš„å‚æ•°æ›´æ–°ï¼Œè€Œæ˜¯ä¸€ä¸ªæ¶‰åŠçŸ¥è¯†è¿ç§»ã€ç­–ç•¥é€‰æ‹©å’Œæµç¨‹ç®¡ç†çš„å¤æ‚è¿‡ç¨‹ã€‚</p>
<p>åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯LoRAã€Adapterç­‰å‰æ²¿æ–¹æ³•ï¼Œè®©æˆ‘ä»¬çš„æ¨¡å‹å®šåˆ¶å·¥å‚èƒ½å¤Ÿæä¾›æ›´åŠ é«˜æ•ˆå’Œç»æµçš„å®šåˆ¶æ–¹æ¡ˆã€‚</p>
<hr>
<h2 id="287-%E6%9C%AC%E7%AB%A0%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B">28.7 æœ¬ç« æ€»ç»“ä¸å±•æœ›</h2>
<p>é€šè¿‡è¿™ä¸€ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ·±å…¥ç†è§£äº†æ¨¡å‹å¾®è°ƒä¸å®šåˆ¶åŒ–å¼€å‘çš„æ ¸å¿ƒåŸç†å’ŒæŠ€æœ¯è·¯çº¿ã€‚æˆ‘ä»¬å­¦ä¹ äº†å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯ã€æ•°æ®å·¥ç¨‹ä¸é¢„å¤„ç†æŠ€æœ¯ã€è®­ç»ƒä¼˜åŒ–ä¸ç›‘æ§æŠ€æœ¯ã€æ¨¡å‹è¯„ä¼°ä¸åˆ†ææŠ€æœ¯ï¼Œä»¥åŠå®šåˆ¶åŒ–AIåŠ©æ‰‹å¼€å‘æµç¨‹ã€‚</p>
<p>åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å°†è¿™äº›æŠ€æœ¯åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­ï¼Œå®ç°å®Œæ•´çš„å®šåˆ¶åŒ–è§£å†³æ–¹æ¡ˆã€‚</p>
<hr>

</body>
</html>
