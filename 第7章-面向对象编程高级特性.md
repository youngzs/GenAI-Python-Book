# ç¬¬7ç« ï¼šé¢å‘å¯¹è±¡ç¼–ç¨‹é«˜çº§ç‰¹æ€§ - è®©å¯¹è±¡æ‹¥æœ‰"è¶…èƒ½åŠ›"

> **å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡Pythoné¢å‘å¯¹è±¡çš„é«˜çº§ç‰¹æ€§ï¼ŒåŒ…æ‹¬é­”æœ¯æ–¹æ³•ã€å±æ€§ç®¡ç†ã€æè¿°ç¬¦ã€æŠ½è±¡åŸºç±»å’Œè®¾è®¡æ¨¡å¼ï¼Œèƒ½å¤Ÿè®¾è®¡å‡ºåŠŸèƒ½å¼ºå¤§ã€æ‰©å±•æ€§å¥½çš„ç±»ä½“ç³»ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä½ çš„å¯¹è±¡å¯ä»¥åƒå†…ç½®ç±»å‹ä¸€æ ·æ”¯æŒ `+`ã€`-`ã€`==` ç­‰è¿ç®—ç¬¦ï¼Œå¯ä»¥è‡ªåŠ¨éªŒè¯å±æ€§å€¼ï¼Œå¯ä»¥åƒå®¹å™¨ä¸€æ ·è¢«è¿­ä»£å’Œç´¢å¼•ï¼Œé‚£è¯¥æœ‰å¤šé…·ï¼Ÿè¿™å°±æ˜¯Pythoné¢å‘å¯¹è±¡é«˜çº§ç‰¹æ€§çš„é­…åŠ›â€”â€”è®©ä½ çš„è‡ªå®šä¹‰ç±»æ‹¥æœ‰"è¶…èƒ½åŠ›"ï¼

---

## ğŸ­ ç¬¬7.1èŠ‚ï¼šé­”æœ¯æ–¹æ³•ä¸è¿ç®—ç¬¦é‡è½½ - ç»™å¯¹è±¡æ·»åŠ "é­”æ³•"

### ä»€ä¹ˆæ˜¯é­”æœ¯æ–¹æ³•ï¼Ÿ

é­”æœ¯æ–¹æ³•ï¼ˆMagic Methodsï¼‰ï¼Œä¹Ÿå«ç‰¹æ®Šæ–¹æ³•æˆ–åŒä¸‹åˆ’çº¿æ–¹æ³•ï¼Œæ˜¯Pythonä¸­ä»¥åŒä¸‹åˆ’çº¿å¼€å¤´å’Œç»“å°¾çš„ç‰¹æ®Šæ–¹æ³•ã€‚å®ƒä»¬å®šä¹‰äº†å¯¹è±¡çš„è¡Œä¸ºï¼Œè®©ä½ çš„è‡ªå®šä¹‰ç±»å¯ä»¥åƒå†…ç½®ç±»å‹ä¸€æ ·å·¥ä½œã€‚

å°±åƒç»™è¶…çº§è‹±é›„èµ‹äºˆè¶…èƒ½åŠ›ä¸€æ ·ï¼Œé­”æœ¯æ–¹æ³•ç»™æ™®é€šå¯¹è±¡èµ‹äºˆäº†ç‰¹æ®Šèƒ½åŠ›ï¼š

```python
# æ²¡æœ‰é­”æœ¯æ–¹æ³•çš„æ™®é€šç±»
class SimpleVector:
    def __init__(self, x, y):
        self.x = x
        self.y = y

# ä½¿ç”¨æ—¶å¾ˆä¸æ–¹ä¾¿
v1 = SimpleVector(1, 2)
v2 = SimpleVector(3, 4)
print(v1)  # è¾“å‡ºï¼š<__main__.SimpleVector object at 0x...> çœ‹ä¸æ‡‚ï¼
# v3 = v1 + v2  # æŠ¥é”™ï¼ä¸æ”¯æŒåŠ æ³•

# æœ‰é­”æœ¯æ–¹æ³•çš„"è¶…èƒ½åŠ›"ç±»
class MagicVector:
    def __init__(self, x, y):
        self.x = x
        self.y = y
    
    def __str__(self):
        return f"Vector({self.x}, {self.y})"
    
    def __add__(self, other):
        return MagicVector(self.x + other.x, self.y + other.y)

# ä½¿ç”¨èµ·æ¥å°±åƒå†…ç½®ç±»å‹ä¸€æ ·è‡ªç„¶
v1 = MagicVector(1, 2)
v2 = MagicVector(3, 4)
print(v1)  # è¾“å‡ºï¼šVector(1, 2) æ¸…æ¥šæ˜äº†ï¼
v3 = v1 + v2  # å¯ä»¥ç›´æ¥ç›¸åŠ ï¼
print(v3)  # è¾“å‡ºï¼šVector(4, 6)
```

### å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé­”æœ¯æ–¹æ³•

#### 1. `__new__` vs `__init__`ï¼šå¯¹è±¡çš„"å‡ºç”Ÿ"è¿‡ç¨‹

å¾ˆå¤šäººä»¥ä¸º `__init__` æ˜¯æ„é€ å‡½æ•°ï¼Œå…¶å®ä¸ç„¶ã€‚å¯¹è±¡çš„åˆ›å»ºåˆ†ä¸ºä¸¤æ­¥ï¼š

```python
class Person:
    def __new__(cls, name, age):
        print(f"Step 1: __new__ æ­£åœ¨åˆ›å»º {name} çš„å®ä¾‹")
        # __new__ è´Ÿè´£åˆ›å»ºå®ä¾‹
        instance = super().__new__(cls)
        return instance
    
    def __init__(self, name, age):
        print(f"Step 2: __init__ æ­£åœ¨åˆå§‹åŒ– {name}")
        # __init__ è´Ÿè´£åˆå§‹åŒ–å®ä¾‹
        self.name = name
        self.age = age

# åˆ›å»ºå¯¹è±¡æ—¶ä¼šå…ˆè°ƒç”¨ __new__ å†è°ƒç”¨ __init__
person = Person("å¼ ä¸‰", 25)
# è¾“å‡ºï¼š
# Step 1: __new__ æ­£åœ¨åˆ›å»º å¼ ä¸‰ çš„å®ä¾‹
# Step 2: __init__ æ­£åœ¨åˆå§‹åŒ– å¼ ä¸‰
```

**`__new__` çš„å®é™…åº”ç”¨ - å•ä¾‹æ¨¡å¼**ï¼š

```python
class DatabaseConnection:
    _instance = None
    
    def __new__(cls):
        # å•ä¾‹æ¨¡å¼ï¼šåªåˆ›å»ºä¸€ä¸ªå®ä¾‹
        if cls._instance is None:
            print("åˆ›å»ºæ•°æ®åº“è¿æ¥...")
            cls._instance = super().__new__(cls)
        else:
            print("ä½¿ç”¨ç°æœ‰æ•°æ®åº“è¿æ¥...")
        return cls._instance
    
    def __init__(self):
        if not hasattr(self, 'initialized'):
            self.host = "localhost"
            self.port = 3306
            self.initialized = True

# æµ‹è¯•å•ä¾‹æ•ˆæœ
db1 = DatabaseConnection()  # åˆ›å»ºæ•°æ®åº“è¿æ¥...
db2 = DatabaseConnection()  # ä½¿ç”¨ç°æœ‰æ•°æ®åº“è¿æ¥...
print(db1 is db2)  # Trueï¼Œæ˜¯åŒä¸€ä¸ªå®ä¾‹
```

#### 2. `__del__`ï¼šå¯¹è±¡çš„"è‘¬ç¤¼"

```python
class FileManager:
    def __init__(self, filename):
        self.filename = filename
        self.file = open(filename, 'w')
        print(f"æ‰“å¼€æ–‡ä»¶ {filename}")
    
    def __del__(self):
        # å¯¹è±¡è¢«é”€æ¯æ—¶è‡ªåŠ¨è°ƒç”¨
        if hasattr(self, 'file') and not self.file.closed:
            self.file.close()
            print(f"è‡ªåŠ¨å…³é—­æ–‡ä»¶ {self.filename}")

# æµ‹è¯•è‡ªåŠ¨èµ„æºç®¡ç†
manager = FileManager("test.txt")
manager = None  # åˆ é™¤å¼•ç”¨ï¼Œè§¦å‘ __del__
# è¾“å‡ºï¼šè‡ªåŠ¨å…³é—­æ–‡ä»¶ test.txt
```

### å­—ç¬¦ä¸²è¡¨ç¤ºé­”æœ¯æ–¹æ³•

#### `__str__` vs `__repr__`ï¼šä¸¤ç§"è‡ªæˆ‘ä»‹ç»"æ–¹å¼

```python
class Student:
    def __init__(self, name, grade, student_id):
        self.name = name
        self.grade = grade
        self.student_id = student_id
    
    def __str__(self):
        # ç»™ç”¨æˆ·çœ‹çš„å‹å¥½è¡¨ç¤º
        return f"{self.name}åŒå­¦ï¼ˆ{self.grade}å¹´çº§ï¼‰"
    
    def __repr__(self):
        # ç»™å¼€å‘è€…çœ‹çš„ç²¾ç¡®è¡¨ç¤ºï¼Œæœ€å¥½èƒ½é‡ç°å¯¹è±¡
        return f"Student('{self.name}', {self.grade}, '{self.student_id}')"

student = Student("æé›·", 3, "2021001")

print(str(student))   # æé›·åŒå­¦ï¼ˆ3å¹´çº§ï¼‰
print(repr(student))  # Student('æé›·', 3, '2021001')

# åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºæ—¶ä½¿ç”¨ __repr__
students = [student]
print(students)  # [Student('æé›·', 3, '2021001')]
```

**æœ€ä½³å®è·µ**ï¼š
- `__str__`ï¼šå†™ç»™ç”¨æˆ·çœ‹çš„ï¼Œè¦å‹å¥½æ˜“è¯»
- `__repr__`ï¼šå†™ç»™å¼€å‘è€…çœ‹çš„ï¼Œè¦ç²¾ç¡®æ˜ç¡®ï¼Œæœ€å¥½èƒ½ç”¨æ¥é‡å»ºå¯¹è±¡

#### `__format__`ï¼šè‡ªå®šä¹‰æ ¼å¼åŒ–

```python
class Money:
    def __init__(self, amount):
        self.amount = amount
    
    def __format__(self, format_spec):
        if format_spec == 'cn':
            return f"ï¿¥{self.amount:.2f}"
        elif format_spec == 'us':
            return f"${self.amount:.2f}"
        elif format_spec == 'int':
            return f"{int(self.amount)}"
        else:
            return f"{self.amount:.2f}"

money = Money(1234.567)
print(f"ä¸­æ–‡æ ¼å¼ï¼š{money:cn}")    # ä¸­æ–‡æ ¼å¼ï¼šï¿¥1234.57
print(f"ç¾å¼æ ¼å¼ï¼š{money:us}")    # ç¾å¼æ ¼å¼ï¼š$1234.57
print(f"æ•´æ•°æ ¼å¼ï¼š{money:int}")   # æ•´æ•°æ ¼å¼ï¼š1234
```

### æ¯”è¾ƒè¿ç®—ç¬¦é‡è½½

```python
class Grade:
    def __init__(self, score):
        self.score = score
    
    def __eq__(self, other):
        """ç›¸ç­‰æ¯”è¾ƒ =="""
        return self.score == other.score
    
    def __lt__(self, other):
        """å°äºæ¯”è¾ƒ <"""
        return self.score < other.score
    
    def __le__(self, other):
        """å°äºç­‰äº <="""
        return self.score <= other.score
    
    def __gt__(self, other):
        """å¤§äºæ¯”è¾ƒ >"""
        return self.score > other.score
    
    def __ge__(self, other):
        """å¤§äºç­‰äº >="""
        return self.score >= other.score
    
    def __ne__(self, other):
        """ä¸ç­‰äº !="""
        return self.score != other.score
    
    def __str__(self):
        return f"Grade({self.score})"

# æµ‹è¯•æ¯”è¾ƒæ“ä½œ
grade1 = Grade(85)
grade2 = Grade(92)
grade3 = Grade(85)

print(f"{grade1} == {grade3}: {grade1 == grade3}")  # True
print(f"{grade1} < {grade2}: {grade1 < grade2}")    # True
print(f"{grade1} > {grade2}: {grade1 > grade2}")    # False

# å¯ä»¥æ’åºäº†ï¼
grades = [Grade(78), Grade(92), Grade(85), Grade(67)]
sorted_grades = sorted(grades)
print("æ’åºåçš„æˆç»©ï¼š", [str(g) for g in sorted_grades])
# è¾“å‡ºï¼šæ’åºåçš„æˆç»©ï¼š ['Grade(67)', 'Grade(78)', 'Grade(85)', 'Grade(92)']
```

**æŠ€å·§**ï¼šPython å¯ä»¥ä» `__eq__` å’Œ `__lt__` è‡ªåŠ¨æ¨å¯¼å…¶ä»–æ¯”è¾ƒæ–¹æ³•ï¼Œä½¿ç”¨ `functools.total_ordering` è£…é¥°å™¨ï¼š

```python
from functools import total_ordering

@total_ordering
class SimpleGrade:
    def __init__(self, score):
        self.score = score
    
    def __eq__(self, other):
        return self.score == other.score
    
    def __lt__(self, other):
        return self.score < other.score
    
    def __str__(self):
        return f"Grade({self.score})"

# åªå®šä¹‰äº† __eq__ å’Œ __lt__ï¼Œä½†å…¶ä»–æ¯”è¾ƒæ–¹æ³•ä¹Ÿèƒ½å·¥ä½œï¼
grade1 = SimpleGrade(85)
grade2 = SimpleGrade(92)
print(grade1 <= grade2)  # Trueï¼Œè‡ªåŠ¨æ¨å¯¼å‡ºæ¥çš„
```

### ç®—æœ¯è¿ç®—ç¬¦é‡è½½

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„å‘é‡ç±»ï¼š

```python
class Vector2D:
    def __init__(self, x, y):
        self.x = x
        self.y = y
    
    # åŸºæœ¬ç®—æœ¯è¿ç®—
    def __add__(self, other):
        """å‘é‡åŠ æ³•"""
        return Vector2D(self.x + other.x, self.y + other.y)
    
    def __sub__(self, other):
        """å‘é‡å‡æ³•"""
        return Vector2D(self.x - other.x, self.y - other.y)
    
    def __mul__(self, scalar):
        """å‘é‡æ•°ä¹˜"""
        if isinstance(scalar, (int, float)):
            return Vector2D(self.x * scalar, self.y * scalar)
        else:
            raise TypeError("å‘é‡åªèƒ½ä¸æ•°å­—ç›¸ä¹˜")
    
    def __rmul__(self, scalar):
        """åå‘ä¹˜æ³•ï¼š3 * vector"""
        return self.__mul__(scalar)
    
    def __truediv__(self, scalar):
        """å‘é‡é™¤æ³•"""
        if isinstance(scalar, (int, float)) and scalar != 0:
            return Vector2D(self.x / scalar, self.y / scalar)
        else:
            raise ValueError("é™¤æ•°å¿…é¡»æ˜¯éé›¶æ•°å­—")
    
    # å¢å¼ºèµ‹å€¼è¿ç®—ç¬¦
    def __iadd__(self, other):
        """+="""
        self.x += other.x
        self.y += other.y
        return self
    
    def __isub__(self, other):
        """-="""
        self.x -= other.x
        self.y -= other.y
        return self
    
    # ä¸€å…ƒè¿ç®—ç¬¦
    def __neg__(self):
        """è´Ÿå· -vector"""
        return Vector2D(-self.x, -self.y)
    
    def __abs__(self):
        """ç»å¯¹å€¼ï¼ˆå‘é‡é•¿åº¦ï¼‰"""
        return (self.x ** 2 + self.y ** 2) ** 0.5
    
    # æ¯”è¾ƒè¿ç®—ï¼ˆæŒ‰é•¿åº¦æ¯”è¾ƒï¼‰
    def __eq__(self, other):
        return abs(self) == abs(other)
    
    def __lt__(self, other):
        return abs(self) < abs(other)
    
    def __str__(self):
        return f"Vector2D({self.x}, {self.y})"
    
    def __repr__(self):
        return f"Vector2D(x={self.x}, y={self.y})"

# æµ‹è¯•å®Œæ•´çš„å‘é‡è¿ç®—
v1 = Vector2D(3, 4)
v2 = Vector2D(1, 2)

print(f"v1 = {v1}")              # v1 = Vector2D(3, 4)
print(f"v2 = {v2}")              # v2 = Vector2D(1, 2)
print(f"v1 + v2 = {v1 + v2}")    # v1 + v2 = Vector2D(4, 6)
print(f"v1 - v2 = {v1 - v2}")    # v1 - v2 = Vector2D(2, 2)
print(f"v1 * 2 = {v1 * 2}")      # v1 * 2 = Vector2D(6, 8)
print(f"3 * v1 = {3 * v1}")      # 3 * v1 = Vector2D(9, 12)
print(f"-v1 = {-v1}")            # -v1 = Vector2D(-3, -4)
print(f"|v1| = {abs(v1)}")       # |v1| = 5.0

# å¢å¼ºèµ‹å€¼
v1 += v2
print(f"v1 += v2 å: {v1}")       # v1 += v2 å: Vector2D(4, 6)
```

### å®¹å™¨æ¨¡æ‹Ÿé­”æœ¯æ–¹æ³•

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„æˆç»©å†Œç±»ï¼Œæ”¯æŒåƒåˆ—è¡¨ä¸€æ ·çš„æ“ä½œï¼š

```python
class GradeBook:
    def __init__(self):
        self._grades = {}  # {å­¦ç”Ÿå§“å: æˆç»©}
    
    def __len__(self):
        """æ”¯æŒ len() å‡½æ•°"""
        return len(self._grades)
    
    def __getitem__(self, name):
        """æ”¯æŒ [] å–å€¼"""
        if name in self._grades:
            return self._grades[name]
        else:
            raise KeyError(f"å­¦ç”Ÿ {name} ä¸å­˜åœ¨")
    
    def __setitem__(self, name, grade):
        """æ”¯æŒ [] èµ‹å€¼"""
        if not isinstance(grade, (int, float)) or not 0 <= grade <= 100:
            raise ValueError("æˆç»©å¿…é¡»æ˜¯ 0-100 ä¹‹é—´çš„æ•°å­—")
        self._grades[name] = grade
    
    def __delitem__(self, name):
        """æ”¯æŒ del åˆ é™¤"""
        if name in self._grades:
            del self._grades[name]
        else:
            raise KeyError(f"å­¦ç”Ÿ {name} ä¸å­˜åœ¨")
    
    def __contains__(self, name):
        """æ”¯æŒ in æ“ä½œç¬¦"""
        return name in self._grades
    
    def __iter__(self):
        """æ”¯æŒ for å¾ªç¯éå†"""
        return iter(self._grades.items())
    
    def __str__(self):
        return f"GradeBook({len(self)} students)"
    
    def __repr__(self):
        return f"GradeBook({dict(self._grades)})"

# æµ‹è¯•å®¹å™¨åŠŸèƒ½
gradebook = GradeBook()

# æ·»åŠ æˆç»©ï¼ˆæ”¯æŒ [] èµ‹å€¼ï¼‰
gradebook["å¼ ä¸‰"] = 85
gradebook["æå››"] = 92
gradebook["ç‹äº”"] = 78

# è·å–æˆç»©ï¼ˆæ”¯æŒ [] å–å€¼ï¼‰
print(f"å¼ ä¸‰çš„æˆç»©ï¼š{gradebook['å¼ ä¸‰']}")  # å¼ ä¸‰çš„æˆç»©ï¼š85

# æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å­˜åœ¨ï¼ˆæ”¯æŒ inï¼‰
print("å¼ ä¸‰" in gradebook)  # True
print("èµµå…­" in gradebook)  # False

# è·å–å­¦ç”Ÿæ•°é‡ï¼ˆæ”¯æŒ lenï¼‰
print(f"å­¦ç”Ÿæ•°é‡ï¼š{len(gradebook)}")  # å­¦ç”Ÿæ•°é‡ï¼š3

# éå†æ‰€æœ‰å­¦ç”Ÿï¼ˆæ”¯æŒ for å¾ªç¯ï¼‰
print("æ‰€æœ‰å­¦ç”Ÿæˆç»©ï¼š")
for name, grade in gradebook:
    print(f"  {name}: {grade}")

# åˆ é™¤å­¦ç”Ÿï¼ˆæ”¯æŒ delï¼‰
del gradebook["ç‹äº”"]
print(f"åˆ é™¤ç‹äº”åå­¦ç”Ÿæ•°é‡ï¼š{len(gradebook)}")  # åˆ é™¤ç‹äº”åå­¦ç”Ÿæ•°é‡ï¼š2
```

### ğŸƒâ€â™‚ï¸ å®è·µç»ƒä¹ ï¼šæ™ºèƒ½è®¡ç®—å™¨ç±»

**ç»ƒä¹ 1**ï¼šåˆ›å»ºä¸€ä¸ª `Calculator` ç±»ï¼Œæ”¯æŒåŸºæœ¬æ•°å­¦è¿ç®—å’Œæ¯”è¾ƒã€‚

**è¦æ±‚**ï¼š
1. æ”¯æŒ `+`ã€`-`ã€`*`ã€`/` å››åˆ™è¿ç®—
2. æ”¯æŒæ¯”è¾ƒè¿ç®—ç¬¦
3. æ”¯æŒæ ¼å¼åŒ–è¾“å‡ºï¼ˆæ•´æ•°ã€å°æ•°ã€ç™¾åˆ†æ¯”ï¼‰
4. è®°å½•è¿ç®—å†å²

```python
class Calculator:
    def __init__(self, value=0):
        self.value = value
        self.history = []  # è¿ç®—å†å²
    
    def _record(self, operation, other, result):
        """è®°å½•è¿ç®—å†å²"""
        self.history.append(f"{self.value} {operation} {other} = {result}")
    
    def __add__(self, other):
        if isinstance(other, Calculator):
            result = self.value + other.value
        else:
            result = self.value + other
        self._record('+', other, result)
        return Calculator(result)
    
    def __sub__(self, other):
        # TODO: å®ç°å‡æ³•
        pass
    
    def __mul__(self, other):
        # TODO: å®ç°ä¹˜æ³•
        pass
    
    def __truediv__(self, other):
        # TODO: å®ç°é™¤æ³•
        pass
    
    def __eq__(self, other):
        # TODO: å®ç°ç›¸ç­‰æ¯”è¾ƒ
        pass
    
    def __format__(self, format_spec):
        # TODO: å®ç°æ ¼å¼åŒ–
        # 'int': æ•´æ•°æ ¼å¼
        # 'float': å°æ•°æ ¼å¼
        # 'percent': ç™¾åˆ†æ¯”æ ¼å¼
        pass
    
    def __str__(self):
        return str(self.value)

# æµ‹è¯•ä»£ç 
calc1 = Calculator(10)
calc2 = Calculator(3)
result = calc1 + calc2
print(f"è®¡ç®—ç»“æœï¼š{result}")  # è®¡ç®—ç»“æœï¼š13
```

### æœ¬èŠ‚å°ç»“

é­”æœ¯æ–¹æ³•è®©ä½ çš„è‡ªå®šä¹‰ç±»å…·å¤‡äº†"è¶…èƒ½åŠ›"ï¼š

1. **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ**ï¼š`__new__`ã€`__init__`ã€`__del__`
2. **å­—ç¬¦ä¸²è¡¨ç¤º**ï¼š`__str__`ã€`__repr__`ã€`__format__`
3. **æ¯”è¾ƒè¿ç®—**ï¼š`__eq__`ã€`__lt__`ã€`__le__` ç­‰
4. **ç®—æœ¯è¿ç®—**ï¼š`__add__`ã€`__sub__`ã€`__mul__` ç­‰
5. **å®¹å™¨æ¨¡æ‹Ÿ**ï¼š`__len__`ã€`__getitem__`ã€`__setitem__` ç­‰

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†å­¦ä¹ å±æ€§ç®¡ç†å’Œæè¿°ç¬¦ï¼Œè®©å¯¹è±¡çš„å±æ€§å˜å¾—æ›´åŠ æ™ºèƒ½ï¼

---

## ğŸ›ï¸ ç¬¬7.2èŠ‚ï¼šå±æ€§ç®¡ç†ä¸æè¿°ç¬¦ - è®©å±æ€§å˜å¾—"æ™ºèƒ½"

### ä¸ºä»€ä¹ˆéœ€è¦æ™ºèƒ½å±æ€§ï¼Ÿ

åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œæœ‰äº›å±æ€§ä¸èƒ½éšæ„è®¾ç½®ã€‚æ¯”å¦‚ï¼š
- äººçš„å¹´é¾„ä¸èƒ½æ˜¯è´Ÿæ•°
- æ¸©åº¦ä¸èƒ½ä½äºç»å¯¹é›¶åº¦ï¼ˆ-273.15Â°Cï¼‰
- é“¶è¡Œè´¦æˆ·ä½™é¢å˜åŒ–éœ€è¦è®°å½•æ—¥å¿—
- æŸäº›å±æ€§éœ€è¦æ ¹æ®å…¶ä»–å±æ€§è‡ªåŠ¨è®¡ç®—

ä¼ ç»Ÿçš„åšæ³•æ˜¯å†™å¤§é‡çš„ getter å’Œ setter æ–¹æ³•ï¼Œä½† Python æä¾›äº†æ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚

### property è£…é¥°å™¨ï¼šå±æ€§çš„"å®ˆé—¨å‘˜"

#### åŸºç¡€ç”¨æ³•ï¼šåªè¯»å±æ€§

```python
class Circle:
    def __init__(self, radius):
        self._radius = radius  # ä½¿ç”¨ä¸‹åˆ’çº¿è¡¨ç¤º"å†…éƒ¨"å±æ€§
    
    @property
    def radius(self):
        """åŠå¾„å±æ€§ï¼ˆåªè¯»ï¼‰"""
        return self._radius
    
    @property  
    def area(self):
        """é¢ç§¯å±æ€§ï¼ˆåªè¯»ï¼Œè‡ªåŠ¨è®¡ç®—ï¼‰"""
        return 3.14159 * self._radius ** 2
    
    @property
    def circumference(self):
        """å‘¨é•¿å±æ€§ï¼ˆåªè¯»ï¼Œè‡ªåŠ¨è®¡ç®—ï¼‰"""
        return 2 * 3.14159 * self._radius

# ä½¿ç”¨åƒæ™®é€šå±æ€§ä¸€æ ·
circle = Circle(5)
print(f"åŠå¾„ï¼š{circle.radius}")       # åŠå¾„ï¼š5
print(f"é¢ç§¯ï¼š{circle.area:.2f}")     # é¢ç§¯ï¼š78.54
print(f"å‘¨é•¿ï¼š{circle.circumference:.2f}")  # å‘¨é•¿ï¼š31.42

# è¯•å›¾ä¿®æ”¹åªè¯»å±æ€§ä¼šæŠ¥é”™
# circle.area = 100  # AttributeError: can't set attribute
```

#### å®Œæ•´ç”¨æ³•ï¼šgetterã€setterã€deleter

```python
class Temperature:
    def __init__(self, celsius=0):
        self._celsius = celsius
        self._change_log = []  # è®°å½•æ¸©åº¦å˜åŒ–
    
    @property
    def celsius(self):
        """æ‘„æ°æ¸©åº¦ getter"""
        return self._celsius
    
    @celsius.setter
    def celsius(self, value):
        """æ‘„æ°æ¸©åº¦ setterï¼Œå¸¦éªŒè¯"""
        if not isinstance(value, (int, float)):
            raise TypeError("æ¸©åº¦å¿…é¡»æ˜¯æ•°å­—")
        if value < -273.15:
            raise ValueError("æ¸©åº¦ä¸èƒ½ä½äºç»å¯¹é›¶åº¦ï¼ˆ-273.15Â°Cï¼‰")
        
        # è®°å½•å˜åŒ–
        old_value = self._celsius
        self._celsius = value
        self._change_log.append(f"æ¸©åº¦ä» {old_value}Â°C å˜ä¸º {value}Â°C")
    
    @celsius.deleter
    def celsius(self):
        """é‡ç½®æ¸©åº¦"""
        self._celsius = 0
        self._change_log.append("æ¸©åº¦è¢«é‡ç½®ä¸º 0Â°C")
    
    # åæ°æ¸©åº¦å±æ€§ï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰
    @property
    def fahrenheit(self):
        """åæ°æ¸©åº¦ getter"""
        return self._celsius * 9/5 + 32
    
    @fahrenheit.setter
    def fahrenheit(self, value):
        """åæ°æ¸©åº¦ setterï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºæ‘„æ°åº¦"""
        if not isinstance(value, (int, float)):
            raise TypeError("æ¸©åº¦å¿…é¡»æ˜¯æ•°å­—")
        celsius_value = (value - 32) * 5/9
        self.celsius = celsius_value  # ä½¿ç”¨æ‘„æ°åº¦çš„ setterï¼ŒåŒ…å«éªŒè¯é€»è¾‘
    
    @property
    def kelvin(self):
        """å¼€å°”æ–‡æ¸©åº¦"""
        return self._celsius + 273.15
    
    @property
    def change_log(self):
        """æ¸©åº¦å˜åŒ–æ—¥å¿—"""
        return self._change_log.copy()

# æµ‹è¯•æ¸©åº¦ç±»
temp = Temperature(25)
print(f"åˆå§‹æ¸©åº¦ï¼š{temp.celsius}Â°C")
print(f"åæ°æ¸©åº¦ï¼š{temp.fahrenheit}Â°F")
print(f"å¼€å°”æ–‡æ¸©åº¦ï¼š{temp.kelvin}K")

# ä¿®æ”¹æ¸©åº¦
temp.celsius = 30
print(f"ä¿®æ”¹åæ¸©åº¦ï¼š{temp.celsius}Â°C")

# é€šè¿‡åæ°åº¦è®¾ç½®æ¸©åº¦
temp.fahrenheit = 86  # 30Â°C
print(f"é€šè¿‡åæ°åº¦è®¾ç½®ï¼š{temp.celsius}Â°C")

# æŸ¥çœ‹å˜åŒ–æ—¥å¿—
print("æ¸©åº¦å˜åŒ–è®°å½•ï¼š")
for log in temp.change_log:
    print(f"  {log}")

# åˆ é™¤å±æ€§ï¼ˆé‡ç½®ï¼‰
del temp.celsius
print(f"é‡ç½®åæ¸©åº¦ï¼š{temp.celsius}Â°C")

# éªŒè¯æœºåˆ¶æµ‹è¯•
try:
    temp.celsius = -300  # ä½äºç»å¯¹é›¶åº¦
except ValueError as e:
    print(f"é”™è¯¯ï¼š{e}")
```

#### ç¼“å­˜å±æ€§ï¼šæé«˜æ€§èƒ½

```python
class ExpensiveCalculation:
    def __init__(self, data):
        self.data = data
        self._result_cache = None
    
    @property
    def expensive_result(self):
        """æ˜‚è´µçš„è®¡ç®—ï¼Œä½¿ç”¨ç¼“å­˜ä¼˜åŒ–"""
        if self._result_cache is None:
            print("æ­£åœ¨è¿›è¡Œæ˜‚è´µçš„è®¡ç®—...")
            # æ¨¡æ‹Ÿå¤æ‚è®¡ç®—
            self._result_cache = sum(x**2 for x in self.data)
        return self._result_cache
    
    def clear_cache(self):
        """æ¸…é™¤ç¼“å­˜"""
        self._result_cache = None

# æµ‹è¯•ç¼“å­˜æ•ˆæœ
calc = ExpensiveCalculation([1, 2, 3, 4, 5])
print(calc.expensive_result)  # æ­£åœ¨è¿›è¡Œæ˜‚è´µçš„è®¡ç®—... 55
print(calc.expensive_result)  # 55ï¼ˆç›´æ¥ä»ç¼“å­˜è¿”å›ï¼Œä¸å†è®¡ç®—ï¼‰
```

### æè¿°ç¬¦åè®®ï¼šå±æ€§ç®¡ç†çš„"ç»ˆææ­¦å™¨"

æè¿°ç¬¦æ˜¯å®ç°äº†æè¿°ç¬¦åè®®çš„ç±»ï¼Œå¯ä»¥æ§åˆ¶å¯¹å±æ€§çš„è®¿é—®ã€‚è¿™æ˜¯ property è£…é¥°å™¨çš„åº•å±‚å®ç°æœºåˆ¶ã€‚

#### æè¿°ç¬¦åè®®çš„ä¸‰ä¸ªæ–¹æ³•

```python
class MyDescriptor:
    def __get__(self, obj, objtype=None):
        """è·å–å±æ€§æ—¶è°ƒç”¨"""
        print(f"__get__ è¢«è°ƒç”¨ï¼šobj={obj}, objtype={objtype}")
        return "æè¿°ç¬¦çš„å€¼"
    
    def __set__(self, obj, value):
        """è®¾ç½®å±æ€§æ—¶è°ƒç”¨"""
        print(f"__set__ è¢«è°ƒç”¨ï¼šobj={obj}, value={value}")
    
    def __delete__(self, obj):
        """åˆ é™¤å±æ€§æ—¶è°ƒç”¨"""
        print(f"__delete__ è¢«è°ƒç”¨ï¼šobj={obj}")

class TestClass:
    attr = MyDescriptor()  # ç±»å±æ€§

# æµ‹è¯•æè¿°ç¬¦
test = TestClass()
print(test.attr)        # è§¦å‘ __get__
test.attr = "æ–°å€¼"       # è§¦å‘ __set__  
del test.attr          # è§¦å‘ __delete__
```

#### å®ç”¨çš„æè¿°ç¬¦ï¼šç±»å‹éªŒè¯å™¨

```python
class TypeValidator:
    """ç±»å‹éªŒè¯æè¿°ç¬¦"""
    
    def __init__(self, expected_type, default=None):
        self.expected_type = expected_type
        self.default = default
        self.name = None
    
    def __set_name__(self, owner, name):
        """Python 3.6+ æ–°ç‰¹æ€§ï¼Œè‡ªåŠ¨è·å–å±æ€§å"""
        self.name = name
    
    def __get__(self, obj, objtype=None):
        if obj is None:
            return self
        return obj.__dict__.get(self.name, self.default)
    
    def __set__(self, obj, value):
        if not isinstance(value, self.expected_type):
            raise TypeError(
                f"{self.name} å¿…é¡»æ˜¯ {self.expected_type.__name__} ç±»å‹ï¼Œ"
                f"å¾—åˆ°çš„æ˜¯ {type(value).__name__}"
            )
        obj.__dict__[self.name] = value

class RangeValidator(TypeValidator):
    """èŒƒå›´éªŒè¯æè¿°ç¬¦"""
    
    def __init__(self, expected_type, min_val=None, max_val=None, default=None):
        super().__init__(expected_type, default)
        self.min_val = min_val
        self.max_val = max_val
    
    def __set__(self, obj, value):
        # å…ˆè¿›è¡Œç±»å‹éªŒè¯
        super().__set__(obj, value)
        
        # å†è¿›è¡ŒèŒƒå›´éªŒè¯
        if self.min_val is not None and value < self.min_val:
            raise ValueError(f"{self.name} ä¸èƒ½å°äº {self.min_val}")
        if self.max_val is not None and value > self.max_val:
            raise ValueError(f"{self.name} ä¸èƒ½å¤§äº {self.max_val}")

# ä½¿ç”¨æè¿°ç¬¦åˆ›å»ºå­¦ç”Ÿç±»
class Student:
    # ä½¿ç”¨æè¿°ç¬¦å®šä¹‰å±æ€§ï¼Œè‡ªåŠ¨è¿›è¡Œç±»å‹å’ŒèŒƒå›´éªŒè¯
    name = TypeValidator(str, "")
    age = RangeValidator(int, min_val=0, max_val=150, default=18)
    grade = RangeValidator(float, min_val=0.0, max_val=100.0, default=0.0)
    
    def __init__(self, name, age, grade):
        self.name = name    # è§¦å‘ TypeValidator.__set__
        self.age = age      # è§¦å‘ RangeValidator.__set__
        self.grade = grade  # è§¦å‘ RangeValidator.__set__
    
    def __str__(self):
        return f"Student(name='{self.name}', age={self.age}, grade={self.grade})"

# æµ‹è¯•æè¿°ç¬¦éªŒè¯
try:
    student1 = Student("å¼ ä¸‰", 20, 85.5)
    print(student1)  # æ­£å¸¸åˆ›å»º
    
    student2 = Student("æå››", -5, 90)  # å¹´é¾„éªŒè¯å¤±è´¥
except ValueError as e:
    print(f"éªŒè¯é”™è¯¯ï¼š{e}")

try:
    student1.grade = 105  # æˆç»©éªŒè¯å¤±è´¥
except ValueError as e:
    print(f"éªŒè¯é”™è¯¯ï¼š{e}")

try:
    student1.name = 123  # ç±»å‹éªŒè¯å¤±è´¥
except TypeError as e:
    print(f"ç±»å‹é”™è¯¯ï¼š{e}")
```

#### è®¡ç®—å±æ€§æè¿°ç¬¦

```python
class ComputedProperty:
    """è®¡ç®—å±æ€§æè¿°ç¬¦"""
    
    def __init__(self, func):
        self.func = func
        self.name = func.__name__
    
    def __get__(self, obj, objtype=None):
        if obj is None:
            return self
        # æ¯æ¬¡è®¿é—®éƒ½é‡æ–°è®¡ç®—
        return self.func(obj)
    
    def __set__(self, obj, value):
        raise AttributeError(f"'{self.name}' æ˜¯åªè¯»è®¡ç®—å±æ€§")

class Rectangle:
    def __init__(self, width, height):
        self.width = width
        self.height = height
    
    @ComputedProperty
    def area(self):
        """é¢ç§¯ï¼ˆè®¡ç®—å±æ€§ï¼‰"""
        print("è®¡ç®—é¢ç§¯...")
        return self.width * self.height
    
    @ComputedProperty
    def perimeter(self):
        """å‘¨é•¿ï¼ˆè®¡ç®—å±æ€§ï¼‰"""
        print("è®¡ç®—å‘¨é•¿...")
        return 2 * (self.width + self.height)

# æµ‹è¯•è®¡ç®—å±æ€§
rect = Rectangle(5, 3)
print(f"é¢ç§¯ï¼š{rect.area}")        # è®¡ç®—é¢ç§¯... é¢ç§¯ï¼š15
print(f"å‘¨é•¿ï¼š{rect.perimeter}")   # è®¡ç®—å‘¨é•¿... å‘¨é•¿ï¼š16

# ä¿®æ”¹å°ºå¯¸åé‡æ–°è®¡ç®—
rect.width = 10
print(f"æ–°é¢ç§¯ï¼š{rect.area}")      # è®¡ç®—é¢ç§¯... æ–°é¢ç§¯ï¼š30
```

### å±æ€§è®¿é—®æ§åˆ¶é­”æœ¯æ–¹æ³•

#### `__getattr__`ã€`__setattr__`ã€`__delattr__`

```python
class DynamicObject:
    """æ”¯æŒåŠ¨æ€å±æ€§çš„å¯¹è±¡"""
    
    def __init__(self):
        # å¿…é¡»ä½¿ç”¨ super().__setattr__ é¿å…æ— é™é€’å½’
        super().__setattr__('_data', {})
        super().__setattr__('_access_log', [])
    
    def __getattr__(self, name):
        """å½“è®¿é—®ä¸å­˜åœ¨çš„å±æ€§æ—¶è°ƒç”¨"""
        self._access_log.append(f"è®¿é—®å±æ€§ï¼š{name}")
        if name in self._data:
            return self._data[name]
        else:
            raise AttributeError(f"'{type(self).__name__}' å¯¹è±¡æ²¡æœ‰å±æ€§ '{name}'")
    
    def __setattr__(self, name, value):
        """è®¾ç½®ä»»ä½•å±æ€§æ—¶è°ƒç”¨"""
        if name.startswith('_'):
            # å†…éƒ¨å±æ€§ç›´æ¥è®¾ç½®
            super().__setattr__(name, value)
        else:
            # ç”¨æˆ·å±æ€§å­˜å‚¨åœ¨ _data ä¸­
            if not hasattr(self, '_data'):
                super().__setattr__('_data', {})
            if not hasattr(self, '_access_log'):
                super().__setattr__('_access_log', [])
            
            self._access_log.append(f"è®¾ç½®å±æ€§ï¼š{name} = {value}")
            self._data[name] = value
    
    def __delattr__(self, name):
        """åˆ é™¤å±æ€§æ—¶è°ƒç”¨"""
        if name.startswith('_'):
            super().__delattr__(name)
        else:
            if name in self._data:
                self._access_log.append(f"åˆ é™¤å±æ€§ï¼š{name}")
                del self._data[name]
            else:
                raise AttributeError(f"å±æ€§ '{name}' ä¸å­˜åœ¨")
    
    def get_access_log(self):
        """è·å–è®¿é—®æ—¥å¿—"""
        return self._access_log.copy()

# æµ‹è¯•åŠ¨æ€å±æ€§
obj = DynamicObject()

# åŠ¨æ€è®¾ç½®å±æ€§
obj.name = "å¼ ä¸‰"
obj.age = 25
obj.city = "åŒ—äº¬"

# è®¿é—®å±æ€§
print(f"å§“åï¼š{obj.name}")
print(f"å¹´é¾„ï¼š{obj.age}")

# åˆ é™¤å±æ€§
del obj.city

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
print("è®¿é—®æ—¥å¿—ï¼š")
for log in obj.get_access_log():
    print(f"  {log}")
```

### ğŸƒâ€â™‚ï¸ å®è·µç»ƒä¹ ï¼šæ™ºèƒ½é…ç½®ç®¡ç†å™¨

**ç»ƒä¹ 2**ï¼šåˆ›å»ºä¸€ä¸ªé…ç½®ç®¡ç†å™¨ç±»ï¼Œæ”¯æŒï¼š
1. è‡ªåŠ¨ç±»å‹è½¬æ¢å’ŒéªŒè¯
2. é…ç½®é¡¹çš„å†å²è®°å½•
3. åµŒå¥—é…ç½®è®¿é—®
4. é…ç½®çš„ä¿å­˜å’ŒåŠ è½½

```python
class ConfigValidator:
    """é…ç½®éªŒè¯æè¿°ç¬¦"""
    def __init__(self, expected_type, default=None, validator=None):
        self.expected_type = expected_type
        self.default = default
        self.validator = validator  # è‡ªå®šä¹‰éªŒè¯å‡½æ•°
        self.name = None
    
    def __set_name__(self, owner, name):
        self.name = name
    
    def __get__(self, obj, objtype=None):
        if obj is None:
            return self
        return obj._config.get(self.name, self.default)
    
    def __set__(self, obj, value):
        # TODO: å®ç°ç±»å‹è½¬æ¢ã€éªŒè¯å’Œå†å²è®°å½•
        pass

class ConfigManager:
    # å®šä¹‰é…ç½®é¡¹
    host = ConfigValidator(str, "localhost")
    port = ConfigValidator(int, 8080, lambda x: 1 <= x <= 65535)
    debug = ConfigValidator(bool, False)
    timeout = ConfigValidator(float, 30.0, lambda x: x > 0)
    
    def __init__(self):
        self._config = {}
        self._history = {}
    
    def get_history(self, key):
        """è·å–é…ç½®é¡¹çš„å†å²è®°å½•"""
        return self._history.get(key, [])
    
    def save_config(self, filename):
        """ä¿å­˜é…ç½®åˆ°æ–‡ä»¶"""
        # TODO: å®ç°é…ç½®ä¿å­˜
        pass
    
    def load_config(self, filename):
        """ä»æ–‡ä»¶åŠ è½½é…ç½®"""
        # TODO: å®ç°é…ç½®åŠ è½½
        pass

# æµ‹è¯•ä»£ç 
config = ConfigManager()
config.host = "192.168.1.1"
config.port = "9000"  # å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢ä¸ºæ•´æ•°
config.debug = "true"  # å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢ä¸ºå¸ƒå°”å€¼

print(f"ä¸»æœºï¼š{config.host}")
print(f"ç«¯å£ï¼š{config.port}")
print(f"è°ƒè¯•æ¨¡å¼ï¼š{config.debug}")
```

### æœ¬èŠ‚å°ç»“

å±æ€§ç®¡ç†å’Œæè¿°ç¬¦ä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„å·¥å…·ï¼š

1. **property è£…é¥°å™¨**ï¼šåˆ›å»ºæ™ºèƒ½å±æ€§ï¼Œæ”¯æŒéªŒè¯ã€è®¡ç®—ã€ç¼“å­˜
2. **æè¿°ç¬¦åè®®**ï¼šåº•å±‚çš„å±æ€§æ§åˆ¶æœºåˆ¶ï¼Œå¯é‡ç”¨çš„å±æ€§ç®¡ç†å™¨
3. **å±æ€§è®¿é—®æ§åˆ¶**ï¼šæ‹¦æˆªå±æ€§è®¿é—®ï¼Œå®ç°åŠ¨æ€å±æ€§å’Œæ—¥å¿—è®°å½•

è¿™äº›ç‰¹æ€§è®©æˆ‘ä»¬èƒ½å¤Ÿåˆ›å»ºæ›´åŠ å¥å£®ã€æ™ºèƒ½çš„ç±»ï¼Œä¸ºå¤æ‚åº”ç”¨å¥ å®šåŸºç¡€ã€‚

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†å­¦ä¹ é«˜çº§ç±»ç‰¹æ€§ï¼ŒåŒ…æ‹¬æŠ½è±¡åŸºç±»ã€ç±»æ–¹æ³•ã€é™æ€æ–¹æ³•å’Œå…ƒç±»ç¼–ç¨‹ï¼

---

## ğŸ›ï¸ ç¬¬7.3èŠ‚ï¼šé«˜çº§ç±»ç‰¹æ€§ - æ„å»ºå¼ºå¤§çš„ç±»ä½“ç³»

### ç±»æ–¹æ³•ä¸é™æ€æ–¹æ³•ï¼šé€‰æ‹©åˆé€‚çš„å·¥å…·

åœ¨Pythonä¸­ï¼Œé™¤äº†æ™®é€šçš„å®ä¾‹æ–¹æ³•ï¼Œè¿˜æœ‰ç±»æ–¹æ³•å’Œé™æ€æ–¹æ³•ã€‚ç†è§£å®ƒä»¬çš„åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯æ˜¯è®¾è®¡è‰¯å¥½ç±»ä½“ç³»çš„å…³é”®ã€‚

#### å®ä¾‹æ–¹æ³• vs ç±»æ–¹æ³• vs é™æ€æ–¹æ³•

```python
class Student:
    # ç±»å˜é‡
    school_name = "Pythonå¤§å­¦"
    total_students = 0
    
    def __init__(self, name, age):
        self.name = name
        self.age = age
        Student.total_students += 1
    
    # å®ä¾‹æ–¹æ³•ï¼šéœ€è¦è®¿é—®å®ä¾‹æ•°æ®
    def introduce(self):
        """å®ä¾‹æ–¹æ³•ï¼Œè®¿é—® self"""
        return f"æˆ‘æ˜¯{self.name}ï¼Œä»Šå¹´{self.age}å²"
    
    # ç±»æ–¹æ³•ï¼šéœ€è¦è®¿é—®ç±»æ•°æ®æˆ–åˆ›å»ºå®ä¾‹
    @classmethod
    def get_school_info(cls):
        """ç±»æ–¹æ³•ï¼Œè®¿é—® clsï¼ˆç±»æœ¬èº«ï¼‰"""
        return f"å­¦æ ¡ï¼š{cls.school_name}ï¼Œæ€»å­¦ç”Ÿæ•°ï¼š{cls.total_students}"
    
    @classmethod
    def create_adult_student(cls, name):
        """ç±»æ–¹æ³•ä½œä¸ºæ›¿ä»£æ„é€ å‡½æ•°"""
        return cls(name, 18)  # è°ƒç”¨ __init__
    
    # é™æ€æ–¹æ³•ï¼šé€»è¾‘ä¸Šå±äºè¿™ä¸ªç±»ï¼Œä½†ä¸éœ€è¦è®¿é—®ç±»æˆ–å®ä¾‹æ•°æ®
    @staticmethod
    def is_valid_age(age):
        """é™æ€æ–¹æ³•ï¼Œçº¯å·¥å…·å‡½æ•°"""
        return 0 <= age <= 120
    
    @staticmethod
    def calculate_graduation_year(current_year, grade):
        """é™æ€æ–¹æ³•ï¼Œè®¡ç®—æ¯•ä¸šå¹´ä»½"""
        return current_year + (4 - grade)

# ä½¿ç”¨ç¤ºä¾‹
student1 = Student("å¼ ä¸‰", 20)
student2 = Student("æå››", 19)

# å®ä¾‹æ–¹æ³•è°ƒç”¨
print(student1.introduce())  # æˆ‘æ˜¯å¼ ä¸‰ï¼Œä»Šå¹´20å²

# ç±»æ–¹æ³•è°ƒç”¨ï¼ˆä¸¤ç§æ–¹å¼ï¼‰
print(Student.get_school_info())     # å­¦æ ¡ï¼šPythonå¤§å­¦ï¼Œæ€»å­¦ç”Ÿæ•°ï¼š2
print(student1.get_school_info())    # åŒæ ·çš„ç»“æœ

# ç±»æ–¹æ³•ä½œä¸ºæ›¿ä»£æ„é€ å‡½æ•°
adult_student = Student.create_adult_student("ç‹äº”")
print(adult_student.introduce())     # æˆ‘æ˜¯ç‹äº”ï¼Œä»Šå¹´18å²

# é™æ€æ–¹æ³•è°ƒç”¨ï¼ˆä¸‰ç§æ–¹å¼ï¼‰
print(Student.is_valid_age(25))      # True
print(student1.is_valid_age(-5))     # False
print(Student.calculate_graduation_year(2024, 2))  # 2026
```

**é€‰æ‹©æŒ‡å—**ï¼š
- **å®ä¾‹æ–¹æ³•**ï¼šéœ€è¦è®¿é—®æˆ–ä¿®æ”¹å®ä¾‹çŠ¶æ€æ—¶ä½¿ç”¨
- **ç±»æ–¹æ³•**ï¼šéœ€è¦è®¿é—®ç±»å˜é‡ï¼Œæˆ–ä½œä¸ºæ›¿ä»£æ„é€ å‡½æ•°æ—¶ä½¿ç”¨
- **é™æ€æ–¹æ³•**ï¼šé€»è¾‘ä¸Šå±äºç±»ï¼Œä½†ä¸éœ€è¦è®¿é—®ç±»æˆ–å®ä¾‹æ•°æ®çš„å·¥å…·å‡½æ•°

#### å®é™…åº”ç”¨ï¼šæ•°æ®åº“è¿æ¥ç®¡ç†

```python
import json
from datetime import datetime

class DatabaseConnection:
    # ç±»å˜é‡ï¼šè¿æ¥æ± é…ç½®
    max_connections = 10
    active_connections = 0
    connection_history = []
    
    def __init__(self, host, port, database):
        if DatabaseConnection.active_connections >= DatabaseConnection.max_connections:
            raise Exception("è¿æ¥æ± å·²æ»¡")
        
        self.host = host
        self.port = port
        self.database = database
        self.connected_at = datetime.now()
        DatabaseConnection.active_connections += 1
        DatabaseConnection.connection_history.append({
            'host': host,
            'database': database,
            'connected_at': self.connected_at.isoformat()
        })
    
    # å®ä¾‹æ–¹æ³•ï¼šæ“ä½œå…·ä½“è¿æ¥
    def execute_query(self, sql):
        """æ‰§è¡ŒSQLæŸ¥è¯¢"""
        return f"åœ¨ {self.database} æ‰§è¡Œï¼š{sql}"
    
    def close(self):
        """å…³é—­è¿æ¥"""
        DatabaseConnection.active_connections -= 1
        print(f"è¿æ¥ {self.host}:{self.database} å·²å…³é—­")
    
    # ç±»æ–¹æ³•ï¼šç®¡ç†è¿æ¥æ± çŠ¶æ€
    @classmethod
    def get_pool_status(cls):
        """è·å–è¿æ¥æ± çŠ¶æ€"""
        return {
            'active': cls.active_connections,
            'max': cls.max_connections,
            'available': cls.max_connections - cls.active_connections
        }
    
    @classmethod
    def create_local_connection(cls, database):
        """åˆ›å»ºæœ¬åœ°æ•°æ®åº“è¿æ¥ï¼ˆæ›¿ä»£æ„é€ å‡½æ•°ï¼‰"""
        return cls('localhost', 3306, database)
    
    @classmethod
    def create_from_config(cls, config_file):
        """ä»é…ç½®æ–‡ä»¶åˆ›å»ºè¿æ¥ï¼ˆæ›¿ä»£æ„é€ å‡½æ•°ï¼‰"""
        with open(config_file, 'r') as f:
            config = json.load(f)
        return cls(config['host'], config['port'], config['database'])
    
    # é™æ€æ–¹æ³•ï¼šå·¥å…·å‡½æ•°
    @staticmethod
    def validate_host(host):
        """éªŒè¯ä¸»æœºåœ°å€æ ¼å¼"""
        import re
        pattern = r'^(\d{1,3}\.){3}\d{1,3}$|^localhost$|^[\w.-]+$'
        return bool(re.match(pattern, host))
    
    @staticmethod
    def parse_connection_string(conn_str):
        """è§£æè¿æ¥å­—ç¬¦ä¸²"""
        # ç¤ºä¾‹ï¼šmysql://user:pass@host:port/database
        import re
        pattern = r'(\w+)://(\w+):(\w+)@([^:]+):(\d+)/(\w+)'
        match = re.match(pattern, conn_str)
        if match:
            return {
                'type': match.group(1),
                'user': match.group(2),
                'password': match.group(3),
                'host': match.group(4),
                'port': int(match.group(5)),
                'database': match.group(6)
            }
        return None

# ä½¿ç”¨ç¤ºä¾‹
# éªŒè¯ä¸»æœºåœ°å€ï¼ˆé™æ€æ–¹æ³•ï¼‰
print(DatabaseConnection.validate_host("192.168.1.1"))  # True
print(DatabaseConnection.validate_host("localhost"))     # True

# è§£æè¿æ¥å­—ç¬¦ä¸²ï¼ˆé™æ€æ–¹æ³•ï¼‰
conn_info = DatabaseConnection.parse_connection_string(
    "mysql://admin:123456@localhost:3306/testdb"
)
print(conn_info)

# åˆ›å»ºè¿æ¥ï¼ˆç±»æ–¹æ³•ä½œä¸ºæ„é€ å‡½æ•°ï¼‰
db1 = DatabaseConnection.create_local_connection("myapp")
db2 = DatabaseConnection.create_local_connection("logs")

# æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€ï¼ˆç±»æ–¹æ³•ï¼‰
print(DatabaseConnection.get_pool_status())  # {'active': 2, 'max': 10, 'available': 8}

# ä½¿ç”¨è¿æ¥ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰
result = db1.execute_query("SELECT * FROM users")
print(result)

# å…³é—­è¿æ¥
db1.close()
```

### æŠ½è±¡åŸºç±»ï¼ˆABCï¼‰ï¼šå®šä¹‰æ¥å£å¥‘çº¦

æŠ½è±¡åŸºç±»ç”¨äºå®šä¹‰æ¥å£è§„èŒƒï¼Œç¡®ä¿å­ç±»å®ç°å¿…è¦çš„æ–¹æ³•ã€‚è¿™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡ä¸­çš„é‡è¦æ¨¡å¼ã€‚

#### åŸºç¡€æŠ½è±¡åŸºç±»

```python
from abc import ABC, abstractmethod

class Shape(ABC):
    """å½¢çŠ¶æŠ½è±¡åŸºç±»"""
    
    def __init__(self, name):
        self.name = name
    
    @abstractmethod
    def area(self):
        """è®¡ç®—é¢ç§¯ï¼ˆæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°ï¼‰"""
        pass
    
    @abstractmethod
    def perimeter(self):
        """è®¡ç®—å‘¨é•¿ï¼ˆæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°ï¼‰"""
        pass
    
    # å…·ä½“æ–¹æ³•ï¼ˆå­ç±»å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼‰
    def display_info(self):
        """æ˜¾ç¤ºå½¢çŠ¶ä¿¡æ¯"""
        return f"{self.name}: é¢ç§¯={self.area():.2f}, å‘¨é•¿={self.perimeter():.2f}"
    
    @classmethod
    def from_string(cls, shape_str):
        """ä»å­—ç¬¦ä¸²åˆ›å»ºå½¢çŠ¶ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰"""
        # è¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå®šä¹‰äº†åˆ›å»ºæµç¨‹
        parts = shape_str.split(',')
        if len(parts) < 2:
            raise ValueError("æ ¼å¼é”™è¯¯")
        
        shape_type = parts[0].strip()
        if shape_type == "circle":
            radius = float(parts[1])
            return Circle(radius)
        elif shape_type == "rectangle":
            width, height = float(parts[1]), float(parts[2])
            return Rectangle(width, height)
        else:
            raise ValueError(f"æœªçŸ¥çš„å½¢çŠ¶ç±»å‹ï¼š{shape_type}")

class Circle(Shape):
    def __init__(self, radius):
        super().__init__("åœ†å½¢")
        if radius <= 0:
            raise ValueError("åŠå¾„å¿…é¡»å¤§äº0")
        self.radius = radius
    
    def area(self):
        return 3.14159 * self.radius ** 2
    
    def perimeter(self):
        return 2 * 3.14159 * self.radius

class Rectangle(Shape):
    def __init__(self, width, height):
        super().__init__("çŸ©å½¢")
        if width <= 0 or height <= 0:
            raise ValueError("å®½åº¦å’Œé«˜åº¦å¿…é¡»å¤§äº0")
        self.width = width
        self.height = height
    
    def area(self):
        return self.width * self.height
    
    def perimeter(self):
        return 2 * (self.width + self.height)

# ä½¿ç”¨ç¤ºä¾‹
# shape = Shape("æŠ½è±¡å½¢çŠ¶")  # æŠ¥é”™ï¼ä¸èƒ½å®ä¾‹åŒ–æŠ½è±¡ç±»

circle = Circle(5)
rectangle = Rectangle(4, 6)

print(circle.display_info())     # åœ†å½¢: é¢ç§¯=78.54, å‘¨é•¿=31.42
print(rectangle.display_info())  # çŸ©å½¢: é¢ç§¯=24.00, å‘¨é•¿=20.00

# ä½¿ç”¨ç±»æ–¹æ³•åˆ›å»ºå¯¹è±¡
shape1 = Shape.from_string("circle, 3")
shape2 = Shape.from_string("rectangle, 2, 8")
print(shape1.display_info())     # åœ†å½¢: é¢ç§¯=28.27, å‘¨é•¿=18.85
print(shape2.display_info())     # çŸ©å½¢: é¢ç§¯=16.00, å‘¨é•¿=20.00
```

#### å¤æ‚æŠ½è±¡åŸºç±»ï¼šæ•°æ®å¤„ç†å™¨

```python
from abc import ABC, abstractmethod
from typing import Any, List, Dict

class DataProcessor(ABC):
    """æ•°æ®å¤„ç†å™¨æŠ½è±¡åŸºç±»"""
    
    def __init__(self, name: str):
        self.name = name
        self._processed_count = 0
    
    @abstractmethod
    def validate(self, data: Any) -> bool:
        """éªŒè¯æ•°æ®æ ¼å¼"""
        pass
    
    @abstractmethod
    def process_single(self, data: Any) -> Any:
        """å¤„ç†å•æ¡æ•°æ®"""
        pass
    
    @abstractmethod
    def get_output_format(self) -> str:
        """è·å–è¾“å‡ºæ ¼å¼è¯´æ˜"""
        pass
    
    # æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰å¤„ç†æµç¨‹
    def process(self, data_list: List[Any]) -> List[Any]:
        """å¤„ç†æ•°æ®åˆ—è¡¨ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰"""
        results = []
        for data in data_list:
            try:
                # 1. éªŒè¯æ•°æ®
                if not self.validate(data):
                    print(f"æ•°æ®éªŒè¯å¤±è´¥ï¼š{data}")
                    continue
                
                # 2. å¤„ç†æ•°æ®
                result = self.process_single(data)
                results.append(result)
                self._processed_count += 1
                
            except Exception as e:
                print(f"å¤„ç†æ•°æ®æ—¶å‡ºé”™ï¼š{data}, é”™è¯¯ï¼š{e}")
        
        return results
    
    def get_statistics(self) -> Dict[str, Any]:
        """è·å–å¤„ç†ç»Ÿè®¡ä¿¡æ¯"""
        return {
            'processor_name': self.name,
            'processed_count': self._processed_count,
            'output_format': self.get_output_format()
        }

class TextProcessor(DataProcessor):
    """æ–‡æœ¬å¤„ç†å™¨"""
    
    def __init__(self, transform_type="upper"):
        super().__init__(f"æ–‡æœ¬å¤„ç†å™¨({transform_type})")
        self.transform_type = transform_type
    
    def validate(self, data):
        return isinstance(data, str) and len(data.strip()) > 0
    
    def process_single(self, data):
        text = data.strip()
        if self.transform_type == "upper":
            return text.upper()
        elif self.transform_type == "lower":
            return text.lower()
        elif self.transform_type == "title":
            return text.title()
        elif self.transform_type == "reverse":
            return text[::-1]
        else:
            return text
    
    def get_output_format(self):
        return f"è½¬æ¢åçš„æ–‡æœ¬({self.transform_type})"

class NumberProcessor(DataProcessor):
    """æ•°å­—å¤„ç†å™¨"""
    
    def __init__(self, operation="square"):
        super().__init__(f"æ•°å­—å¤„ç†å™¨({operation})")
        self.operation = operation
    
    def validate(self, data):
        try:
            float(data)
            return True
        except (ValueError, TypeError):
            return False
    
    def process_single(self, data):
        num = float(data)
        if self.operation == "square":
            return num ** 2
        elif self.operation == "sqrt":
            return num ** 0.5
        elif self.operation == "abs":
            return abs(num)
        elif self.operation == "round":
            return round(num, 2)
        else:
            return num
    
    def get_output_format(self):
        return f"å¤„ç†åçš„æ•°å­—({self.operation})"

# ä½¿ç”¨ç¤ºä¾‹
text_processor = TextProcessor("upper")
number_processor = NumberProcessor("square")

# å¤„ç†æ–‡æœ¬æ•°æ®
texts = ["hello world", "python programming", "  ", "abc123"]
processed_texts = text_processor.process(texts)
print("å¤„ç†åçš„æ–‡æœ¬ï¼š", processed_texts)
print("æ–‡æœ¬å¤„ç†ç»Ÿè®¡ï¼š", text_processor.get_statistics())

# å¤„ç†æ•°å­—æ•°æ®
numbers = ["3.14", "25", "invalid", "-5", "0"]
processed_numbers = number_processor.process(numbers)
print("å¤„ç†åçš„æ•°å­—ï¼š", processed_numbers)
print("æ•°å­—å¤„ç†ç»Ÿè®¡ï¼š", number_processor.get_statistics())
```

### æ··å…¥æ¨¡å¼ï¼ˆMixinï¼‰ï¼šåŠŸèƒ½çš„"ä¹é«˜ç§¯æœ¨"

æ··å…¥æ¨¡å¼å…è®¸æˆ‘ä»¬å°†åŠŸèƒ½åˆ†è§£ä¸ºå°çš„ã€å¯é‡ç”¨çš„ç»„ä»¶ï¼Œç„¶åé€šè¿‡å¤šé‡ç»§æ‰¿ç»„åˆå®ƒä»¬ã€‚

#### åŸºç¡€æ··å…¥ç¤ºä¾‹

```python
# æ··å…¥ç±»ï¼šæä¾›ç‰¹å®šåŠŸèƒ½
class TimestampMixin:
    """æ—¶é—´æˆ³æ··å…¥"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        from datetime import datetime
        self.created_at = datetime.now()
        self.updated_at = datetime.now()
    
    def touch(self):
        """æ›´æ–°æ—¶é—´æˆ³"""
        from datetime import datetime
        self.updated_at = datetime.now()
    
    def get_age(self):
        """è·å–å¯¹è±¡å¹´é¾„ï¼ˆç§’ï¼‰"""
        from datetime import datetime
        return (datetime.now() - self.created_at).total_seconds()

class ValidationMixin:
    """éªŒè¯æ··å…¥"""
    
    def validate(self):
        """éªŒè¯å¯¹è±¡çŠ¶æ€"""
        errors = []
        
        # è°ƒç”¨æ‰€æœ‰ä»¥ validate_ å¼€å¤´çš„æ–¹æ³•
        for method_name in dir(self):
            if method_name.startswith('validate_') and callable(getattr(self, method_name)):
                try:
                    getattr(self, method_name)()
                except ValueError as e:
                    errors.append(str(e))
        
        if errors:
            raise ValueError(f"éªŒè¯å¤±è´¥ï¼š{'; '.join(errors)}")
        return True

class SerializationMixin:
    """åºåˆ—åŒ–æ··å…¥"""
    
    def to_dict(self):
        """è½¬æ¢ä¸ºå­—å…¸"""
        result = {}
        for key, value in self.__dict__.items():
            if not key.startswith('_'):
                if hasattr(value, 'isoformat'):  # datetimeå¯¹è±¡
                    result[key] = value.isoformat()
                else:
                    result[key] = value
        return result
    
    @classmethod
    def from_dict(cls, data):
        """ä»å­—å…¸åˆ›å»ºå¯¹è±¡"""
        # è¿‡æ»¤æ‰æ—¶é—´æˆ³å­—æ®µï¼Œè®©TimestampMixinè‡ªåŠ¨è®¾ç½®
        filtered_data = {k: v for k, v in data.items() 
                        if k not in ['created_at', 'updated_at']}
        return cls(**filtered_data)
    
    def to_json(self):
        """è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²"""
        import json
        return json.dumps(self.to_dict(), indent=2)

# ä½¿ç”¨æ··å…¥çš„å…·ä½“ç±»
class User(TimestampMixin, ValidationMixin, SerializationMixin):
    """ç”¨æˆ·ç±»ï¼Œç»„åˆå¤šä¸ªæ··å…¥åŠŸèƒ½"""
    
    def __init__(self, username, email, age):
        # é‡è¦ï¼šè°ƒç”¨çˆ¶ç±»çš„__init__ä»¥å¯ç”¨æ··å…¥åŠŸèƒ½
        super().__init__()
        self.username = username
        self.email = email
        self.age = age
    
    # éªŒè¯æ–¹æ³•ï¼ˆè¢«ValidationMixinè°ƒç”¨ï¼‰
    def validate_username(self):
        if not self.username or len(self.username) < 3:
            raise ValueError("ç”¨æˆ·åé•¿åº¦è‡³å°‘3ä¸ªå­—ç¬¦")
    
    def validate_email(self):
        if '@' not in self.email:
            raise ValueError("é‚®ç®±æ ¼å¼æ— æ•ˆ")
    
    def validate_age(self):
        if not isinstance(self.age, int) or self.age < 0:
            raise ValueError("å¹´é¾„å¿…é¡»æ˜¯éè´Ÿæ•´æ•°")
    
    def __str__(self):
        return f"User({self.username}, {self.email})"

# å¦ä¸€ä¸ªä½¿ç”¨æ··å…¥çš„ç±»
class Product(TimestampMixin, ValidationMixin, SerializationMixin):
    """äº§å“ç±»"""
    
    def __init__(self, name, price, category):
        super().__init__()
        self.name = name
        self.price = price
        self.category = category
    
    def validate_name(self):
        if not self.name or len(self.name.strip()) == 0:
            raise ValueError("äº§å“åç§°ä¸èƒ½ä¸ºç©º")
    
    def validate_price(self):
        if not isinstance(self.price, (int, float)) or self.price < 0:
            raise ValueError("ä»·æ ¼å¿…é¡»æ˜¯éè´Ÿæ•°")
    
    def __str__(self):
        return f"Product({self.name}, Â¥{self.price})"

# ä½¿ç”¨ç¤ºä¾‹
import time

# åˆ›å»ºç”¨æˆ·
user = User("alice", "alice@example.com", 25)
print(f"åˆ›å»ºç”¨æˆ·ï¼š{user}")

# éªŒè¯åŠŸèƒ½
try:
    user.validate()
    print("ç”¨æˆ·éªŒè¯é€šè¿‡")
except ValueError as e:
    print(f"éªŒè¯å¤±è´¥ï¼š{e}")

# æ—¶é—´æˆ³åŠŸèƒ½
print(f"ç”¨æˆ·åˆ›å»ºæ—¶é—´ï¼š{user.created_at}")
time.sleep(1)
user.touch()  # æ›´æ–°æ—¶é—´æˆ³
print(f"ç”¨æˆ·æ›´æ–°æ—¶é—´ï¼š{user.updated_at}")
print(f"ç”¨æˆ·å¹´é¾„ï¼š{user.get_age():.2f}ç§’")

# åºåˆ—åŒ–åŠŸèƒ½
user_dict = user.to_dict()
print("ç”¨æˆ·å­—å…¸ï¼š", user_dict)

user_json = user.to_json()
print("ç”¨æˆ·JSONï¼š", user_json)

# ä»å­—å…¸é‡å»ºå¯¹è±¡
new_user = User.from_dict({'username': 'bob', 'email': 'bob@test.com', 'age': 30})
print(f"é‡å»ºç”¨æˆ·ï¼š{new_user}")

# åˆ›å»ºäº§å“
product = Product("iPhone", 999.99, "electronics")
print(f"åˆ›å»ºäº§å“ï¼š{product}")
print("äº§å“å­—å…¸ï¼š", product.to_dict())
```

#### é«˜çº§æ··å…¥ï¼šç¼“å­˜ç³»ç»Ÿ

```python
import time
import hashlib
from functools import wraps

class CacheMixin:
    """ç¼“å­˜æ··å…¥"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._cache = {}
        self._cache_stats = {'hits': 0, 'misses': 0}
    
    def _get_cache_key(self, method_name, args, kwargs):
        """ç”Ÿæˆç¼“å­˜é”®"""
        key_data = f"{method_name}:{args}:{sorted(kwargs.items())}"
        return hashlib.md5(key_data.encode()).hexdigest()
    
    def cached_method(self, expire_time=300):
        """ç¼“å­˜è£…é¥°å™¨"""
        def decorator(func):
            @wraps(func)
            def wrapper(*args, **kwargs):
                cache_key = self._get_cache_key(func.__name__, args[1:], kwargs)
                current_time = time.time()
                
                # æ£€æŸ¥ç¼“å­˜
                if cache_key in self._cache:
                    cached_data, cached_time = self._cache[cache_key]
                    if current_time - cached_time < expire_time:
                        self._cache_stats['hits'] += 1
                        print(f"ç¼“å­˜å‘½ä¸­ï¼š{func.__name__}")
                        return cached_data
                
                # ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œæ–¹æ³•
                self._cache_stats['misses'] += 1
                result = func(*args, **kwargs)
                self._cache[cache_key] = (result, current_time)
                print(f"ç¼“å­˜è®¾ç½®ï¼š{func.__name__}")
                return result
            
            return wrapper
        return decorator
    
    def clear_cache(self):
        """æ¸…é™¤ç¼“å­˜"""
        self._cache.clear()
        print("ç¼“å­˜å·²æ¸…é™¤")
    
    def get_cache_stats(self):
        """è·å–ç¼“å­˜ç»Ÿè®¡"""
        total = self._cache_stats['hits'] + self._cache_stats['misses']
        hit_rate = self._cache_stats['hits'] / total if total > 0 else 0
        return {
            'hits': self._cache_stats['hits'],
            'misses': self._cache_stats['misses'],
            'hit_rate': f"{hit_rate:.2%}",
            'cache_size': len(self._cache)
        }

class LogMixin:
    """æ—¥å¿—æ··å…¥"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._logs = []
    
    def log(self, message, level="INFO"):
        """è®°å½•æ—¥å¿—"""
        import datetime
        timestamp = datetime.datetime.now().isoformat()
        log_entry = f"[{timestamp}] [{level}] {message}"
        self._logs.append(log_entry)
        print(log_entry)
    
    def get_logs(self):
        """è·å–æ—¥å¿—"""
        return self._logs.copy()
    
    def clear_logs(self):
        """æ¸…é™¤æ—¥å¿—"""
        self._logs.clear()

class DatabaseMixin:
    """æ•°æ®åº“æ“ä½œæ··å…¥"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._db_operations = []
    
    def save(self):
        """ä¿å­˜åˆ°æ•°æ®åº“"""
        operation = f"INSERT INTO {self.__class__.__name__.lower()} ..."
        self._db_operations.append(operation)
        if hasattr(self, 'log'):
            self.log(f"ä¿å­˜æ“ä½œï¼š{operation}")
        return f"å·²ä¿å­˜ï¼š{self}"
    
    def update(self):
        """æ›´æ–°æ•°æ®åº“"""
        operation = f"UPDATE {self.__class__.__name__.lower()} ..."
        self._db_operations.append(operation)
        if hasattr(self, 'log'):
            self.log(f"æ›´æ–°æ“ä½œï¼š{operation}")
        return f"å·²æ›´æ–°ï¼š{self}"
    
    def delete(self):
        """ä»æ•°æ®åº“åˆ é™¤"""
        operation = f"DELETE FROM {self.__class__.__name__.lower()} ..."
        self._db_operations.append(operation)
        if hasattr(self, 'log'):
            self.log(f"åˆ é™¤æ“ä½œï¼š{operation}")
        return f"å·²åˆ é™¤ï¼š{self}"
    
    def get_db_operations(self):
        """è·å–æ•°æ®åº“æ“ä½œå†å²"""
        return self._db_operations.copy()

# ä½¿ç”¨å¤šä¸ªæ··å…¥çš„å¤æ‚ç±»
class AdvancedUser(CacheMixin, LogMixin, DatabaseMixin, TimestampMixin):
    """é«˜çº§ç”¨æˆ·ç±»ï¼Œç»„åˆå¤šç§åŠŸèƒ½"""
    
    def __init__(self, username, email):
        super().__init__()
        self.username = username
        self.email = email
        self.log(f"åˆ›å»ºç”¨æˆ·ï¼š{username}")
    
    @property  # æ³¨æ„ï¼šéœ€è¦åœ¨æ–¹æ³•å®šä¹‰ååº”ç”¨è£…é¥°å™¨
    def profile_data(self):
        """è·å–ç”¨æˆ·èµ„æ–™ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰"""
        return self._get_profile_data()
    
    def _get_profile_data(self):
        """å†…éƒ¨æ–¹æ³•ï¼Œè·å–ç”¨æˆ·èµ„æ–™"""
        # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        time.sleep(0.5)
        return {
            'username': self.username,
            'email': self.email,
            'created_at': self.created_at.isoformat(),
            'status': 'active'
        }
    
    def __str__(self):
        return f"AdvancedUser({self.username})"

# ä¸ºæ–¹æ³•æ·»åŠ ç¼“å­˜è£…é¥°å™¨
def apply_cache_to_method(instance, method_name, expire_time=300):
    """åŠ¨æ€ä¸ºæ–¹æ³•æ·»åŠ ç¼“å­˜"""
    original_method = getattr(instance, method_name)
    cached_method = instance.cached_method(expire_time)(original_method)
    setattr(instance, method_name, cached_method)

# ä½¿ç”¨ç¤ºä¾‹
user = AdvancedUser("charlie", "charlie@example.com")

# åº”ç”¨ç¼“å­˜åˆ°ç‰¹å®šæ–¹æ³•
apply_cache_to_method(user, '_get_profile_data', expire_time=10)

# æµ‹è¯•ç¼“å­˜åŠŸèƒ½
print("ç¬¬ä¸€æ¬¡è·å–èµ„æ–™ï¼š")
profile1 = user._get_profile_data()
print(profile1)

print("\nç¬¬äºŒæ¬¡è·å–èµ„æ–™ï¼ˆåº”è¯¥å‘½ä¸­ç¼“å­˜ï¼‰ï¼š")
profile2 = user._get_profile_data()
print(profile2)

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
print("\nç¼“å­˜ç»Ÿè®¡ï¼š", user.get_cache_stats())

# æµ‹è¯•æ•°æ®åº“æ“ä½œ
user.save()
user.update()

# æŸ¥çœ‹æ—¥å¿—
print("\næ“ä½œæ—¥å¿—ï¼š")
for log in user.get_logs():
    print(log)

# æŸ¥çœ‹æ•°æ®åº“æ“ä½œå†å²
print("\næ•°æ®åº“æ“ä½œï¼š", user.get_db_operations())
```

### æ–¹æ³•è§£æé¡ºåºï¼ˆMROï¼‰ï¼šç†è§£å¤šé‡ç»§æ‰¿

å½“ä½¿ç”¨å¤šé‡ç»§æ‰¿æ—¶ï¼ŒPythonä½¿ç”¨C3çº¿æ€§åŒ–ç®—æ³•ç¡®å®šæ–¹æ³•è§£æé¡ºåºã€‚

#### MROçš„é‡è¦æ€§

```python
class A:
    def method(self):
        print("A.method")

class B(A):
    def method(self):
        print("B.method")
        super().method()

class C(A):
    def method(self):
        print("C.method")
        super().method()

class D(B, C):
    def method(self):
        print("D.method")
        super().method()

# æŸ¥çœ‹æ–¹æ³•è§£æé¡ºåº
print("MRO:", D.__mro__)
# è¾“å‡ºï¼š(<class '__main__.D'>, <class '__main__.B'>, <class '__main__.C'>, <class '__main__.A'>, <class 'object'>)

print("MROåˆ—è¡¨ï¼š", [cls.__name__ for cls in D.__mro__])
# è¾“å‡ºï¼š['D', 'B', 'C', 'A', 'object']

# è°ƒç”¨æ–¹æ³•ï¼Œè§‚å¯Ÿæ‰§è¡Œé¡ºåº
d = D()
d.method()
# è¾“å‡ºï¼š
# D.method
# B.method
# C.method
# A.method
```

#### è®¾è®¡è‰¯å¥½çš„æ··å…¥ä½“ç³»

```python
class EventMixin:
    """äº‹ä»¶æ··å…¥åŸºç±»"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._event_handlers = {}
    
    def on(self, event_name, handler):
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""
        if event_name not in self._event_handlers:
            self._event_handlers[event_name] = []
        self._event_handlers[event_name].append(handler)
    
    def emit(self, event_name, *args, **kwargs):
        """è§¦å‘äº‹ä»¶"""
        if event_name in self._event_handlers:
            for handler in self._event_handlers[event_name]:
                handler(*args, **kwargs)

class ValidatedModel(ValidationMixin, EventMixin):
    """ç»è¿‡éªŒè¯çš„æ¨¡å‹åŸºç±»"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.on('before_save', self._before_save)
        self.on('after_save', self._after_save)
    
    def _before_save(self):
        print("ä¿å­˜å‰éªŒè¯...")
        self.validate()
    
    def _after_save(self):
        print("ä¿å­˜åæ¸…ç†...")
    
    def save(self):
        self.emit('before_save')
        # æ‰§è¡Œä¿å­˜é€»è¾‘
        print("æ­£åœ¨ä¿å­˜...")
        self.emit('after_save')
        return True

class TrackedModel(TimestampMixin, LogMixin, ValidatedModel):
    """å¯è¿½è¸ªçš„æ¨¡å‹"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.log("æ¨¡å‹å·²åˆ›å»º")
    
    def save(self):
        self.log("å¼€å§‹ä¿å­˜æ¨¡å‹")
        result = super().save()
        self.touch()  # æ›´æ–°æ—¶é—´æˆ³
        self.log("æ¨¡å‹ä¿å­˜å®Œæˆ")
        return result

class BlogPost(TrackedModel):
    """åšå®¢æ–‡ç« ç±»"""
    
    def __init__(self, title, content, author):
        super().__init__()
        self.title = title
        self.content = content
        self.author = author
    
    def validate_title(self):
        if not self.title or len(self.title.strip()) < 5:
            raise ValueError("æ ‡é¢˜é•¿åº¦è‡³å°‘5ä¸ªå­—ç¬¦")
    
    def validate_content(self):
        if not self.content or len(self.content.strip()) < 10:
            raise ValueError("å†…å®¹é•¿åº¦è‡³å°‘10ä¸ªå­—ç¬¦")
    
    def __str__(self):
        return f"BlogPost('{self.title}' by {self.author})"

# æŸ¥çœ‹MRO
print("BlogPost MRO:")
for i, cls in enumerate(BlogPost.__mro__):
    print(f"  {i+1}. {cls.__name__}")

# ä½¿ç”¨ç¤ºä¾‹
post = BlogPost("Pythoné«˜çº§ç‰¹æ€§", "è¿™æ˜¯ä¸€ç¯‡å…³äºPythoné¢å‘å¯¹è±¡é«˜çº§ç‰¹æ€§çš„æ–‡ç« ...", "ä½œè€…")

# æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨
post.on('before_save', lambda: print("è‡ªå®šä¹‰ï¼šä¿å­˜å‰æ£€æŸ¥"))
post.on('after_save', lambda: print("è‡ªå®šä¹‰ï¼šä¿å­˜åé€šçŸ¥"))

# ä¿å­˜åšå®¢æ–‡ç« 
print("\nä¿å­˜åšå®¢æ–‡ç« ï¼š")
post.save()

# æŸ¥çœ‹æ—¥å¿—
print("\næ“ä½œæ—¥å¿—ï¼š")
for log in post.get_logs():
    print(f"  {log}")
```

### ğŸƒâ€â™‚ï¸ å®è·µç»ƒä¹ ï¼šæ’ä»¶ç³»ç»Ÿè®¾è®¡

**ç»ƒä¹ 3**ï¼šè®¾è®¡ä¸€ä¸ªæ’ä»¶ç³»ç»Ÿï¼Œæ”¯æŒåŠ¨æ€åŠ è½½å’Œå¸è½½åŠŸèƒ½æ¨¡å—ã€‚

```python
from abc import ABC, abstractmethod
from typing import Dict, List, Any

class PluginInterface(ABC):
    """æ’ä»¶æ¥å£"""
    
    @property
    @abstractmethod
    def name(self) -> str:
        """æ’ä»¶åç§°"""
        pass
    
    @property
    @abstractmethod
    def version(self) -> str:
        """æ’ä»¶ç‰ˆæœ¬"""
        pass
    
    @abstractmethod
    def install(self) -> bool:
        """å®‰è£…æ’ä»¶"""
        pass
    
    @abstractmethod
    def uninstall(self) -> bool:
        """å¸è½½æ’ä»¶"""
        pass
    
    @abstractmethod
    def execute(self, *args, **kwargs) -> Any:
        """æ‰§è¡Œæ’ä»¶åŠŸèƒ½"""
        pass

class PluginManager:
    """æ’ä»¶ç®¡ç†å™¨"""
    
    def __init__(self):
        self._plugins: Dict[str, PluginInterface] = {}
        self._installed_plugins: List[str] = []
    
    def register_plugin(self, plugin: PluginInterface):
        """æ³¨å†Œæ’ä»¶"""
        # TODO: å®ç°æ’ä»¶æ³¨å†Œé€»è¾‘
        pass
    
    def unregister_plugin(self, plugin_name: str):
        """æ³¨é”€æ’ä»¶"""
        # TODO: å®ç°æ’ä»¶æ³¨é”€é€»è¾‘
        pass
    
    def install_plugin(self, plugin_name: str):
        """å®‰è£…æ’ä»¶"""
        # TODO: å®ç°æ’ä»¶å®‰è£…é€»è¾‘
        pass
    
    def uninstall_plugin(self, plugin_name: str):
        """å¸è½½æ’ä»¶"""
        # TODO: å®ç°æ’ä»¶å¸è½½é€»è¾‘
        pass
    
    def execute_plugin(self, plugin_name: str, *args, **kwargs):
        """æ‰§è¡Œæ’ä»¶"""
        # TODO: å®ç°æ’ä»¶æ‰§è¡Œé€»è¾‘
        pass
    
    def get_installed_plugins(self) -> List[str]:
        """è·å–å·²å®‰è£…çš„æ’ä»¶åˆ—è¡¨"""
        return self._installed_plugins.copy()

# ç¤ºä¾‹æ’ä»¶å®ç°
class LoggerPlugin(PluginInterface):
    @property
    def name(self):
        return "logger"
    
    @property
    def version(self):
        return "1.0.0"
    
    def install(self):
        print(f"å®‰è£…æ—¥å¿—æ’ä»¶ {self.version}")
        return True
    
    def uninstall(self):
        print("å¸è½½æ—¥å¿—æ’ä»¶")
        return True
    
    def execute(self, message, level="INFO"):
        import datetime
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        print(f"[{timestamp}] [{level}] {message}")

# TODO: å®ç°å®Œæ•´çš„æ’ä»¶ç³»ç»Ÿ
```

### æœ¬èŠ‚å°ç»“

é«˜çº§ç±»ç‰¹æ€§ä¸ºæˆ‘ä»¬æä¾›äº†æ„å»ºå¤æ‚ç³»ç»Ÿçš„å·¥å…·ï¼š

1. **æ–¹æ³•ç±»å‹é€‰æ‹©**ï¼šå®ä¾‹æ–¹æ³•ã€ç±»æ–¹æ³•ã€é™æ€æ–¹æ³•å„æœ‰ç”¨é€”
2. **æŠ½è±¡åŸºç±»**ï¼šå®šä¹‰æ¥å£å¥‘çº¦ï¼Œç¡®ä¿å®ç°ä¸€è‡´æ€§
3. **æ··å…¥æ¨¡å¼**ï¼šåŠŸèƒ½æ¨¡å—åŒ–ï¼Œæé«˜ä»£ç å¤ç”¨æ€§
4. **MROç†è§£**ï¼šæŒæ¡å¤šé‡ç»§æ‰¿çš„æ–¹æ³•è§£æé¡ºåº

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†å­¦ä¹ ç»å…¸è®¾è®¡æ¨¡å¼çš„Pythonå®ç°ï¼

--- 

## ğŸ¨ ç¬¬7.4èŠ‚ï¼šè®¾è®¡æ¨¡å¼åº”ç”¨ - ç»å…¸è®¾è®¡çš„Pythonå®ç°

è®¾è®¡æ¨¡å¼æ˜¯è§£å†³ç‰¹å®šé—®é¢˜çš„ç»å…¸æ–¹æ¡ˆã€‚æŒæ¡è¿™äº›æ¨¡å¼ä¸ä»…èƒ½æé«˜ä»£ç è´¨é‡ï¼Œè¿˜èƒ½è®©ä½ åœ¨å›¢é˜Ÿä¸­æ›´å¥½åœ°æ²Ÿé€šè®¾è®¡æ€è·¯ã€‚

### å•ä¾‹æ¨¡å¼ï¼šå…¨å±€å”¯ä¸€çš„å®ä¾‹

å•ä¾‹æ¨¡å¼ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›å…¨å±€è®¿é—®ç‚¹ã€‚å¸¸ç”¨äºé…ç½®ç®¡ç†ã€æ—¥å¿—ç³»ç»Ÿã€æ•°æ®åº“è¿æ¥æ± ç­‰åœºæ™¯ã€‚

#### æ–¹æ³•1ï¼šä½¿ç”¨`__new__`æ–¹æ³•

```python
class Singleton:
    _instance = None
    _initialized = False
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
    
    def __init__(self):
        # é˜²æ­¢é‡å¤åˆå§‹åŒ–
        if not Singleton._initialized:
            print("å•ä¾‹åˆå§‹åŒ–")
            self.value = 0
            Singleton._initialized = True

# ä½¿ç”¨ç¤ºä¾‹
s1 = Singleton()
s2 = Singleton()
print(s1 is s2)  # Trueï¼ŒåŒä¸€ä¸ªå®ä¾‹

s1.value = 100
print(s2.value)  # 100ï¼Œå…±äº«çŠ¶æ€
```

#### æ–¹æ³•2ï¼šä½¿ç”¨è£…é¥°å™¨

```python
def singleton(cls):
    """å•ä¾‹è£…é¥°å™¨"""
    instances = {}
    def get_instance(*args, **kwargs):
        if cls not in instances:
            instances[cls] = cls(*args, **kwargs)
        return instances[cls]
    return get_instance

@singleton
class DatabaseConfig:
    def __init__(self):
        self.host = "localhost"
        self.port = 3306
        self.database = "myapp"
        print(f"åˆ›å»ºæ•°æ®åº“é…ç½®ï¼š{self.host}:{self.port}")
    
    def get_connection_string(self):
        return f"mysql://{self.host}:{self.port}/{self.database}"

# ä½¿ç”¨ç¤ºä¾‹
config1 = DatabaseConfig()
config2 = DatabaseConfig()
print(config1 is config2)  # True
print(config1.get_connection_string())
```

#### æ–¹æ³•3ï¼šä½¿ç”¨å…ƒç±»ï¼ˆé«˜çº§ï¼‰

```python
class SingletonMeta(type):
    """å•ä¾‹å…ƒç±»"""
    _instances = {}
    
    def __call__(cls, *args, **kwargs):
        if cls not in cls._instances:
            cls._instances[cls] = super().__call__(*args, **kwargs)
        return cls._instances[cls]

class Logger(metaclass=SingletonMeta):
    def __init__(self):
        self.logs = []
        print("æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–")
    
    def log(self, message):
        import datetime
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        log_entry = f"[{timestamp}] {message}"
        self.logs.append(log_entry)
        print(log_entry)
    
    def get_logs(self):
        return self.logs.copy()

# ä½¿ç”¨ç¤ºä¾‹
logger1 = Logger()
logger2 = Logger()
print(logger1 is logger2)  # True

logger1.log("ç”¨æˆ·ç™»å½•")
logger2.log("æ•°æ®æŸ¥è¯¢")
print(len(logger1.get_logs()))  # 2ï¼Œå…±äº«æ—¥å¿—
```

#### å®é™…åº”ç”¨ï¼šé…ç½®ç®¡ç†ç³»ç»Ÿ

```python
import json
import os
from threading import Lock

class ConfigManager:
    _instance = None
    _lock = Lock()  # çº¿ç¨‹å®‰å…¨
    _initialized = False
    
    def __new__(cls):
        if cls._instance is None:
            with cls._lock:  # åŒé‡æ£€æŸ¥é”å®š
                if cls._instance is None:
                    cls._instance = super().__new__(cls)
        return cls._instance
    
    def __init__(self):
        if not ConfigManager._initialized:
            self._config = {}
            self._config_file = "app_config.json"
            self.load_config()
            ConfigManager._initialized = True
    
    def load_config(self):
        """ä»æ–‡ä»¶åŠ è½½é…ç½®"""
        if os.path.exists(self._config_file):
            try:
                with open(self._config_file, 'r') as f:
                    self._config = json.load(f)
                print(f"é…ç½®å·²ä» {self._config_file} åŠ è½½")
            except Exception as e:
                print(f"åŠ è½½é…ç½®å¤±è´¥ï¼š{e}")
                self._config = self._get_default_config()
        else:
            self._config = self._get_default_config()
            self.save_config()
    
    def _get_default_config(self):
        """è·å–é»˜è®¤é…ç½®"""
        return {
            "database": {
                "host": "localhost",
                "port": 3306,
                "name": "myapp"
            },
            "logging": {
                "level": "INFO",
                "file": "app.log"
            },
            "app": {
                "debug": False,
                "max_connections": 100
            }
        }
    
    def save_config(self):
        """ä¿å­˜é…ç½®åˆ°æ–‡ä»¶"""
        try:
            with open(self._config_file, 'w') as f:
                json.dump(self._config, f, indent=2)
            print(f"é…ç½®å·²ä¿å­˜åˆ° {self._config_file}")
        except Exception as e:
            print(f"ä¿å­˜é…ç½®å¤±è´¥ï¼š{e}")
    
    def get(self, key, default=None):
        """è·å–é…ç½®å€¼ï¼ˆæ”¯æŒåµŒå¥—é”®ï¼Œå¦‚ 'database.host'ï¼‰"""
        keys = key.split('.')
        value = self._config
        
        for k in keys:
            if isinstance(value, dict) and k in value:
                value = value[k]
            else:
                return default
        
        return value
    
    def set(self, key, value):
        """è®¾ç½®é…ç½®å€¼ï¼ˆæ”¯æŒåµŒå¥—é”®ï¼‰"""
        keys = key.split('.')
        config = self._config
        
        # å¯¼èˆªåˆ°æœ€åä¸€çº§
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            config = config[k]
        
        # è®¾ç½®å€¼
        config[keys[-1]] = value
        self.save_config()

# ä½¿ç”¨ç¤ºä¾‹
config = ConfigManager()
print("æ•°æ®åº“ä¸»æœºï¼š", config.get("database.host"))
print("è°ƒè¯•æ¨¡å¼ï¼š", config.get("app.debug"))

config.set("app.debug", True)
config.set("database.timeout", 30)

# å¦ä¸€ä¸ªåœ°æ–¹è·å–é…ç½®ï¼ˆåŒä¸€ä¸ªå®ä¾‹ï¼‰
config2 = ConfigManager()
print("æ–°çš„è°ƒè¯•æ¨¡å¼ï¼š", config2.get("app.debug"))  # True
```

### å·¥å‚æ¨¡å¼ï¼šåŠ¨æ€åˆ›å»ºå¯¹è±¡

å·¥å‚æ¨¡å¼ç”¨äºæ ¹æ®æ¡ä»¶åŠ¨æ€åˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ç±»ååˆ›å»ºå¯¹è±¡ã€‚

#### ç®€å•å·¥å‚æ¨¡å¼

```python
from abc import ABC, abstractmethod

# äº§å“æ¥å£
class Notification(ABC):
    @abstractmethod
    def send(self, message: str) -> str:
        pass

# å…·ä½“äº§å“
class EmailNotification(Notification):
    def __init__(self, recipient):
        self.recipient = recipient
    
    def send(self, message):
        return f"é‚®ä»¶å‘é€ç»™ {self.recipient}: {message}"

class SMSNotification(Notification):
    def __init__(self, phone):
        self.phone = phone
    
    def send(self, message):
        return f"çŸ­ä¿¡å‘é€åˆ° {self.phone}: {message}"

class PushNotification(Notification):
    def __init__(self, device_id):
        self.device_id = device_id
    
    def send(self, message):
        return f"æ¨é€åˆ°è®¾å¤‡ {self.device_id}: {message}"

# ç®€å•å·¥å‚
class NotificationFactory:
    @staticmethod
    def create_notification(notification_type: str, target: str) -> Notification:
        if notification_type.lower() == "email":
            return EmailNotification(target)
        elif notification_type.lower() == "sms":
            return SMSNotification(target)
        elif notification_type.lower() == "push":
            return PushNotification(target)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„é€šçŸ¥ç±»å‹ï¼š{notification_type}")

# ä½¿ç”¨ç¤ºä¾‹
factory = NotificationFactory()

email = factory.create_notification("email", "user@example.com")
sms = factory.create_notification("sms", "13800138000")
push = factory.create_notification("push", "device123")

print(email.send("æ¬¢è¿æ³¨å†Œï¼"))
print(sms.send("éªŒè¯ç ï¼š123456"))
print(push.send("æ‚¨æœ‰æ–°æ¶ˆæ¯"))
```

#### æŠ½è±¡å·¥å‚æ¨¡å¼

```python
# æŠ½è±¡äº§å“å®¶æ—
class Button(ABC):
    @abstractmethod
    def render(self):
        pass

class Dialog(ABC):
    @abstractmethod
    def render(self):
        pass

# å…·ä½“äº§å“å®¶æ— - Windowsé£æ ¼
class WindowsButton(Button):
    def render(self):
        return "æ¸²æŸ“Windowsé£æ ¼æŒ‰é’®"

class WindowsDialog(Dialog):
    def render(self):
        return "æ¸²æŸ“Windowsé£æ ¼å¯¹è¯æ¡†"

# å…·ä½“äº§å“å®¶æ— - Macé£æ ¼
class MacButton(Button):
    def render(self):
        return "æ¸²æŸ“Macé£æ ¼æŒ‰é’®"

class MacDialog(Dialog):
    def render(self):
        return "æ¸²æŸ“Macé£æ ¼å¯¹è¯æ¡†"

# æŠ½è±¡å·¥å‚
class GUIFactory(ABC):
    @abstractmethod
    def create_button(self) -> Button:
        pass
    
    @abstractmethod
    def create_dialog(self) -> Dialog:
        pass

# å…·ä½“å·¥å‚
class WindowsFactory(GUIFactory):
    def create_button(self):
        return WindowsButton()
    
    def create_dialog(self):
        return WindowsDialog()

class MacFactory(GUIFactory):
    def create_button(self):
        return MacButton()
    
    def create_dialog(self):
        return MacDialog()

# å®¢æˆ·ç«¯ä»£ç 
class Application:
    def __init__(self, factory: GUIFactory):
        self.factory = factory
    
    def create_ui(self):
        button = self.factory.create_button()
        dialog = self.factory.create_dialog()
        
        return {
            'button': button.render(),
            'dialog': dialog.render()
        }

# ä½¿ç”¨ç¤ºä¾‹
import platform

# æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å·¥å‚
if platform.system() == "Windows":
    factory = WindowsFactory()
elif platform.system() == "Darwin":  # macOS
    factory = MacFactory()
else:
    factory = WindowsFactory()  # é»˜è®¤

app = Application(factory)
ui_components = app.create_ui()
print(ui_components)
```

### è§‚å¯Ÿè€…æ¨¡å¼ï¼šå‘å¸ƒ-è®¢é˜…ç³»ç»Ÿ

è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰äº†å¯¹è±¡é—´çš„ä¸€å¯¹å¤šä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–è€…éƒ½ä¼šå¾—åˆ°é€šçŸ¥ã€‚

#### åŸºç¡€è§‚å¯Ÿè€…æ¨¡å¼

```python
from abc import ABC, abstractmethod
from typing import List

# è§‚å¯Ÿè€…æ¥å£
class Observer(ABC):
    @abstractmethod
    def update(self, subject, event_data):
        pass

# ä¸»é¢˜æ¥å£
class Subject(ABC):
    def __init__(self):
        self._observers: List[Observer] = []
    
    def attach(self, observer: Observer):
        """æ·»åŠ è§‚å¯Ÿè€…"""
        if observer not in self._observers:
            self._observers.append(observer)
    
    def detach(self, observer: Observer):
        """ç§»é™¤è§‚å¯Ÿè€…"""
        if observer in self._observers:
            self._observers.remove(observer)
    
    def notify(self, event_data=None):
        """é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…"""
        for observer in self._observers:
            observer.update(self, event_data)

# å…·ä½“ä¸»é¢˜ï¼šæ–°é—»å‘å¸ƒç³»ç»Ÿ
class NewsAgency(Subject):
    def __init__(self):
        super().__init__()
        self._news = None
        self._category = None
    
    def set_news(self, news, category="general"):
        """å‘å¸ƒæ–°é—»"""
        self._news = news
        self._category = category
        print(f"æ–°é—»å‘å¸ƒï¼š[{category}] {news}")
        self.notify({
            'news': news,
            'category': category,
            'timestamp': self._get_timestamp()
        })
    
    def _get_timestamp(self):
        import datetime
        return datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    def get_news(self):
        return self._news

# å…·ä½“è§‚å¯Ÿè€…
class NewsChannel(Observer):
    def __init__(self, name):
        self.name = name
        self.latest_news = None
    
    def update(self, subject, event_data):
        self.latest_news = event_data
        print(f"ğŸ“º {self.name} æ”¶åˆ°æ–°é—»ï¼š{event_data['news']}")

class EmailSubscriber(Observer):
    def __init__(self, email):
        self.email = email
        self.subscribed_categories = set()
    
    def subscribe_category(self, category):
        """è®¢é˜…ç‰¹å®šç±»åˆ«"""
        self.subscribed_categories.add(category)
    
    def update(self, subject, event_data):
        category = event_data.get('category', 'general')
        
        # åªæ¥æ”¶è®¢é˜…çš„ç±»åˆ«
        if not self.subscribed_categories or category in self.subscribed_categories:
            print(f"ğŸ“§ å‘é€é‚®ä»¶åˆ° {self.email}ï¼š{event_data['news']}")

class MobileApp(Observer):
    def __init__(self, app_name):
        self.app_name = app_name
        self.notification_count = 0
    
    def update(self, subject, event_data):
        self.notification_count += 1
        print(f"ğŸ“± {self.app_name} æ¨é€é€šçŸ¥ #{self.notification_count}ï¼š{event_data['news']}")

# ä½¿ç”¨ç¤ºä¾‹
news_agency = NewsAgency()

# åˆ›å»ºè§‚å¯Ÿè€…
tv_channel = NewsChannel("CNNæ–°é—»å°")
email_subscriber = EmailSubscriber("user@example.com")
mobile_app = MobileApp("æ–°é—»å®¢æˆ·ç«¯")

# é‚®ä»¶è®¢é˜…è€…åªè®¢é˜…ç‰¹å®šç±»åˆ«
email_subscriber.subscribe_category("technology")
email_subscriber.subscribe_category("science")

# æ³¨å†Œè§‚å¯Ÿè€…
news_agency.attach(tv_channel)
news_agency.attach(email_subscriber)
news_agency.attach(mobile_app)

# å‘å¸ƒä¸åŒç±»åˆ«çš„æ–°é—»
print("=== å‘å¸ƒç§‘æŠ€æ–°é—» ===")
news_agency.set_news("Python 3.12æ­£å¼å‘å¸ƒ", "technology")

print("\n=== å‘å¸ƒä½“è‚²æ–°é—» ===")
news_agency.set_news("ä¸–ç•Œæ¯å†³èµ›ç»“æœå‡ºç‚‰", "sports")

print("\n=== ç§»é™¤è§‚å¯Ÿè€… ===")
news_agency.detach(mobile_app)
news_agency.set_news("é‡å¤§ç§‘å­¦å‘ç°", "science")
```

#### é«˜çº§è§‚å¯Ÿè€…æ¨¡å¼ï¼šäº‹ä»¶ç³»ç»Ÿ

```python
from collections import defaultdict
from typing import Callable, Any
import functools

class EventManager:
    """é«˜çº§äº‹ä»¶ç®¡ç†å™¨"""
    
    def __init__(self):
        self._handlers = defaultdict(list)
        self._middleware = []
    
    def on(self, event_name: str, handler: Callable = None, priority: int = 0):
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ï¼ˆæ”¯æŒè£…é¥°å™¨ç”¨æ³•ï¼‰"""
        def decorator(func):
            self._handlers[event_name].append({
                'handler': func,
                'priority': priority
            })
            # æŒ‰ä¼˜å…ˆçº§æ’åºï¼ˆé«˜ä¼˜å…ˆçº§å…ˆæ‰§è¡Œï¼‰
            self._handlers[event_name].sort(key=lambda x: x['priority'], reverse=True)
            return func
        
        if handler is None:
            return decorator
        else:
            return decorator(handler)
    
    def off(self, event_name: str, handler: Callable = None):
        """ç§»é™¤äº‹ä»¶å¤„ç†å™¨"""
        if handler is None:
            # ç§»é™¤æ‰€æœ‰å¤„ç†å™¨
            if event_name in self._handlers:
                del self._handlers[event_name]
        else:
            # ç§»é™¤ç‰¹å®šå¤„ç†å™¨
            self._handlers[event_name] = [
                h for h in self._handlers[event_name] 
                if h['handler'] != handler
            ]
    
    def emit(self, event_name: str, *args, **kwargs):
        """è§¦å‘äº‹ä»¶"""
        event_data = {
            'event_name': event_name,
            'args': args,
            'kwargs': kwargs,
            'stopped': False
        }
        
        # æ‰§è¡Œä¸­é—´ä»¶
        for middleware in self._middleware:
            middleware(event_data)
            if event_data['stopped']:
                return
        
        # æ‰§è¡Œäº‹ä»¶å¤„ç†å™¨
        for handler_info in self._handlers[event_name]:
            try:
                result = handler_info['handler'](*args, **kwargs)
                if result is False:  # æ˜ç¡®è¿”å›Falseæ—¶åœæ­¢ä¼ æ’­
                    break
            except Exception as e:
                print(f"äº‹ä»¶å¤„ç†å™¨é”™è¯¯ï¼š{e}")
    
    def middleware(self, func: Callable):
        """æ³¨å†Œä¸­é—´ä»¶"""
        self.middleware.append(func)
        return func
    
    def once(self, event_name: str, handler: Callable = None):
        """ä¸€æ¬¡æ€§äº‹ä»¶å¤„ç†å™¨"""
        def decorator(func):
            @functools.wraps(func)
            def wrapper(*args, **kwargs):
                result = func(*args, **kwargs)
                self.off(event_name, wrapper)  # æ‰§è¡Œåè‡ªåŠ¨ç§»é™¤
                return result
            
            self.on(event_name, wrapper)
            return wrapper
        
        if handler is None:
            return decorator
        else:
            return decorator(handler)

# ä½¿ç”¨ç¤ºä¾‹ï¼šç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
user_events = EventManager()

# æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ï¼ˆè£…é¥°å™¨æ–¹å¼ï¼‰
@user_events.on("user_login", priority=10)
def log_user_login(user_id, timestamp):
    print(f"ğŸ“ è®°å½•ç”¨æˆ·ç™»å½•ï¼š{user_id} at {timestamp}")

@user_events.on("user_login", priority=5)
def send_welcome_email(user_id, timestamp):
    print(f"ğŸ“§ å‘é€æ¬¢è¿é‚®ä»¶ç»™ç”¨æˆ·ï¼š{user_id}")

@user_events.on("user_login")
def update_last_seen(user_id, timestamp):
    print(f"ğŸ•’ æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´ï¼š{user_id}")

# ä¸€æ¬¡æ€§äº‹ä»¶å¤„ç†å™¨
@user_events.once("user_first_login")
def setup_user_profile(user_id):
    print(f"ğŸ‰ é¦–æ¬¡ç™»å½•ï¼Œè®¾ç½®ç”¨æˆ·æ¡£æ¡ˆï¼š{user_id}")

# æ·»åŠ ä¸­é—´ä»¶
@user_events.middleware
def security_check(event_data):
    """å®‰å…¨æ£€æŸ¥ä¸­é—´ä»¶"""
    if event_data['event_name'] == 'user_login':
        user_id = event_data['args'][0]
        if user_id == 'banned_user':
            print("ğŸš« ç”¨æˆ·è¢«ç¦æ­¢ï¼Œé˜»æ­¢äº‹ä»¶ä¼ æ’­")
            event_data['stopped'] = True

# æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œ
import datetime

timestamp = datetime.datetime.now().isoformat()

print("=== æ­£å¸¸ç”¨æˆ·ç™»å½• ===")
user_events.emit("user_login", "user123", timestamp)

print("\n=== é¦–æ¬¡ç™»å½•ç”¨æˆ· ===")
user_events.emit("user_first_login", "newuser456")
user_events.emit("user_first_login", "newuser456")  # ç¬¬äºŒæ¬¡ä¸ä¼šè§¦å‘

print("\n=== è¢«ç¦ç”¨æˆ·å°è¯•ç™»å½• ===")
user_events.emit("user_login", "banned_user", timestamp)
```

### è£…é¥°å™¨æ¨¡å¼ï¼šåŠ¨æ€æ·»åŠ åŠŸèƒ½

è£…é¥°å™¨æ¨¡å¼å…è®¸åœ¨è¿è¡Œæ—¶ä¸ºå¯¹è±¡åŠ¨æ€æ·»åŠ æ–°åŠŸèƒ½ï¼Œè€Œä¸æ”¹å˜å…¶ç»“æ„ã€‚

#### å‡½æ•°è£…é¥°å™¨åº”ç”¨

```python
import time
import functools
from typing import Callable

# æ€§èƒ½è®¡æ—¶è£…é¥°å™¨
def timing(func: Callable):
    """è®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´"""
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        print(f"â±ï¸ {func.__name__} æ‰§è¡Œæ—¶é—´ï¼š{end_time - start_time:.4f}ç§’")
        return result
    return wrapper

# ç¼“å­˜è£…é¥°å™¨
def memoize(func: Callable):
    """ç¼“å­˜å‡½æ•°ç»“æœ"""
    cache = {}
    
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        # åˆ›å»ºç¼“å­˜é”®
        key = str(args) + str(sorted(kwargs.items()))
        
        if key in cache:
            print(f"ğŸ’¾ ç¼“å­˜å‘½ä¸­ï¼š{func.__name__}")
            return cache[key]
        
        result = func(*args, **kwargs)
        cache[key] = result
        print(f"ğŸ’¾ ç¼“å­˜è®¾ç½®ï¼š{func.__name__}")
        return result
    
    wrapper.cache = cache  # æš´éœ²ç¼“å­˜ä»¥ä¾¿æ£€æŸ¥
    return wrapper

# é‡è¯•è£…é¥°å™¨
def retry(max_attempts: int = 3, delay: float = 1.0):
    """é‡è¯•è£…é¥°å™¨"""
    def decorator(func: Callable):
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_attempts - 1:
                        print(f"âŒ {func.__name__} é‡è¯•{max_attempts}æ¬¡åä»ç„¶å¤±è´¥")
                        raise e
                    print(f"âš ï¸ {func.__name__} ç¬¬{attempt + 1}æ¬¡å°è¯•å¤±è´¥ï¼Œ{delay}ç§’åé‡è¯•...")
                    time.sleep(delay)
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@timing
@memoize
def fibonacci(n):
    """è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—"""
    if n <= 1:
        return n
    return fibonacci(n - 1) + fibonacci(n - 2)

@retry(max_attempts=3, delay=0.5)
@timing
def unreliable_api_call():
    """æ¨¡æ‹Ÿä¸å¯é çš„APIè°ƒç”¨"""
    import random
    if random.random() < 0.7:  # 70%å¤±è´¥ç‡
        raise Exception("APIè°ƒç”¨å¤±è´¥")
    return "APIè°ƒç”¨æˆåŠŸ"

# æµ‹è¯•æ–æ³¢é‚£å¥‘
print("=== æ–æ³¢é‚£å¥‘è®¡ç®— ===")
result1 = fibonacci(10)  # ç¬¬ä¸€æ¬¡è®¡ç®—
result2 = fibonacci(10)  # ä½¿ç”¨ç¼“å­˜

# æµ‹è¯•é‡è¯•
print("\n=== APIé‡è¯•æµ‹è¯• ===")
try:
    result = unreliable_api_call()
    print(f"âœ… {result}")
except Exception as e:
    print(f"âŒ æœ€ç»ˆå¤±è´¥ï¼š{e}")
```

#### ç±»è£…é¥°å™¨æ¨¡å¼

```python
# æ—¥å¿—è£…é¥°å™¨ç±»
class LoggedClass:
    """ä¸ºç±»çš„æ‰€æœ‰æ–¹æ³•æ·»åŠ æ—¥å¿—"""
    
    def __init__(self, cls):
        self.cls = cls
        self._wrap_methods()
    
    def _wrap_methods(self):
        """åŒ…è£…æ‰€æœ‰å…¬å…±æ–¹æ³•"""
        for attr_name in dir(self.cls):
            attr = getattr(self.cls, attr_name)
            if callable(attr) and not attr_name.startswith('_'):
                setattr(self.cls, attr_name, self._log_method(attr))
    
    def _log_method(self, method):
        """ä¸ºæ–¹æ³•æ·»åŠ æ—¥å¿—"""
        @functools.wraps(method)
        def wrapper(*args, **kwargs):
            print(f"ğŸ“ è°ƒç”¨æ–¹æ³•ï¼š{method.__name__}")
            result = method(*args, **kwargs)
            print(f"ğŸ“ æ–¹æ³•å®Œæˆï¼š{method.__name__}")
            return result
        return wrapper
    
    def __call__(self, *args, **kwargs):
        """ä½¿è£…é¥°å™¨å¯ä»¥åƒç±»ä¸€æ ·å®ä¾‹åŒ–"""
        return self.cls(*args, **kwargs)

# æƒé™æ£€æŸ¥è£…é¥°å™¨
def require_permission(permission: str):
    """æƒé™æ£€æŸ¥è£…é¥°å™¨"""
    def decorator(cls):
        original_init = cls.__init__
        
        @functools.wraps(original_init)
        def new_init(self, *args, **kwargs):
            self._required_permission = permission
            original_init(self, *args, **kwargs)
        
        cls.__init__ = new_init
        
        # åŒ…è£…æ‰€æœ‰å…¬å…±æ–¹æ³•
        for attr_name in dir(cls):
            attr = getattr(cls, attr_name)
            if callable(attr) and not attr_name.startswith('_'):
                setattr(cls, attr_name, check_permission(attr))
        
        return cls
    return decorator

def check_permission(method):
    """æ£€æŸ¥æƒé™çš„æ–¹æ³•è£…é¥°å™¨"""
    @functools.wraps(method)
    def wrapper(self, *args, **kwargs):
        if not hasattr(self, '_required_permission'):
            return method(self, *args, **kwargs)
        
        # æ¨¡æ‹Ÿæƒé™æ£€æŸ¥
        user_permissions = getattr(self, '_user_permissions', set())
        if self._required_permission not in user_permissions:
            raise PermissionError(f"ç¼ºå°‘æƒé™ï¼š{self._required_permission}")
        
        return method(self, *args, **kwargs)
    return wrapper

# ä½¿ç”¨è£…é¥°å™¨
@LoggedClass
@require_permission("admin")
class AdminPanel:
    def __init__(self):
        self._user_permissions = set()
    
    def set_permissions(self, permissions):
        """è®¾ç½®ç”¨æˆ·æƒé™"""
        self._user_permissions = set(permissions)
    
    def create_user(self, username):
        return f"åˆ›å»ºç”¨æˆ·ï¼š{username}"
    
    def delete_user(self, username):
        return f"åˆ é™¤ç”¨æˆ·ï¼š{username}"
    
    def view_logs(self):
        return "æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"

# ä½¿ç”¨ç¤ºä¾‹
print("=== æƒé™ç®¡ç†æµ‹è¯• ===")
admin = AdminPanel()

# æ²¡æœ‰æƒé™æ—¶
try:
    admin.create_user("newuser")
except PermissionError as e:
    print(f"âŒ {e}")

# è®¾ç½®æƒé™å
admin.set_permissions(["admin", "user"])
result = admin.create_user("newuser")
print(f"âœ… {result}")
```

### ç­–ç•¥æ¨¡å¼ï¼šç®—æ³•æ—çš„å°è£…

ç­–ç•¥æ¨¡å¼å®šä¹‰äº†ç®—æ³•æ—ï¼Œåˆ†åˆ«å°è£…èµ·æ¥ï¼Œè®©å®ƒä»¬ä¹‹é—´å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚

#### åŸºç¡€ç­–ç•¥æ¨¡å¼

```python
from abc import ABC, abstractmethod

# ç­–ç•¥æ¥å£
class SortStrategy(ABC):
    @abstractmethod
    def sort(self, data):
        pass

# å…·ä½“ç­–ç•¥
class BubbleSort(SortStrategy):
    def sort(self, data):
        print("ä½¿ç”¨å†’æ³¡æ’åº")
        data = data.copy()
        n = len(data)
        for i in range(n):
            for j in range(0, n - i - 1):
                if data[j] > data[j + 1]:
                    data[j], data[j + 1] = data[j + 1], data[j]
        return data

class QuickSort(SortStrategy):
    def sort(self, data):
        print("ä½¿ç”¨å¿«é€Ÿæ’åº")
        return self._quick_sort(data.copy())
    
    def _quick_sort(self, data):
        if len(data) <= 1:
            return data
        
        pivot = data[len(data) // 2]
        left = [x for x in data if x < pivot]
        middle = [x for x in data if x == pivot]
        right = [x for x in data if x > pivot]
        
        return self._quick_sort(left) + middle + self._quick_sort(right)

class MergeSort(SortStrategy):
    def sort(self, data):
        print("ä½¿ç”¨å½’å¹¶æ’åº")
        return self._merge_sort(data.copy())
    
    def _merge_sort(self, data):
        if len(data) <= 1:
            return data
        
        mid = len(data) // 2
        left = self._merge_sort(data[:mid])
        right = self._merge_sort(data[mid:])
        
        return self._merge(left, right)
    
    def _merge(self, left, right):
        result = []
        i = j = 0
        
        while i < len(left) and j < len(right):
            if left[i] <= right[j]:
                result.append(left[i])
                i += 1
            else:
                result.append(right[j])
                j += 1
        
        result.extend(left[i:])
        result.extend(right[j:])
        return result

# ä¸Šä¸‹æ–‡ç±»
class Sorter:
    def __init__(self, strategy: SortStrategy = None):
        self._strategy = strategy or BubbleSort()
    
    def set_strategy(self, strategy: SortStrategy):
        """åˆ‡æ¢ç­–ç•¥"""
        self._strategy = strategy
    
    def sort(self, data):
        """æ‰§è¡Œæ’åº"""
        return self._strategy.sort(data)

# ä½¿ç”¨ç¤ºä¾‹
data = [64, 34, 25, 12, 22, 11, 90]
sorter = Sorter()

print("åŸå§‹æ•°æ®ï¼š", data)

# ä½¿ç”¨ä¸åŒçš„æ’åºç­–ç•¥
strategies = [
    ("å†’æ³¡æ’åº", BubbleSort()),
    ("å¿«é€Ÿæ’åº", QuickSort()),
    ("å½’å¹¶æ’åº", MergeSort())
]

for name, strategy in strategies:
    sorter.set_strategy(strategy)
    result = sorter.sort(data)
    print(f"{name}ç»“æœï¼š{result}\n")
```

#### å®é™…åº”ç”¨ï¼šæ”¯ä»˜ç³»ç»Ÿ

```python
from abc import ABC, abstractmethod
from enum import Enum

class PaymentStatus(Enum):
    PENDING = "pending"
    SUCCESS = "success"
    FAILED = "failed"

# æ”¯ä»˜ç­–ç•¥æ¥å£
class PaymentStrategy(ABC):
    @abstractmethod
    def pay(self, amount: float) -> dict:
        pass
    
    @abstractmethod
    def refund(self, transaction_id: str, amount: float) -> dict:
        pass

# å…·ä½“æ”¯ä»˜ç­–ç•¥
class CreditCardPayment(PaymentStrategy):
    def __init__(self, card_number: str, cvv: str):
        self.card_number = card_number
        self.cvv = cvv
    
    def pay(self, amount: float) -> dict:
        # æ¨¡æ‹Ÿä¿¡ç”¨å¡æ”¯ä»˜
        print(f"ğŸ’³ ä½¿ç”¨ä¿¡ç”¨å¡æ”¯ä»˜ Â¥{amount}")
        return {
            'status': PaymentStatus.SUCCESS,
            'transaction_id': f"cc_{hash(self.card_number + str(amount))}",
            'method': 'credit_card',
            'amount': amount
        }
    
    def refund(self, transaction_id: str, amount: float) -> dict:
        print(f"ğŸ’³ ä¿¡ç”¨å¡é€€æ¬¾ Â¥{amount}")
        return {
            'status': PaymentStatus.SUCCESS,
            'refund_id': f"rf_{transaction_id}",
            'amount': amount
        }

class AlipayPayment(PaymentStrategy):
    def __init__(self, account: str):
        self.account = account
    
    def pay(self, amount: float) -> dict:
        print(f"ğŸ’° ä½¿ç”¨æ”¯ä»˜å®æ”¯ä»˜ Â¥{amount}")
        return {
            'status': PaymentStatus.SUCCESS,
            'transaction_id': f"alipay_{hash(self.account + str(amount))}",
            'method': 'alipay',
            'amount': amount
        }
    
    def refund(self, transaction_id: str, amount: float) -> dict:
        print(f"ğŸ’° æ”¯ä»˜å®é€€æ¬¾ Â¥{amount}")
        return {
            'status': PaymentStatus.SUCCESS,
            'refund_id': f"rf_{transaction_id}",
            'amount': amount
        }

class WeChatPayment(PaymentStrategy):
    def __init__(self, wechat_id: str):
        self.wechat_id = wechat_id
    
    def pay(self, amount: float) -> dict:
        print(f"ğŸ’š ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜ Â¥{amount}")
        return {
            'status': PaymentStatus.SUCCESS,
            'transaction_id': f"wechat_{hash(self.wechat_id + str(amount))}",
            'method': 'wechat',
            'amount': amount
        }
    
    def refund(self, transaction_id: str, amount: float) -> dict:
        print(f"ğŸ’š å¾®ä¿¡é€€æ¬¾ Â¥{amount}")
        return {
            'status': PaymentStatus.SUCCESS,
            'refund_id': f"rf_{transaction_id}",
            'amount': amount
        }

# æ”¯ä»˜ä¸Šä¸‹æ–‡
class PaymentProcessor:
    def __init__(self):
        self._strategy = None
        self._transaction_history = []
    
    def set_payment_method(self, strategy: PaymentStrategy):
        """è®¾ç½®æ”¯ä»˜æ–¹å¼"""
        self._strategy = strategy
        print(f"åˆ‡æ¢æ”¯ä»˜æ–¹å¼ï¼š{strategy.__class__.__name__}")
    
    def process_payment(self, amount: float) -> dict:
        """å¤„ç†æ”¯ä»˜"""
        if not self._strategy:
            raise ValueError("è¯·å…ˆè®¾ç½®æ”¯ä»˜æ–¹å¼")
        
        result = self._strategy.pay(amount)
        self._transaction_history.append(result)
        return result
    
    def process_refund(self, transaction_id: str, amount: float) -> dict:
        """å¤„ç†é€€æ¬¾"""
        if not self._strategy:
            raise ValueError("è¯·å…ˆè®¾ç½®æ”¯ä»˜æ–¹å¼")
        
        return self._strategy.refund(transaction_id, amount)
    
    def get_transaction_history(self):
        """è·å–äº¤æ˜“å†å²"""
        return self._transaction_history.copy()

# ä½¿ç”¨ç¤ºä¾‹
processor = PaymentProcessor()

# åˆ›å»ºä¸åŒçš„æ”¯ä»˜æ–¹å¼
credit_card = CreditCardPayment("1234-5678-9012-3456", "123")
alipay = AlipayPayment("user@example.com")
wechat = WeChatPayment("wxid_123456")

print("=== åœ¨çº¿è´­ç‰©æ”¯ä»˜æµç¨‹ ===")

# æ¨¡æ‹Ÿè´­ç‰©è½¦æ”¯ä»˜
items = [
    {"name": "Pythonç¼–ç¨‹ä¹¦ç±", "price": 89.90},
    {"name": "æ— çº¿é¼ æ ‡", "price": 129.00},
    {"name": "æœºæ¢°é”®ç›˜", "price": 299.00}
]

total_amount = sum(item["price"] for item in items)
print(f"è´­ç‰©è½¦æ€»é‡‘é¢ï¼šÂ¥{total_amount}")

# ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ–¹å¼
payment_methods = [
    ("ä¿¡ç”¨å¡", credit_card),
    ("æ”¯ä»˜å®", alipay),
    ("å¾®ä¿¡æ”¯ä»˜", wechat)
]

for name, method in payment_methods:
    print(f"\n--- ä½¿ç”¨{name}æ”¯ä»˜ ---")
    processor.set_payment_method(method)
    result = processor.process_payment(total_amount)
    print(f"æ”¯ä»˜ç»“æœï¼š{result}")
    
    # æ¨¡æ‹Ÿéƒ¨åˆ†é€€æ¬¾
    if result['status'] == PaymentStatus.SUCCESS:
        refund_result = processor.process_refund(
            result['transaction_id'], 
            items[0]["price"]  # é€€æ¬¾ç¬¬ä¸€ä»¶å•†å“
        )
        print(f"é€€æ¬¾ç»“æœï¼š{refund_result}")

print(f"\näº¤æ˜“å†å²ï¼š{len(processor.get_transaction_history())}ç¬”")
```

### æœ¬èŠ‚å°ç»“

æˆ‘ä»¬å­¦ä¹ äº†å‡ ä¸ªç»å…¸çš„è®¾è®¡æ¨¡å¼ï¼š

1. **å•ä¾‹æ¨¡å¼**ï¼šç¡®ä¿å…¨å±€å”¯ä¸€å®ä¾‹ï¼Œé€‚ç”¨äºé…ç½®ç®¡ç†ã€æ—¥å¿—ç³»ç»Ÿ
2. **å·¥å‚æ¨¡å¼**ï¼šåŠ¨æ€åˆ›å»ºå¯¹è±¡ï¼Œé™ä½ä»£ç è€¦åˆåº¦
3. **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šå®ç°å‘å¸ƒ-è®¢é˜…æœºåˆ¶ï¼Œæ”¯æŒäº‹ä»¶é©±åŠ¨ç¼–ç¨‹
4. **è£…é¥°å™¨æ¨¡å¼**ï¼šåŠ¨æ€æ·»åŠ åŠŸèƒ½ï¼Œä¸æ”¹å˜åŸæœ‰ç»“æ„
5. **ç­–ç•¥æ¨¡å¼**ï¼šå°è£…ç®—æ³•æ—ï¼Œä½¿ç®—æ³•å¯ä»¥äº’ç›¸æ›¿æ¢

è¿™äº›æ¨¡å¼åœ¨å®é™…å¼€å‘ä¸­éå¸¸å¸¸ç”¨ï¼ŒæŒæ¡å®ƒä»¬èƒ½è®©ä½ çš„ä»£ç æ›´åŠ ä¼˜é›…å’Œå¯ç»´æŠ¤ï¼

---

## ğŸš€ ç¬¬7.5èŠ‚ï¼šç»¼åˆé¡¹ç›®æ¡ˆä¾‹ - é«˜çº§ORMç³»ç»Ÿè®¾è®¡

åœ¨è¿™ä¸ªç»¼åˆé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†è®¾è®¡ä¸€ä¸ªå°å‹çš„ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰ç³»ç»Ÿï¼Œé›†æˆæœ¬ç« å­¦åˆ°çš„æ‰€æœ‰é«˜çº§ç‰¹æ€§ï¼šé­”æœ¯æ–¹æ³•ã€å±æ€§ç®¡ç†ã€æŠ½è±¡åŸºç±»ã€æ··å…¥æ¨¡å¼å’Œè®¾è®¡æ¨¡å¼ã€‚

### é¡¹ç›®æ¶æ„æ¦‚è§ˆ

```mermaid
graph TB
    A[ModelåŸºç±»] --> B[æ•°æ®åº“è¿æ¥ç®¡ç†]
    A --> C[å­—æ®µå®šä¹‰ç³»ç»Ÿ]
    A --> D[æŸ¥è¯¢æ„å»ºå™¨]
    A --> E[äº‹ä»¶ç³»ç»Ÿ]
    
    C --> F[å­—æ®µç±»å‹]
    C --> G[éªŒè¯å™¨]
    
    D --> H[æŸ¥è¯¢æ‰§è¡Œå™¨]
    D --> I[ç»“æœæ˜ å°„å™¨]
    
    B --> J[è¿æ¥æ± ]
    B --> K[äº‹åŠ¡ç®¡ç†]
```

### ç¬¬ä¸€æ­¥ï¼šå­—æ®µç±»å‹ç³»ç»Ÿ

```python
from abc import ABC, abstractmethod
from typing import Any, Optional, Dict, List, Callable
from datetime import datetime, date
import re

class Field(ABC):
    """å­—æ®µåŸºç±»"""
    
    def __init__(self, 
                 primary_key: bool = False,
                 nullable: bool = True,
                 default: Any = None,
                 validators: List[Callable] = None):
        self.primary_key = primary_key
        self.nullable = nullable
        self.default = default
        self.validators = validators or []
        self.name = None  # å°†åœ¨Modelå…ƒç±»ä¸­è®¾ç½®
    
    def __set_name__(self, owner, name):
        """æè¿°ç¬¦åè®®ï¼šè®¾ç½®å­—æ®µå"""
        self.name = name
    
    def __get__(self, instance, owner):
        """æè¿°ç¬¦åè®®ï¼šè·å–å€¼"""
        if instance is None:
            return self
        return instance.__dict__.get(self.name)
    
    def __set__(self, instance, value):
        """æè¿°ç¬¦åè®®ï¼šè®¾ç½®å€¼"""
        # æ•°æ®éªŒè¯
        if value is None and not self.nullable:
            raise ValueError(f"å­—æ®µ {self.name} ä¸èƒ½ä¸ºç©º")
        
        if value is not None:
            value = self.validate_and_convert(value)
        
        instance.__dict__[self.name] = value
    
    @abstractmethod
    def validate_and_convert(self, value):
        """éªŒè¯å¹¶è½¬æ¢å€¼"""
        pass
    
    @abstractmethod
    def to_db_value(self, value):
        """è½¬æ¢ä¸ºæ•°æ®åº“å€¼"""
        pass
    
    @abstractmethod
    def from_db_value(self, value):
        """ä»æ•°æ®åº“å€¼è½¬æ¢"""
        pass

class StringField(Field):
    """å­—ç¬¦ä¸²å­—æ®µ"""
    
    def __init__(self, max_length: int = 255, **kwargs):
        super().__init__(**kwargs)
        self.max_length = max_length
    
    def validate_and_convert(self, value):
        if not isinstance(value, str):
            value = str(value)
        
        if len(value) > self.max_length:
            raise ValueError(f"å­—ç¬¦ä¸²é•¿åº¦ä¸èƒ½è¶…è¿‡ {self.max_length}")
        
        # æ‰§è¡Œè‡ªå®šä¹‰éªŒè¯å™¨
        for validator in self.validators:
            validator(value)
        
        return value
    
    def to_db_value(self, value):
        return value
    
    def from_db_value(self, value):
        return value

class IntegerField(Field):
    """æ•´æ•°å­—æ®µ"""
    
    def __init__(self, min_value: int = None, max_value: int = None, **kwargs):
        super().__init__(**kwargs)
        self.min_value = min_value
        self.max_value = max_value
    
    def validate_and_convert(self, value):
        if not isinstance(value, int):
            try:
                value = int(value)
            except ValueError:
                raise ValueError(f"æ— æ³•å°† {value} è½¬æ¢ä¸ºæ•´æ•°")
        
        if self.min_value is not None and value < self.min_value:
            raise ValueError(f"å€¼ä¸èƒ½å°äº {self.min_value}")
        
        if self.max_value is not None and value > self.max_value:
            raise ValueError(f"å€¼ä¸èƒ½å¤§äº {self.max_value}")
        
        for validator in self.validators:
            validator(value)
        
        return value
    
    def to_db_value(self, value):
        return value
    
    def from_db_value(self, value):
        return int(value) if value is not None else None

class DateTimeField(Field):
    """æ—¥æœŸæ—¶é—´å­—æ®µ"""
    
    def __init__(self, auto_now: bool = False, auto_now_add: bool = False, **kwargs):
        super().__init__(**kwargs)
        self.auto_now = auto_now
        self.auto_now_add = auto_now_add
    
    def validate_and_convert(self, value):
        if isinstance(value, str):
            # ç®€å•çš„æ—¥æœŸæ—¶é—´è§£æ
            try:
                value = datetime.fromisoformat(value)
            except ValueError:
                raise ValueError(f"æ— æ³•è§£ææ—¥æœŸæ—¶é—´ï¼š{value}")
        
        if not isinstance(value, datetime):
            raise ValueError("å¿…é¡»æ˜¯datetimeå¯¹è±¡")
        
        for validator in self.validators:
            validator(value)
        
        return value
    
    def to_db_value(self, value):
        return value.isoformat() if value else None
    
    def from_db_value(self, value):
        return datetime.fromisoformat(value) if value else None

# å­—æ®µéªŒè¯å™¨
class Validators:
    @staticmethod
    def email_validator(value):
        """é‚®ç®±éªŒè¯å™¨"""
        pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(pattern, value):
            raise ValueError("æ— æ•ˆçš„é‚®ç®±æ ¼å¼")
    
    @staticmethod
    def min_length(length):
        """æœ€å°é•¿åº¦éªŒè¯å™¨"""
        def validator(value):
            if len(value) < length:
                raise ValueError(f"é•¿åº¦ä¸èƒ½å°‘äº {length}")
        return validator
    
    @staticmethod
    def max_length(length):
        """æœ€å¤§é•¿åº¦éªŒè¯å™¨"""
        def validator(value):
            if len(value) > length:
                raise ValueError(f"é•¿åº¦ä¸èƒ½è¶…è¿‡ {length}")
        return validator
```

### ç¬¬äºŒæ­¥ï¼šæŸ¥è¯¢æ„å»ºå™¨

```python
from typing import Dict, List, Any, Union

class QueryBuilder:
    """æŸ¥è¯¢æ„å»ºå™¨"""
    
    def __init__(self, model_class):
        self.model_class = model_class
        self._select_fields = ['*']
        self._where_conditions = []
        self._order_by = []
        self._limit_value = None
        self._offset_value = None
    
    def select(self, *fields):
        """é€‰æ‹©å­—æ®µ"""
        self._select_fields = list(fields) if fields else ['*']
        return self
    
    def where(self, **conditions):
        """WHEREæ¡ä»¶"""
        for field, value in conditions.items():
            self._where_conditions.append(f"{field} = ?")
        return self
    
    def order_by(self, *fields):
        """æ’åº"""
        self._order_by.extend(fields)
        return self
    
    def limit(self, count):
        """é™åˆ¶æ•°é‡"""
        self._limit_value = count
        return self
    
    def offset(self, count):
        """åç§»é‡"""
        self._offset_value = count
        return self
    
    def build_sql(self) -> str:
        """æ„å»ºSQLè¯­å¥"""
        table_name = self.model_class._meta.table_name
        
        # SELECTå­å¥
        select_clause = f"SELECT {', '.join(self._select_fields)}"
        
        # FROMå­å¥
        from_clause = f"FROM {table_name}"
        
        # WHEREå­å¥
        where_clause = ""
        if self._where_conditions:
            where_clause = f"WHERE {' AND '.join(self._where_conditions)}"
        
        # ORDER BYå­å¥
        order_clause = ""
        if self._order_by:
            order_clause = f"ORDER BY {', '.join(self._order_by)}"
        
        # LIMITå­å¥
        limit_clause = ""
        if self._limit_value:
            limit_clause = f"LIMIT {self._limit_value}"
            if self._offset_value:
                limit_clause += f" OFFSET {self._offset_value}"
        
        # ç»„åˆSQL
        sql_parts = [select_clause, from_clause, where_clause, order_clause, limit_clause]
        return ' '.join(part for part in sql_parts if part)

class QuerySet:
    """æŸ¥è¯¢é›†åˆ"""
    
    def __init__(self, model_class, db_manager):
        self.model_class = model_class
        self.db_manager = db_manager
        self._builder = QueryBuilder(model_class)
        self._cache = None
    
    def filter(self, **kwargs):
        """è¿‡æ»¤"""
        new_qs = self._clone()
        new_qs._builder.where(**kwargs)
        return new_qs
    
    def order_by(self, *fields):
        """æ’åº"""
        new_qs = self._clone()
        new_qs._builder.order_by(*fields)
        return new_qs
    
    def limit(self, count):
        """é™åˆ¶æ•°é‡"""
        new_qs = self._clone()
        new_qs._builder.limit(count)
        return new_qs
    
    def all(self):
        """è·å–æ‰€æœ‰ç»“æœ"""
        if self._cache is None:
            sql = self._builder.build_sql()
            raw_results = self.db_manager.execute_query(sql)
            self._cache = [self._create_instance(row) for row in raw_results]
        return self._cache
    
    def first(self):
        """è·å–ç¬¬ä¸€ä¸ªç»“æœ"""
        results = self.limit(1).all()
        return results[0] if results else None
    
    def count(self):
        """è®¡ç®—æ•°é‡"""
        builder = QueryBuilder(self.model_class)
        builder.select('COUNT(*)')
        sql = builder.build_sql()
        result = self.db_manager.execute_query(sql)
        return result[0][0] if result else 0
    
    def _clone(self):
        """å…‹éš†æŸ¥è¯¢é›†"""
        new_qs = QuerySet(self.model_class, self.db_manager)
        new_qs._builder = QueryBuilder(self.model_class)
        # å¤åˆ¶æŸ¥è¯¢æ¡ä»¶
        new_qs._builder._select_fields = self._builder._select_fields.copy()
        new_qs._builder._where_conditions = self._builder._where_conditions.copy()
        new_qs._builder._order_by = self._builder._order_by.copy()
        new_qs._builder._limit_value = self._builder._limit_value
        new_qs._builder._offset_value = self._builder._offset_value
        return new_qs
    
    def _create_instance(self, row_data):
        """ä»æ•°æ®åº“è¡Œåˆ›å»ºæ¨¡å‹å®ä¾‹"""
        instance = self.model_class()
        fields = self.model_class._meta.fields
        
        for i, (field_name, field) in enumerate(fields.items()):
            if i < len(row_data):
                db_value = row_data[i]
                python_value = field.from_db_value(db_value)
                setattr(instance, field_name, python_value)
        
        instance._state.loaded_from_db = True
        return instance
    
    def __iter__(self):
        """æ”¯æŒè¿­ä»£"""
        return iter(self.all())
    
    def __len__(self):
        """æ”¯æŒlen()"""
        return len(self.all())
    
    def __getitem__(self, key):
        """æ”¯æŒç´¢å¼•å’Œåˆ‡ç‰‡"""
        if isinstance(key, slice):
            start, stop = key.start or 0, key.stop
            new_qs = self._clone()
            new_qs._builder.offset(start)
            if stop is not None:
                new_qs._builder.limit(stop - start)
            return new_qs.all()
        else:
            return self.all()[key]
```

### ç¬¬ä¸‰æ­¥ï¼šæ•°æ®åº“ç®¡ç†å™¨å’Œè¿æ¥æ± 

```python
import sqlite3
import threading
from queue import Queue, Empty
from contextlib import contextmanager

class ConnectionPool:
    """æ•°æ®åº“è¿æ¥æ± """
    
    def __init__(self, database_url: str, max_connections: int = 10):
        self.database_url = database_url
        self.max_connections = max_connections
        self._pool = Queue(maxsize=max_connections)
        self._current_connections = 0
        self._lock = threading.Lock()
    
    def get_connection(self):
        """è·å–è¿æ¥"""
        try:
            # å°è¯•ä»æ± ä¸­è·å–è¿æ¥
            return self._pool.get_nowait()
        except Empty:
            # æ± ä¸­æ²¡æœ‰è¿æ¥ï¼Œåˆ›å»ºæ–°è¿æ¥
            with self._lock:
                if self._current_connections < self.max_connections:
                    conn = sqlite3.connect(self.database_url)
                    conn.row_factory = sqlite3.Row  # ä½¿æŸ¥è¯¢ç»“æœå¯ä»¥æŒ‰åˆ—åè®¿é—®
                    self._current_connections += 1
                    return conn
                else:
                    # ç­‰å¾…è¿æ¥å¯ç”¨
                    return self._pool.get()
    
    def return_connection(self, conn):
        """å½’è¿˜è¿æ¥"""
        self._pool.put(conn)
    
    @contextmanager
    def get_connection_context(self):
        """è¿æ¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
        conn = self.get_connection()
        try:
            yield conn
        finally:
            self.return_connection(conn)

class DatabaseManager:
    """æ•°æ®åº“ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    
    _instance = None
    _lock = threading.Lock()
    
    def __new__(cls):
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    cls._instance = super().__new__(cls)
        return cls._instance
    
    def __init__(self):
        if not hasattr(self, '_initialized'):
            self.connection_pool = None
            self._initialized = True
    
    def configure(self, database_url: str, max_connections: int = 10):
        """é…ç½®æ•°æ®åº“"""
        self.connection_pool = ConnectionPool(database_url, max_connections)
    
    def execute_query(self, sql: str, params: tuple = ()) -> List[tuple]:
        """æ‰§è¡ŒæŸ¥è¯¢"""
        with self.connection_pool.get_connection_context() as conn:
            cursor = conn.cursor()
            cursor.execute(sql, params)
            return cursor.fetchall()
    
    def execute_update(self, sql: str, params: tuple = ()) -> int:
        """æ‰§è¡Œæ›´æ–°"""
        with self.connection_pool.get_connection_context() as conn:
            cursor = conn.cursor()
            cursor.execute(sql, params)
            conn.commit()
            return cursor.rowcount
    
    @contextmanager
    def transaction(self):
        """äº‹åŠ¡ç®¡ç†"""
        conn = self.connection_pool.get_connection()
        try:
            cursor = conn.cursor()
            yield cursor
            conn.commit()
        except Exception:
            conn.rollback()
            raise
        finally:
            self.connection_pool.return_connection(conn)
```

### ç¬¬å››æ­¥ï¼šäº‹ä»¶ç³»ç»Ÿå’Œæ··å…¥

```python
class EventMixin:
    """äº‹ä»¶æ··å…¥"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._event_handlers = {}
    
    def on(self, event_name: str, handler: Callable):
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""
        if event_name not in self._event_handlers:
            self._event_handlers[event_name] = []
        self._event_handlers[event_name].append(handler)
    
    def emit(self, event_name: str, *args, **kwargs):
        """è§¦å‘äº‹ä»¶"""
        if event_name in self._event_handlers:
            for handler in self._event_handlers[event_name]:
                handler(self, *args, **kwargs)

class TimestampMixin:
    """æ—¶é—´æˆ³æ··å…¥"""
    
    created_at = DateTimeField(auto_now_add=True)
    updated_at = DateTimeField(auto_now=True)

class ValidationMixin:
    """éªŒè¯æ··å…¥"""
    
    def clean(self):
        """æ¸…ç†å’ŒéªŒè¯æ•°æ®"""
        errors = {}
        
        # å­—æ®µçº§éªŒè¯
        for field_name, field in self._meta.fields.items():
            value = getattr(self, field_name)
            try:
                if value is not None:
                    field.validate_and_convert(value)
            except ValueError as e:
                errors[field_name] = str(e)
        
        # æ¨¡å‹çº§éªŒè¯
        try:
            self.validate()
        except ValueError as e:
            errors['__all__'] = str(e)
        
        if errors:
            raise ValueError(f"éªŒè¯å¤±è´¥ï¼š{errors}")
    
    def validate(self):
        """æ¨¡å‹çº§éªŒè¯ï¼ˆå­ç±»å¯é‡å†™ï¼‰"""
        pass

class ModelState:
    """æ¨¡å‹çŠ¶æ€"""
    
    def __init__(self):
        self.loaded_from_db = False
        self.dirty_fields = set()
    
    def mark_dirty(self, field_name):
        """æ ‡è®°å­—æ®µä¸ºè„"""
        self.dirty_fields.add(field_name)
    
    def mark_clean(self):
        """æ ‡è®°ä¸ºå¹²å‡€"""
        self.dirty_fields.clear()
```

### ç¬¬äº”æ­¥ï¼šModelå…ƒç±»å’ŒåŸºç±»

```python
class ModelMeta(type):
    """Modelå…ƒç±»"""
    
    def __new__(mcs, name, bases, attrs, **kwargs):
        # ä¸å¤„ç†ModelåŸºç±»æœ¬èº«
        if name == 'Model':
            return super().__new__(mcs, name, bases, attrs)
        
        # æ”¶é›†å­—æ®µ
        fields = {}
        for key, value in list(attrs.items()):
            if isinstance(value, Field):
                fields[key] = value
                # ä»ç±»å±æ€§ä¸­ç§»é™¤å­—æ®µï¼Œå°†é€šè¿‡æè¿°ç¬¦è®¿é—®
                attrs.pop(key)
        
        # ç»§æ‰¿çˆ¶ç±»å­—æ®µ
        for base in bases:
            if hasattr(base, '_meta'):
                fields.update(base._meta.fields)
        
        # åˆ›å»ºMetaç±»
        meta_attrs = {
            'table_name': attrs.get('_table_name', name.lower()),
            'fields': fields,
            'primary_key': None
        }
        
        # æŸ¥æ‰¾ä¸»é”®å­—æ®µ
        for field_name, field in fields.items():
            if field.primary_key:
                meta_attrs['primary_key'] = field_name
                break
        
        attrs['_meta'] = type('Meta', (), meta_attrs)
        
        # åˆ›å»ºç±»
        cls = super().__new__(mcs, name, bases, attrs)
        
        # è®¾ç½®å­—æ®µåç§°
        for field_name, field in fields.items():
            field.name = field_name
        
        return cls

class Model(EventMixin, ValidationMixin, metaclass=ModelMeta):
    """ORMæ¨¡å‹åŸºç±»"""
    
    def __init__(self, **kwargs):
        super().__init__()
        self._state = ModelState()
        
        # è®¾ç½®å­—æ®µå€¼
        for field_name, value in kwargs.items():
            if field_name in self._meta.fields:
                setattr(self, field_name, value)
            else:
                raise AttributeError(f"æ¨¡å‹ {self.__class__.__name__} æ²¡æœ‰å­—æ®µ {field_name}")
        
        # è®¾ç½®é»˜è®¤å€¼
        for field_name, field in self._meta.fields.items():
            if field_name not in kwargs:
                if field.default is not None:
                    setattr(self, field_name, field.default)
                elif field.auto_now_add and isinstance(field, DateTimeField):
                    setattr(self, field_name, datetime.now())
    
    def __setattr__(self, name, value):
        # è¿½è¸ªå­—æ®µå˜åŒ–
        if hasattr(self, '_state') and name in self._meta.fields:
            self._state.mark_dirty(name)
        super().__setattr__(name, value)
    
    def save(self):
        """ä¿å­˜æ¨¡å‹"""
        self.emit('before_save')
        self.clean()  # éªŒè¯æ•°æ®
        
        db_manager = DatabaseManager()
        
        # å¤„ç†auto_nowå­—æ®µ
        for field_name, field in self._meta.fields.items():
            if isinstance(field, DateTimeField) and field.auto_now:
                setattr(self, field_name, datetime.now())
        
        if self._state.loaded_from_db:
            # æ›´æ–°
            self._update()
        else:
            # æ’å…¥
            self._insert()
        
        self._state.mark_clean()
        self._state.loaded_from_db = True
        self.emit('after_save')
    
    def _insert(self):
        """æ’å…¥æ•°æ®"""
        fields = []
        values = []
        
        for field_name, field in self._meta.fields.items():
            if hasattr(self, field_name):
                value = getattr(self, field_name)
                if value is not None:
                    fields.append(field_name)
                    values.append(field.to_db_value(value))
        
        sql = f"INSERT INTO {self._meta.table_name} ({', '.join(fields)}) VALUES ({', '.join(['?' for _ in values])})"
        
        db_manager = DatabaseManager()
        db_manager.execute_update(sql, tuple(values))
    
    def _update(self):
        """æ›´æ–°æ•°æ®"""
        if not self._state.dirty_fields:
            return  # æ²¡æœ‰å˜åŒ–ï¼Œä¸éœ€è¦æ›´æ–°
        
        set_clauses = []
        values = []
        
        for field_name in self._state.dirty_fields:
            if field_name in self._meta.fields:
                field = self._meta.fields[field_name]
                value = getattr(self, field_name)
                set_clauses.append(f"{field_name} = ?")
                values.append(field.to_db_value(value))
        
        primary_key = self._meta.primary_key
        pk_value = getattr(self, primary_key)
        
        sql = f"UPDATE {self._meta.table_name} SET {', '.join(set_clauses)} WHERE {primary_key} = ?"
        values.append(pk_value)
        
        db_manager = DatabaseManager()
        db_manager.execute_update(sql, tuple(values))
    
    def delete(self):
        """åˆ é™¤æ¨¡å‹"""
        self.emit('before_delete')
        
        primary_key = self._meta.primary_key
        pk_value = getattr(self, primary_key)
        
        sql = f"DELETE FROM {self._meta.table_name} WHERE {primary_key} = ?"
        
        db_manager = DatabaseManager()
        db_manager.execute_update(sql, (pk_value,))
        
        self.emit('after_delete')
    
    @classmethod
    def objects(cls):
        """è·å–æŸ¥è¯¢é›†"""
        db_manager = DatabaseManager()
        return QuerySet(cls, db_manager)
    
    def __str__(self):
        primary_key = self._meta.primary_key
        pk_value = getattr(self, primary_key, 'None')
        return f"{self.__class__.__name__}(id={pk_value})"
    
    def __repr__(self):
        return self.__str__()
```

### ç¬¬å…­æ­¥ï¼šä½¿ç”¨ç¤ºä¾‹

```python
# é…ç½®æ•°æ®åº“
db = DatabaseManager()
db.configure('example.db')

# å®šä¹‰æ¨¡å‹
class User(Model, TimestampMixin):
    """ç”¨æˆ·æ¨¡å‹"""
    
    id = IntegerField(primary_key=True)
    username = StringField(
        max_length=50, 
        validators=[Validators.min_length(3)]
    )
    email = StringField(
        max_length=100,
        validators=[Validators.email_validator]
    )
    age = IntegerField(min_value=0, max_value=150)
    
    def validate(self):
        """æ¨¡å‹çº§éªŒè¯"""
        if self.age and self.age < 13:
            raise ValueError("ç”¨æˆ·å¹´é¾„ä¸èƒ½å°äº13å²")

class Post(Model, TimestampMixin):
    """æ–‡ç« æ¨¡å‹"""
    
    id = IntegerField(primary_key=True)
    title = StringField(max_length=200)
    content = StringField(max_length=5000)
    author_id = IntegerField()
    published = IntegerField(default=0)  # 0=è‰ç¨¿, 1=å·²å‘å¸ƒ

# åˆ›å»ºè¡¨ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
def create_tables():
    db_manager = DatabaseManager()
    
    # åˆ›å»ºç”¨æˆ·è¡¨
    user_sql = """
    CREATE TABLE IF NOT EXISTS user (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        email TEXT NOT NULL,
        age INTEGER,
        created_at TEXT,
        updated_at TEXT
    )
    """
    
    # åˆ›å»ºæ–‡ç« è¡¨
    post_sql = """
    CREATE TABLE IF NOT EXISTS post (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        content TEXT,
        author_id INTEGER,
        published INTEGER DEFAULT 0,
        created_at TEXT,
        updated_at TEXT
    )
    """
    
    db_manager.execute_update(user_sql)
    db_manager.execute_update(post_sql)

# ä½¿ç”¨ç¤ºä¾‹
def demo():
    create_tables()
    
    print("=== ORMç³»ç»Ÿæ¼”ç¤º ===")
    
    # åˆ›å»ºç”¨æˆ·
    user = User(
        username="pythondev",
        email="dev@python.org",
        age=25
    )
    
    # æ·»åŠ äº‹ä»¶ç›‘å¬
    user.on('before_save', lambda model: print(f"å‡†å¤‡ä¿å­˜ç”¨æˆ·ï¼š{model.username}"))
    user.on('after_save', lambda model: print(f"ç”¨æˆ·ä¿å­˜å®Œæˆï¼š{model.username}"))
    
    # ä¿å­˜ç”¨æˆ·
    user.save()
    print(f"åˆ›å»ºç”¨æˆ·ï¼š{user}")
    
    # åˆ›å»ºæ–‡ç« 
    post1 = Post(
        title="Pythoné¢å‘å¯¹è±¡ç¼–ç¨‹",
        content="è¿™æ˜¯ä¸€ç¯‡å…³äºPython OOPçš„æ–‡ç« ...",
        author_id=1,
        published=1
    )
    post1.save()
    
    post2 = Post(
        title="è®¾è®¡æ¨¡å¼è¯¦è§£",
        content="è®¾è®¡æ¨¡å¼æ˜¯è½¯ä»¶å¼€å‘çš„ç»å…¸è§£å†³æ–¹æ¡ˆ...",
        author_id=1,
        published=0
    )
    post2.save()
    
    print(f"åˆ›å»ºæ–‡ç« ï¼š{post1}")
    print(f"åˆ›å»ºæ–‡ç« ï¼š{post2}")
    
    # æŸ¥è¯¢ç¤ºä¾‹
    print("\n=== æŸ¥è¯¢æ¼”ç¤º ===")
    
    # æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
    all_users = User.objects().all()
    print(f"æ‰€æœ‰ç”¨æˆ·ï¼š{all_users}")
    
    # æŸ¥è¯¢å·²å‘å¸ƒçš„æ–‡ç« 
    published_posts = Post.objects().filter(published=1).all()
    print(f"å·²å‘å¸ƒæ–‡ç« ï¼š{published_posts}")
    
    # æŸ¥è¯¢ç¬¬ä¸€ä¸ªç”¨æˆ·
    first_user = User.objects().first()
    print(f"ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼š{first_user}")
    
    # æ›´æ–°ç”¨æˆ·
    print("\n=== æ›´æ–°æ¼”ç¤º ===")
    first_user.age = 26
    first_user.save()
    print(f"æ›´æ–°åçš„ç”¨æˆ·ï¼š{first_user}")
    
    # é“¾å¼æŸ¥è¯¢
    print("\n=== é“¾å¼æŸ¥è¯¢æ¼”ç¤º ===")
    recent_posts = Post.objects().filter(published=1).order_by('created_at').limit(5).all()
    print(f"æœ€è¿‘å‘å¸ƒçš„æ–‡ç« ï¼š{recent_posts}")

if __name__ == "__main__":
    demo()
```

### é¡¹ç›®ç‰¹è‰²æ€»ç»“

è¿™ä¸ªORMç³»ç»Ÿå±•ç¤ºäº†æœ¬ç« å­¦ä¹ çš„æ‰€æœ‰é«˜çº§ç‰¹æ€§ï¼š

1. **é­”æœ¯æ–¹æ³•**ï¼š
   - `__new__`ï¼šå•ä¾‹æ¨¡å¼çš„æ•°æ®åº“ç®¡ç†å™¨
   - `__setattr__`ï¼šè¿½è¸ªå­—æ®µå˜åŒ–
   - `__str__` å’Œ `__repr__`ï¼šå‹å¥½çš„å¯¹è±¡è¡¨ç¤º
   - `__iter__`ã€`__len__`ã€`__getitem__`ï¼šQuerySetçš„å®¹å™¨åè®®

2. **å±æ€§ç®¡ç†ä¸æè¿°ç¬¦**ï¼š
   - Fieldç±»å®ç°äº†å®Œæ•´çš„æè¿°ç¬¦åè®®
   - è‡ªåŠ¨éªŒè¯å’Œç±»å‹è½¬æ¢
   - `__set_name__`æ”¯æŒå­—æ®µåè‡ªåŠ¨è®¾ç½®

3. **é«˜çº§ç±»ç‰¹æ€§**ï¼š
   - å…ƒç±»ModelMetaè‡ªåŠ¨æ”¶é›†å­—æ®µå®šä¹‰
   - ç±»æ–¹æ³•`objects()`ä½œä¸ºæŸ¥è¯¢å…¥å£
   - é™æ€æ–¹æ³•ç”¨äºéªŒè¯å™¨å·¥å‚

4. **æŠ½è±¡åŸºç±»**ï¼š
   - FieldæŠ½è±¡åŸºç±»å®šä¹‰å­—æ®µæ¥å£
   - å¼ºåˆ¶å­ç±»å®ç°å¿…è¦æ–¹æ³•

5. **æ··å…¥æ¨¡å¼**ï¼š
   - EventMixinï¼šäº‹ä»¶ç³»ç»Ÿ
   - TimestampMixinï¼šæ—¶é—´æˆ³ç®¡ç†
   - ValidationMixinï¼šæ•°æ®éªŒè¯

6. **è®¾è®¡æ¨¡å¼**ï¼š
   - å•ä¾‹æ¨¡å¼ï¼šDatabaseManager
   - å·¥å‚æ¨¡å¼ï¼šQuerySetåˆ›å»º
   - è§‚å¯Ÿè€…æ¨¡å¼ï¼šäº‹ä»¶ç³»ç»Ÿ
   - æ„å»ºå™¨æ¨¡å¼ï¼šQueryBuilder

### ğŸƒâ€â™‚ï¸ å®è·µç»ƒä¹ ï¼šæ‰©å±•ORMç³»ç»Ÿ

**ç»ƒä¹ 4**ï¼šä¸ºORMç³»ç»Ÿæ·»åŠ ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **å…³ç³»å­—æ®µ**ï¼šå®ç°ForeignKeyå­—æ®µï¼Œæ”¯æŒå…³è”æŸ¥è¯¢
2. **ç¼“å­˜ç³»ç»Ÿ**ï¼šä¸ºæŸ¥è¯¢ç»“æœæ·»åŠ ç¼“å­˜æœºåˆ¶
3. **è¿ç§»ç³»ç»Ÿ**ï¼šè‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“è¡¨ç»“æ„å˜æ›´è„šæœ¬
4. **åºåˆ—åŒ–å™¨**ï¼šå°†æ¨¡å‹è½¬æ¢ä¸ºJSONæ ¼å¼

```python
# TODO: å®ç°å…³ç³»å­—æ®µ
class ForeignKey(Field):
    def __init__(self, to_model, **kwargs):
        # å®ç°å¤–é”®å…³ç³»
        pass

# TODO: å®ç°æŸ¥è¯¢ç¼“å­˜
class CachedQuerySet(QuerySet):
    def __init__(self, *args, **kwargs):
        # æ·»åŠ ç¼“å­˜åŠŸèƒ½
        pass

# TODO: å®ç°æ¨¡å‹åºåˆ—åŒ–
class ModelSerializer:
    def serialize(self, instance):
        # è½¬æ¢ä¸ºå­—å…¸/JSON
        pass
```

---

## ğŸ¯ ç¬¬7ç« æ€»ç»“

æ­å–œä½ å®Œæˆäº†Pythoné¢å‘å¯¹è±¡ç¼–ç¨‹é«˜çº§ç‰¹æ€§çš„å­¦ä¹ ï¼è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æœ¬ç« çš„æ ¸å¿ƒå†…å®¹ï¼š

### çŸ¥è¯†è¦ç‚¹å›é¡¾

1. **é­”æœ¯æ–¹æ³•ä¸è¿ç®—ç¬¦é‡è½½**
   - å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - å­—ç¬¦ä¸²è¡¨ç¤ºå’Œæ ¼å¼åŒ–
   - è¿ç®—ç¬¦é‡è½½å®ç°
   - å®¹å™¨åè®®æ”¯æŒ

2. **å±æ€§ç®¡ç†ä¸æè¿°ç¬¦**
   - propertyè£…é¥°å™¨çš„é«˜çº§ç”¨æ³•
   - æè¿°ç¬¦åè®®çš„ä¸‰ä¸ªæ–¹æ³•
   - å±æ€§éªŒè¯å’Œè®¡ç®—å±æ€§
   - å±æ€§è®¿é—®æ§åˆ¶æœºåˆ¶

3. **é«˜çº§ç±»ç‰¹æ€§**
   - ç±»æ–¹æ³•ã€é™æ€æ–¹æ³•çš„é€‰æ‹©
   - æŠ½è±¡åŸºç±»çš„æ¥å£è®¾è®¡
   - æ··å…¥æ¨¡å¼çš„ç»„åˆä½¿ç”¨
   - æ–¹æ³•è§£æé¡ºåº(MRO)ç†è§£

4. **è®¾è®¡æ¨¡å¼åº”ç”¨**
   - å•ä¾‹æ¨¡å¼çš„å¤šç§å®ç°
   - å·¥å‚æ¨¡å¼çš„å¯¹è±¡åˆ›å»º
   - è§‚å¯Ÿè€…æ¨¡å¼çš„äº‹ä»¶ç³»ç»Ÿ
   - è£…é¥°å™¨æ¨¡å¼çš„åŠŸèƒ½å¢å¼º
   - ç­–ç•¥æ¨¡å¼çš„ç®—æ³•å°è£…

5. **ç»¼åˆé¡¹ç›®å®è·µ**
   - å¤æ‚ç³»ç»Ÿçš„æ¶æ„è®¾è®¡
   - å¤šç§ç‰¹æ€§çš„ç»¼åˆè¿ç”¨
   - å·¥ç¨‹åŒ–çš„ä»£ç ç»„ç»‡
   - å®é™…é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ

### ç¼–ç¨‹èƒ½åŠ›æå‡

é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ å·²ç»å…·å¤‡äº†ï¼š

- **é«˜çº§é¢å‘å¯¹è±¡è®¾è®¡èƒ½åŠ›**ï¼šèƒ½å¤Ÿè®¾è®¡å¤æ‚çš„ç±»ä½“ç³»
- **ä»£ç å¤ç”¨å’Œæ¨¡å—åŒ–æ€ç»´**ï¼šæŒæ¡æ··å…¥å’Œç»„åˆæ¨¡å¼
- **è®¾è®¡æ¨¡å¼åº”ç”¨èƒ½åŠ›**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨ç»å…¸æ¨¡å¼
- **æ¡†æ¶è®¾è®¡æ€ç»´**ï¼šç†è§£ORMç­‰æ¡†æ¶çš„å®ç°åŸç†
- **å·¥ç¨‹åŒ–å¼€å‘èƒ½åŠ›**ï¼šç¼–å†™å¯ç»´æŠ¤ã€å¯æ‰©å±•çš„ä»£ç 

### ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

1. **æ·±å…¥å­¦ä¹ **ï¼šç ”ç©¶Djangoã€SQLAlchemyç­‰æˆç†Ÿæ¡†æ¶çš„æºä»£ç 
2. **å®è·µé¡¹ç›®**ï¼šç”¨å­¦åˆ°çš„çŸ¥è¯†é‡æ„ç°æœ‰é¡¹ç›®æˆ–å¼€å‘æ–°é¡¹ç›®
3. **æ‰©å±•é˜…è¯»**ï¼šå­¦ä¹ ã€Šè®¾è®¡æ¨¡å¼ã€‹ã€ã€Šé‡æ„ã€‹ç­‰ç»å…¸ä¹¦ç±
4. **ç¤¾åŒºå‚ä¸**ï¼šåœ¨å¼€æºé¡¹ç›®ä¸­åº”ç”¨å’Œåˆ†äº«ä½ çš„çŸ¥è¯†

é¢å‘å¯¹è±¡ç¼–ç¨‹çš„é«˜çº§ç‰¹æ€§æ˜¯Pythonå¼ºå¤§åŠŸèƒ½çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æŒæ¡è¿™äº›ç‰¹æ€§ä¸ä»…èƒ½è®©ä½ å†™å‡ºæ›´ä¼˜é›…çš„ä»£ç ï¼Œè¿˜èƒ½å¸®ä½ æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨Pythonç”Ÿæ€ç³»ç»Ÿä¸­çš„å„ç§å·¥å…·å’Œæ¡†æ¶ã€‚

ç»§ç»­ä¿æŒå­¦ä¹ çš„çƒ­æƒ…ï¼Œåœ¨å®è·µä¸­ä¸æ–­æ·±åŒ–å¯¹è¿™äº›æ¦‚å¿µçš„ç†è§£ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†å­¦ä¹ Pythonçš„ç½‘ç»œç¼–ç¨‹å’ŒWebå¼€å‘ï¼

---